<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <!-- commented for dropdown menu hover bug -->
    <!-- <link href="../../static/library/bootstrap-theme.min-3.3.6.css" rel="stylesheet"> -->


    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>
    

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../static/js/multiselect/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../static/js/multiselect/jquery.multi-select.js"></script>

    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">
    <meta charset="UTF-8">


    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <script src="../../static/library/g6.min-4.3.11.js"></script>

{#    <script src="../../static/library/jquery.min-2.2.2.js"></script>#}
    <script src="../../static/library/jquery-ui.min-1.11.4.js"></script>


    <title> تحلیل کلان حوزه ها </title>
    {% include "doc/title_icon.html" %}

</head>

<body>
    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <script>
        $(document).ready(function () {
            {% comment %} $('.searchable').select2({
                dir: 'rtl',
            }); {% endcomment %}
            // Active panel
            $('#SepecificDropdown').addClass('active');
            $('#document_subject_area').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>

    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">

        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" autocomplete="off" novalidate>

            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mx-auto">

                <!-- Country Input -->
                <div class="col-md-6 pt-3 col-12 col-lg-2 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;" onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>

                </div>


                <!-- Search Box input -->
                <div class="col-md-6 pt-3 col-12 col-lg-4 bg-light" style="display: none;">
                    <label class="float-right" style="direction: rtl;">عبارت مورد نظر:</label>
                    <input style="direction: rtl;" class="float-left form-control text-right"
                        placeholder="متن جست‌وجو ..." type="text" required="" name="SearchBox" id="SearchBox" value="">
                </div>

                <!-- Validation input -->
                <div class="col-md-6 pt-3 col-12 col-lg-2 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">اعتبار سند:</label>
                    <select id="ValidationSelect" class="form-select text-right float-right searchable-select" style="direction: rtl;">

                    </select>
                </div>

                <!-- Revoked Size -->
                <div id="RevokedSizeSelectDiv" class="col-md-6 pt-3 col-12 col-lg-2 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> جزئی / کلی:</label>

                    <select id="RevokedSizeSelect" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button type="button" id="document_search" onclick="NewSearch()"
                        class="btn d-flex float-right mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        نمایش
                    </button>
                </div>

            </div>

            <!-- Advanced Fields in Second Row -->
            <div id="advanced_fields" class="collapse show row flex-row-reverse mx-auto mt-4">

                <!-- document Subject Area -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">حوزه موضوعی سند:</label>
                    <select id="SubjectAreaSelect" onchange="AreaChanged()" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- document Subject Sub Area -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">زیرحوزه موضوعی سند:</label>
                    <select id="SubjectSubAreaSelect" class="form-select text-right float-right searchable-multi-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- Organization Type -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">سازمان:</label>

                    <select id="OrganizationTypeSelect" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                    </select>

                </div>

                <!-- search type input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> نوع سند:</label>

                    <select id="TypeSelect" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                    </select>

                </div>



            </div>

        </form>
        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">نتایج جست‌وجو</button>
                </li>
                <!--
                <li class="nav-item float-right" role="presentation">
                    <button id="terms_graph_tab" class="nav-link" data-bs-toggle="pill" data-bs-target="#terms_graph_pane" type="button" role="tab" aria-controls="terms_graph_pane" aria-selected="false">گراف کلمات</button>
                </li>
                -->
                <li class="nav-item float-right" role="presentation">
                    <button id="bar_chart_info_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#bar_chart_info_pane" type="button" role="tab"
                        aria-controls="bar_chart_info_pane" aria-selected="false">داشبورد آماری</button>
                </li>
                <li class="nav-item float-right" role="presentation">
                    <button id="graph_tab" class="nav-link" data-bs-toggle="pill" data-bs-target="#graph_pane"
                        type="button" role="tab" aria-controls="graph_pane" aria-selected="false">گراف ارجاعات</button>
                </li>
                <li class="nav-item float-right definition_keywords_class" role="presentation">
                    <button id="definition_keywords_graph_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#definition_keywords_graph_pane" type="button" role="tab"
                        aria-controls="definition_keywords_graph_pane" aria-selected="false">گراف کلیدواژگان
                        تعاریف</button>
                </li>


                <!-- Download Buttons -->
                <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                    class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

                </button>

                <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button>


                <!-- Result Count -->
                <p id="SearchResultLable" class="text-left float-left text-secondary pl-2"></p>



            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">


                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                    aria-labelledby="search_result_tab">
                    <!-- Table Headers -->
                    <div class="mt-4">
                        <!-- Column Selection -->
                        <p id="ColumnSelection" class="text-left text-secondary float-right">فهرست براساس:</p>


                        <!-- Column select -->
                        <div class="col-md-6 col-12 col-lg-2 float-right">

                            <select id="ColumnSelect" onchange="show_table_result();"
                                class="form-select text-right float-right searchable-multi-select" style="direction: rtl;">

                            </select>

                        </div>


                        <!-- Page select -->
                        <div class="col-md-6 col-12 col-lg-2 float-left">

                            <input type="number" disabled ="true" onchange="TablePaginationChanged(event)" id="TablePaginationInput" min="1" max="1" value="1"
                            class="form-select text-right float-right" style="direction: rtl;">

                        </div>


                        <!-- Result Pagination -->
                        <p id="ResultPagination" class="text-left text-secondary float-left">صفحه:
                            <span id="from_page">1</span>
                            /
                            <span id="total_page">1</span>
                        </p>

                    </div>
                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                        </table>
                    </div>

                </div>

                <!-- Bar chart Info Pane -->
                <div dir="rtl" style="min-height: 200px;" class="tab-pane fade float-right w-100"
                    id="bar_chart_info_pane" role="tabpanel" aria-labelledby="bar_chart_info_tab">

                    <div class="mt-4 w-100 mx-0 px-0">
                        <div class="p-3 border border-2 m-3">
                            <!-- Document Subject  segment -->
                            <h5 class="document_subject pr-2 w-100 mt-4 text-center float-right">
                                توزیع موضوعی اسناد
                            </h5>
                            <br>
                            <div id="subject_sub_area_name_container" style="height: 400px" class="bg-white w-100 p-4" >
                            </div>
                        </div>
                        <div class="p-3 border border-2 m-3">
                            <!-- Document Level segment -->
                            <h5 class="document_level pr-2 w-100 mt-4 text-center float-right">
                                توزیع اسناد بر اساس سطح اسناد
                            </h5>
                            <br>
                            <div id="level_container" style="height: 400px" class="bg-white w-100 p-4">
                            </div>
                        </div>
                        <div class="p-3 border border-2 m-3">
                            <!-- Document Level segment -->
                            <h5 class="document_level pr-2 w-100 mt-4 text-center float-right">
                               توزیع اسناد بر اساس سال تصویب
                            </h5>
                            <br>
                            <div id="year_container" style="height: 400px" class="bg-white w-100 p-4">
                            </div>
                        </div>
                        <div class="p-3 border border-2 m-3">
                            <!-- Extracted References segment -->
                            <h5 class="extractected_references pr-2 w-100 mt-4 text-center float-right">
                               توزیع اسناد بر اساس مرجع تصویب
                            </h5>
                            <br>
                            <div id="approval_container" style="height: 400px" class="bg-white w-100 p-4">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Graph Pane -->

                <div dir="rtl" style="min-height: 200px;" class="tab-pane fade float-right w-100" id="graph_pane"
                    role="tabpanel" aria-labelledby="graph_tab">
                    <div class="row mt-4 w-100 flex-row-reverse mx-auto pb-5 px-4">
                        <!-- doc colors -->
                        <div dir="rtl" id="ColorBox" class="w-100 text-right" style="display: inline-flex">
                        </div>

                        <div id="constraints_container"
                            class="collapse show constraints_container row flex-row-reverse pt-0 mb-0 mt-0 mx-auto">

                            <div id="DegreeDiv" class="col-md-3 p-1 col-12 col-lg-6 mt-1">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">فیلتر درجه</label>
                                </div>
                                <div class="source_container pb-2 row mx-auto">
                                    <div dir="rtl" class="wrapper mt-5 mb-1" id="RangeSlider"
                                        style="visibility: hidden;">
                                        <div class="container" style="display: flex; justify-content: center;">
                                            <div class="slider-wrapper">
                                                <div dir="ltr" id="slider-range"></div>
                                                <div dir="rtl"
                                                    style="display:flex; width: 300px; justify-content: center"
                                                    class="range-wrapper">
                                                    <div dir="ltr" class="range mt-1"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="WeightDiv" class="col-md-3 p-1 col-12 col-lg-6 mt-1">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">فیلتر وزن</label>
                                </div>
                                <div class="source_container pb-2 row mx-auto">
                                    <div dir="rtl" class="wrapper mt-5 mb-1" id="WeightSlider"
                                        style="visibility: hidden;">
                                        <div class="container" style="display: flex; justify-content: center;">
                                            <div class="slider-wrapper">
                                                <div dir="ltr" id="slider-range"></div>
                                                <div dir="rtl"
                                                    style="display:flex; width: 300px; justify-content: center"
                                                    class="range-wrapper">
                                                    <div dir="ltr" class="range mt-1"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div dir="ltr">
                            <img style="width: 4%; cursor: pointer" src="../../static/image/neighbourhood.png"
                                onclick="SelectNeighbourhood()">
                            <img style="width: 3%; cursor: pointer" id="ShowHideImg"
                                src="../../static/image/hide_nodes.png" onclick="ShowHideNode()">
                        </div>

                        <select id="ChangeLayout" name="ChangeLayout" onchange="ChangeLayout()"
                            class="form-select text-right float-right" style="direction: rtl;">
                            <option value="grid">مربعی</option>
                            <option value="circular"> دایره ای </option>
                            <option value="force">ساده</option>
                            <option value="dagre">بالا به پایین</option>
                            <option value="radial">شعاعی</option>
                            <option value="concentric">متحدالمرکز</option>
                            <option value="comboForce">خوشه ای</option>
                        </select>

                        <script src="../../static/js/graph/color_picker_handler.js">
                        </script>

                        <div id="advanced_graph_container" class="border mt-1" style="height:500px; overflow: hidden">
                        </div>

                        <div dir="rtl" style="display: flex; margin-bottom: 50px;">
                            <div class="col-md-6 px-0 col-12 col-lg-5 pt-1">
                                <h6 class="table_header text-center  p-2  mb-0">
                                    گره های انتخاب شده
                                </h6>
                                <table id="selected_node_table" class="table table-striped PopUpTable"
                                    style="width: 95%;margin: auto;">

                                </table>
                            </div>

                            <div class="col-md-6 px-0 col-12 col-lg-7 pt-1">
                                <h6 class="table_header text-center  p-2  mb-0">
                                    یال های انتخاب شده
                                </h6>
                                <table id="selected_edge_table" class="table table-striped PopUpTable"
                                    style="width: 95%;margin: auto;">

                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!--  Document Graph Pane -->
                <div class="tab-pane fade show float-right w-100" id="document_graph_pane" role="tabpanel"
                    aria-labelledby="document_graph_tab">
                    <div class="row mt-4 w-100 flex-row-reverse  mx-auto pb-5 px-4">
                        <!-- doc colors -->
                        <!-- <ul id="ColorBox"
                            class="list-group flex-row-reverse list-unstyled w-100 list-group-horizontal text-right">
                        </ul> -->
                        <script src="../../static/js/graph/color_picker_handler.js">
                        </script>
                        <div id="advanced_graph_container" class="w-100 border mt-1" style="height:500px;">
                        </div>
                    </div>
                </div>

                <!--  Definition Keywords Graph Pane -->
                <div class="tab-pane fade show float-right w-100" id="definition_keywords_graph_pane" role="tabpanel"
                    aria-labelledby="definition_keywords_graph_tab">
                    <!-- keyword graph container -->
                    <div class="row mt-4 w-100 flex-row mx-0 px-4 pb-5">

                        <div id="definition_keywords_graph_container" class="w-100 border" style="height: 500px;">
                        </div>
                    </div>
                </div>


            </div>

        </div>


    </div>

    <!-- EdgeModal Container -->
    <button type="button" id="EdgeModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#EdgeModal"></button>
    <div class="modal fade" id="EdgeModal">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="EdgeModalHeader" class="modal-title"></h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="EdgeModalText" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->
                <div dir="rtl" class="modal-footer">

                </div>

            </div>
        </div>
    </div>


    <!-- Modal Container -->
    <div class="modal fade" id="myModal">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="DetailText" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal Container for Area Information  -->
    <div class="modal fade" id="AreaInfo">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="AreaInfoHeader" class="modal-title"> جزئیات </h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body bg-light text-justify">
                    <div class="row w-100 flex-row-reverse mx-0 px-0" id="AreaInfoBody">
                        <div class="col-md-4 px-4 col-12 col-lg-12">
                            <!-- Document Subject_Sub_Area segment -->
                            <h5 class="document_subject w-100 mt-4 text-center float-right pt-3 pb-3">
                                زیرحوزه
                            </h5>
                            <br>
                            <div style="margin-left: 1px !important; height: 400px;" id="subject_sub_area_container"
                                class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                            </div>
                        </div>
                    </div>

                    <!-- Keywords for each subject segment -->
                    <h6 class="subject_keywords pr-2">
                        <label for="doc_info" class="text-right float-right mt-5">واژه‌های کلیدی سند در هر زیرحوزه</label>
                    </h6>
                    <div dir="rtl" class="table-responsive">
                        <table class="table table-light table-striped  caption-top">
                            <thead class="table">
                                <tr>
                                    <th class="text-center" scope="col">ردیف</th>
                                    <th class="text-center" scope="col">زیرحوزه</th>
                                    <th class="text-center" scope="col">واژه‌های کلیدی در متن ( تعداد تکرار )</th>
                                </tr>
                            </thead>
                            <tbody id="subject_table">
                            </tbody>
                        </table>
                    </div>
                </div>

                {% comment %} <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div> {% endcomment %}

            </div>
        </div>
    </div>

    <!-- ChartModal Container -->
    <button type="button" id="ChartModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#ChartModal"></button>
    <div class="modal fade" id="ChartModal">
        <div id="modal_size" class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ChartModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ChartModalText" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->
                <div dir="rtl" class="modal-footer" id="chart_modal_footer">
                    <button id="DownloadDocuments" class="btn btn-primary"><i class="fa fa-download"></i> دانلود
                        اسناد</button>

                    <button id="ExportExcel2" class="btn btn-primary"><i class="fa fa-download"></i> خروجی اکسل
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- ActorChartModal Container -->
    <button type="button" id="actors_modal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#actors_modal"></button>
    <div class="modal fade" id="actors_modal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="actor_modal_header" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>
                <!-- Modal body -->

                <div class="bg-light modal-body text-justify">
                    <div class="highlight_options mt-0 p-0 float-left" style="z-index: 13;">
                        <button onclick="showOtherActors()" data-bs-toggle="tooltip" data-bs-placement="right"
                            title="نمایش سایر کنشگران" class="btn border float-left m-0  px-1"><i
                                style="font-size: 24px;" class="bi text-primary bi-people-fill"></i></button>
                        <!-- <button class="btn float-left m-0  px-1"><i style="font-size: 24px;" class="bi text-success bi-hourglass-split"></i></button> -->
                    </div>
                    <br>
                    <div id="actor_modal_body" class="bg-light text-justify">

                    </div>
                </div>
                <!-- Modal footer -->
                <div id="modal_footer" class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
        <!-- <i class="bi bi-chevron-up"></i> -->
        <!-- <i class="bi bi-chevron-double-up"></i> -->
        <!-- <i class="bi bi-arrow-up-circle"></i> -->
    </button>


    <!-- Toast -->
    <div class="position-absolute top-0 start-50 translate-middle p-3" style="z-index: 11;margin-top:95px;">
        <div dir="rtl" id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">
                <button type="button" class="btn-close float-left ml-0" data-bs-dismiss="toast"
                    aria-label="Close"></button>
                <i style="position: relative; top: -4px; font-size: 18px;"
                    class="bi bi-info-circle-fill  text-info"></i>
                <span id="toast_message">
                </span>
            </div>
        </div>
    </div>


    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js">
    </script>
    <!-- Intro Js -->
    <script src="../../static/js/search/search_tour.js"></script>
    <script src="../../static/js/tour.js"></script>


    <!-- Blocking UI -->
    <script src="../../static/js/blockUI.js"></script>
    <script src="../../static/js/blockUI_handler.js"></script>
    <link rel="stylesheet" href="../../static/styles/loader.css">

    <script src="../../static/js/column.js"></script>

    <script>
        const COLUMNS = {
            "approval_date": 'تاریخ تصویب',
            "etebar": 'اعتبار',
            "subject_sub_area_name": "زیرحوزه",
            "organization_type_name": "سازمان",
            "subject_sub_area_weight": "وزن",
            "subject_sub_area_entropy": "آنتروپی",
        }
        initSearchableSelects();
        append_column(COLUMNS)
        init()

        SearchResultValue = []
        ES_SearchResult = []
        TABLE_INFO = []
        MAX_RESULT_WINDOW = 5000
        SEARCH_RESULT_SIZE = 500
        let subject_area_dict = {}

        let graph_object;
        let data_graph;
        let min_selected_degree;
        let max_selected_degree;
        let min_selected_weight;
        let max_selected_weight;
        let show_hide_state = "show"

        container_id_list = ['SearchResultLable', 'SearchTable', 'subject_sub_area_name_container',
            'level_container', 'year_container', 'approval_container',
            'advanced_graph_container', 'definition_keywords_graph_container']

        function clearPrevResults(container_id_list) {

            for (container_id of container_id_list) {
                document.getElementById(container_id).innerHTML = "";
            }
        }


        async function init() {
            const country_id = document.getElementById("country").value
            startFullPageBlockUI();

            let request_link = 'http://' + location.host + "/GetSearchParameters/" + country_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            subject_area_dict = response["subject_area"]
            response = response["parameters_result"]

            /****************** Validation List ****************************/
            document.getElementById("ValidationSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                response['ValidationType'];

            /****************** SubjectArea List ****************************/
            document.getElementById("SubjectAreaSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                response['subject_area_id'];

            /****************** SubjectSubArea List ****************************/
            document.getElementById("SubjectSubAreaSelect").innerHTML = "<option value=" + 0 + " selected>" + "همه" + "</option>" +
                response['subject_sub_area_id'];

            /****************** SubjectArea List ****************************/
            document.getElementById("OrganizationTypeSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                response['OrganizationType'];

            /****************** Type List ****************************/
            document.getElementById("TypeSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                response['type'];

            /****************** SubjectArea List ****************************/
            document.getElementById("RevokedSizeSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                response['revoked_size'];


            syncAllSelectsWithResetExceptions(["country"]);


            //user log
            let form_data = new FormData()
            let detail_type = "نمایش پنل"
            form_data.append('detail_type', detail_type);
            UserLog(form_data)

            stopFullPageBlockUI('مقداردهی اولیه')

        }

        async function ShowColorBox() {
            let selected_category_id = document.getElementById('SubjectAreaSelect').value
    
            let selected_type = await GetMultiSelectValue('SubjectSubAreaSelect');
            selected_type = selected_type.split("__")
    
            const request_link = 'http://' + location.host + "/GetSubjectSubAreaList/" + selected_category_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["sub_area_list"]
            document.getElementById("ColorBox").innerHTML = "";
            for (var i = 0; i < response.length; i++) {
                const type_id = response[i]["id"]
                const type_name = response[i]["name"]
                const type_color = response[i]["color"]
    
                let is_checked = ""
                if (selected_type.includes(type_id.toString()) || selected_type.includes("0"))
                    is_checked = "checked"
    
                tag = '<div class="form-check"><input onclick="showReferencesGraph(0)" type="checkbox" id="' + type_id + '" '+is_checked+' disabled>'
                tag += '<label class="form-check-label" style="padding-right: 20px; color: ' + type_color + '" for="flexCheckChecked">' + type_name + '</label></div>'
    
                document.getElementById("ColorBox").innerHTML += tag
            }
        }

        function CountryChanged() {
            init()
        }

        async function AreaChanged() {
            document.getElementById("document_search").disabled = true;
    
            let selected_category_id = document.getElementById('SubjectAreaSelect').value

            let options = [{ value: '0', text: 'همه'}];

            if (selected_category_id != 0) {
                let key = selected_category_id + "#" + $('#SubjectAreaSelect option:selected').text();
                
                for (let sub of subject_area_dict[key]) {
                    options.push({value: sub[0], text: sub[1]});
                }
            }
            else {
                for (let key in subject_area_dict) {
                    for (let sub of subject_area_dict[key]) {
                        options.push({value: sub[0], text: sub[1]});
                    }
                }
            }
    
            syncSelectOptions('SubjectSubAreaSelect', options)
            document.getElementById("document_search").disabled = false;
        }
    
        function showDocumentInformation(documents_information_result, mode, where, total_hits,curr_page, text) {

            SearchResultValue = documents_information_result;
            SearchResultValue_Count = SearchResultValue.length
            const search_text = document.getElementById("SearchBox").value;

            document.getElementById("SearchResultLable").innerText = "تعداد کل نتایج: " + total_hits + " سند"
            let index = (curr_page - 1)*SEARCH_RESULT_SIZE + 1;
            let document_result = []
            for (let doc of documents_information_result) {
                const es_id = doc["_id"]
                const id = doc["_source"]["document_id"]
                const name = doc["_source"]["name"]
                const level = doc["_source"]["level_name"]
                const approval_date = doc["_source"]["approval_date"]
                const revoked_type_name = doc["_source"]["revoked_type_name"]
                const subject_area_name = doc["_source"]["subject_area_name"]
                const subject_sub_area_name = doc["_source"]["subject_sub_area_name"]
                const subject_sub_area_weight = doc["_source"]["subject_sub_area_weight"]
                const subject_sub_area_entropy = doc["_source"]["subject_sub_area_entropy"]
                const revoked_size = doc["_source"]["revoked_size"]
                const organization_type_name = doc["_source"]["organization_type_name"]

                let count = Math.round((doc['_score'] * 100)) / 100


                let button_disable = ""
                if (subject_area_name === "نامشخص") {
                    button_disable = "disabled"
                }

                // const detail_function = `DetailFunction('${es_id}', '${name}', '${mode}', '${where}', '${index - 1}')`;
                const detail_function = `DetailFunction('${id}')`;
                const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" onclick="' + detail_function + '" data-bs-target="#myModal">جزئیات</button>'

                const chart_function = `ShowAreaChartInformation('${id}', '${name}')`;
                const chart = '<button style="background-color:lightblue;color:black" type="button" class="btn modal_btn" data-bs-toggle="modal" ' + button_disable + ` onclick="` + chart_function + '">مشاهده</button>'

                const document_link = 'http://' + location.host + "/document_profile/?id=" + id
                const doc_name = '<a href="' + document_link + '">' + name + "</a>"

                const etebar = revoked_type_name + "(" + revoked_size + ")"

                const row = {
                    "id": index, "name": doc_name, "approval_date": approval_date,
                    "count": count, "revoked_type_name": revoked_type_name,"subject_area_name": subject_area_name,
                    "subject_sub_area_name": subject_sub_area_name, "organization_type_name": organization_type_name,
                    "etebar":etebar, "subject_sub_area_weight": subject_sub_area_weight,"subject_sub_area_entropy": subject_sub_area_entropy, "detail": detail, 'chart':chart
                }

                document_result.push(row)
                index += 1
            }
            TABLE_INFO = document_result
            show_table_result()
        }

        async function show_table_result() {
            selected_columns = ["id", "name", "chart", "detail"]
            selected_columns = find_selected_column(selected_columns)


            columns = [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
            }, {
                "name": "name",
                "title": "نام سند",
            }, {
                "name": "approval_date",
                "title": "تاریخ تصویب",
            }, {
                "name": "subject_sub_area_name",
                "title": "زیر حوزه",
            }, {
                "name": "organization_type_name",
                "title": "سازمان",
            }, {
                "name": "etebar",
                "title": "اعتبار",
            }, {
                "name": "subject_sub_area_weight",
                "title": "وزن",
                "sorted": true,
                "direction": "DESC",
            }, {
                "name": "subject_sub_area_entropy",
                "title": "آنتروپی",
            }, {
                "name": "chart",
                "title": "تحلیل نموداری",
            }, {
                "name": "detail",
                "title": "جزئیات",
            }]
            if (!selected_columns.includes("all")) {
                for (let column of columns) {
                    if (selected_columns.includes(column["name"])) {
                        column["visible"] = true
                    } else {
                        column["visible"] = false
                    }
                }
            }


            $('#SearchTable').empty();
            $('.SearchTable').footable({
                "paging": {
                    "enabled": true,
                    strings: {
                        first: '»',
                        prev: '›',
                        next: '‹',
                        last: '«'
                    }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "سندی یافت نشد.",
                "columns": columns,
                "rows": TABLE_INFO
            });
        }


        async function ChangeValidationSelect() {
            ValidationSelect = document.getElementById("ValidationSelect").value
            revoked = ['منسوخ', 'ابطال', 'منقضی']
            if (revoked.includes(ValidationSelect)) {
                document.getElementById("RevokedSizeSelectDiv").display = "block";
            }
            else {
                document.getElementById("RevokedSizeSelectDiv").display = "none";
            }
        }
        
        
        async function GetDocumentsInformation(country_id, revoked_type_id,subject_area_name, 
            subject_sub_area_name, organization_name, type_id, revoked_size, place, text, search_type,curr_page) {

            let request_link = '';
            notyf.dismissAll();

            startBlockUI('SearchTable');


            const from_advisory_opinion_count = 0
            const from_interpretation_rules_count = 0
            request_link = 'http://' + location.host + "/SearchDocumentSubjectArea_ES/" + country_id + "/" + revoked_type_id +
            "/" + subject_area_name + "/" + subject_sub_area_name + "/" + organization_name + "/" + type_id + "/" + revoked_size + "/" + place + "/" 
            + text + "/" + search_type + "/" + from_advisory_opinion_count + "/" + from_interpretation_rules_count + "/"
             + curr_page + "/"


            let response = await fetch(request_link).then(response => response.json());

            /*  Show Table Result */
            total_hits = response["total_hits"]
            curr_page = response["curr_page"]
            ES_SearchResult = response["result"]
            ES_Aggregations = response["aggregations"]

            update_pagination_input(curr_page ,total_hits)

            showDocumentInformation(ES_SearchResult, search_type, place, total_hits,curr_page, text)
            stopBlockUI('SearchTable', 'نتایج جست‌وجو');


            GetChartData_Es(country_id, text, ES_Aggregations, ES_SearchResult);


            /********************* Show Graph *************************/

            startBlockUI('advanced_graph_container');
            await showReferencesGraph(1)
            stopBlockUI('advanced_graph_container', 'گراف ارجاعات');

        }

        async function update_pagination_input(curr_page,total_hits){
            
            page_count = 0;

            if (total_hits < SEARCH_RESULT_SIZE) {
                page_count = 1

            }else if (total_hits < MAX_RESULT_WINDOW) {
                page_count = Math.ceil(total_hits / SEARCH_RESULT_SIZE)

            }else if (total_hits >= MAX_RESULT_WINDOW){
                page_count = MAX_RESULT_WINDOW / SEARCH_RESULT_SIZE
            }

            document.getElementById("TablePaginationInput").min = 1;
            document.getElementById("TablePaginationInput").max = page_count;
            document.getElementById("TablePaginationInput").value = curr_page;

            document.getElementById("from_page").innerText = curr_page;
            document.getElementById("total_page").innerText = page_count
            
        }

        async function GetChartData_Es(country_id, text, ES_Aggregations, documents_information_result) {

            let request_link = '';
            startBlockUI('bar_chart_info_pane');

            subject_sub_area_name_data = ES_Aggregations['subject-sub-area-agg']['buckets']
            approval_references_data = ES_Aggregations['approval-ref-agg']['buckets']
            level_data = ES_Aggregations['level-agg']['buckets']
            approval_year_data = ES_Aggregations['approval-year-agg']['buckets']
            doc_ids = []


            for (doc of documents_information_result) {
                doc_ids.push(doc['_id'])
            }


            /* Show Chart  */


            showChartData(subject_sub_area_name_data, "subject_sub_area_name_container", documents_information_result, false, "موضوع")
            showChartData(level_data, "level_container", documents_information_result, false, "سطح")
            showChartData(approval_year_data, "year_container", documents_information_result, true, "سال تصویب")
            showChartData(approval_references_data, "approval_container", documents_information_result, false, "مرجع تصویب")
            stopBlockUI('bar_chart_info_pane', 'داشبورد آماری');

        }


        $('#definition_keywords_graph_tab').hide();

        async function NewSearch(){
            await update_pagination_input(1,0);
            await ShowResult()
        }

        async function ShowResult() {
            await SpinnerModeFunction("Active");
            document.getElementById('TablePaginationInput').disabled = true;
            // clear previous results
            clearPrevResults(container_id_list);

            await SpinnerModeFunction("Active");

            const country_id = document.getElementById("country").value;
            const revoked_type_id = document.getElementById("ValidationSelect").value;
            const subject_area_name = document.getElementById("SubjectAreaSelect").value;
            const subject_sub_area_name = await GetMultiSelectValue('SubjectSubAreaSelect');
            const organization_name = document.getElementById("OrganizationTypeSelect").value;
            const type_id = document.getElementById("TypeSelect").value;
            const revoked_size = document.getElementById("RevokedSizeSelect").value;
            const curr_page = document.getElementById('TablePaginationInput').value

            console.log(document.getElementById("SubjectSubAreaSelect"))

            const place = "عنوان یا متن"
            let text = document.getElementById("SearchBox").value;
            const search_type = 'exact'

            if (text.trim().length > 0) {
                text = text.replaceAll('/', '>')
                text = text.replaceAll('\\', '<')

                GetDocumentsInformation(country_id, revoked_type_id,
                subject_area_name, subject_sub_area_name, organization_name, type_id, revoked_size, place, text, search_type,curr_page);

            } else {

                GetDocumentsInformation(country_id, revoked_type_id,
                 subject_area_name, subject_sub_area_name, organization_name, type_id, revoked_size, place, "empty", 'All',curr_page);

            }
            if (place == 'تعاریف') {
                $('#definition_keywords_graph_tab').show();
                const request_link = 'http://' + location.host + "/SearchGeneralDocumentsDefinition/" + country_id + "/" + search_type + "/" + text + "/"
                const response = await fetch(request_link).then(response => response.json());

                createKeywordsGraphData(response['keywords_information']);

            } else {
                $('#definition_keywords_graph_tab').hide();

            }

            document.getElementById('TablePaginationInput').disabled = false;

            await SpinnerModeFunction("Disable");

            //user log
            let form_data = new FormData()
            let detail_type = "نتایج جست و جو"
            let country_name = $("#country option:selected").text();
            let Validation_Select = $("#ValidationSelect option:selected").text();
            let SubjectArea_Select = $("#SubjectAreaSelect option:selected").text();
            let SubjectSubArea_Select = $("#SubjectSubAreaSelect option:selected").text();
            let OrganizationType_Select = $("#OrganizationTypeSelect option:selected").text();
            let Type_Select = $("#TypeSelect option:selected").text();
            let RevokedSize_Select = $("#RevokedSizeSelect option:selected").text();
            let search_text = text
            form_data.append('detail_type', detail_type);
            form_data.append('country_name', country_name);
            form_data.append('Validation_Select', Validation_Select);
            form_data.append('SubjectArea_Select', SubjectArea_Select);
            form_data.append('SubjectSubArea_Select', SubjectSubArea_Select);
            form_data.append('OrganizationType_Select', OrganizationType_Select);
            form_data.append('Type_Select', Type_Select);
            form_data.append('RevokedSize_Select', RevokedSize_Select);
            form_data.append('search_text', search_text);
            UserLog(form_data)

        }

        async function ShowAreaChartInformation(doc_id, doc_name) { 
            subject_sub_area_data = []
            
            startFullPageBlockUI();
            const request_link = 'http://' + location.host + "/GetAreaChartInformation/" + doc_id + "/"
            const response = await fetch(request_link).then(response => response.json());
            let request_link2 = 'http://' + location.host + "/GetParagraphWithAreaKeywords/" + doc_id + "/";
            let response2 = await fetch(request_link2).then(response2 => response2.json());
            stopFullPageBlockUI('داشبورد آماری');


            document.getElementById('AreaInfoHeader').innerHTML = "";
            const header = 'داشبورد آماری سند ' + doc_name
            document.getElementById('AreaInfoHeader').innerHTML += header

            documents_information_result = response['result']
            for (subject_sub_area of documents_information_result['details']) {
                    const subject_sub_area_id = subject_sub_area['subject_sub_area_id']
                    subject_sub_area_data.push({'key': subject_sub_area['subject_sub_area_name'], 'doc_count': subject_sub_area['weight']})
            }
            documents_information_result = response2['sub_area_paragraph']
            console.log(response2['keywords'])
            showChartData(subject_sub_area_data, "subject_sub_area_container", documents_information_result, false, 'زیرحوزه')

            keywords = response2["keywords"]
            document.getElementById("subject_table").innerHTML = ""

            for (let i = 0; i < keywords.length; i++) {
                const sub_area = keywords[i]["sub_area_name"]
                const keywords_text = keywords[i]["words_count"]

                tag = "<tr>" +
                    "<td class='col-1'>" + (i + 1) + "</td>" +
                    "<td class='col-2'>" + sub_area + "</td>" +
                    "<td class='col-4'>" + keywords_text + "</td>" +
                    "</tr>";

                document.getElementById("subject_table").innerHTML += tag;

            }

            $('#AreaInfo').modal('show');
        }


        function showChartData(data, container, documents_information_result, keySort, xAxisTitle) {
            let chart_data = []
            for (column of data) {

                key = column["key"]
                // key = column["key"] != 0 ? column["key"] : 'نامشخص'
                value = column["doc_count"]

                chart_data.push([key, value])
            }
            showChart(chart_data, container, documents_information_result, keySort, xAxisTitle)
        }


        async function showReferencesGraph(firstLoad) {
            document.getElementById("advanced_graph_container").innerHTML = ""
    
            if (firstLoad === 1)
                await ShowColorBox()
    
            const subject_area_id = document.getElementById("SubjectAreaSelect").value
            const country_id = document.getElementById("country").value
    
            let request_link = 'http://' + location.host + "/GetSubjectAreaGraphNodesEdges/" + country_id + "/" + subject_area_id + "/";
            let response = await fetch(request_link).then(response => response.json());
    
            let Nodes_data = response["Nodes_data"]
            let Edges_data = response["Edges_data"]
    
            data_graph = {
                nodes: Nodes_data,
                edges: Edges_data
            };
    
            await FilterGraphSubArea()
    
            const container = document.getElementById('advanced_graph_container');
            const width = 1300;
            const height = 500;
    
            const tooltip = new G6.Tooltip({
                offsetX: 10,
                offsetY: 10,
                itemTypes: ['node', 'edge'],
                getContent: (e) => {
                    const outDiv = document.createElement('div');
                    outDiv.style.width = 'fit-content';
                    let a = e.item.getType()
                    if (a === "node") {
                        outDiv.innerHTML = `<div>
                                                <p>${e.item.getModel().name}</p>
                                            </div>`;
                    }
                    else if (a === "edge") {
                        outDiv.innerHTML = `<div style="direction: rtl">
                            <p>از: ${e.item.getModel().source_name}</p>
                            <p>به: ${e.item.getModel().target_name}</p>
                            <p style="font-weight: bold">تعداد ارجاع: ${e.item.getModel().weight}</p>
                        </div>`;
                    }
                    return outDiv;
                }
            });
    
            graph_object = new G6.Graph({
                container: 'advanced_graph_container',
                width,
                height,
                modes: {
                    default: ['zoom-canvas',
                        'drag-node',
                        'drag-canvas',
                        { type: "brush-select", trigger: 'ctrl' },
                    ], //"activate-relations"
                },
                plugins: [tooltip],
                layout: "grid",
                animate: true,
                defaultEdge: {
                    style: {
                        stroke: '#404040',
                        endArrow: {
                            path: 'M 0,0 L 8,4 L 8,-4 Z',
                            fill: '#404040',
                        },
                        cursor: "pointer"
                    },
                },
                nodeStateStyles: {
                    selected: {
                        stroke: 'Yellow',
                        fill: 'Yellow'
                    },
                    cursor: "pointer"
                },
            });
    
    
            graph_object.data(data_graph);
            graph_object.render();
    
            graph_object.on('nodeselectchange', e => {
                const selected_nodes = e.selectedItems.nodes
                const selected_edges = e.selectedItems.edges
    
                let nodes_data = []
                let id = 1
                for (const node of selected_nodes) {
                    const node_object = node._cfg.model
                    const node_id = node_object.id
                    const node_name = node_object.name
                    const type_name = node_object.type_name
    
                    const degree = graph_object.getNodeDegree(node_object.id, 'total');
    
                    const nodeSelection = "NodeSelection('" + node_id + "')"
                    const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" onclick="' + nodeSelection + '" data-bs-target="#detailModal">انتخاب</button>'
    
                    nodes_data.push({ id: id, name: node_name, type_name: type_name, degree: degree, node_selection: detail })
                    id = id + 1
                }
                $('#selected_node_table').empty();
                $('#selected_node_table').footable({
                    "paging": {
                        "enabled": true,
                        strings: {
                            first: '»',
                            prev: '›',
                            next: '‹',
                            last: '«'
                        }
                    },
                    "filtering": {
                        "enabled": false
                    },
                    "sorting": {
                        "enabled": true
                    },
                    "empty": "گره ای انتخاب نشده است",
                    "columns": [{
                        "name": "id",
                        "title": "ردیف",
                        "breakpoints": "xs sm",
                        "type": "number",
                        "style": {
                            "width": "5%"
                        }
                    }, {
                        "name": "name",
                        "title": "نام گره",
                        "style": {
                            "width": "60%"
                        }
                    }, {
                        "name": "degree",
                        "title": "درجه",
                        "style": {
                            "width": "10%"
                        }
                    }, {
                        "name": "type_name",
                        "title": "نوع گره",
                        "style": {
                            "width": "15%"
                        }
                    }, {
                        "name": "node_selection",
                        "title": "انتخاب",
                        "style": {
                            "width": "10%"
                        }
                    }
                    ],
                    "rows": nodes_data
                });
    
                let edges_data = []
                id = 1
                for (const edge of selected_edges) {
                    const edge_object = edge._cfg.model
    
                    const src_node_id = edge_object.source
                    const src_node_name = edge_object.source_name
                    const source_doc_link = 'http://' + location.host + '/document_profile/?id=' + src_node_id.toString()
                    const source_doc_tag = '<a class="document_link" target="_blank" href="' + source_doc_link + '">' + src_node_name + "</a>"
    
                    const target_node_id = edge_object.target
                    const target_node_name = edge_object.target_name
                    const target_doc_link = 'http://' + location.host + '/document_profile/?id=' + target_node_id.toString()
                    const target_doc_tag = '<a class="document_link" target="_blank" href="' + target_doc_link + '">' + target_node_name + "</a>"
    
                    const weight = edge_object.weight
    
                    edges_data.push({ id: id, src_name: src_node_name, target_name: target_node_name, weight: weight })
                    id = id + 1
                }
                $('#selected_edge_table').empty();
                $('#selected_edge_table').footable({
                    "paging": {
                        "enabled": true,
                        strings: {
                            first: '»',
                            prev: '›',
                            next: '‹',
                            last: '«'
                        }
                    },
                    "filtering": {
                        "enabled": false
                    },
                    "sorting": {
                        "enabled": true
                    },
                    "empty": "یالی انتخاب نشده است",
                    "columns": [{
                        "name": "id",
                        "title": "ردیف",
                        "breakpoints": "xs sm",
                        "type": "number",
                        "style": {
                            "width": "5%"
                        }
                    }, {
                        "name": "src_name",
                        "title": "مبدا",
                        "style": {
                            "width": "40%"
                        }
                    }, {
                        "name": "target_name",
                        "title": "مقصد",
                        "style": {
                            "width": "40%"
                        }
                    }, {
                        "name": "weight",
                        "title": "وزن",
                        "style": {
                            "width": "15%"
                        }
                    },
                    ],
                    "rows": edges_data
                });
    
            })
    
            function handleNodeClick(event) {
                const item = event.item._cfg.model;
                window.open('http://' + location.host + "/document_profile?id=" + item["id"]);
            }
            graph_object.on('node:dblclick', handleNodeClick);
    
            function handleEdgeClick(event) {
                const item = event.item._cfg.model;
                const edge_id = item["source"] + "__" + item["target"]
                window.open('http://' + location.host + "/comparison?id=" + edge_id);
            }
            graph_object.on('edge:dblclick', handleEdgeClick);
    
            if (typeof window !== 'undefined')
                window.onresize = () => {
                    if (!graph_object || graph_object.get('destroyed')) return;
                    if (!container || !container.scrollWidth || !container.scrollHeight) return;
                    graph_object.changeSize(container.scrollWidth, 500);
                };
    
            var select = $("#ChangeLayout");
            select.val(select.children(":first").val());
    
            let min_degree = 1.797693134862315E+308
            let max_degree = 0
            data_graph.nodes.forEach((node) => {
                const degree = graph_object.getNodeDegree(node["id"], 'total');
                if (degree < min_degree) {
                    min_degree = degree
                }
                if (degree > max_degree) {
                    max_degree = degree
                }
            })
    
            if (min_degree === 1.797693134862315E+308)
                min_degree = 0
    
            let min_weight = 1.797693134862315E+308
            let max_weight = 0
            data_graph.edges.forEach((edge) => {
                const weight = edge["weight"];
                if (weight < min_weight) {
                    min_weight = weight
                }
                if (weight > max_weight) {
                    max_weight = weight
                }
            })
    
            if (min_weight === 1.797693134862315E+308)
                min_weight = 0
    
            await ShowRangeSlider(min_degree, max_degree)
            await ShowWeightSlider(min_weight, max_weight)
    
            var element = document.getElementById('advanced_graph_container');
            element.style.position = null;
    
        }


        function showChart(data, position, documents_information_result, keySort, xAxisTitle) {


            if (keySort === true) {
                data.sort(function (element_a, element_b) {
                    return element_a[0] - element_b[0];
                });
            }
            else {
                data.sort(function (element_a, element_b) {
                    return element_a[1] - element_b[1];
                });
            }

            data.sort(function (x, y) { return x[0] === 'نامشخص' ? -1 : y[0] === 'نامشخص' ? 1 : 0; });

            if (data[0][0] == 0) {
                data[0][0] = 'نامشخص'
            }
            // Sorts the data by descending.
            data = anychart.data.set(data)

            document.getElementById(position).innerHTML = ""

            chart = anychart.column();
            chart.container(position);
            // create a column series and set the data
            var series = chart.column(data);
            chart
                .animation(true)
                .padding([10, 40, 5, 20])


            chart.background().fill('#ffffff');
            series.normal().fill("#488fb8", 1);
            series.normal().stroke("#488fb8", 0);

            // var state = series.normal();
            // state.fill('#1481c0')

            // x axix labels font setting
            var xAxisLabels = chart.xAxis().labels();
            xAxisLabels.fontFamily("vazir");
            xAxisLabels.rotation(315);

            var yAxisLabels = chart.yAxis().labels();
            yAxisLabels.fontFamily("vazir");

            // Not allow labels overlapping
            var xAxis = chart.xAxis();
            xAxis.overlapMode("noOverlap");
            xAxis.title(xAxisTitle);
            xAxis.title().fontFamily('vazir');
xAxis.title().fontWeight("bold");
            xAxis.title().height(40);

            var yAxis = chart.yAxis();
            yAxis.title("تعداد سند");
            if (position == "subject_sub_area_container")
                yAxis.title("درصد");
            yAxis.title().fontFamily('vazir');
yAxis.title().fontWeight("bold");
            yAxis.title().height(40);

            // tooltip content font setting
            var tooltip = chart.tooltip();
            tooltip.fontFamily("vazir");

            // tooltip title font setting
            var title = chart.tooltip().title();
            title.fontFamily("vazir");

            chart.tooltip().hAlign('center').format("{%value}");

            chart.xAxis().labels().height(60);

            chart.yAxis().labels().format("{%value}");

            chart.yScale().minimum(0);
            chart.yScale().ticks().allowFractional(false);

            //xAxisLabels.rotation(-90)
            // initiate drawing the chart
            chart.draw();
            chart.listen("mouseOver", function(e){
              document.body.style.cursor = "pointer";
            });
            chart.listen("mouseOut", function(e){
              document.body.style.cursor = "auto";
            });

            chart.listen('Click', async function (event) {
                const click_tag = event.domTarget.tag;
                const index = click_tag["index"]
                const text = data.row(index)[0];
                var best_result_count = ""
                try {
                    best_result_count = documents_information_result.length
                }
                catch {
                    best_result_count = ""
                }

                let filtered_result = []
                let header = ""
                let save_file_name = document.getElementById("SearchBox").value;

                if (position === "subject_sub_area_name_container") {
                    filtered_result = documents_information_result.filter(function (row) {
                        if (row['_source']["subject_sub_area_name"] === text)
                            return row
                    });
                    header = "موضوع: " + text
                    save_file_name += " (مجموعه سند {1} و موضوع {2})".replace("1", filtered_result[0]["country"]).replace("2", text)
                }

                else if (position === "approval_container") {
                    filtered_result = documents_information_result.filter(function (row) {
                        if (row['_source']["approval_reference_name"] === text)
                            return row
                    });
                    header = "مرجع تصویب: " + text
                    save_file_name += " (مجموعه سند {1} و مرجع تصویب {2})".replace("1", filtered_result[0]["country"]).replace("2", text)
                }

                else if (position === "level_container") {
                    filtered_result = documents_information_result.filter(function (row) {
                        if (row['_source']["level_name"] === text)
                            return row
                    });
                    header = "سطح سند: " + text
                    save_file_name += " (مجموعه سند {1} و سطح سند {2})".replace("1", filtered_result[0]["country"]).replace("2", text)
                }

                else if (position === "year_container") {
                    filtered_result = documents_information_result.filter(function (row) {
                        doc_approval_year = row["_source"]["approval_year"] != 0 ? row["_source"]["approval_year"] : 'نامشخص'

                        if (doc_approval_year == text)
                            return row
                    });
                    header = "سال تصویب: " + (text != 0 ? text : 'نامشخص')
                    save_file_name += " (مجموعه سند {1} و سال تصویب {2})".replace("1", "داتیک").replace("2", (text != 0 ? text : 'نامشخص'))
                }

                else if (position === "subject_sub_area_container") {
                    filtered_result = documents_information_result.filter(function (row) {
                        if (row["sub_area_name"] === text)
                            return row
                    });
                    header = "زیرحوزه: " + text
                }

                document.getElementById("ChartModalHeader").innerText = header
                let filtered_result_tag = ""
                let list_of_docId = ""
                if (position != "subject_sub_area_container") {
                    for (const doc of filtered_result) {
                        const link = 'http://' + location.host + "/document_profile/?id=" + doc["_source"]["document_id"]
                        let tag = "<li class='mt-3' id=" + doc["_source"]["document_id"] + "><a href='" + link + "'>" + doc["_source"]["name"] + "</a></li>"
                        filtered_result_tag += tag
                        list_of_docId += doc["document_id"] + "_"
                    }

                    const filtered_result_count = filtered_result.length
                    document.getElementById("ChartModalText").innerHTML = "<h6 class='text-secondary' >" + filtered_result_count + " سند از " + best_result_count + " سند نمایشی:" + "</h6>"
                }
                else {
                    document.getElementById("ChartModalText").innerHTML = filtered_result_tag
                    console.log(filtered_result[0]["paragraphs"])
                    for (const para of filtered_result[0]["paragraphs"]) {
                        let tag = "<li class='mt-3'><h6>" + para + "</h6></li>"
                        filtered_result_tag += tag
                    }
                }
                filtered_result_tag = "<ol start='1'>" + filtered_result_tag + "</ol>"
                document.getElementById("ChartModalText").innerHTML += filtered_result_tag


                /* download file creation */
                document.getElementById("DownloadDocuments").onclick = function () {
                    downloadFiles(filtered_result, save_file_name);
                };

                /* export into excel files */
                document.getElementById("ExportExcel2").onclick = function ExportExcelFunction() {

                    var csv = "";

                    sep = ","
                    let Csv = "نام سند" + sep + "سطح سند" + sep +
                        "موضوع سند" + sep + "نوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + "\n"
                    for (const document of filtered_result) {
                        Csv += document['_source']["name"] + sep + document['_source']["level_name"] + sep + document['_source']["subject_name"] + sep +
                            document['_source']["type_name"] + sep + document['_source']["approval_reference_name"] + sep + document['_source']["approval_date"] + "\n"

                    }

                    let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
                    var link = document.createElement("a");
                    link.setAttribute("href", csvContent);
                    link.setAttribute("download", save_file_name + ".csv");
                    document.body.appendChild(link);
                    link.click()
                };
                if (position != "subject_sub_area_container") {
                    document.getElementById("chart_modal_footer").style.display = "block";
                    $("#ChartModalBtn").click();
                }
                else {
                    document.getElementById("chart_modal_footer").style.display = "none";
                    document.getElementById("modal_size").setAttribute("style", "height: '350px;vertical-align: middle;")
                    $('#ChartModal').modal('show');
                }

            })

        }

        function popup_handler() {
            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
            var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl)
            });
        }

        let actors_dict = {}
        let actors_list = []

        /* Optianal keywords need to be highlighted */
        const optional_keywords = ['به‌منظور', 'نسبت به']
        let optional_after_terms_count = {}
        optional_after_terms_count['به‌منظور'] = 2
        optional_after_terms_count['نسبت به'] = 2


        /* Global Constants */
        const motevalian_punctuations = ['.', '،', 'ـ', '-', ':'];
        const hamkaran_punctuations = ['،', ')', ':']

        const motevali_keywords = ['موظف است', 'مکلف است', 'مکلف‌اند', 'موظف‌اند', 'موظفند', 'مکلفند', 'موظف به', 'مکلف به'];
        const hamkaran_keywords = ['با همکاری', 'باهمکاری'];
        const salahiat_keywords = ['مختار است', 'اختیار دارد', 'می‌تواند', 'می تواند', 'میتواند', 'می­تواند', 'می‏تواند', 'مجاز است'];


        const deadline_pattern_keywords = ['ظرف', 'ظرف مدت', 'ظرف مهلت', 'طی', 'طی مدت', 'طی مهلت', 'حداکثر', 'فواصل زمانی', 'هر']
        const time_categories = ['روز', 'هفته', 'ماه', 'سال']
        const numbers_dict = {
            "یک": {
                'value': 1,
            },
            "دو": {
                'value': 2,
            },
            "سه": {
                'value': 3,
            },
            "چهار": {
                'value': 4,
            },
            "پنج": {
                'value': 5,
            },
            "شش": {
                'value': 6,
            },
            "هفت": {
                'value': 7,
            },
            "هشت": {
                'value': 8,
            },
            "نه": {
                'value': 9,
            },
            "ده": {
                'value': 10,
            }
        }

        async function showActorsChart(chart_container, chart_data, country_id, preprocessed_keywords_text) {

            /* Get Actors Dict */
            let request_link = 'http://' + location.host + "/GetActorsDict/";
            let response = await fetch(request_link).then(response => response.json());
            actors_dict = response['actorsDict']

            /* Get Actors List */
            request_link = 'http://' + location.host + "/GetActorsList/";
            response = await fetch(request_link).then(response => response.json());
            actors_list = response["actorsList"];

            if (!preprocessed_keywords_text || preprocessed_keywords_text == '') {
                preprocessed_keywords_text = 'empty'
            } else {
                preprocessed_keywords_text = preprocessed_keywords_text.replace(' ', ',')
            }
            document.getElementById(chart_container).innerHTML = ""
            // create a data set
            var data = anychart.data.set(chart_data);

            // map the data
            var salahiat_series_data = data.mapAs({ x: 0, value: 3 });
            var hamkaran_series_data = data.mapAs({ x: 0, value: 2 });
            var motevalian_series_data = data.mapAs({ x: 0, value: 1 });



            // create a chart
            let chart = anychart.column();

            chart
                .animation(true)
                .padding([10, 60, 10, 0])



            // x axix labels font setting
            let xAxisLabels = chart.xAxis().labels();
            xAxisLabels.fontFamily("vazir");


            let yAxisLabels = chart.yAxis().labels();
            yAxisLabels.fontFamily("vazir");

            // Not allow labels overlapping
            let xAxis = chart.xAxis();
            xAxis.overlapMode("noOverlap");

            let yAxis = chart.yAxis();
            yAxis.title("تعداد پاراگراف");
            yAxis.title().fontFamily('vazir');
yAxis.title().fontWeight("bold");
            yAxis.title().height(40);


            chart.yScale().minimum(0);
            chart.yScale().ticks().allowFractional(false);
            // tooltip content font setting
            let tooltip = chart.tooltip();
            tooltip.fontFamily("vazir");

            // tooltip title font setting
            let title = chart.tooltip().title();
            title.fontFamily("vazir");


            // set the container id
            chart.container(chart_container);

            // create the second series, set the data and name
            let salahiat_series = chart.column(salahiat_series_data);
            salahiat_series.normal().stroke("#28a745", 0);
            salahiat_series.normal().fill("#ffc107");
            salahiat_series.name("دارای صلاحیت اختیاری");


            // create the second series, set the data and name
            let hamkaran_series = chart.column(hamkaran_series_data);
            hamkaran_series.normal().stroke("#28a745", 0);
            hamkaran_series.normal().fill("#28a745");
            hamkaran_series.name("همکار");


            // create the first series, set the data and name
            let motevalian_series = chart.column(motevalian_series_data);
            // configure the visual settings of the first series
            motevalian_series.normal().fill("#007bff");
            motevalian_series.normal().stroke("#28a745", 0);
            motevalian_series.name("متولی اجرا");

            // enable the legend
            chart.legend(true);

            var legend = chart.legend();
            legend.fontFamily('vazir')


            // set position mode
            legend.positionMode("outside");
            // set the position of the legend
            legend.position("top");
            // set the alignment of the legend
            legend.align("center");

            legend.itemsLayout("horizontalExpandable");
            // initiate drawing the chart
            chart.draw();
            chart.listen("mouseOver", function(e){
              document.body.style.cursor = "pointer";
            });
            chart.listen("mouseOut", function(e){
              document.body.style.cursor = "auto";
            });

            // motevalian columns
            motevalian_series.listen('click', async function (e) {
                const click_tag = e.domTarget.tag;
                const column_index = click_tag["index"]
                const actor_name = chart_data[column_index][0];
                const actor_role_name = 'متولی اجرا';
                showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text)

            });

            // hamkaran columns
            hamkaran_series.listen('click', function (e) {
                const click_tag = e.domTarget.tag;
                const column_index = click_tag["index"]
                const actor_name = chart_data[column_index][0];
                const actor_role_name = 'همکار';
                showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text)
            });

            // salahiat columns
            salahiat_series.listen('click', function (e) {
                /* Modal Headers */
                const click_tag = e.domTarget.tag;
                const column_index = click_tag["index"]
                const actor_name = chart_data[column_index][0];
                const actor_role_name = 'دارای صلاحیت اختیاری';
                showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text)
            });

        }



        async function showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text) {
            startFullPageBlockUI();
            /* Title Body */
            const title_tag = actor_name + ' (' + actor_role_name + ')'
            $('#actor_modal_header').text(title_tag);

            /* Modal Body */
            document.getElementById('actor_modal_body').innerHTML = "";

            let request_link = 'http://' + location.host + "/GetColumnParagraphsByActorRoleName_Modal/" + country_id + "/" + actor_name + "/" + actor_role_name + "/" + preprocessed_keywords_text + "/"
            let response = await fetch(request_link).then(response => response.json());
            let actor_paragraphs_result = response["actor_paragraphs_result"]

            paragraph_tag = '';
            let keywords_list = preprocessed_keywords_text.split(",")

            for (const [paragraph_id, paragraph_info] of Object.entries(actor_paragraphs_result)) {
                document_id = paragraph_info['document_id']
                document_name = paragraph_info['document_name']

                document_link = 'http://' + location.host + "/document_profile/?id=" + document_id
                doc_name = '<a class="bold text-secondary" target="_blank" href="' + document_link + '">' + document_name + "</a>"

                paragraph_text = paragraph_info['text']
                actor_form = paragraph_info['actor_form']
                is_ref_actor = paragraph_info['is_ref_actor']
                ref_text = paragraph_info['ref_text']

                highlighted_paragraph = await highlightParagraphs(paragraph_text, actor_name, actor_role_name, actor_form, keywords_list, false, is_ref_actor, ref_text)

                paragraph_tag += "<li class='mb-3 lh-lg'>" + doc_name + highlighted_paragraph + "</li>";

            }


            document.getElementById('actor_modal_body').innerHTML = '<ol start="1">' + paragraph_tag + '</ol>'
            popup_handler();
            stopFullPageBlockUI('کلیک روی نمودار')
            $("#actors_modal_btn").click();
        }

        /****************** Highlight algorithms ********************************** */

        async function highlightParagraphs(paragraph, actor_name, actor_role, paragraph_actor_form, keywords_list, all_hamkar, is_ref_actor, ref_paragraph_text) {


            paragraph_text = paragraph;

            // Highlight keywords
            if (!keywords_list.includes('empty')) {
                for (keyword of keywords_list) {
                    keyword_tag = "<span class= 'bg-info text-white  rounded px-1'>" + keyword + "</span>"
                    paragraph_text = paragraph_text.replaceAll(keyword, keyword_tag);

                }
            }


            // highlight other actors
            paragraph_text = await highlightOtherActors(paragraph_text, paragraph_actor_form, actor_name)



            if (actor_role.includes('متولی اجرا')) {

                paragraph_text = await highlightMotevalian(paragraph_text, paragraph_actor_form, motevali_keywords, 'bg-primary', is_ref_actor, ref_paragraph_text)
                paragraph_text = await highlightLegalDeadline(paragraph_text, motevali_keywords)

            } else if (actor_role.includes('همکار')) {
                paragraph_text = await highlightHamkaran(paragraph_text, paragraph_actor_form, hamkaran_keywords, 'bg-success');

            } else {
                paragraph_text = await highlightSalahiat(paragraph_text, paragraph_actor_form, salahiat_keywords, 'bg-warning', is_ref_actor, ref_paragraph_text)

            }






            /********************* Highlight optional keywords  **************************/
            for (pattern_keyword of optional_keywords) {

                if (optional_after_terms_count[pattern_keyword] > 0)
                    paragraph_text = await highlightSomeTermsAfterKeyword(paragraph_text, optional_after_terms_count[pattern_keyword], pattern_keyword)

                pattern_keyword_tag = "<span class='border border-secondary border-2  px-1 rounded'>" + pattern_keyword + "</span>"
                paragraph_text = paragraph_text.replaceAll(pattern_keyword, pattern_keyword_tag)

            }

            return paragraph_text
        }


        async function highlightMotevalian(paragraph_text, actor_form, pattern_keywords, bg_color, is_ref_actor, ref_paragraph_text) {


            for (pattern_keyword of pattern_keywords) {

                /* Highlight with actors list */
                let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"

                actor_with_postfix_1 = actor_form + ' ' + 'جمهوری اسلامی ایران'
                actor_with_postfix_2 = actor_form + ' ' + 'ایران'
                actor_with_postfix_3 = actor_form + ' ' + 'کشور'

                paragraph_text = paragraph_text.split('.').map((sentence) => {


                    if (sentence.includes(actor_form + ' ' + pattern_keyword)) {

                        if (is_ref_actor) {

                            popover_title = actor_form;
                            popover_content = ref_paragraph_text;
                            actor_tag = '<a dir="rtl" tabindex="0" class="d-inline-block ' + bg_color.replace('bg', 'text') + ' text-right bold"  data-bs-placement="bottom" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="' + popover_title + '" data-bs-content="' + popover_content + '">' + popover_title + '</a>'
                            sentence = sentence.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);

                        } else {

                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                            sentence = sentence.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);

                        }

                    }
                    else if (sentence.includes(actor_with_postfix_1 + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_1 + "</span>"
                        sentence = sentence.replaceAll(actor_with_postfix_1 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes(actor_with_postfix_2 + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_2 + "</span>"
                        sentence = sentence.replaceAll(actor_with_postfix_2 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes(actor_with_postfix_3 + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_3 + "</span>"
                        sentence = sentence.replaceAll(actor_with_postfix_3 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes('(' + actor_form + ')' + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_form + ')' + "</span>"
                        sentence = sentence.replaceAll('(' + actor_form + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes('(' + actor_with_postfix_1 + ')' + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_1 + ')' + "</span>"
                        sentence = sentence.replaceAll('(' + actor_with_postfix_1 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes('(' + actor_with_postfix_2 + ')' + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_2 + ')' + "</span>"
                        sentence = sentence.replaceAll('(' + actor_with_postfix_2 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes('(' + actor_with_postfix_3 + ')' + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_3 + ')' + "</span>"
                        sentence = sentence.replaceAll('(' + actor_with_postfix_3 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }

                    return sentence
                }).join('.')

            }



            /* Highlight with actors list */
            eghdam_keywords = ['اقدام کند', 'اقدام‌کند', 'اقدام نماید', 'اقدام‌نماید']
            non_eghdam_keywords = pattern_keywords.filter(x => !eghdam_keywords.includes(x));

            paragraph_text = paragraph_text.split('.').map((sentence) => {

                for (e_kw of eghdam_keywords) {

                    pattern_keyword_tag1 = "<span class='bg-secondary text-white rounded px-1'>" + e_kw + "</span>"

                    if (sentence.includes(e_kw) && !check_non_eghdam_kw_exists(sentence, non_eghdam_keywords)) {

                        actor_tag1 = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                        sentence = sentence.replaceAll(actor_form + ' ', actor_tag1 + ' ');

                        sentence = sentence.replaceAll(e_kw, pattern_keyword_tag1);


                    }

                }

                return sentence
            }).join('.')




            return paragraph_text;


        }


        function check_non_eghdam_kw_exists(sentence, pattern_keywords) {
            for (p_kw of pattern_keywords) {
                pattern = p_kw
                if (sentence.includes(pattern)) {
                    return true;
                }
            }
            return false;

        }


        async function highlightHamkaran(paragraph_text, actor_form, pattern_keywords, bg_color) {
            const window_length = 100;

            let space_counter = 0;
            detected_hamkaran_list = []


            /* Highlight pattern keywords and references */
            for (pattern_keyword of pattern_keywords) {


                /* Highlight more with actors list */
                let regex = '', result, indices = [];

                if (pattern_keyword == 'با همکاری') {
                    regex = /با همکاری/gi;
                } else {
                    regex = /باهمکاری/gi;
                }

                while ((result = regex.exec(paragraph_text))) {
                    indices.push(result.index);
                }

                for (const index of indices) {

                    let start_index = (index + pattern_keyword.length);
                    let substring = paragraph_text.substring(start_index, start_index + window_length);
                    let current_substring = substring;


                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                    // substring = substring.replaceAll(' ' + actor_form + ' ', ' ' + actor_tag + ' ');
                    substring = substring.replaceAll(' ' + actor_form, ' ' + actor_tag);
                    substring = substring.replaceAll('(' + actor_form + ')', '(' + actor_tag + ')');

                    for (symbol of hamkaran_punctuations) {

                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                        substring = substring.replaceAll(' ' + actor_form + symbol, ' ' + actor_tag + symbol);

                    }

                    actor_without_affix = actor_form.replaceAll('وزارت ', '').replaceAll('سازمان ', '').replaceAll(' جمهوری اسلامی ایران', '')

                    if (actor_without_affix != 'اطلاعات' && actor_without_affix != 'کشور' && !substring.includes(actor_form)) {


                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                        substring = substring.replaceAll(' ' + actor_without_affix + ' ', ' ' + actor_tag + ' ');
                        substring = substring.replaceAll('(' + actor_without_affix + ')', '(' + actor_tag + ')');

                        for (symbol of hamkaran_punctuations) {


                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                            substring = substring.replaceAll(' ' + actor_without_affix + symbol, ' ' + actor_tag + symbol);

                        }

                    }



                    paragraph_text = paragraph_text.replaceAll(current_substring, substring);

                }
                /* Highlight with actors list */
                let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"

                paragraph_text = paragraph_text.replaceAll(pattern_keyword, pattern_keyword_tag);

            }




            return paragraph_text;



        }

        async function highlightSalahiat(paragraph_text, actor_form, pattern_keywords, bg_color, is_ref_actor, ref_paragraph_text) {


            for (pattern_keyword of pattern_keywords) {

                /* Highlight with actors list */
                let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"

                actor_with_postfix_1 = actor_form + ' ' + 'جمهوری اسلامی ایران'
                actor_with_postfix_2 = actor_form + ' ' + 'ایران'
                actor_with_postfix_3 = actor_form + ' ' + 'کشور'

                paragraph_text = paragraph_text.split('.').map((sentence) => {


                    if (sentence.includes(actor_form + ' ' + pattern_keyword)) {

                        if (is_ref_actor) {

                            popover_title = actor_form;
                            popover_content = ref_paragraph_text;
                            actor_tag = '<a dir="rtl" tabindex="0" class="d-inline-block ' + bg_color.replace('bg', 'text') + ' text-right bold"  data-bs-placement="bottom" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="' + popover_title + '" data-bs-content="' + popover_content + '">' + popover_title + '</a>'
                            sentence = sentence.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);


                        } else {

                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                            sentence = sentence.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);

                        }

                    }
                    else if (sentence.includes(actor_with_postfix_1 + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_1 + "</span>"
                        sentence = sentence.replaceAll(actor_with_postfix_1 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes(actor_with_postfix_2 + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_2 + "</span>"
                        sentence = sentence.replaceAll(actor_with_postfix_2 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes(actor_with_postfix_3 + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_3 + "</span>"
                        sentence = sentence.replaceAll(actor_with_postfix_3 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes('(' + actor_form + ')' + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_form + ')' + "</span>"
                        sentence = sentence.replaceAll('(' + actor_form + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes('(' + actor_with_postfix_1 + ')' + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_1 + ')' + "</span>"
                        sentence = sentence.replaceAll('(' + actor_with_postfix_1 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes('(' + actor_with_postfix_2 + ')' + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_2 + ')' + "</span>"
                        sentence = sentence.replaceAll('(' + actor_with_postfix_2 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes('(' + actor_with_postfix_3 + ')' + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_3 + ')' + "</span>"
                        sentence = sentence.replaceAll('(' + actor_with_postfix_3 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }

                    return sentence
                }).join('.')

            }



            return paragraph_text;

        }


        /* Highlight N terms after one keyword */
        async function highlightSomeTermsAfterKeyword(paragraph_text, terms_count, keyword) {
            paragraph_selected_terms = '';
            selected_terms_list = []
            let indices = await getIndicesOf(keyword, paragraph_text);

            for (index of indices) {

                let pattern_keyword_index = index;
                let start_index = pattern_keyword_index + keyword.length + 1
                let end_index = paragraph_text.length;
                let selected_terms_size = 0

                if (pattern_keyword_index != -1) {
                    sub_string = paragraph_text.substring(start_index, end_index)

                    selected_terms = sub_string.split(' ').slice(0, terms_count)

                    for (term of selected_terms) {
                        selected_terms_size += term.length
                    }
                    selected_terms_size += (terms_count - 1)

                    selected_terms_text = paragraph_text.substring(start_index, start_index + selected_terms_size);

                    if (!selected_terms_text.includes('span')) {
                        if (!selected_terms_list.includes(selected_terms_text)) {
                            selected_terms_list.push(selected_terms_text)
                        }

                    }


                }


            }

            for (selected_terms_text of selected_terms_list) {
                if (selected_terms_text != "") {
                    selected_terms_tag = "<span class='blue_dotted_border selected_terms px-1 mx-1'>" + selected_terms_text + "</span>"
                    paragraph_text = paragraph_text.replaceAll(selected_terms_text, selected_terms_tag)
                }

            }

            return paragraph_text;
        }

        async function highlightLegalDeadline(paragraph_text, actor_pattern_keywords) {

            for (pattern_keyword of actor_pattern_keywords) {

                let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"


                let indices = await getIndicesOf(pattern_keyword_tag, paragraph_text);

                for (index of indices) {
                    start_index = index + pattern_keyword_tag.length;

                    sub_string = paragraph_text.substring(start_index, paragraph_text.length);

                    for (deadline_keyword of deadline_pattern_keywords) {
                        for (const [nubmer_text, value] of Object.entries(numbers_dict)) {
                            for (time_category of time_categories) {

                                // ظرف شش ماه
                                pattern1 = deadline_keyword + ' ' + nubmer_text + ' ' + time_category;
                                pattern2 = deadline_keyword + ' ' + nubmer_text + ' ' + '(' + value + ')' + ' ' + time_category;

                                // ظرف شش‌ماه
                                pattern3 = deadline_keyword + ' ' + nubmer_text + '‌' + time_category;
                                pattern4 = deadline_keyword + ' ' + nubmer_text + ' ' + '(' + value + ')' + '‌' + time_category;

                                // ظرف یکسال
                                pattern5 = deadline_keyword + ' ' + nubmer_text + time_category;
                                pattern6 = deadline_keyword + ' ' + nubmer_text + ' ' + '(' + value + ')' + time_category;

                                patterns = [pattern1, pattern2, pattern3,
                                    pattern4, pattern5, pattern6];

                                for (pattern of patterns) {
                                    deadline_keyword_tag = "<span class='deadlines gray_dotted_border px-1 rounded'>" + deadline_keyword + "</span>"
                                    pattern_without_deadline_keyword = pattern.replace(deadline_keyword + ' ', '');
                                    pattern_without_keyword_tag = "<span class='deadlines border border-warning border-2 px-1 rounded'>" + pattern_without_deadline_keyword + "</span>"
                                    new_sub_string = sub_string.replaceAll(pattern, deadline_keyword_tag + ' ' + pattern_without_keyword_tag)

                                    // closest deadline..not all deadlines. => replace()
                                    paragraph_text = paragraph_text.replace(sub_string, new_sub_string);

                                }

                                /* *********************************** */

                            }
                        }
                    }


                }

            }
            return paragraph_text;

        }

        async function getIndicesOf(searchStr, str) {
            var searchStrLen = searchStr.length;
            if (searchStrLen == 0) {
                return [];
            }
            var startIndex = 0, index, indices = [];
            while ((index = str.indexOf(searchStr, startIndex)) > -1) {
                indices.push(index);
                startIndex = index + searchStrLen;
            }
            return indices;
        }

        async function highlightOtherActors(paragraph_text, paragraph_actor_form, paragraph_actor_name) {
            para_actor_forms = []
            for (const [actor_id, actor_info] of Object.entries(actors_dict)) {
                if (actor_info['name'] == paragraph_actor_name) {
                    para_actor_forms = actor_info['forms'];
                    break;
                }
            }

            for (actor_form of actors_list) {
                if (!para_actor_forms.includes(actor_form)) {
                    actor_form_tag = "<span class='other_actors'>" + actor_form + "</span>"
                    paragraph_text = paragraph_text.replaceAll(' ' + actor_form + ' ', ' ' + actor_form_tag + ' ');
                    paragraph_text = paragraph_text.replaceAll(' ' + actor_form + '،', ' ' + actor_form_tag + '،');
                    paragraph_text = paragraph_text.replaceAll('(' + actor_form + ')', '(' + actor_form_tag + ')');
                }

            }

            return paragraph_text;
        }

        async function showOtherActors() {
            if ($('.highlighted').length) {
                $('.highlighted').attr('class', 'other_actors')
            } else {
                $('.other_actors').attr('class', 'other_actors highlighted bold text-primary px-1 rounded')
            }

        }

        /* *********************************************************************** */

        async function showHighlightedParagraphs_Details(document_id, document_name, paragraphs_list) {
            /* Title Text */
            const link = 'http://' + location.host + "/document_profile/?id=" + document_id
            let title_tag = "<a target='blank' href='" + link + "'>" + document_name + "</a>"
            document.getElementById("ModalHeader").innerHTML = title_tag

            document.getElementById("DetailText").innerHTML = ""
            for (let paragraph of paragraphs_list) {

                tag = "<li class='mb-3'>" + paragraph + "</li>"
                document.getElementById("DetailText").innerHTML += tag;
            }
            document.getElementById("DetailText").innerHTML = "<ul>" + document.getElementById("DetailText").innerHTML + "</ul>"
        }

        async function DetailFunction(document_id) {
            startFullPageBlockUI();
    
            console.log('hello')
            document.getElementById("ModalHeader").innerHTML = "";
            document.getElementById("DetailText").innerHTML = ""
    
            let request_link = 'http://' + location.host + "/GetDocumentWithAreaKeywords/" + document_id + "/";
    
            let response = await fetch(request_link).then(response => response.json());
    
            /*  Show detail Result */
            let document_paragraphs_result = response["result_paragraph"];
            let document_name = response["doc_name"];
            console.log(document_name)
            await showDetailsModal(document_id, document_name, document_paragraphs_result);
            stopFullPageBlockUI("جزئیات سند");
        }
    
    
        async function showDetailsModal(document_id, document_name, paragraphs_list) {
            /* Title Text */
            const link = 'http://' + location.host + "/document_profile/?id=" + document_id;
            document.getElementById("ModalHeader").innerHTML = "<a target='to_blank' href='" + link + "'>" + document_name + "</a>";
    
            /* Body Text */
            document.getElementById("DetailText").innerHTML = ""
            result_tag = ''
    
            for (para of paragraphs_list){
                result_tag += '<li class="lh-lg">' + para + '</li>'
            }
    
            document.getElementById("DetailText").innerHTML = "<ul>" + result_tag + "</ul>"
    
        }

        function NodeSelection(node_id) {
            data_graph.nodes.forEach((node) => {
                let item = graph_object.findById(node["id"])
                if (node["id"] === node_id) {
                    graph_object.setItemState(item, 'selected', true);
                }
                else {
                    graph_object.setItemState(item, 'selected', false);
                }
            })
    
            graph_object.getEdges().forEach((edge) => {
                graph_object.setItemState(edge, 'selected', false);
    
            });
    
            let item = graph_object.findById(node_id)._cfg.model
            const degree = graph_object.getNodeDegree(node_id, 'total');
            const nodeSelection = "NodeSelection('" + node_id + "')"
            const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" onclick="' + nodeSelection + '" data-bs-target="#detailModal">انتخاب</button>'
    
            nodes_data = [{ id: 1, name: item["name"], degree: degree, type_name: item.type_name, node_selection: detail }]
            $('#selected_node_table').empty();
            $('#selected_node_table').footable({
                "paging": {
                    "enabled": true,
                    strings: {
                        first: '»',
                        prev: '›',
                        next: '‹',
                        last: '«'
                    }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "گره ای انتخاب نشده است",
                "columns": [{
                    "name": "id",
                    "title": "ردیف",
                    "breakpoints": "xs sm",
                    "type": "number",
                    "style": {
                        "width": "5%"
                    }
                }, {
                    "name": "name",
                    "title": "نام گره",
                    "style": {
                        "width": "60%"
                    }
                }, {
                    "name": "degree",
                    "title": "درجه",
                    "style": {
                        "width": "10%"
                    }
                }, {
                    "name": "type_name",
                    "title": "نوع گره",
                    "style": {
                        "width": "15%"
                    }
                }, {
                    "name": "node_selection",
                    "title": "انتخاب",
                    "style": {
                        "width": "10%"
                    }
                }
                ],
                "rows": nodes_data
            });
    
            $('#selected_edge_table').empty();
            $('#selected_edge_table').footable({
                "paging": {
                    "enabled": true,
                    strings: {
                        first: '»',
                        prev: '›',
                        next: '‹',
                        last: '«'
                    }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "یالی انتخاب نشده است",
                "columns": [{
                    "name": "id",
                    "title": "ردیف",
                    "breakpoints": "xs sm",
                    "type": "number",
                    "style": {
                        "width": "5%"
                    }
                }, {
                    "name": "src_name",
                    "title": "مبدا",
                    "style": {
                        "width": "40%"
                    }
                }, {
                    "name": "target_name",
                    "title": "مقصد",
                    "style": {
                        "width": "40%"
                    }
                }, {
                    "name": "weight",
                    "title": "وزن",
                    "style": {
                        "width": "15%"
                    }
                },
                ],
                "rows": []
            });
    
        }

        function ShowRangeSlider(min, max) {
            document.getElementById("RangeSlider").style.visibility = "visible"
    
            $('#RangeSlider #slider-range').slider({
                range: true,
                min: min,
                max: max,
                step: 1,
                values: [min, max]
            });
    
            // Move the range wrapper into the generated divs
            $('#RangeSlider .ui-slider-range').append($('#RangeSlider .range-wrapper'));
    
            console.log($('#RangeSlider #slider-range'))
            // Apply initial values to the range container
            $('#RangeSlider .range').html(
                '<span class="range-value"><sup></sup>' +
                $('#RangeSlider #slider-range').slider("values", 0).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") +
                '</span><span class="range-divider"></span><span class="range-value"><sup></sup>' +
                $("#RangeSlider #slider-range").slider("values", 1).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") + '</span>');
    
            // Show the gears on press of the handles
            $('#RangeSlider .ui-slider-handle, #RangeSlider .ui-slider-range').on('mousedown', function () {
                $('.gear-large').addClass('active');
            });
    
    
            $('#RangeSlider #slider-range').slider({
                slide: function (event, ui) {
                    $('#RangeSlider .range').html(
                        '<span class="range-value"><sup></sup>' +
                        ui.values[0].toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") +
                        '</span><span class="range-divider"></span><span class="range-value"><sup></sup>' +
                        ui.values[1].toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") + '</span>');
    
                    // Get old value
                    var previousVal = parseInt($(this).data('value'));
    
                    min_selected_degree = ui.values[0]
                    max_selected_degree = ui.values[1]
    
                    FilterGraphDegreeWeight()
    
                    // Save new value
                    $(this).data({
                        'value': parseInt(ui.value)
                    });
                }
            });
    
            $("#RangeSlider .ui-slider-handle").parent().css('z-index', 0);
    
        }
    
        function ShowWeightSlider(min, max) {
    
            document.getElementById("WeightSlider").style.visibility = "visible"
    
            $('#WeightSlider #slider-range').slider({
                range: true,
                min: min,
                max: max,
                step: 1,
                values: [min, max]
            });
    
            // Move the range wrapper into the generated divs
            $('#WeightSlider .ui-slider-range').append($('#WeightSlider .range-wrapper'));
    
            // Apply initial values to the range container
            $('#WeightSlider .range').html(
                '<span class="range-value"><sup></sup>' +
                $('#WeightSlider #slider-range').slider("values", 0).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") +
                '</span><span class="range-divider"></span><span class="range-value"><sup></sup>' +
                $("#WeightSlider #slider-range").slider("values", 1).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") + '</span>');
    
            // Show the gears on press of the handles
            $('#WeightSlider .ui-slider-handle, #WeightSlider .ui-slider-range').on('mousedown', function () {
                $('.gear-large').addClass('active');
            });
    
            $('#WeightSlider #slider-range').slider({
                slide: function (event, ui) {
                    $('#WeightSlider .range').html(
                        '<span class="range-value"><sup></sup>' +
                        ui.values[0].toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") +
                        '</span><span class="range-divider"></span><span class="range-value"><sup></sup>' +
                        ui.values[1].toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") + '</span>');
    
                    // Get old value
                    var previousVal = parseInt($(this).data('value'));
    
                    min_selected_weight = ui.values[0]
                    max_selected_weight = ui.values[1]
    
                    FilterGraphDegreeWeight()
    
                    // Save new value
                    $(this).data({
                        'value': parseInt(ui.value)
                    });
                }
            });
    
            $("#WeightSlider .ui-slider-handle").parent().css('z-index', 0);
    
        }
    
        function FilterGraphDegreeWeight() {
            graph_object.getEdges().forEach((edge) => { edge.show() })
            graph_object.getNodes().forEach((node) => { node.show() })
    
            const min_degree = min_selected_degree
            const max_degree = max_selected_degree
    
            const min_weight = min_selected_weight
            const max_weight = max_selected_weight
    
            graph_object.getEdges().forEach((edge) => {
                const edge_item = edge._cfg.model
                const edge_weight = edge_item.weight
                if (edge_weight < min_weight || edge_weight > max_weight) {
                    edge.hide()
                }
                else {
                    const source_node_degree = graph_object.getNodeDegree(edge_item.source, 'total');
                    const target_node_degree = graph_object.getNodeDegree(edge_item.target, 'total');
    
                    if (source_node_degree < min_degree || source_node_degree > max_degree) {
                        graph_object.findById(edge_item.source).hide();
                        graph_object.getEdges().forEach((edge_temp) => {
                            if (edge_temp._cfg.model.source === edge_item.source || edge_temp._cfg.model.target === edge_item.source) {
                                edge_temp.hide()
                            }
                        })
                    }
                    if (target_node_degree < min_degree || target_node_degree > max_degree) {
                        graph_object.findById(edge_item.target).hide();
                        graph_object.getEdges().forEach((edge_temp) => {
                            if (edge_temp._cfg.model.source === edge_item.target || edge_temp._cfg.model.target === edge_item.target) {
                                edge_temp.hide()
                            }
                        })
                    }
                }
            })
    
            graph_object.getNodes().forEach((node) => {
                const node_degree = graph_object.getNodeDegree(node._cfg.model.id, 'total');
                if (node_degree < min_degree || node_degree > max_degree) {
                    graph_object.findById(node._cfg.model.id).hide();
                }
            });
    
        }
    
        const { louvain } = G6.Algorithm;
        function ChangeLayout() {
            layout = document.getElementById("ChangeLayout").value
            la = { type: layout }
            graph_object.updateLayout(la);
        }
    
        function onlyUnique(value, index, self) {
            return self.indexOf(value) === index;
        }
    
        function SelectNeighbourhood() {
            const selected_node_list = []
            let selected_nodes = []
            let selected_edges = []
    
            graph_object.cfg.states.selected.forEach((item) => {
                const item_cfg = item._cfg
                if (item_cfg.type === "node") {
                    selected_node_list.push(item_cfg.model.id)
                    selected_nodes.push(item)
                }
                else {
                    selected_edges.push(item)
                }
    
            })
    
            graph_object.getEdges().forEach((edge) => {
    
                if (edge.get('visible') === true) {
                    const source_id = edge._cfg.model.source
                    const target_id = edge._cfg.model.target
    
                    if (selected_node_list.includes(source_id)) {
                        graph_object.setItemState(edge, 'selected', true);
                        graph_object.setItemState(graph_object.findById(target_id), 'selected', true);
                        selected_nodes.push(graph_object.findById(target_id))
                        selected_edges.push(edge)
                    }
                    else if (selected_node_list.includes(target_id)) {
                        graph_object.setItemState(edge, 'selected', true);
                        graph_object.setItemState(graph_object.findById(source_id), 'selected', true);
                        selected_nodes.push(graph_object.findById(source_id))
                        selected_edges.push(edge)
                    }
                }
            });
    
            let nodes_data = []
            let id = 1
            for (const node of selected_nodes.filter(onlyUnique)) {
                const node_object = node._cfg.model
                const node_id = node_object.id
                const node_name = node_object.name
    
                const degree = graph_object.getNodeDegree(node_object.id, 'total');
    
                const doc_link = 'http://' + location.host + '/document_profile/?id=' + node_id.toString()
                const doc_tag = '<a class="document_link" target="_blank" href="' + doc_link + '">' + node_name + "</a>"
    
                const nodeSelection = "NodeSelection('" + node_id + "')"
                const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" onclick="' + nodeSelection + '" data-bs-target="#detailModal">انتخاب</button>'
    
    
                nodes_data.push({ id: id, name: doc_tag, degree: degree, type_name: node_object.type_name, node_selection: detail })
                id = id + 1
            }
            $('#selected_node_table').empty();
            $('#selected_node_table').footable({
                "paging": {
                    "enabled": true,
                    strings: {
                        first: '»',
                        prev: '›',
                        next: '‹',
                        last: '«'
                    }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "گره ای انتخاب نشده است",
                "columns": [{
                    "name": "id",
                    "title": "ردیف",
                    "breakpoints": "xs sm",
                    "type": "number",
                    "style": {
                        "width": "5%"
                    }
                }, {
                    "name": "name",
                    "title": "نام گره",
                    "style": {
                        "width": "60%"
                    }
                }, {
                    "name": "degree",
                    "title": "درجه",
                    "style": {
                        "width": "10%"
                    }
                }, {
                    "name": "type_name",
                    "title": "نوع گره",
                    "style": {
                        "width": "15%"
                    }
                }, {
                    "name": "node_selection",
                    "title": "انتخاب",
                    "style": {
                        "width": "10%"
                    }
                }
                ],
                "rows": nodes_data
            });
    
    
            let edges_data = []
            id = 1
            for (const edge of selected_edges.filter(onlyUnique)) {
                const edge_object = edge._cfg.model
    
                const src_node_id = edge_object.source
                const src_node_name = edge_object.source_name
                const source_doc_link = 'http://' + location.host + '/document_profile/?id=' + src_node_id.toString()
                const source_doc_tag = '<a class="document_link" target="_blank" href="' + source_doc_link + '">' + src_node_name + "</a>"
    
                const target_node_id = edge_object.target
                const target_node_name = edge_object.target_name
                const target_doc_link = 'http://' + location.host + '/document_profile/?id=' + target_node_id.toString()
                const target_doc_tag = '<a class="document_link" target="_blank" href="' + target_doc_link + '">' + target_node_name + "</a>"
    
                const weight = edge_object.weight
    
                edges_data.push({ id: id, src_name: source_doc_tag, target_name: target_doc_tag, weight: weight })
                id = id + 1
            }
            $('#selected_edge_table').empty();
            $('#selected_edge_table').footable({
                "paging": {
                    "enabled": true,
                    strings: {
                        first: '»',
                        prev: '›',
                        next: '‹',
                        last: '«'
                    }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "یالی انتخاب نشده است",
                "columns": [{
                    "name": "id",
                    "title": "ردیف",
                    "breakpoints": "xs sm",
                    "type": "number",
                    "style": {
                        "width": "5%"
                    }
                }, {
                    "name": "src_name",
                    "title": "مبدا",
                    "style": {
                        "width": "40%"
                    }
                }, {
                    "name": "target_name",
                    "title": "مقصد",
                    "style": {
                        "width": "40%"
                    }
                }, {
                    "name": "weight",
                    "title": "وزن",
                    "style": {
                        "width": "15%"
                    }
                },
                ],
                "rows": edges_data
            });
    
        }
    
        function ShowHideNode()
        {
            const img_tag_id = "ShowHideImg"

            if (show_hide_state === "show")
            {
                document.getElementById(img_tag_id).src = "../../static/image/show_nodes.png"
                show_hide_state = "hide"
                checked_Nodes = []
                graph_object.getEdges().forEach((edge) => {
                    const edge_object = edge._cfg.model
                    const source_object = graph_object.findById(edge_object.source)
                    const target_object = graph_object.findById(edge_object.target)
                    if (source_object._cfg.states.includes('selected') === false)
                    {
                        source_object.hide()
                    }
                    if (target_object._cfg.states.includes('selected') === false)
                    {
                        target_object.hide()
                    }
                    if (edge._cfg.states.includes('selected') === false)
                    {
                        console.log(2)
                        edge.hide()
                    }
                    checked_Nodes.push(edge_object.source)
                    checked_Nodes.push(edge_object.target)
                });

                graph_object.getNodes().forEach((node) => {
                    if(checked_Nodes.includes(node._cfg.model.id) === false &&
                    node._cfg.states.includes('selected') === false)
                    {
                        node.hide()
                    }
                })
            }
            else if (show_hide_state === "hide")
            {
                document.getElementById(img_tag_id).src = "../../static/image/hide_nodes.png"
                show_hide_state = "show"

                FilterGraphDegreeWeight()

            }

        }

        async function FilterGraphSubArea() {

            let selected_type = await GetMultiSelectValue('SubjectSubAreaSelect');
    
            selected_type = selected_type.split("__")
    
            data_graph.nodes.forEach((node) => {
                node_id = node["id"].toString()
                node_type_id = node["sub_area"]
    
                let all_type_condition = selected_type.includes(node_type_id.toString()) || selected_type.includes("0")
    
                if (all_type_condition === false) {
    
                    data_graph.nodes = $.grep(data_graph.nodes, function (n, i) {
                        return n["id"] !== node_id;
                    });
    
                    data_graph.edges = $.grep(data_graph.edges, function (n, i) {
                        return n["source"] !== node_id || n["target"] !== node_id;
                    });
                }
            })
    
            data_graph.nodes.forEach((node) => {
                function getNodeData(node_id) {
                    return data_graph.edges.filter(
                        function (data) { return data.source === node_id || data.target === node_id }
                    );
                }
    
                // console.log(getNodeData(node["id"]).length, node["id"])
    
                if (getNodeData(node["id"]).length === 0) {
                    data_graph.nodes = $.grep(data_graph.nodes, function (n, i) {
                        if (n["id"] === node["id"])
                            // console.log(n["id"], node["id"])
                        return n["id"] !== node["id"];
                    });
                }
            })
    
    
        }

        async function GetMultiSelectValue(container_id) {
            let e = document.getElementById(container_id);
            let selected = [...e.options]
                .filter(option => option.selected)
                .map(option => option.value)
            return selected.join("__")
        }
        
        async function SpinnerModeFunction(mode) {
            if (mode === "Active") {
                $(".spinner-border").addClass("active");
            } else if (mode === "Disable") {
                $(".spinner-border").removeClass("active");
            }
        }
    </script>
    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>
    <script>

        async function downloadFiles(file_name_list, save_file_name) {
            startFullPageBlockUI()
            const country_id = document.getElementById('country').value
            let zip = new JSZip()

            const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["country_information"][0]
            const country_folder = response["folder"];
            const country_name = response["name"];

            save_file_name += " مجموعه سند {" + country_name + "}"


            let extension = ".txt"
            if (country_name.includes("فاوا")) {
                extension = '.docx';
            }

            for (const document of file_name_list) {
                const document_name = document["_source"]["name"] + extension
                const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

                await fetch(path)
                    .then(res => res.arrayBuffer())
                    .then(value => {
                        zip.file(document_name, value);
                    })
            }
            zip.generateAsync({
                type: "blob"
            })
                .then(function (content) {
                    // see FileSaver.js
                    saveAs(content, save_file_name + ".zip");
                });
            stopFullPageBlockUI('دانلود اسناد');
        }


        async function DownloadSerachResultFunction() {

            const save_file_name = "نتیجه جستجو {" + document.getElementById("SearchBox").value + "}"
            downloadFiles(SearchResultValue, save_file_name)
        }

        async function ExportExcelSerachResultFunction() {
            var selected_columns = []
            selected_columns = find_selected_column(selected_columns)
            main_columns = ['نام سند']
            rows = ['name']
            for (const column in COLUMNS) {
                if (selected_columns.includes(column) || selected_columns.includes('all')) {
                    main_columns.push(COLUMNS[column])
                    rows.push(column)
                }
            }
    
            var csv = "";
            sep = ","

            let Csv = ""
            for (const column of main_columns) {
                Csv += column + sep
            }
            Csv += "\n"
            for (const document of SearchResultValue) {
                for (const row of rows) {
                    Csv += document["_source"][row] + sep
                }
                Csv += "\n"
            }

            let save_file_name = "نتیجه جستجو {" + document.getElementById("SearchBox").value + "}"
            save_file_name += " مجموعه سند {" + document.getElementById("country").innerText + "}"

            let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
            var link = document.createElement("a");
            link.setAttribute("href", csvContent);
            link.setAttribute("download", save_file_name + ".csv");
            document.body.appendChild(link);
            link.click()
        }


        async function createKeywordsGraphData(keywords_information_result) {

            nodes = []
            edges = []
            chart_data = []

            for (const [keyword, documents_list] of Object.entries(keywords_information_result)) {

                if (documents_list.length > 1) {
                    common_keyword_node = {
                        'id': keyword, 'name': keyword, 'fill': {
                            'src': "../../static/icons/question1.png"
                        }, 'group': 'common_keyword'
                    }
                    nodes.push(common_keyword_node);
                } else {
                    keyword_node = { 'id': keyword, 'name': keyword, 'group': 'keyword' };
                    nodes.push(keyword_node);
                }

                for (doc_info of documents_list) {
                    const document_id = doc_info["id"]
                    const document_name = doc_info["name"]
                    const document_link = 'http://' + location.host + "/document_profile/?id=" + document_id
                    const doc_name = '<a target="_blank" href="' + document_link + '">' + document_name + "</a>"

                    document_node = {
                        'id': document_id, 'name': document_name, 'fill': {
                            'src': "../../static/icons/docs.png"
                        }, 'group': 'document'
                    }
                    nodes.push(document_node);

                    edge = {
                        'id': document_id + '__' + keyword,
                        'from': document_id,
                        'to': keyword,
                        'from_name': document_name
                    };

                    edges.push(edge);
                }


            }

            chart_data = {
                'nodes': nodes,
                'edges': edges
            }


            showKeywordsGraph('definition_keywords_graph_container', chart_data)

        }



        async function showKeywordsGraph(chart_container, chart_data) {


            document.getElementById(chart_container).innerHTML = ''
            // create a chart and set the data
            var chart = anychart.graph(chart_data);

            // set the container id
            chart.container(chart_container);

            // configure labels of keywords
            let keywords = chart.group("keyword");
            let common_keywords = chart.group("common_keyword");
            let documents = chart.group("document");



            if (common_keywords != undefined) {
                common_keywords.normal().height(35);
                common_keywords.hovered().height(40);
                common_keywords.selected().height(40);
                common_keywords.normal().stroke(null);

                common_keywords.labels().enabled(true);
                common_keywords.labels().format("{%id}").fontFamily('vazir');
                common_keywords.labels().fontSize(14);
                common_keywords.labels().fontWeight(600);
            }


            if (documents != undefined) {
                documents.normal().height(35);
                documents.hovered().height(40);
                documents.selected().height(40);
                documents.normal().stroke(null);
            }

            chart.nodes().tooltip().format("{%name}");
            chart.edges().tooltip().format(" سند:  {%from_name} \n کلیدواژه:  {%to}");
            chart.edges().tooltip().fontFamily('vazir');
            chart.nodes().tooltip().fontFamily('vazir');

            // initiate drawing the chart
            chart.draw();
            chart.listen("mouseOver", function(e){
              document.body.style.cursor = "pointer";
            });
            chart.listen("mouseOut", function(e){
              document.body.style.cursor = "auto";
            });

            chart.listen('Click', async function (event) {

                const click_tag = event.domTarget.tag;
                if (click_tag["type"] === "node") {

                    // window.open('http://' + location.host + "/document_profile?id=" + click_tag["id"]);
                } else if (click_tag["type"] === "edge") {

                    edge_data = click_tag["id"].split('__');
                    doc_id = edge_data[0]
                    keyword = edge_data[1]

                    const link = 'http://' + location.host + "/GetKeywordsGeneralDefinitionByDocumentId/" + doc_id + "/" + keyword + "/";
                    response = await fetch(link).then(response => response.json());
                    response = response['keyword_information']

                    document.getElementById('EdgeModalHeader').innerText = 'کلیدواژه: ' + keyword

                    paragraph_text = response['croped_text']
                    keyword_tag = "<span class='bg-success text-white px-1 rounded'>" + keyword + "</span>: "
                    paragraph_text = paragraph_text.replaceAll(keyword + ':', keyword_tag)

                    keyword_tag = "<span class='bg-success text-white px-1 rounded'>" + keyword + "</span>: "
                    paragraph_text = paragraph_text.replaceAll(keyword + ' :', keyword_tag)


                    const document_address = 'http://' + location.host + "/document_profile/?id=" + response["doc_id"]
                    const document_link = '<a target = "to_blank" href = "' + document_address + '">' + response["doc_name"] + ':</a>'

                    doc_tag = '<h6 class="bold">' + document_link + '</h6>'
                    paragraph_tag = '<li dir="rtl" class = "text-right lh-lg">' + doc_tag + paragraph_text + '</li>'

                    document.getElementById('EdgeModalText').innerHTML = '<ol start="1"> ' + paragraph_tag + '</ol>';

                    $('#EdgeModalBtn').click();

                }

            })

        }

        /* Search after press Enter */
        $("#info_form").submit(function () { return false; });
        $("#SearchBox").keyup(function (event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                $("#document_search").click();
            }
        });



    </script>


</body>

<!-- save log user -->
<script>
    async function UserLog(form_data) {
        if (getCookie("username") !== "") {
            const user_name = getCookie("username")
            let page_url = window.location.pathname
            const user_ip = "127.0.0.0"
            page_url = page_url.slice(0, -1);
            if (page_url === "") {
                page_url = "/0";
            }


            let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                console.log("done")

            }).fail(function (res) {
                console.log("fail")
            });

        }
    }
</script>

<script>
    function TablePaginationChanged(event){

        input_id = event.target.id

        curr_page_number =  parseInt(event.target.value);
        max_page_number =  parseInt(document.getElementById(input_id).max);
        min_page_number =  parseInt(document.getElementById(input_id).min);


        if (curr_page_number > max_page_number){
            document.getElementById(input_id).value = max_page_number
        }

        else if (curr_page_number < min_page_number){
            document.getElementById(input_id).value = min_page_number
        }
            
        ShowResult();

    }
</script>

<script src="../../static/js/tooltip_handler.js"></script>

<!-- Intro Js -->
<script src="../../static/js/search/search_tour.js">
</script>
<script src="../../static/js/tour.js"></script>

<script src="../../static/js/signout_function.js"></script>





</html>