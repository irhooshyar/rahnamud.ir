<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>


    <!-- jsnetworkx -->
    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="../../static/js/jsnetworkx.js"></script>


    <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../static/js/multiselect/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../static/js/multiselect/jquery.multi-select.js"></script>


    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">
    <!-- Download Zip Files -->
    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/adaptation.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">


    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>


    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <script src="../../static/js/chart.js"></script>
    <meta charset="UTF-8">
    <title>هشداردهی</title>
    {% include "doc/title_icon.html" %}
</head>

<body>


    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#ExecutiveDropdown').addClass('active');
            $('#executive_regulations_analysis_v2').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>
    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">
        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" novalidate>
            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mt-2 mx-auto">
                <!-- Country Input -->
                <div class="col-md-6  pt-3 col-12 col-lg-2 bg-light" dir="rtl">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;" onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button id="advanced_search" type="button" class="btn float-right" data-bs-toggle="collapse"
                        data-bs-target="#advanced_fields" aria-expanded="true" aria-controls="advanced_fields">تنظیمات
                        پیشرفته</button>
                    <button type="button" id="document_search" onclick="NewSearch()"
                        class="btn d-flex float-right mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        جست‌وجو
                    </button>
                </div>
            </div>

            <div id="advanced_fields" class="collapse show row flex-row-reverse mx-auto mt-4">
                <!-- Actor Area-->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">حوزه:</label>

                    <select id="ActorAreaSelect" onchange="AreaChanged()" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                    </select>

                </div>

                <!-- Actor Sub-Area-->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> زیر حوزه:</label>

                    <select disabled id="ActorSubAreaSelect" onchange="SubAreaChanged()"
                        class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- Actor -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light ActorSelect" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">کنشگر:</label>

                    <select id="ActorSelect" class="form-select text-right float-right searchable-multi-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- search type input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> نوع سند:</label>

                    <select id="TypeSelect" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- From Year input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> سال تصویب از:</label>

                    <select id="YearFrom" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- To Year input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class="text-right bg-light float-right" style="direction: rtl;;"> سال تصویب تا:</label>

                    <select id="YearTo" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>
            </div>
        </form>

        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">نتایج جست‌وجو</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="bar_chart_info_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#bar_chart_info_pane" type="button" role="tab" aria-controls="bar_chart_info_pane"
                        aria-selected="false">داشبورد آماری</button>
                </li>

                <!-- Download Buttons -->
                <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                    class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

                </button>

                <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button>
                <!-- Result Count -->
                <p id="DocumentCount" dir="rtl" class="text-left float-left text-secondary  pl-2"></p>

            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">

                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                    aria-labelledby="search_result_tab">


                    <div class="mt-4">
                        <!-- Column Selection -->
                        <p id="ColumnSelection" class="text-left text-secondary float-right">فهرست براساس:</p>


                        <!-- Column select -->
                        <div class="col-md-6 col-12 col-lg-2 float-right" dir="rtl">

                            <select id="ColumnSelect" onchange="ShowResult();"
                                class="form-select text-right float-right searchable-multi-select"
                                style="direction: rtl;">

                            </select>

                        </div>


                        <!-- Page select -->
                        <div class="col-md-6 col-12 col-lg-2 float-left">

                            <input type="number" disabled="true" onchange="TablePaginationChanged(event)"
                                id="TablePaginationInput" min="1" max="1" value="1"
                                class="form-select text-right float-right" style="direction: rtl;">

                        </div>


                        <!-- Result Pagination -->
                        <p id="ResultPagination" class="text-left text-secondary float-left">صفحه:
                            <span id="from_page">1</span>
                            /
                            <span id="total_page">1</span>
                        </p>

                    </div>


                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                        </table>
                    </div>
                </div>

                <!-- Bar chart Info Pane -->
                <div dir="rtl" class="tab-pane fade float-right w-100" id="bar_chart_info_pane" role="tabpanel"
                aria-labelledby="bar_chart_info_tab">

                <div class="charts-list-container">
                    <div id="deadline_container" class="third"></div>
                    <div id="has_executive_container" class="third"></div>
                    <div id="year_container" class="third"></div>
                    <div id="actor_container" class="full"></div>
                </div>
            </div>
        </div>

        </div>

    </div>

    <!-- ChartModal Container -->
    <button type="button" id="ChartModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#ChartModal"></button>
    <div class="modal fade" id="ChartModal">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ChartModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ChartModalText" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->
                <div dir="rtl" class="modal-footer">
                    <button id="DownloadDocuments" class="btn btn-primary"><i class="fa fa-download"></i> دانلود
                        اسناد</button>

                    <button id="ExportExcel2" class="btn btn-primary"><i class="fa fa-download"></i> خروجی اکسل
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div class="modal fade" id="myModal">
        <div id="modal_dialog" class="modal-dialog  modal-fullscreen">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title w-100">
                        <div class="row w-100">
                            <div id="ParagraphHeader" class="col-6 float-right text-center my-auto"></div>
                            <div id="DocumentHeader" class="col-6 float-left text-center my-auto"></div>
                        </div>
                    </h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="DetailText" class="modal-body bg-light text-justify">
                    <div class="row w-100 ">
                        <div id="ParagraphDetails" class="col-6 float-right" style="overflow-y: scroll;height: 74vh;">
                        </div>
                        <div id="DocumentDetails" class="col-6 float-left" style="height: 74vh;"></div>
                    </div>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js">
    </script>

    <!-- <script src="../../static/js/executive_regulations_analysis/executive_regulations_analysis_tour.js"> -->
    </script>
</body>


<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">

<script src="../../static/js/column.js"></script>


<script>

    initialized = false
    container_id_list = ['SearchTable', 'DocumentCount']

    TABLE_INFO = []
    firstRun = true
    total_hits = 0
    curr_page = 1
    MAX_RESULT_WINDOW = 15000
    SEARCH_RESULT_SIZE = 500

    const COLUMNS = {
        "doc_approval_date": 'تاریخ تصویب',
        "clause_info": 'بند قانون',
        "actors_info": 'کنشگران مسئول',
        "deadline_date": 'مهلت نگارش آئین‌نامه',
        "deadline_status": 'وضعیت زمانی'
    }

    initSearchableSelects();
    append_column(COLUMNS)
    init()

    let SearchResultValue = []
    let multiselect_actor_value = '';

    class ResultValue{
        constructor(SearchResultValue) {
            this.SearchResultValue = SearchResultValue
        }
        getSearchResultValue(){
            return this.SearchResultValue
        }
    }

    MyResultValue = new ResultValue(SearchResultValue)

    let result_patterns = []

    {# آیین نامه اجرایی این بند #}
    regulation_forms = [
        'ایین نامه',
        'ائین نامه',
        'ایین‌نامه',
        'ائین‌نامه',

    ]

    for(form of regulation_forms){
        result_patterns.push(form + (' ' + 'اجرایی' + ' ' + 'این بند'))
    }

    {# تهیه/تدوین/... پیش نویس #}
    regulation_forms1 = [
        'پیش نویس',
        'پیشنویس',
        'پیش‌نویس',
    ]
    regulation_forms2 = [
        'تهیه و تنظیم',
        'تهیه',
        'تدوین',
        'بررسی و تصویب',
    ]
    for(let form1 of regulation_forms1)
        for (let form2 of regulation_forms2)
            result_patterns.push((form2 + ' ' + form1))


    {# پیش نویس پیشنهادی/استاندارد #}
    regulation_forms2 = [
        'پیشنهادی',
        'پیش‌نهادی',
        'پیش نهادی',
        'استاندارد',
    ]
    for(let form1 of regulation_forms1)
        for (let form2 of regulation_forms2)
            result_patterns.push((form1 + ' ' + form2))



    function clearPrevResults(container_id_list) {

        for (container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }
    }

    async function init() {
        const country_id = document.getElementById("country").value

        /****************** Type List ****************************/
            let request_link = 'http://' + location.host + "/GetTypeByCountryId/" + country_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["documents_type_list"]

            document.getElementById("TypeSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>";

            for (var i = 0; i < response.length; i++) {
                const type_id = response[i]["id"]
                const type_name = response[i]["type"]

                const tag = "<option value=" + type_id + " >" + type_name + "</option>";

                document.getElementById("TypeSelect").innerHTML += tag
            }
        /****************** ApprovalReferences List ****************************/
            request_link = 'http://' + location.host + "/GetYearsBoundByCountryId/" + country_id + "/";
            response = await fetch(request_link).then(response => response.json());
            response = response["documents_approval_list"]
            const min_year = response[0]
            const max_year = response[1]


            document.getElementById("YearFrom").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>";
            document.getElementById("YearTo").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>";

            if (max_year !== -1 && min_year !== -1) {
                for (var i = max_year; i >= min_year; i--) {
                    const tag = "<option value=" + i + " >" + i + "</option>";
                    document.getElementById("YearFrom").innerHTML += tag
                    document.getElementById("YearTo").innerHTML += tag
                }
            }
        syncAllSelectsWithResetExceptions(["country"]);

        /****************** Actors Area List ****************************/

            request_link = 'http://' + location.host + "/GetActorAreaList/";
            response = await fetch(request_link).then(response => response.json());
            response = response["ActorAreaList"]
            let options = [{ value:'0', text: 'همه' }];
            for (let i = 0; i < response.length; i++) {
                const area_id = response[i]["id"]
                const area_name = response[i]["area_name"]

                options.push( {value: area_id, text: area_name});

            }
            syncSelectOptions("ActorAreaSelect", options);
            initialized = true

        //user log
        let form_data = new FormData()
        let detail_type = "نمایش پنل"
        form_data.append('detail_type', detail_type);
        UserLog(form_data)

    }

    async function CountryChanged() {
        init()
    }

    async function AreaChanged() {

        document.getElementById("document_search").disabled = true;


        let selected_area_id = document.getElementById('ActorAreaSelect').value
        let request_link = 'http://' + location.host + "/GetSubAreasByAreaId/" + selected_area_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["SubAreaList"];


        let options = [{ value:'0', text: 'همه' }];
        for (let i = 0; i < response.length; i++) {
            const sub_area_id = response[i]["id"]
            const sub_area_name = response[i]["name"]

            options.push( {value: sub_area_id, text: sub_area_name});
        }
        syncSelectOptions("ActorSubAreaSelect", options)
        document.getElementById("document_search").disabled = false;

    }

    async function SubAreaChanged() {

        document.getElementById("document_search").disabled = true;

        let selected_area_id = document.getElementById('ActorAreaSelect').value
        let request_link = 'http://' + location.host + "/GetActorsByAreaID/" + selected_area_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["ActorsList"];
        options = [{ value: "0", text: "همه"}];

        for (let i = 0; i < response.length; i++) {
            const actor_id = response[i]["id"]
            const actor_name = response[i]["name"]

            options.push({value:actor_id, text: actor_name});

        }
        syncSelectOptions('ActorSelect', options)
        document.getElementById("document_search").disabled = false;

    }

    async function NewSearch() {
        {#await SpinnerModeFunction("Disable");#}
        firstRun = true
        await update_table_pagination_input(1, 0);
        {#console.log("here")#}
        await ShowResult()
    }

    async function ShowResult() {
        if (!initialized)
            return
        {#console.log("ran")#}
        clearPrevResults(container_id_list);
        notyf.dismissAll();
        startBlockUI('SearchTable');

        await SpinnerModeFunction("Active");
        document.getElementById('TablePaginationInput').disabled = true;


        multiselect_actor_value = await GetMultiSelectValue('ActorSelect');
        console.log(multiselect_actor_value)

        let country_id = document.getElementById("country").value;


        const country_name = $('#country option:selected').text()
        const area_id = document.getElementById("ActorAreaSelect").value;
        const type_id = document.getElementById("TypeSelect").value;
        const from_year = document.getElementById("YearFrom").value;
        const to_year = document.getElementById("YearTo").value;
        const curr_page = document.getElementById('TablePaginationInput').value



        


        request_link = 'http://' + location.host + "/GetExecutiveRegulations/" + country_id + '/' + area_id + '/' +
                         multiselect_actor_value + '/' + type_id + '/' + from_year + '/' + to_year + '/' + curr_page + '/';
        response = await fetch(request_link).then(response => response.json());


        await showDocumentInformation(response);

        await SpinnerModeFunction("Disable");

        //user log
        let form_data = new FormData()
        let detail_type = "نتایج جست و جو"
        let country_name_select = $("#country option:selected").text();
        let actor_area_name = $("#ActorAreaSelect option:selected").text();
        let actor_name = $("#ActorSelect option:selected").text();
        let type = $("#TypeSelect option:selected").text();
        let y_from = $("#YearFrom option:selected").text();
        let y_to = $("#YearTo option:selected").text();
        form_data.append('detail_type', detail_type);
        form_data.append('country_name_select', country_name_select);
        form_data.append('actor_area_name', actor_area_name);
        form_data.append('actor_name', actor_name);
        form_data.append('type', type);
        form_data.append('y_from', y_from);
        form_data.append('y_to', y_to);
        UserLog(form_data)

           
        document.getElementById('TablePaginationInput').disabled = false;
        stopBlockUI('SearchTable', 'نتایج جست‌وجو');

        if(firstRun){
            firstRun = false
            /************************* Generate chart data *********************/
            startBlockUI('bar_chart_info_pane');

            clauses_result = response['clauses_result']

            request_link = 'http://' + location.host + "/GetChartExecutiveRegulations/" + country_id + '/'+ area_id + '/' +
                             multiselect_actor_value + '/' + type_id + '/' + from_year + '/' + to_year + '/';
            response = await fetch(request_link).then(response => response.json());

            const has_executive_list = response["has_executive_list"]
            const deadline_list = response["deadline_list"]
            const actor_chart_list = response["actor_chart_list"]
            const approval_year_chart_data = response["approval_year_list"]






            showChartData(has_executive_list, "has_executive_container", clauses_result, true, 'مهلت زمانی', "مهلت زمانی")
            showChartData(actor_chart_list, "actor_container", clauses_result, true, 'کنشگر', "کنشگر")
            showChartData(approval_year_chart_data, "year_container",  clauses_result, true, 'دارای آئین‌نامه', "دارای آئین‌نامه")
            showChartData(deadline_list, "deadline_container",  clauses_result, true, 'سال تصویب',  "مهلت زمانی")

            stopBlockUI('bar_chart_info_pane', 'داشبورد آماری');
        }

        

        

    }



    async function showDocumentInformation(response) {
        total_hits = response["total_hits"]
        curr_page = response["curr_page"]
        update_table_pagination_input(curr_page, total_hits)
        table_rows = []

        clauses_result = response['clauses_result']
        doc_count = response['total_hits']


         MyResultValue.SearchResultValue = response['clauses_result']


        document.getElementById("DocumentCount").innerText =
            (doc_count).toString() + " الگو یافت شد.";

        let i = (curr_page - 1) * SEARCH_RESULT_SIZE;
        for (clause of clauses_result) {
            clause_id = clause['clause_id']
            doc_id = clause['doc_id']
            doc_name = clause['doc_name']
            doc_approval_date = clause['doc_approval_date']
            doc_found_pattern = clause['found_pattern']



            const doc_link = 'http://' + location.host + "/document_profile/?id=" + doc_id
            const doc_tag = '<a target="_blank" href="' + doc_link + '">' + doc_name + "</a>"

            clause_info = clause['clause_info']
            actors_info = clause['actors_info']
            actors_str = (Object.keys(actors_info)).join(' - ') == '' ? '-' : (Object.keys(actors_info)).join(' - ')
            deadline_date = clause['deadline_date']
            deadline_status = clause['deadline_status']

            const detail_function = "DetailFunction(" + clause_id + ")"
            const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + ' onclick="' + detail_function + '" data-bs-target="#myModal">جزئیات</button>'
            has_executive = clause['has_executive']
            {#console.log(has_executive)#}
            execution_symbol = has_executive ? '<i class="bi bi-check-circle-fill text-success"></i>':'<i class="bi bi-x-circle-fill text-danger"></i>'

            if(deadline_status == null){
                deadline_message = '<span>-</span>'
            }else {
                if(deadline_status == 'نگارش شده'){
                    deadline_message = '<span class="text-success">نگارش شده</span>'
                }else if(deadline_status == 'منقضی شده'){
                    deadline_message = '<span class="text-danger">منقضی شده</span>'
                }else if(deadline_status == 'دارای مهلت'){
                    deadline_message = '<span class="text-success">دارای مهلت</span>'
                }
            }

            if(deadline_date == null){
                deadline_date = '-'
            }

            i++;

            let row = {
                "index": i,
                "doc_name": doc_tag,
                "doc_approval_date":doc_approval_date,
                "clause_info": clause_info,
                "actors_info": actors_str,
                "detail": detail,
                "has_execution":execution_symbol,
                "deadline_date":deadline_date,
                "deadline_status":deadline_message,
                "found_pattern":doc_found_pattern

            }


            table_rows.push(row)
        }

        selected_columns = ["id", "name", "has_execution", "detail"]
        selected_columns = find_selected_column(selected_columns)

        columns = [
                {
                "name": "index",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "doc_name",
                "title": "نام سند",
                "style": {
                    "width": "25%"
                }
            },
            {
                "name": "doc_approval_date",
                "title": "تاریخ تصویب",
                "sorted": true,
                "direction": 'DESC',
                "style": {
                    "width": "5%"
                }
            },  {
                "name": "clause_info",
                "title": "بند قانون",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "actors_info",
                "title": "کنشگران مسئول",
                "style": {
                    "width": "20%"
                }
            }, {
                "name": "has_execution",
                "title": "دارای آئین‌نامه",
                "style": {
                    "width": "5%"
                }
            }, {
                 "name": "deadline_date",
                 "title": "مهلت نگارش آئین‌نامه",
                 "style": {
                     "width": "10%"
                 }
             },{
                 "name": "deadline_status",
                 "title": "وضعیت زمانی",
                 "style": {
                     "width": "10%"
                 }
             },{
                "name": "detail",
                "title": "جزئیات",
                "style": {
                    "width": "10%"
                }
            }
        ]

        if (!selected_columns.includes("all")) {
            for (let column of columns) {
                if (selected_columns.includes(column["name"])) {
                    column["visible"] = true
                } else {
                    column["visible"] = false
                }
            }
        }


        $('#SearchTable').empty();
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                         first: '»',
                         prev:'›',
                         next: '‹',
                         last: '«'
                     }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "سندی یافت نشد.",
            "columns": columns,
            "rows": table_rows
        });

    }

    async function DetailFunction(clause_id) {
        document.getElementById('ParagraphHeader').innerHTML = ""
        document.getElementById('ParagraphDetails').innerHTML = ""
        document.getElementById('DocumentDetails').innerHTML = ""
        document.getElementById('DocumentHeader').innerHTML = ""
        let deadline_date = null

        let request_link = 'http://' + location.host + "/GetExecutiveClauseParagraph/" + clause_id + "/"

        let response = await fetch(request_link).then(response => response.json());

        paragraph_info_result = response['paragraph_info_result']
        parent_paragraphs = paragraph_info_result['parent_paragraphs']
        doc_id = paragraph_info_result['doc_id']
        doc_name = paragraph_info_result['doc_name']
        actors_info = paragraph_info_result['actors_info']
        para_text = paragraph_info_result['text']

        //new update
        executive_doc_paragraphs =paragraph_info_result['executive_doc_paragraphs']
        executive_doc_name = paragraph_info_result['executive_doc_name']
        executive_doc_id = paragraph_info_result['executive_doc_id']
        deadline_date = paragraph_info_result['deadline_date']
        console.log(paragraph_info_result['found_pattern'].replaceAll('#','.*?'))
        found_pattern = new RegExp(paragraph_info_result['found_pattern'].replaceAll('#','.*?'),'g')
        {#console.log(deadline_date)#}

        const doc_link = 'http://' + location.host + "/document_profile/?id=" + doc_id
        const doc_tag = '<a target="_blank" href="' + doc_link + '">' + doc_name + "</a>"


        document.getElementById('ParagraphHeader').innerHTML = doc_tag


        result_ul = ''
        for (para_p of parent_paragraphs) {
            result_ul += '<li class="mb-3 lh-lg">' + para_p + '</li>'
        }

        for (para of para_text){
            for (const[name,form] of Object.entries(actors_info)){
                actor_form_tag = "<span class='text-primary bold'>" + form + "</span>"
                para = para.replaceAll(form, actor_form_tag)

                actor_form_tag = "<span class='text-primary bold'>" + form.replaceAll('وزارت ', '').replaceAll('سازمان ', '') + "</span>"
                para = para.replaceAll(form.replaceAll('وزارت ', '').replaceAll('سازمان ', ''), actor_form_tag)
            }

            {#keyword_tag = "<span class='gray_dotted_border px-1 rounded bold'>" + pattern + "</span>"#}
            {#para = para.replaceAll(found_pattern, "<span class='gray_dotted_border px-1 rounded bold'>Salam</span>")#}
            para = para.replaceAll(found_pattern, "<span class='gray_dotted_border px-1 rounded bold'>$&</span>")

            deadline_date_tag = "<span class='deadlines border border-warning border-2 px-1 rounded bold'>" + deadline_date + "</span>"
            para = para.replaceAll(deadline_date, deadline_date_tag)

            result_ul += '<li style="font-weight: bold;" class="mb-3 lh-lg">' + para + '</li>'
        }

        result_ul = '<ul>' + result_ul + '</ul>';

        document.getElementById('ParagraphDetails').innerHTML = result_ul

        let exe_doc_tag = ''
        if(executive_doc_name == "آیین نامه‌ای برای این بند یافت نشد."){
            exe_doc_tag = executive_doc_name
        }else{
            var exe_doc_link = 'http://' + location.host + "/document_profile/?id=" + executive_doc_id
            exe_doc_tag = '<a target="_blank" href="' + exe_doc_link + '">' + executive_doc_name + "</a>"
        }

        document.getElementById('DocumentHeader').innerHTML = exe_doc_tag



        console.log(executive_doc_paragraphs)


        result_ul = ''
        for (para of executive_doc_paragraphs) {
            result_ul += '<li class="mb-3 lh-lg">' + para + '</li>'
        }

        result_ul = '<ul>' + result_ul + '</ul>';

        document.getElementById('DocumentDetails').innerHTML = result_ul





    }

    function showChartData(data, container, documents_information_dict, keySort, xAxisTitle, title) {
        let documents_information_result = []
        for (const [key, value] of Object.entries(documents_information_dict)) {
            documents_information_result.push(value)
        }

        showChart(data, container, documents_information_result, keySort, xAxisTitle, title)
    }

    function showChart(data, container, documents_information_result, sortKeys, xAxisTitle, title) {
        const options = {
            data,
            sortKeys,
            xAxisTitle,
            title,
            yAxisTitle: "تعداد بند",
            onClick: async function (event, data) {
                const click_tag = event.domTarget.tag;
                const index = click_tag["index"]
                let text = data.row(index)[0];
                let filtered_result = []
                let header = ""
                let save_file_name = ""

                if (container === "has_executive_container") {
                    filtered_result = documents_information_result.filter(function (row) {
                        if(text == 'هست'){
                            if (row["has_executive"] === true)
                                return row
                        }else{
                            if (row["has_executive"] === false)
                                return row
                        }
                    });
                    header = "دارای آیین نامه " + text
                    save_file_name += " (مجموعه سند {1} و موضوع {2})".replace("1", documents_information_result[0]["country"]).replace("2", text)
                }


                else if (container === "deadline_container") {
                    filtered_result = documents_information_result.filter(function (row) {
                        if (text == 'نامشخص')
                            text = null
                        if (row["deadline_status"] === text)
                            return row
                    });
                    if (text == null)
                        header = "مهلت زمانی: نامشخص"
                    else
                        header = "مهلت زمانی: " + text
                    save_file_name += " (مجموعه سند {1} و مرجع تصویب {2})".replace("1", documents_information_result[0]["country"]).replace("2", text)
                }

                else if (container === "actor_container") {
                    filtered_result = documents_information_result.filter(function (row) {
                        for(var key in row["actors_info"]) {
                            if (key === text)
                                return row
                        }
                    });
                    header = "نام کنشگر: " + text
                    save_file_name += " (مجموعه سند {1} و سطح سند {2})".replace("1", documents_information_result[0]["country"]).replace("2", text)
                }

                else if (container === "year_container") {
                    filtered_result = documents_information_result.filter(function (row) {
                        if (row["doc_approval_date"].substring(0, 4) === text.toString())
                            return row
                    });
                    header = "سال تصویب: " + text
                    save_file_name += " (مجموعه سند {1} و سال تصویب {2})".replace("1", documents_information_result[0]["country"]).replace("2", text)
                }

                console.log(filtered_result)

                document.getElementById("ChartModalHeader").innerText = header
                let filtered_result_tag = ""
                let list_of_docId = ""
                for (const doc of filtered_result) {
                    const link = 'http://' + location.host + "/document_profile/?id=" + doc["doc_id"]
                    let tag = "<li class='mt-3' id=" + doc["doc_id"] + "><a href='" + link + "'>" + doc["doc_name"] + " (" + doc["clause_info"] + ")" +"</a></li>"
                    filtered_result_tag += tag
                    list_of_docId += doc["doc_id"] + "_"
                }

                filtered_result_tag = "<ol start='1'>" + filtered_result_tag + "</ol>"
                document.getElementById("ChartModalText").innerHTML = filtered_result_tag


                /* download file creation */
                document.getElementById("DownloadDocuments").onclick = function () {
                    downloadFiles(filtered_result, save_file_name);
                };

                console.log(filtered_result)
                /* export into excel files */
                document.getElementById("ExportExcel2").onclick = function ExportExcelFunction() {

                    var csv = "";

                    sep = ","
                    let Csv = "نام سند" + sep + "سطح سند" + sep +
                        "موضوع سند" + sep + "نوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + "\n"
                    for (const document of filtered_result) {
                        Csv += document["name"] + sep + document["level"] + sep + document["subject"] + sep +
                            document["type"] + sep + document["approval_reference"] + sep + document["approval_date"] + "\n"

                    }

                    let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
                    var link = document.createElement("a");
                    link.setAttribute("href", csvContent);
                    link.setAttribute("download", save_file_name + ".csv");
                    document.body.appendChild(link);
                    link.click()
                };

                $("#ChartModalBtn").click();


            }
        };

        if (container === "actor_container"){
            newBarChart(container, options);
        } else {
            newDoughnutChart(container, options);
        }
    }

    async function show2ColumnChart(chart_container, chart_data, country_id, preprocessed_keywords_text) {


        document.getElementById(chart_container).innerHTML = ""
        // create a data set
        var data = anychart.data.set(chart_data);

        // map the data
        var has_not_executive_series_data = data.mapAs({ x: 0, value: 2 });
        var has_executive_series_data = data.mapAs({ x: 0, value: 1 });



        // create a chart
        var chart = anychart.column();

        chart
            .animation(true)
            .padding([10, 60, 10, 0])

        chart.background().fill('#ffffff');


        // x axix labels font setting
        var xAxisLabels = chart.xAxis().labels();
        xAxisLabels.fontFamily("vazir");

        var yAxisLabels = chart.yAxis().labels();
        yAxisLabels.fontFamily("vazir");

        // Not allow labels overlapping
        var xAxis = chart.xAxis();
        xAxis.overlapMode("noOverlap");

        var yAxis = chart.yAxis();
        yAxis.title("تعداد پاراگراف");
        yAxis.title().fontFamily('vazir');
yAxis.title().fontWeight("bold");
        yAxis.title().height(40);


        chart.yScale().minimum(0);
        chart.yScale().ticks().allowFractional(false);
        // tooltip content font setting
        var tooltip = chart.tooltip();
        tooltip.fontFamily("vazir");

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir");


        // set the container id
        chart.container(chart_container);

        // create the second series, set the data and name
        var has_executive_series = chart.column(salahiat_series_data);
        has_executive_series.normal().stroke("#28a745", 0);
        has_executive_series.normal().fill("#ffc107");
        has_executive_series.name("دارای آیین نامه هست");


        // create the second series, set the data and name
        var has_not_executive_series = chart.column(hamkaran_series_data);
        has_not_executive_series.normal().stroke("#28a745", 0);
        has_not_executive_series.normal().fill("#28a745");
        has_not_executive_series.name("دارای آیین نامه نیست");


        // enable the legend
        chart.legend(true);

        var legend = chart.legend();
        legend.fontFamily('vazir')

        // set position mode
        legend.positionMode("inside");
        // set position and alignement
        legend.position("top");
        legend.align("center");
        legend.itemsLayout("horizontalExpandable");
        // initiate drawing the chart
        chart.draw();

        has_executive_series.listen("mouseOver", function (e) {
            document.body.style.cursor = "pointer";
        });
        has_executive_series.listen("mouseOut", function (e) {
            document.body.style.cursor = "auto";
        });

        has_not_executive_series.listen("mouseOver", function (e) {
            document.body.style.cursor = "pointer";
        });
        has_not_executive_series.listen("mouseOut", function (e) {
            document.body.style.cursor = "auto";
        });

        // has_executive columns
        has_executive_series.listen('click', async function (e) {
            const click_tag = e.domTarget.tag;
            const column_index = click_tag["index"]
            const actor_name = chart_data[column_index][0];
            const actor_role_name = 'متولی اجرا';
            showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text)

        });

        // has_not_executive columns
        has_not_executive_series.listen('click', function (e) {
            const click_tag = e.domTarget.tag;
            const column_index = click_tag["index"]
            const actor_name = chart_data[column_index][0];
            const actor_role_name = 'همکار';
            showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text)
        });

    }

    async function SpinnerModeFunction(mode) {
        if (mode === "Active") {
            $(".spinner-border").addClass("active");
        } else if (mode === "Disable") {
            $(".spinner-border").removeClass("active");
        }
    }

    async function GetMultiSelectValue(container_id) {
        let e = document.getElementById(container_id);
        let selected = [...e.options]
            .filter(option => option.selected)
            .map(option => option.value)
        return selected.join("__")
    }

</script>

<!-- Export results -->

<script>

    async function downloadFiles(file_name_list, save_file_name) {
        console.log(file_name_list)
        startFullPageBlockUI()
        const country_id = document.getElementById("country").value

        let zip = new JSZip()

        const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["country_information"][0]
        const country_folder = response["folder"];
        const country_name = response["name"];

        save_file_name += " مجموعه سند {" + country_name + "}"


        let extension = ".txt"
        if (country_name.includes("فاوا")) {
            extension = '.docx';
        }


        for (const document of file_name_list) {
            const document_name = document['doc_name'] + extension

            const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

            await fetch(path)
                .then(res => res.arrayBuffer())
                .then(value => {
                    zip.file(document_name, value);
                })
        }
        zip.generateAsync({
            type: "blob"
        })
            .then(function (content) {
                // see FileSaver.js
                saveAs(content, save_file_name + ".zip");
            });
        stopFullPageBlockUI('دانلود اسناد');
    }

    async function DownloadSerachResultFunction() {
        const save_file_name = " آئین‌نامه‌های اجرایی در"
        downloadFiles(MyResultValue.getSearchResultValue(), save_file_name)

        console.log('SearchResultValue')
        console.log(MyResultValue.getSearchResultValue())

    }

    async function ExportExcelSerachResultFunction() {
        var csv = "";

        sep = ","


        let Csv = "نام آئین‌نامه‌" + sep + "نام قانون" + sep +
            "بند قانونی" + "\n"
        for (const document of SearchResultValue) {
            let temp = document['matter'].join(';');
            console.log(temp);
            Csv += document["regulator_name"] + sep + document["law_name"] + sep + temp + "\n"
        }

        let save_file_name = " آئین‌نامه‌های اجرایی در"
        save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"

        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
        var link = document.createElement("a");
        link.setAttribute("href", csvContent);
        link.setAttribute("download", save_file_name + ".csv");
        document.body.appendChild(link);
        link.click()
    }

    function TablePaginationChanged(event) {

        input_id = event.target.id

        curr_page_number = parseInt(event.target.value);
        max_page_number = parseInt(document.getElementById(input_id).max);
        min_page_number = parseInt(document.getElementById(input_id).min);


        if (curr_page_number > max_page_number) {
            document.getElementById(input_id).value = max_page_number
        }

        else if (curr_page_number < min_page_number) {
            document.getElementById(input_id).value = min_page_number
        }

        {#console.log("here")#}
        if (parseInt(curr_page_number) !== 0)
            ShowResult();

    }

    async function update_table_pagination_input(curr_page, total_hits) {

            page_count = 0;

            if (total_hits < SEARCH_RESULT_SIZE) {
                page_count = 1

            } else if (total_hits < MAX_RESULT_WINDOW) {
                page_count = Math.ceil(total_hits / SEARCH_RESULT_SIZE)

            } else if (total_hits >= MAX_RESULT_WINDOW) {
                page_count = MAX_RESULT_WINDOW / SEARCH_RESULT_SIZE
            }

            document.getElementById("TablePaginationInput").min = 1;
            document.getElementById("TablePaginationInput").max = page_count;
            document.getElementById("TablePaginationInput").value = curr_page;

            document.getElementById("from_page").innerText = curr_page;
            document.getElementById("total_page").innerText = page_count

        }

</script>
<!-- save log user -->
<script>
    async function UserLog(form_data) {
        if (getCookie("username") !== "") {
            const user_name = getCookie("username")
            let page_url = window.location.pathname
            const user_ip = "127.0.0.0"
            page_url = page_url.slice(0, -1);
            if (page_url === "") {
                page_url = "/0";
            }


            let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                console.log("done")

            }).fail(function (res) {
                console.log("fail")
            });

        }
    }
</script>

<script src="../../static/js/tooltip_handler.js"></script>
<!-- Intro Js -->
<!-- <script src="../../static/js/UserLogSave.js"></script>-->
<script src="../../static/js/signout_function.js"></script>



</html>