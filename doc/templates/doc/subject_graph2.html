<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">

    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>


    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="../../static/js/jsnetworkx.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/graph.css">
    <link rel="stylesheet" href="../../static/styles/subject_graph.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <meta charset="UTF-8">

    <title> گراف موضوعی</title>
    {% include "doc/title_icon.html" %}

</head>

<body>

    <!-- Menu -->

    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <!-- Intro Js -->
    <script src="../../static/js/subject_graph/subject_graph_tour.js">
    </script>
    <script src="../../static/js/tour.js"></script>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#SubjectDropdown').addClass('active');
            $('#subject_graph').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>

    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">
        <form enctype="multipart/form-data" class="custom-control mx-auto needs-validation" id="graph_form">

            <div class="row mb-0 flex-row-reverse mx-auto mt-3">

                <div class="col-12 col-lg-3 mt-2 px-0">

                    <label class="text-right d-block w-100 bg-light float-right" style="direction: rtl;;">فایل
                        موضوعات:</label>
                    <button type="button" id="file_input_btn" class="btn p-2 d-block float-right"><i
                            class="bi bi-folder"></i> انتخاب فایل</button>
                    <span id="file_name" dir="rtl" class="p-2 float-right text-center text-secondary">فایلی انتخاب
                        نشده‌است.</span>
                    <input type="file" name="SubjectFile" id="SubjectFile" class="d-none">
                </div>

                <div class="col-12 col-lg-2 mr-1 mt-3 pb-0">
                    <!-- Show result btn -->
                    <button type="button" id="load_sample" style="color: white; background-color: var(--menu_color)" class="btn d-block mt-4 p-2 float-right"
                        onclick="loadSample()"> انتخاب فایل نمونه
                    </button>
                </div>


                <div class="col-12 col-lg-3 mt-2 pb-0 px-0 mr-2" dir="rtl">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">نوع گراف:</label>

                    <select id="graph_type" name="graph_type" class="form-select py-2 mr-0 text-right float-right searchable-select"
                        style="direction: rtl;">
                        <option value="all">همه</option>
                        <option value="common_duplicated">کلیدواژه‌های مشترک و تکراری</option>
                    </select>
                </div>

                <div class="col-12 col-lg-2 mr-1 mt-3 pb-0">
                    <!-- Show result btn -->
                    <button type="button" id="graph_show" class="btn d-block mt-4 p-2 float-right"
                        onclick="showResult()"> نمایش
                        گراف
                    </button>
                </div>
            </div>

        </form>

        <!--Original Tabs -->
        <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
            role="tablist">

            <li class="nav-item float-right" role="presentation">
                <button id="advanced_view_tab" class="nav-link active" data-bs-toggle="pill"
                    data-bs-target="#advanced_view_pane" type="button" role="tab" aria-controls="advanced_view_pane"
                    aria-selected="true">گراف موضوعات</button>
            </li>
        </ul>

        <!-- Original Panes -->
        <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">

            <!--  Graph Pane -->
            <div class="tab-pane fade show active float-right w-100" id="advanced_view_pane" role="tabpanel"
                aria-labelledby="advanced_view_tab">
                <div class="row mt-4 w-100 flex-row-reverse  mx-auto pb-5 px-4">
                    <div class="col-12 subjects_container">
                        <div class="form-check form-check-inline d-none float-right"><input id="all_subjects"
                                class="form-check-input" checked type="checkbox" value="all">
                            <label class="form-check-label">همه</label>
                        </div>
                    </div>
                    <div id="advanced_graph_container" class="col-12 w-100 mx-auto border mt-2" style="height:500px;">
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js"></script>

    <!-- Intro Js -->
    <script src="../../static/js/subject_graph/subject_graph_tour.js">
    </script>
    <script src="../../static/js/tour.js"></script>

</body>

<!-- save log user -->
<script>
    async function UserLog(form_data) {
        if (getCookie("username") !== "") {
            const user_name = getCookie("username")
            let page_url = window.location.pathname
            const user_ip = "127.0.0.0"
            page_url = page_url.slice(0, -1);
            if (page_url === "") {
                page_url = "/0";
            }


            let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                console.log("done")

            }).fail(function (res) {
                console.log("fail")
            });

        }
    }
</script>

<script>
    initSearchableSelects();

    let draft_selected_paragraphs = []
    let draft_actors = {};
    let draft_text = '';


    container_id_list = ['actors_graph_container', 'SearchTable', 'DocumentCount',
        'reference_graph_container', 'documents_actors_table', 'draft_actors_table', 'actors_chart_container']

    function clearPrevResults(container_id_list) {

        for (container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }
    }


    $(document).ready(function () {


        $('#file_input_btn').on('click', function () {
            $('#DraftFile').trigger('click');

        });

        $('#DraftFile').change(function (e) {
            var fileName = e.target.files[0].name;
            file_extention = fileName.split('.').pop();
            if (file_extention == 'pdf') {

                var toastElList = [].slice.call(document.querySelectorAll('.toast'))
                var toastList = toastElList.map(function (toastEl) {
                    return new bootstrap.Toast(toastEl)
                });
                toastList.forEach(toast => toast.show())
                $(this).val("");
                $('span#file_name').text('فایلی انتخاب نشده‌است');
            } else {
                $('span#file_name').text(fileName);
            }

        });

    });
    //user log
    let form_data = new FormData()
    let detail_type = "نمایش پنل"
    form_data.append('detail_type', detail_type);
    UserLog(form_data)
</script>


<script>
    initSearchableSelects();

    let all_subjects = [];
    let text = [];
    let common_keywords = []
    let duplicated_keywords = []
    let subject_keywords_count = {} // {key: subject, value: {key:keyword, value: count} }

    $(document).ready(function () {

        $('#file_input_btn').on('click', function () {
            $('#SubjectFile').trigger('click');

        });

        $('#SubjectFile').change(function (e) {
            var fileName = e.target.files[0].name;
            $('span#file_name').text(fileName);
            readData();

        });

        $('#all_subjects').change(function (e) {
            if (this.checked) {
                // select all subjects
                subjects = document.getElementsByClassName('subject');
                for (subject of subjects) {
                    if (!subject.checked) {
                        subject.checked = true;
                    }
                }
                $('.subject').attr('disabled', true);


            } else {
                $('.subject').attr('disabled', false);
                subjects = document.getElementsByClassName('subject');
                for (subject of subjects) {
                    if (subject.checked) {
                        subject.checked = false;
                    }
                }
            }
        })

        

    });

    
</script>

<script>

    container_id_list = ['advanced_graph_container']


    function clearPrevResults(container_id_list) {

        for (container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }

        
    }

    async function loadSample(sample_file_name = 'LegalOrientations.txt') {
        const request_link = 'http://' + location.host + "/GetLocalTextFile/" + sample_file_name + "/";
        let response = await fetch(request_link).then(response => response.json());
        const text = response["file_text"];

        showSubjects(text);
        makeGraphData(text);

        
    }

    function readData() {
        let SubjectFile = document.getElementById('SubjectFile');
        console.log(SubjectFile)
        let text = ''
        let file_reader = new FileReader();

        if (SubjectFile.files.length === 0) {
            $('span#file_name').text('.فایلی انتخاب نشده‌است');

        } else {
            file_reader.onload = function () {
                text = file_reader.result;
                showSubjects(text);
                makeGraphData(text)
            }

            file_reader.readAsText(SubjectFile.files[0]);
        }

        //user log
        let form_data = new FormData()
        let detail_type = "نتایج جست و جو"
        let subject_select = $("#SubjectFile option:selected").text();
        form_data.append('detail_type', detail_type);
        form_data.append('subject_select', subject_select);
        UserLog(form_data)

        
    }

    function showSubjects(text) {
        all_subjects = []
        let lines = text.split('\n');
        $('#all_subjects').parent().removeClass('d-none');
        document.getElementById('all_subjects').checked = true;
        $('.subjects_container').children().not(':first').remove();
        for (line of lines) {
            line = line.trim();
            if (line.includes('*')) {
                let subject = line.replace('*', '');
                subject = subject.trim();
                all_subjects.push(subject);
                tag = '<div class="form-check form-check-inline float-right"><input class="subject form-check-input" disabled checked="true" type="checkbox" value="' + subject + '">' +
                    '<label class="form-check-label">' + subject + '</label></div>'
                $('.subjects_container').append(tag)

            }
        }
        //user log
        let form_data = new FormData()
        let detail_type = "نتایج جست و جو"
        let subject_select = $("all_subjects option:selected").text();
        form_data.append('detail_type', detail_type);
        form_data.append('subject_select', subject_select);
        UserLog(form_data)
    }

    function makeGraphData(text) {
        let nodes = []
        let temp_edges = []
        let edges = []
        let chart_data = {}

        let lines = text.split('\n');
        let current_subject = ''
        let keywords_list = []
        let subjects_list = []
        common_keywords = []
        duplicated_keywords = []
        subject_keywords_count = {} // {key: subject, value: {key:keyword, value: count} }

        /* Fill Data */
        for (i = 0; i < lines.length; i++) {

            line = lines[i];
            line = line.trim();

            if (line.includes('*')) {
                let subject = line.replace('*', '');
                subject = subject.trim();
                current_subject = subject;
                subject_keywords_count[subject] = {}

            } else {

                let keyword = line;
                let current_subject_keywords = subject_keywords_count[current_subject];

                // if keyword exist
                if (keywords_list.includes(keyword)) {

                    // if in current subject --> duplicated
                    if (Object.keys(current_subject_keywords).includes(keyword)) {
                        subject_keywords_count[current_subject][keyword] += 1;
                        if (!duplicated_keywords.includes(keyword)) {
                            duplicated_keywords.push(keyword);
                        }
                    } else {
                        // if in another subject --> common 
                        subject_keywords_count[current_subject][keyword] = 1;
                        if (!common_keywords.includes(keyword)) {
                            common_keywords.push(keyword);
                        }
                    }

                } else {
                    subject_keywords_count[current_subject][keyword] = 1;
                    keywords_list.push(keyword)
                }

            }
        }

        /* Filter subjects */

    }

    function showResult() {
        // get selected subjects
        clearPrevResults(container_id_list);

        subjects = document.getElementsByClassName('subject');
        selected_subjects = []

        for (subject of subjects) {
            if (subject.checked) {
                selected_subjects.push(subject.value);
            }
        }

        if (selected_subjects.length == 0) {
            alert('موضوعی انتخاب نشده‌است.')
        } else {

            let graph_type = $('#graph_type').val()
            filterGraphData(selected_subjects, graph_type)

        }

        //user log
        let form_data = new FormData()
        let detail_type = "نتایج جست و جو"
        let graph_type_select = $("#graph_type option:selected").text();
        form_data.append('detail_type', detail_type);
        form_data.append('graph_type_select', graph_type_select);
        UserLog(form_data)

    }

    function filterGraphData(selected_subjects, graph_type) {
        let nodes = []
        let edges = []
        let duplicated_keywords_count = 0;
        let commmon_keywords_count = 0;
        for (subject of selected_subjects) {

            let subject_node = {
                id: subject,
                group: 'subjects',
                normal: {
                    height: 30,
                    shape: "diamond",
                    fill: "#ffa000",
                    stroke: null
                },
                hovered: {
                    height: 35,
                    shape: "diamond",
                    fill: "white",
                    stroke: "3 #ffa000"
                },
                selected: {
                    height: 35,
                    shape: "diamond",
                    fill: "#ffa000",
                    stroke: "3 #333333"
                }
            };

            nodes.push(subject_node);

            subject_keywords = Object.keys(subject_keywords_count[subject])
            for (keyword of subject_keywords) {
                let keyword_node = {}

                if (common_keywords.includes(keyword)) {
                    keyword_node = {
                        id: keyword,
                        group: 'common_keywords',
                        normal: {
                            height: 20,
                            shape: "diagonal-cross",
                            fill: "#ff3300",
                            stroke: null
                        },
                        hovered: {
                            height: 27,
                            shape: "diagonal-cross",
                            fill: "white",
                            stroke: "3 #ff3300"
                        },
                        selected: {
                            height: 27,
                            shape: "diagonal-cross",
                            fill: "#ff3300",
                            stroke: "3 #333333"
                        }
                    }
                    commmon_keywords_count += 1;
                } else if (duplicated_keywords.includes(keyword)) {
                    keyword_node = {
                        id: keyword,
                        group: 'duplicated_keywords',
                        normal: {
                            height: 20,
                            shape: "cross",
                            fill: "#5cd926",
                            stroke: null
                        },
                        hovered: {
                            height: 27,
                            shape: "cross",
                            fill: "white",
                            stroke: "3 #5cd926"
                        },
                        selected: {
                            height: 27,
                            shape: "cross",
                            fill: "#5cd926",
                            stroke: "3 #333333"
                        }
                    }
                    duplicated_keywords_count += 1;
                } else if (graph_type == 'all') {
                    keyword_node = {
                        id: keyword,
                        group: 'unique_keywords'
                    }
                }
                nodes.push(keyword_node);

                edge = {
                    from: subject,
                    to: keyword
                }
                edges.push(edge);
            }

        }

        chart_data = {
            nodes,
            edges
        };
        $("html, body").animate({
            scrollTop: $(document).height()
        }, 500);
        showChart(chart_data, duplicated_keywords_count, commmon_keywords_count)

    }

    function showChart(chart_data, duplicated_keywords_count, commmon_keywords_count) {
        // create a chart and set the data
        var chart = anychart.graph(chart_data);

        // set the container id
        document.getElementById('advanced_graph_container').innerHTML = ""
        chart.container("advanced_graph_container");


        if (duplicated_keywords_count !== 0) {
            // configure labels of duplicate keywords in one subject
            let duplicated_keywords = chart.group("duplicated_keywords");

            duplicated_keywords.labels().enabled(true);
            duplicated_keywords.labels().format("{%id}").fontFamily('vazir');
            duplicated_keywords.labels().fontSize(14);
            duplicated_keywords.labels().fontWeight(600);
        }

        if (commmon_keywords_count != 0) {
            // configure labels of common keywords
            let common_keywords = chart.group("common_keywords");

            common_keywords.labels().enabled(true);
            common_keywords.labels().format("{%id}").fontFamily('vazir');
            common_keywords.labels().fontSize(14);
            common_keywords.labels().fontWeight(600);
        }


        // configure labels of subjects
        let subjects = chart.group("subjects");

        subjects.labels().enabled(true);
        subjects.labels().format("{%id}").fontFamily('vazir');
        subjects.labels().fontSize(14);
        subjects.labels().fontWeight(600);


        chart.nodes().tooltip().format("{%id}");
        chart.edges().tooltip().format(" from: {%from} \n to: {%to}");
        chart.edges().tooltip().fontFamily('vazir');
        chart.nodes().tooltip().fontFamily('vazir');



        // initiate drawing the chart
        chart.draw();



    }
</script>

<!-- BS Tooltips handler -->
<script src="../../static/js/tooltip_handler.js"></script>

<!-- Intro Js -->
<script src="../../static/js/subject_graph/subject_graph_tour.js">
</script>
<script src="../../static/js/tour.js"></script>
<!-- <script src="../../static/js/UserLogSave.js"></script>-->
<script src="../../static/js/signout_function.js"></script>

</html>