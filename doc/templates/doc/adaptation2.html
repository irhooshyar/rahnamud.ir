<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>


    <!-- jsnetworkx -->
    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="../../static/js/jsnetworkx.js"></script>


    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <!-- Download Zip Files -->
    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/adaptation.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">


    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <meta charset="UTF-8">
    <title>انطباق موضوعی</title>
    {% include "doc/title_icon.html" %}
</head>

<body>

    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#SubjectDropdown').addClass('active');
            $('#adaptation').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>

    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">

        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" novalidate>

            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mt-2 mx-auto">

                <!-- Country Input -->
                <div class="col-md-6  pt-3 col-12 col-lg-2 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;" onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>

                </div>

                <!-- Search Box input -->
                <div class="col-md-6 pt-3 col-12 col-lg-4">
                    <label class="float-right" style="direction: rtl;">لیست کلیدواژه‌ها <span
                            style="color: red">(*)</span>:</label>
                    <input style="direction: rtl;" class="float-left form-control text-right"
                        placeholder="کلیدواژه اول/ کلیدواژه دوم/ ..." type="text" required="" name="KeywordsBox"
                        id="KeywordsBox" value="" name="KeywordsBox">
                </div>

                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button id="advanced_search" type="button" class="btn float-right" data-bs-toggle="collapse"
                        data-bs-target="#advanced_fields" aria-expanded="true" aria-controls="advanced_fields">تنظیمات
                        پیشرفته</button>
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        نمایش
                    </button>
                </div>

            </div>

            <!-- Advanced Fields in Second Row -->
            <div id="advanced_fields" class="collapse show row flex-row-reverse mx-auto mt-4">

                <!-- File Input -->
                <div class="col-12 col-lg-3 bg-light pb-0 pt-3">
                    <label class="text-right d-block w-100 bg-light float-right" style="direction: rtl;;">فایل
                        پیش‌نویس <span class="text-secondary">(word)</span>:</label>
                    <button type="button" id="file_input_btn" class="btn mb-0 p-1 d-block float-right"><i
                            class="bi bi-folder"></i> انتخاب فایل</button>
                    <span id="file_name" dir="rtl" class="mb-0 p-1 float-right text-center text-secondary">فایلی
                        انتخاب
                        نشده‌است</span>
                    <input type="file" accept=".docx" name="DraftFile" id="DraftFile" class="d-none">
                </div>


                <!-- document level input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">سطح سند:</label>
                    <select id="LevelSelect" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- document subject input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> موضوع سند:</label>
                    <select id="SubjectSelect" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- search type input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> نوع سند:</label>

                    <select id="TypeSelect" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- Approval References -->
                <div class="col-md-6  pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> مرجع تصویب:</label>

                    <select id="ApprovalReferences" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- From Year input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> سال تصویب از:</label>

                    <select id="YearFrom" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- To Year input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class="text-right bg-light float-right" style="direction: rtl;;"> سال تصویب تا:</label>

                    <select id="YearTo" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- Document Type -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">در:</label>

                    <select id="WhereSelect" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                        <option value="عنوان و متن">عنوان و متن</option>
                        <option value="عنوان">عنوان</option>
                        <option value="متن">متن</option>
                    </select>

                </div>

            </div>

        </form>

        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">نتایج جست‌وجو</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="actors_graph_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#actors_graph_pane" type="button" role="tab" aria-controls="actors_graph_pane"
                        aria-selected="false">گراف
                        کنش‌گران</button>
                </li>
                <li class="nav-item float-right" role="presentation">
                    <button id="reference_graph_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#reference_graph_pane" type="button" role="tab"
                        aria-controls="reference_graph_pane" aria-selected="false">گراف ارجاعات پیش‌نویس</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="confilict_analysis_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#confilict_analysis_pane" type="button" role="tab"
                        aria-controls="confilict_analysis_pane" aria-selected="false">تناقضات و تشابهات</button>
                </li>

                <!-- Download Buttons -->
                <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                    class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

                </button>

                <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button>

                <!-- Result Count -->
                <p id="DocumentCount" dir="rtl" class="text-left float-left text-secondary  pl-2"></p>

            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">

                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                    aria-labelledby="search_result_tab">

                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                        </table>
                    </div>

                </div>


                <!-- Actors Graph Pane -->
                <div id="actors_graph_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="actors_graph_tab">
                    <!-- Search Result table -->
                    <div class="row mt-4 w-100 flex-row mx-0 px-4 pb-5">

                        <div id="actors_graph_container" class="w-100 border" style="height: 500px;">
                        </div>
                    </div>

                </div>


                <!-- Reference Graph Pane -->
                <div id="reference_graph_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="reference_graph_tab">
                    <!-- Search Result table -->
                    <div class="row mt-4 w-100 flex-row mx-0 px-4 pb-5">

                        <div id="reference_graph_container" class="w-100 border" style="height: 500px;">
                        </div>
                    </div>

                </div>

                <!-- Confilict Analysis Pane -->
                <div id="confilict_analysis_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="confilict_analysis_tab">

                    <div class="row mt-4 w-100 flex-row mx-auto">

                        <!-- Documents Actors Table -->
                        <div dir="rtl" class="col-md-6 px-0 col-12 col-lg-6 pt-1">
                            <h6 class="table_header text-center  p-2  mb-0">
                                کنش‌گران در اسناد یافت‌شده
                            </h6>
                            <div class=" mt-0 pl-2">
                                <table class="table table-white table-striped table-bordered border-secondary">
                                    <thead class="table">
                                        <tr>
                                            <th class="text-center" scope="col">ردیف</th>
                                            <th class="text-center" scope="col">کنش‌گر</th>
                                            <th class="text-center" scope="col">فراوانی</th>
                                        </tr>
                                    </thead>

                                    <tbody id="documents_actors_table">
                                    </tbody>

                                </table>
                            </div>

                        </div>

                        <!-- Documents Actors Table -->
                        <div dir="rtl" class="col-md-6 px-0 col-12 col-lg-6 pt-1">
                            <h6 class="table_header text-center  p-2  mb-0">
                                کنش‌گران در پیش‌نویس
                            </h6>
                            <div class=" mt-0 pl-2">
                                <table class="table table-white table-striped table-bordered border-secondary">
                                    <thead class="table">
                                        <tr>
                                            <th class="text-center" scope="col">ردیف</th>
                                            <th class="text-center" scope="col">کنش‌گر</th>
                                            <th class="text-center" scope="col">فراوانی</th>
                                        </tr>
                                    </thead>

                                    <tbody id="draft_actors_table">
                                    </tbody>

                                </table>
                            </div>

                        </div>

                    </div>



                    <div class="row mt-4 w-100 flex-row-reverse mx-0 px-0 pb-2">
                        <div class="col-md-4 px-4 col-12 col-lg-12 p-3">
                            <!-- Motevalian chart segment -->
                            <h5 id="actors_chart_header"
                                class="chart_header w-100 mt-4 text-center float-right pt-3 pb-3">
                                توزیع کنش‌گران
                            </h5>
                            <br>
                            <div dir="ltr" style="margin-left: 1px !important;" id="actors_chart_container"
                                class="bg-white w-100 mx-auto py-4 px-1 border text-center border-2 pb-2 vertical chart_container">
                            </div>
                        </div>
                    </div>

                </div>



            </div>

        </div>


    </div>


    <!-- Modal Container -->
    <div class="modal fade" id="myModal">
        <div id="modal_dialog" class="modal-dialog modal-fullscreen  modal-dialog-scrollable ">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title w-100">
                        <div class="row w-100">
                            <div id="document_header" class="col-6 float-right text-center my-auto"></div>
                            <div id="draft_header" class="col-6 float-left text-center my-auto"></div>
                        </div>
                    </h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="DetailText" class="modal-body bg-light text-justify">
                    <div class="row w-100 ">
                        <div id="DocumentParagraph" class="col-6 float-right"></div>
                        <div id="DraftParagraphs" class="col-6 float-left"></div>
                    </div>
                </div>

                <!-- Modal footer -->
                <div id="modal_footer" class="modal-footer">
                    <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن
                    </button> -->
                </div>

            </div>
        </div>
    </div>


    <!-- ChartModal Container -->
    <button type="button" id="edge_modal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#edge_modal"></button>

    <div class="modal fade" id="edge_modal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <div id="edge_modal_header" class="modal-title">
                        <span class="text-secondary">کنش‌گر: </span>
                        <h5 id="actor_modal_header" class="d-inline-block text-right text-warning"></h5>
                        <br>
                        <span class="text-secondary">کلیدواژه: </span>
                        <h6 id="keyword_modal_header" class="d-inline-block text-right text-primary"></h6>
                    </div>

                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="actor_paragraphs" class="modal-body bg-light text-justify">
                    <div id="edge_modal_body">

                    </div>
                </div>


                <!-- Modal footer -->
                <div id="modal_footer" class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div class="position-absolute top-0 start-50 translate-middle p-3" style="z-index: 11;margin-top:95px;">
        <div dir="rtl" id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div dir="rtl" class="toast-header">
                <img width="25px;" src="../../static/icons/logo/logo1.png" class="rounded mx-0" alt="...">
                <strong dir="rtl" class="w-100 mr-2 mt-1">هوش‌یار</strong>
                <button type="button" class="btn-close ml-0" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <i style="position: relative; top: -7px; font-size: 18px;"
                    class="bi bi-exclamation-triangle-fill  text-warning"></i>
                لطفا یک فایل word انتخاب نمایید.
            </div>
        </div>
    </div>


    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js">
    </script>

    <script src="../../static/js/adaption/adaption_tour.js">
    </script>
    <script src="../../static/js/tour.js"></script>

</body>

<!-- save log user -->
<script>
    async function UserLog(form_data) {
        if (getCookie("username") !== "") {
            const user_name = getCookie("username")
            let page_url = window.location.pathname
            const user_ip = "127.0.0.0"
            page_url = page_url.slice(0, -1);
            if (page_url === "") {
                page_url = "/0";
            }


            let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                console.log("done")

            }).fail(function (res) {
                console.log("fail")
            });

        }
    }
</script>

<script>
    initSearchableSelects();

    let draft_selected_paragraphs = []
    let draft_actors = {};
    let draft_text = '';


    container_id_list = ['actors_graph_container', 'SearchTable', 'DocumentCount',
        'reference_graph_container', 'documents_actors_table', 'draft_actors_table', 'actors_chart_container']

    function clearPrevResults(container_id_list) {

        for (container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }
    }


    $(document).ready(function () {


        $('#file_input_btn').on('click', function () {
            $('#DraftFile').trigger('click');

        });

        $('#DraftFile').change(function (e) {
            var fileName = e.target.files[0].name;
            file_extention = fileName.split('.').pop();
            if (file_extention == 'pdf') {

                var toastElList = [].slice.call(document.querySelectorAll('.toast'))
                var toastList = toastElList.map(function (toastEl) {
                    return new bootstrap.Toast(toastEl)
                });
                toastList.forEach(toast => toast.show())
                $(this).val("");
                $('span#file_name').text('فایلی انتخاب نشده‌است');
            } else {
                $('span#file_name').text(fileName);
            }

        });

    });
</script>


<script>
    const motevali_keywords = ['موظف است', 'مکلف است', 'مکلف‌اند', 'موظف‌اند', 'موظفند', 'مکلفند', 'موظف به','مکلف به'];
    const hamkaran_keywords = ['با همکاری', 'باهمکاری'];
    const salahiat_keywords = ['مختار است', 'اختیار دارد', 'می‌تواند', 'می تواند', 'میتواند', 'مجاز است'];

    const hamkaran_punctuations = ['،', ')', ':']

    SearchResultValue = []

    let sorted_draft_actors_frequecies = []
    let draft_actors_frequencies = {}

    init()


    async function init() {
        const country_id = document.getElementById("country").value

        /****************** Level List ****************************/
        let request_link = 'http://' + location.host + "/GetLevelByCountryId/" + country_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["documents_level_list"]

        document.getElementById("LevelSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>";

        for (var i = 0; i < response.length; i++) {
            const level_id = response[i]["id"]
            const level_name = response[i]["level"]

            const tag = "<option value=" + level_id + " >" + level_name + "</option>";

            document.getElementById("LevelSelect").innerHTML += tag
        }

        /****************** Subject List ****************************/
        request_link = 'http://' + location.host + "/GetSubjectsByCountryId/" + country_id + "/";
        response = await fetch(request_link).then(response => response.json());
        response = response["documents_subject_list"]

        document.getElementById("SubjectSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>";

        for (var i = 0; i < response.length; i++) {
            const subject_id = response[i]["id"]
            const subject_name = response[i]["subject"]

            const tag = "<option value=" + subject_id + " >" + subject_name + "</option>";

            document.getElementById("SubjectSelect").innerHTML += tag
        }

        /****************** Type List ****************************/
        request_link = 'http://' + location.host + "/GetTypeByCountryId/" + country_id + "/";
        response = await fetch(request_link).then(response => response.json());
        response = response["documents_type_list"]

        document.getElementById("TypeSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>";

        for (var i = 0; i < response.length; i++) {
            const type_id = response[i]["id"]
            const type_name = response[i]["type"]

            const tag = "<option value=" + type_id + " >" + type_name + "</option>";

            document.getElementById("TypeSelect").innerHTML += tag
        }


        /****************** ApprovalReferences List ****************************/
        request_link = 'http://' + location.host + "/GetApprovalReferencesByCountryId/" + country_id + "/";
        response = await fetch(request_link).then(response => response.json());
        response = response["documents_approval_list"]

        document.getElementById("ApprovalReferences").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>";

        for (var i = 0; i < response.length; i++) {
            const approval_reference_id = response[i]["id"]
            const approval_reference_name = response[i]["approval_reference"]

            const tag = "<option value=" + approval_reference_id + " >" + approval_reference_name + "</option>";

            document.getElementById("ApprovalReferences").innerHTML += tag
        }

        /****************** ApprovalReferences List ****************************/
        request_link = 'http://' + location.host + "/GetYearsBoundByCountryId/" + country_id + "/";
        response = await fetch(request_link).then(response => response.json());
        response = response["documents_approval_list"]
        const min_year = response[0]
        const max_year = response[1]


        document.getElementById("YearFrom").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>";
        document.getElementById("YearTo").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>";

        if (max_year !== -1 && min_year !== -1) {
            for (var i = max_year; i >= min_year; i--) {
                const tag = "<option value=" + i + " >" + i + "</option>";
                document.getElementById("YearFrom").innerHTML += tag
                document.getElementById("YearTo").innerHTML += tag
            }
        }
        syncAllSelectsWithResetExceptions(["country"]);

        //user log
        let form_data = new FormData()
        let detail_type = "نمایش پنل"
        form_data.append('detail_type', detail_type);
        UserLog(form_data)
    }

    function CountryChanged() {
        init()
    }

    async function ShowResult() {

        await SpinnerModeFunction("Active");

        const country_id = document.getElementById("country").value;
        const level_id = document.getElementById("LevelSelect").value;
        const subject_id = document.getElementById("SubjectSelect").value;
        const type_id = document.getElementById("TypeSelect").value;
        const approval_reference_id = document.getElementById("ApprovalReferences").value;
        const from_year = document.getElementById("YearFrom").value;
        const to_year = document.getElementById("YearTo").value;
        const place = document.getElementById("WhereSelect").value;
        const search_type = 'Exact'
        const text = document.getElementById("KeywordsBox").value;
        const draft_file_size = document.getElementById('DraftFile').files.length

        let keywords = text.split('/');
        keywords = keywords.map(function (keyword) {
            return keyword.trim();
        })

        keywords = keywords.filter(keyword => (keyword != '' && keyword != ' '));
        let documents_information_result = [];

        all_keywords = keywords;
        if (keywords.length > 0) {

            clearPrevResults(container_id_list);
            notyf.dismissAll();
            startBlockUI('SearchTable');

            if (draft_file_size != 0) {

                await uploadDraftFile(keywords);

                const draft_file_name = $('span#file_name').text();


                let request_link = 'http://' + location.host + "/getDraftActors/" + country_id + "/" + draft_file_name + "/"
                let response = await fetch(request_link).then(response => response.json());
                draft_actors = response["draft_actors"];



                for (let [actor_type, actors] of Object.entries(draft_actors)) {
                    selected_actor_type = draft_actors[actor_type]

                    for (let [actor_name, count] of Object.entries(selected_actor_type)) {

                        if (Object.keys(draft_actors_frequencies).includes(actor_name)) {
                            draft_actors_frequencies[actor_name] += 1;
                        } else {
                            draft_actors_frequencies[actor_name] = 1
                        }
                    }

                }

                sorted_draft_actors_frequecies = sortActorsFrequencies(draft_actors_frequencies);
                fillActorsFrequenciesTable('draft_actors_table', sorted_draft_actors_frequecies);

            } else {
                $('span#file_name').text('فایلی انتخاب نشده‌است.');
                draft_selected_paragraphs = [];
                draft_actors = {};
                draft_text = ''
                document.getElementById('draft_actors_table').innerHTML = ""
                sorted_draft_actors_frequecies = []


            }
            // search result

            keywords_text = keywords.toString();

            let request_link = 'http://' + location.host + "/SearchDocumentsByKeywords/" + country_id + "/" + level_id + "/" + subject_id + "/" + type_id + "/" +
                approval_reference_id + "/" + from_year + "/" + to_year + "/" + place + "/" + keywords_text + "/"

            let response = await fetch(request_link).then(response => response.json());
            /*  Get Documents Information Result */
            documents_information_list = response["documents_information_result"]

            console.log(documents_information_list)

            showDocumentInformation(documents_information_list);
            stopBlockUI('SearchTable', 'نتایج جست‌وجو');


            // graph result
            startBlockUI('actors_graph_container');

            document_id_list = []
            document_name_list = []

            for (document_info of documents_information_list) {
                document_id_list.push(document_info['id']);
                document_name_list.push(document_info['name']);
            }

            documents_id_text = document_id_list.toString();
            keywords_text = keywords.toString();



            if (documents_id_text.length > 0) {

                let request_link = 'http://' + location.host + "/GetActorsKeywordsGraphByDocumentsIdKeywords/" + documents_id_text + "/" + keywords_text + "/"
                let response = await fetch(request_link).then(response => response.json());
                let chart_data = response['chart_data']
                showActorsGraph('actors_graph_container', chart_data, documents_id_text);

                stopBlockUI('actors_graph_container', 'گراف کنشگران');


                startBlockUI('reference_graph_container');
                createDraftReferencesGraphData(document_name_list, draft_text);
                stopBlockUI('reference_graph_container', 'گراف ارجاعات پیش‌نویس');

            }


        } else {
            alert('کلیدواژه‌ای وارد نشده‌است.')
            $('#KeywordsBox').focus();

        }

        await SpinnerModeFunction("Disable");

        //user log
        let form_data = new FormData()
        let detail_type = "نتایج جست و جو"
        let country_name = $("#country option:selected").text();
        let keywords_text_search = text;
        let Subject_Select = $("#SubjectSelect option:selected").text();
        let Level_select = $("#LevelSelect option:selected").text();
        let Type_Select = $("#TypeSelect option:selected").text();
        let Approval_References = $("#ApprovalReferences option:selected").text();
        let Year_From = $("#YearFrom option:selected").text();
        let Year_To = $("#YearTo option:selected").text();
        let place_name = $("#WhereSelect option:selected").text();
        let draft_file_select = $("#draft_file_size option:selected").text();
        form_data.append('detail_type', detail_type);
        form_data.append('country_name', country_name);
        form_data.append('keywords_text_search', keywords_text_search);
        form_data.append('Level_select', Level_select);
        form_data.append('Subject_Select', Subject_Select);
        form_data.append('Type_Select', Type_Select);
        form_data.append('Approval_References', Approval_References);
        form_data.append('Year_From', Year_From);
        form_data.append('Year_To', Year_To);
        form_data.append('place_name', place_name);
        form_data.append('draft_file_select', draft_file_select);
        UserLog(form_data)

    }


    // Documents Information Result
    function showDocumentInformation(document_list) {
        let index = 1;
        let document_result = []
        SearchResultValue = document_list;
        let document_actors_frequencies = {}

        for (let document_info of document_list) {

            const id = document_info['id']
            const name = document_info['name']
            let keywords = document_info['keywords']
            const keywords_count = document_info['keywords_count']
            const approval_reference = document_info['approval_reference']
            const approval_date = document_info['approval_date']
            const document_actors = document_info['actors']

            const document_link = 'http://' + location.host + "/document_profile/?id=" + id
            const doc_name = '<a target="_blank" href="' + document_link + '">' + name + "</a>"

            const detail_function = "DetailFunction(" + id + ",'" + keywords + "')";
            const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + ' onclick="' + detail_function + '" data-bs-target="#myModal">جزئیات</button>'

            keywords = keywords.join(' - ');

            motevalian_score = ActorsSimilarityCalc(document_actors['motevalian'], draft_actors['motevalian']);
            hamkaran_score = ActorsSimilarityCalc(document_actors['hamkaran'], draft_actors['hamkaran']);
            salahiat_score = ActorsSimilarityCalc(document_actors['salahiat'], draft_actors['salahiat']);

            document_info['motevalian_score'] = motevalian_score
            document_info['hamkaran_score'] = hamkaran_score
            document_info['salahiat_score'] = salahiat_score

            for (let [actor_type, actors] of Object.entries(document_actors)) {
                selected_actor_type = document_actors[actor_type]

                for (let [actor_name, count] of Object.entries(selected_actor_type)) {

                    if (Object.keys(document_actors_frequencies).includes(actor_name)) {
                        document_actors_frequencies[actor_name] += 1;
                    } else {
                        document_actors_frequencies[actor_name] = 1
                    }
                }

            }



            const row = {
                "id": index, "name": doc_name, "approval_reference": approval_reference, "approval_date": approval_date,
                "motevalian_score": motevalian_score, "hamkaran_score": hamkaran_score, "salahiat_score": salahiat_score, "keywords_count": keywords_count, "keywords": keywords, "detail": detail
            }
            document_result.push(row)
            index += 1
        }

        document.getElementById("DocumentCount").innerText = (document_list.length).toString() + " سند یافت شد.";

        $('#SearchTable').empty();
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                        first: '»',
                        prev:'›',
                        next: '‹',
                        last: '«'
                    }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "سندی یافت نشد.",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "name",
                "title": "نام سند",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "approval_reference",
                "title": "مرجع تصویب",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "approval_date",
                "title": "تاریخ تصویب",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "motevalian_score",
                "title": "درصد شباهت متولیان",
                "style": {
                    "width": "5%"
                }
            },
            {
                "name": "hamkaran_score",
                "title": "درصد شباهت همکاران",
                "style": {
                    "width": "5%"
                }
            },
            {
                "name": "salahiat_score",
                "title": "درصد شباهت ذی‌صلاحان",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "keywords_count",
                "title": "تعداد کلیدواژه‌ها",
                "sorted": true,
                "direction": "DESC",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "keywords",
                "title": "کلیدواژه‌ها",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "detail",
                "title": "مقایسه",
                "style": {
                    "width": "5%"
                }
            }
            ],
            "rows": document_result
        });

        let sorted_doc_actors_frequecies = sortActorsFrequencies(document_actors_frequencies);
        fillActorsFrequenciesTable('documents_actors_table', sorted_doc_actors_frequecies);

        checkFirstActorOfTables('documents_actors_table', 'draft_actors_table');
        createActorsDistributionChartData(sorted_doc_actors_frequecies, sorted_draft_actors_frequecies);

    }

    function ActorsSimilarityCalc(document_actors_dict, draft_actors_dict) {
        cosine_similarity = 0;
        surat = 0;
        makhraj = 0;

        doc_size = 0;
        draft_size = 0;


        if (draft_actors_dict != undefined && document_actors_dict != undefined) {

            // document size
            for (actor in document_actors_dict) {
                actor_score = document_actors_dict[actor];
                doc_size += Math.pow(actor_score, 2);
            }
            doc_size = Math.sqrt(doc_size)

            // draft size
            for (actor in draft_actors_dict) {
                actor_score = draft_actors_dict[actor];
                draft_size += Math.pow(actor_score, 2);
            }
            draft_size = Math.sqrt(draft_size)

            // surat: dot product
            for (actor in document_actors_dict) {
                if (Object.keys(draft_actors_dict).includes(actor)) {

                    surat += document_actors_dict[actor] * draft_actors_dict[actor];

                }


            }

            // makhraj
            makhraj = doc_size * draft_size;

            if (makhraj > 0) {
                cosine_similarity = surat / makhraj;
            }


        }

        cosine_similarity = Math.round(((cosine_similarity * 1000) / 1000) * 100);
        return cosine_similarity;

    }

    function sortDocuments(documents_information_result) {
        documents_dict = {}

        for (let documents of documents_information_result) {
            for (let doc of documents) {
                if (doc['id'] in documents_dict) {
                    documents_dict[doc['id']]['searched_word'] += ('-' + doc['searched_word'])
                    documents_dict[doc['id']]['keywords_count'] += 1
                } else {
                    documents_dict[doc['id']] = doc
                }
            }
        }

        // Create items array
        var sorted_items = Object.keys(documents_dict).map(function (key) {
            return [key, documents_dict[key]['name'], documents_dict[key]['searched_word'], documents_dict[key]['keywords_count'],
                documents_dict[key]['approval_reference'], documents_dict[key]['approval_date'],
                documents_dict[key]['actors']];
        });

        // Sort the array based on the second element
        sorted_items.sort(function (first, second) {
            return second[3] - first[3];
        })
        return sorted_items;
    }


    // Detail Modal
    async function DetailFunction(document_id, text) {

        let request_link = 'http://' + location.host + "/GetKeywordsDetailsExact/" + document_id + "/" + text + "/"
        let response = await fetch(request_link).then(response => response.json());

        /*  Show detail Result */
        let document_paragraphs_result = response["document_paragraphs_result"]
        let preprocess_text = response["preprocess_text"][0]
        let document_name = response["document_name"]

        await showDetailsDataExact(document_id, document_name, document_paragraphs_result, preprocess_text)

    }

    async function showDetailsDataExact(document_id, document_name, paragraphs_list, text) {

        /* Title Text */
        const link = 'http://' + location.host + "/document_profile/?id=" + document_id
        let title_tag = "<a href='" + link + "'>" + document_name + "</a>"
        document.getElementById("document_header").innerHTML = title_tag

        /* Body Text */
        const keywords = text.split(",")

        document.getElementById("DocumentParagraph").innerHTML = "";

        /* Highligth Keywords in Document */
        for (let paragraph of paragraphs_list) {

            for (let keyword of keywords) {

                let tag = "<span class='text-primary bold'>" + keyword + "</span> "

                if (paragraph.startsWith(keyword))
                    paragraph = paragraph.replaceAll(keyword + ' ', tag + ' ');

                paragraph = paragraph.replaceAll(' ' + keyword + ' ', ' ' + tag + ' ');
                paragraph = paragraph.replaceAll(' ' + keyword, ' ' + tag);
            }

            /* Hightlight Approval References in Document */
            $("#ApprovalReferences option").each(function () {
                if ($(this).val() != 0) {

                    let approval_reference = $(this).text().replace('مصوبات ', '');
                    let tag = "<span class='text-warning bold'>" + approval_reference + "</span> "

                    if (paragraph.startsWith(approval_reference))
                        paragraph = paragraph.replaceAll(approval_reference + ' ', tag + ' ');

                    paragraph = paragraph.replaceAll(' ' + approval_reference + ' ', ' ' + tag + ' ');
                    paragraph = paragraph.replaceAll(' ' + approval_reference, ' ' + tag)


                }

            });

            tag = "<li class='mb-3'>" + paragraph + "</li>"
            document.getElementById("DocumentParagraph").innerHTML += tag;

        }


        draft_file_name = $('span#file_name').text().split('.')[0];
        document.getElementById("draft_header").innerHTML = 'پیش‌نویس: ' + draft_file_name;

        /* Highligth All Keywords in Draft */
        document.getElementById("DraftParagraphs").innerHTML = ""
        for (let paragraph of draft_selected_paragraphs) {

            for (let keyword of all_keywords) {

                let tag = "<span class='text-primary bold'>" + keyword + "</span> "

                if (paragraph.startsWith(keyword))
                    paragraph = paragraph.replaceAll(keyword + ' ', tag + ' ');

                paragraph = paragraph.replaceAll(' ' + keyword + ' ', ' ' + tag + ' ');
                paragraph = paragraph.replaceAll(' ' + keyword, ' ' + tag);
            }

            /* Hightlight Approval References in Draft */
            $("#ApprovalReferences option").each(function () {
                if ($(this).val() != 0) {
                    let approval_reference = $(this).text().replace('مصوبات ', '');;
                    let tag = "<span class='text-warning bold'>" + approval_reference + "</span> "

                    if (paragraph.startsWith(approval_reference))
                        paragraph = paragraph.replaceAll(approval_reference + ' ', tag + ' ');

                    paragraph = paragraph.replaceAll(' ' + approval_reference + ' ', ' ' + tag + ' ');
                    paragraph = paragraph.replaceAll(' ' + approval_reference, ' ' + tag)
                }
            });

            tag = "<li class='mb-3'>" + paragraph + "</li>"
            document.getElementById("DraftParagraphs").innerHTML += tag;


        }


        document.getElementById("DraftParagraphs").innerHTML = "<ul>" + document.getElementById("DraftParagraphs").innerHTML + "</ul>";
        let tag2 = ''
        if (draft_file_name != 'فایلی انتخاب نشده‌است') {
            tag2 = '<button id="more_comparison" onclick="more_comparison(' + document_id + ')" type="button" class="btn float-right" data-bs-dismiss="modal">مقایسه بیش‌تر</button>'
        } else {
            tag2 = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button> '
        }

        document.getElementById('modal_footer').innerHTML = (tag2)

    }

    function more_comparison(document_id) {

        const draft_file_name = $('span#file_name').text();
        const country_id = document.getElementById("country").value
        const searched_keywords = all_keywords.toString();

        if (draft_file_name != 'فایلی انتخاب نشده‌است') {
            let link_request = 'http://' + location.host + '/adaptation_comparison/' + country_id + "/" + document_id + "/" + draft_file_name + "/" + searched_keywords + "/";
            window.open(link_request, '_blank');
        }

    }


    // Actor Frequency Table
    async function fillActorsFrequenciesTable(table_container, sorted_actors) {

        show_count = 5
        document.getElementById(table_container).innerHTML = "";

        let local_sorted_actors = sorted_actors;

        while (local_sorted_actors.length < show_count) {

            local_sorted_actors.push(['-', '-'])
        }


        for (let i = 0; i < show_count; i++) {
            const index = i + 1;

            let actor_name = local_sorted_actors[i][0];
            let actor_name_tag = "";
            const actor_frequency = local_sorted_actors[i][1]

            if (index == 1) {
                actor_name_tag = "<td class='col-10 bold text-success'>" + '<i class="bi bi-check bold" style="font-size:25px;position:relative;top:-6px;"></i> ' + actor_name + "</td>"
            } else {
                actor_name_tag = "<td class='col-10'>" + actor_name + "</td>"
            }

            let tag = "<tr>" +
                "<td class='col-1'>" + index + "</td>" +
                actor_name_tag +
                "<td class='col-1'>" + actor_frequency + "</td>"
            "</tr>";


            document.getElementById(table_container).innerHTML += tag;
        }

    }

    async function checkFirstActorOfTables(document_table, draft_table) {
        doc_td_selector = '#' + document_table + ' tr:first-child';
        document_first_actor = $(doc_td_selector).children().eq(1).text();


        draft_td_selector = '#' + draft_table + ' tr:first-child';
        draft_first_actor = $(draft_td_selector).children().eq(1).text();

        doc_actor_name_tag = "";
        draft_actor_name_tag = "";


        if (document_first_actor == draft_first_actor) {
            doc_actor_name_tag = '<i class="bi bi-check bold" style="font-size:25px;position:relative;top:-6px;"></i> ' + document_first_actor
            draft_actor_name_tag = '<i class="bi bi-check bold" style="font-size:25px;position:relative;top:-6px;"></i> ' + draft_first_actor


            $(doc_td_selector).children().eq(1).attr('class', 'col-10 bold text-success')
            $(doc_td_selector).children().eq(1).html(doc_actor_name_tag);

            $(draft_td_selector).children().eq(1).attr('class', 'col-10 bold text-success')
            $(draft_td_selector).children().eq(1).html(draft_actor_name_tag);

        } else {
            doc_actor_name_tag = '<i class="bi bi-check bold" style="font-size:25px;position:relative;top:-6px;"></i> ' + document_first_actor
            draft_actor_name_tag = '<i class="bi bi-x bold" style="font-size:25px;position:relative;top:-5px;" ></i> ' + draft_first_actor

            $(doc_td_selector).children().eq(1).attr('class', 'col-10 bold text-success')
            $(doc_td_selector).children().eq(1).html(doc_actor_name_tag);

            $(draft_td_selector).children().eq(1).attr('class', 'col-10 bold text-warning')
            $(draft_td_selector).children().eq(1).html(draft_actor_name_tag);
        }


    }

    function sortActorsFrequencies(actors_frequencies) {

        // Create items array
        var sorted_items = Object.keys(actors_frequencies).map(function (key) {
            return [key, actors_frequencies[key]];
        });

        // Sort the array based on the second element
        sorted_items.sort(function (first, second) {
            return second[1] - first[1];
        })


        return sorted_items;

    }


    // Draft Reference Graph
    async function uploadDraftFile(keywords) {

        draft_actors = []
        draft_selected_paragraphs = []
        draft_text = '';

        let form_data = new FormData();

        let draft_file = document.getElementById('DraftFile').files[0]
        let country_id = document.getElementById("country").value
        let keywords_text = keywords.toString()

        form_data.append('keywords', keywords_text);
        form_data.append('draft_file', draft_file);
        form_data.append('country_id', country_id);
        let link_request = 'http://' + location.host + '/UploadDraft/';

        /* Send Request */
        $.ajax({
            url: link_request,
            data: form_data,
            type: 'POST',
            contentType: false,
            processData: false,
            async: false,
            enctype: 'multipart/form-data',

        }).done(function (res) {
            draft_selected_paragraphs = res['selected_paragraphs'];
            draft_text = res['draft_text']
            draft_actors_frequencies = {}
            sorted_draft_actors_frequecies = []

        }).fail(function (res) {

        });


    }

    function createDraftReferencesGraphData(document_name_list, draf_text) {
        let chart_data = []
        let nodes_list = [];
        let edges_list = [];

        let draft_node = { id: 'پیش‌نویس', group: 'draft' }
        nodes_list.push(draft_node);

        for (doc_name of document_name_list) {
            console.log(doc_name);

            if (draft_text.includes(doc_name)) {

                doc_node = { id: doc_name, group: 'document' };
                nodes_list.push(doc_node);

                edge = { from: 'پیش‌نویس', to: doc_name }
                edges_list.push(edge)
            }
        }
        chart_data = { nodes: nodes_list, edges: edges_list }

        showDraftReferencesGraph('reference_graph_container', chart_data)

    }

    function showDraftReferencesGraph(chart_container, chart_data) {
        document.getElementById(chart_container).innerHTML = "";
        var chart = anychart.graph(chart_data);

        let nodes = chart.nodes();
        nodes.normal().fill('#488fb8')
        nodes.normal().height(12);
        nodes.hovered().height(16);
        nodes.selected().height(16);

        chart.nodes().tooltip().format("{%id}");
        chart.edges().tooltip().format(" از:  {%from} \n به:  {%to}");
        chart.edges().tooltip().fontFamily('vazir');
        chart.nodes().tooltip().fontFamily('vazir');



        // configure labels of draft
        let draft = chart.group("draft");
        let document_nodes = chart.group("document");

        draft.normal().shape("diamond");
        draft.hovered().shape("diamond");
        draft.selected().shape("diamond");

        draft.normal().height(30);
        draft.hovered().height(35);
        draft.selected().height(35);
        // set the fill of nodes in groups
        draft.normal().fill("#ffa000");
        draft.hovered().fill("white");
        draft.selected().fill("#ffa000")

        // set the stroke of nodes in groups
        draft.normal().stroke(null);
        draft.hovered().stroke("#ffa000", 3);
        draft.selected().stroke("#333333", 3);

        draft.labels().enabled(true);
        draft.labels().format("{%id}").fontFamily('vazir');
        draft.labels().fontSize(14);
        draft.labels().fontWeight(600);

        if (document_nodes != undefined) {


            document_nodes.labels().enabled(true);
            document_nodes.labels().format("{%id}").fontFamily('vazir');
            document_nodes.labels().fontSize(14);
            document_nodes.labels().fontWeight(600);

        }


        chart.edges().arrows({
            enabled: true,
            size: 10,
            position: '50%'
        });

        chart.container(chart_container)
        chart.draw();

    }


    // Actors Graph
    async function showActorsGraph(chart_container, chart_data, documents_id_text) {

        document.getElementById(chart_container).innerHTML = ''
        // create a chart and set the data
        var chart = anychart.graph(chart_data);

        // set the container id
        chart.container(chart_container);

        // configure labels of keywords
        let keywords = chart.group("keywords");
        let actors = chart.group("actors");


        keywords.normal().shape("diamond");
        keywords.hovered().shape("diamond");
        keywords.selected().shape("diamond");

        keywords.normal().height(30);
        keywords.hovered().height(35);
        keywords.selected().height(35);
        // set the fill of nodes in groups
        keywords.normal().fill("#16b2f5");
        keywords.hovered().fill("white");
        keywords.selected().fill("#16b2f5")

        // set the stroke of nodes in groups
        keywords.normal().stroke(null);
        keywords.hovered().stroke("#16b2f5", 3);
        keywords.selected().stroke("#333333", 3);

        keywords.labels().enabled(true);
        keywords.labels().format("{%id}").fontFamily('vazir');
        keywords.labels().fontSize(14);
        keywords.labels().fontWeight(600);


        if (actors != undefined) {
            actors.normal().height(35);
            actors.hovered().height(40);
            actors.selected().height(40);
            actors.normal().stroke(null);

            actors.labels().enabled(true);
            actors.labels().format("{%id}").fontFamily('vazir');
            actors.labels().fontSize(14);
            actors.labels().fontWeight(600);
        }

        chart.nodes().tooltip().format("{%id}");
        chart.edges().tooltip().format(" کنش‌گر:  {%from} \n کلیدواژه:  {%to}");
        chart.edges().tooltip().fontFamily('vazir');
        chart.nodes().tooltip().fontFamily('vazir');

        // initiate drawing the chart
        chart.draw();

        chart.listen("mouseOver", function (e) {
            document.body.style.cursor = "pointer";
        });
        chart.listen("mouseOut", function (e) {
            document.body.style.cursor = "auto";
        });

        chart.listen('Click', async function (event) {
            const click_tag = event.domTarget.tag;

            // edge clicked
            if (click_tag["type"] === "edge") {

                edges = chart_data['edges']
                edge_id = parseInt(click_tag['id'].split('_')[1])

                selected_edge = edges[edge_id]
                actor_name = selected_edge['from']
                keyword = selected_edge['to']

                let request_link = 'http://' + location.host + "/GetActorParaphraphsByDocumentsIdActorNameKeyword_Modal/" + documents_id_text + "/" + actor_name + "/" + keyword + "/"
                let response = await fetch(request_link).then(response => response.json());
                let modal_info = response['result_info']

                showEdgeModal(modal_info, actor_name, keyword);

            }

        })
    }

    function showEdgeModal(modal_info, actor_name, keyword) {

        $('#actor_modal_header').text(actor_name)
        $('#keyword_modal_header').text(keyword)
        $('#edge_modal_body').empty();

        let bg_color = 'bg-warning'

        for (info of modal_info) {

            paragraph = info['paragraph'];
            document_name = info['document_name'];
            document_id = info['document_id'];
            document_address = 'http://' + location.host + "/document_profile/?id=" + document_id
            document_link = '<a target = "to_blank" href = "' + document_address + '">' + document_name + ':</a>'

            actor_name = info['actor_name'];
            current_actor_form = info['current_actor_form'];
            actor_type = info['actor_type'];

            doc_tag = '<h6 class="bold">' + document_link + '</h6>'
            document.getElementById('edge_modal_body').innerHTML += doc_tag;

            paragraph = highlightActorsAndKeyword_In_Modal(paragraph, keyword, actor_type, current_actor_form, bg_color);

            paragraph_tag = '<ul> <li dir="rtl" class = "text-right lh-lg">' + paragraph + '</li> </ul>'

            document.getElementById('edge_modal_body').innerHTML += paragraph_tag;


            $('#edge_modal_btn').click();


        }
    }

    function highlightActorsAndKeyword_In_Modal(paragraph, keyword, actor_type, actor_name, bg_color) {
        let window_length = 100;
        if (actor_type == 'متولی اجرا') {

            // highlight motevalian
            for (pattern_keyword of motevali_keywords) {

                let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"
                actor_tag = "<span data-bs-toggle='tooltip' data-bs-placement='top' title = '" + actor_type + "' class='" + bg_color + " text-white rounded px-1'>" + actor_name + "</span>"
                paragraph = paragraph.replaceAll(actor_name + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);



                actor_without_postfix = actor_name.replace(' جمهوری اسلامی ایران', '');
                actor_without_postfix = actor_without_postfix.replace(' ایران', '');
                actor_tag = "<span data-bs-toggle='tooltip' data-bs-placement='top' title = '" + actor_type + "' class='" + bg_color + " text-white rounded px-1'>" + actor_name + "</span>"
                paragraph = paragraph.replaceAll(actor_without_postfix + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
            }


        } else if (actor_type == 'دارای صلاحیت اختیاری') {

            // highlight salahiat
            for (pattern_keyword of salahiat_keywords) {

                let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"
                actor_tag = "<span title = '" + actor_type + "' class='" + bg_color + " text-white rounded px-1'>" + actor_name + "</span>"
                paragraph = paragraph.replaceAll(actor_name + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
            }


        } else {

            /* Highlight pattern keywords and references */
            for (pattern_keyword of hamkaran_keywords) {


                /* Highlight more with actors list */
                let regex = '', result, indices = [];

                if (pattern_keyword == 'با همکاری') {
                    regex = /با همکاری/gi;
                } else {
                    regex = /باهمکاری/gi;
                }

                while ((result = regex.exec(paragraph))) {
                    indices.push(result.index);
                }

                for (const index of indices) {

                    let start_index = (index + pattern_keyword.length);
                    let substring = paragraph.substring(start_index, start_index + window_length);
                    let current_substring = substring;


                    actor_tag = "<span title = '" + actor_type + "' class='" + bg_color + " text-white rounded px-1 reference'>" + actor_name + "</span>"
                    substring = substring.replaceAll(' ' + actor_name + ' ', ' ' + actor_tag + ' ');
                    substring = substring.replaceAll('(' + actor_name + ')', '(' + actor_tag + ')');

                    for (symbol of hamkaran_punctuations) {

                        actor_tag = "<span title = '" + actor_type + "' class='" + bg_color + " text-white rounded px-1 reference'>" + actor_name + "</span>"
                        substring = substring.replaceAll(' ' + actor_name + symbol, ' ' + actor_tag + symbol);

                    }

                    actor_without_affix = actor_name.replaceAll('وزارت ', '').replaceAll('سازمان ', '').replaceAll(' جمهوری اسلامی ایران', '')

                    if (actor_without_affix != 'اطلاعات' && actor_without_affix != 'مجموعه سند' && !substring.includes(actor_name)) {

                        actor_tag = "<span title = '" + actor_type + "' class='" + bg_color + " text-white rounded px-1 reference'>" + actor_name + "</span>"
                        substring = substring.replaceAll(' ' + actor_without_affix + ' ', ' ' + actor_tag + ' ');
                        substring = substring.replaceAll('(' + actor_without_affix + ')', '(' + actor_tag + ')');

                        for (symbol of hamkaran_punctuations) {

                            actor_tag = "<span title = '" + actor_type + "' class='" + bg_color + " text-white rounded px-1 reference'>" + actor_name + "</span>"
                            substring = substring.replaceAll(' ' + actor_without_affix + symbol, ' ' + actor_tag + symbol);

                        }

                    }



                    paragraph = paragraph.replaceAll(current_substring, substring);

                }
                /* Highlight with actors list */
                let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"

                paragraph = paragraph.replaceAll(pattern_keyword, pattern_keyword_tag);

            }


        }

        // highlight keywords
        keyword_tag = '<span class="bg-primary text-white rounded px-1">' + keyword + '</span>'
        paragraph = paragraph.replaceAll(' ' + keyword + ' ', ' ' + keyword_tag + ' ')

        return paragraph;
    }


    // Actors Distribution chart
    async function createActorsDistributionChartData(doc_actors_frequency_list, draft_actors_frequency_list) {
        total_dict = {}
        let index = 0;
        let column_count = 5;

        for (actor of doc_actors_frequency_list) {

            console.log(actor[0], actor[1]);
            actor_name = actor[0];
            actor_count = actor[1];

            if (actor_name != "-") {

                let temp_array = [];
                temp_array.push(actor_count);
                temp_array.push(0);
                total_dict[actor_name] = temp_array;
                index += 1;
            }
            if (index >= column_count) {
                break;
            }


        }

        index = 0;
        for (actor of draft_actors_frequency_list) {

            console.log(actor[0], actor[1]);
            actor_name = actor[0];
            actor_count = actor[1];


            if (actor_name != "-") {

                if (Object.keys(total_dict).includes(actor_name)) {

                    total_dict[actor_name][1] += actor_count;

                } else {
                    let temp_array = [];
                    temp_array.push(0);
                    temp_array.push(actor_count);
                    total_dict[actor_name] = temp_array;
                }


            }

            if (index >= column_count) {
                break;
            }



        }

        data_rows = [];

        for (actor in total_dict) {
            column_data = [actor, total_dict[actor][0], total_dict[actor][1]]
            data_rows.push(column_data);
        }

        showActorsDistributionChart('actors_chart_container', data_rows, 'توزیع کنشگران' );


    }

    async function showActorsDistributionChart(chart_container, chart_data, xAxisTitle) {

        document.getElementById(chart_container).innerHTML = ""
        // create a data set
        var data = anychart.data.set(chart_data);

        // map the data
        var document_series_data = data.mapAs({ x: 0, value: 1 });
        var draft_series_data = data.mapAs({ x: 0, value: 2 });


        // create a chart
        var chart = anychart.column();

        chart
            .animation(true)
            .padding([80, 60, 10, 0])
        // .padding([10, 60, 10, 0])

        chart.background().fill('#ffffff');


        // x axix labels font setting
        var xAxisLabels = chart.xAxis().labels();
        xAxisLabels.fontFamily("vazir");
        xAxisLabels.rotation(315);

        var yAxisLabels = chart.yAxis().labels();
        yAxisLabels.fontFamily("vazir");

        // Not allow labels overlapping
        var xAxis = chart.xAxis();
        xAxis.overlapMode("noOverlap");
        xAxis.title(xAxisTitle);
        xAxis.title().fontFamily('vazir');
        xAxis.title().fontWeight("bold");
        xAxis.title().height(40);

        var xLabels = chart.xAxis().labels();



        var yAxis = chart.yAxis();
        yAxis.title("تعداد پاراگراف");
        yAxis.title().fontFamily('vazir');
yAxis.title().fontWeight("bold");
        yAxis.title().height(40);


        chart.yScale().minimum(0);
        chart.yScale().ticks().allowFractional(false);
        // tooltip content font setting
        var tooltip = chart.tooltip();
        tooltip.fontFamily("vazir");

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir");


        // set the container id
        chart.container(chart_container);


        // create the second series, set the data and name
        var draft_series = chart.column(draft_series_data);
        draft_series.normal().stroke("#28a745", 0);

        // configure the visual settings of the second series
        draft_series.normal().fill("#ffc107");

        draft_series.name("پیش‌نویس");


        // create the first series, set the data and name
        var document_series = chart.column(document_series_data);

        // configure the visual settings of the first series
        document_series.normal().fill("#28a745");
        document_series.normal().stroke("#28a745", 0);
        document_series.name("اسناد");

        // enable the legend
        chart.legend(true);

        var legend = chart.legend();
        legend.fontFamily('vazir')

        // set position mode
        legend.positionMode("inside");
        // set position and alignement
        legend.position("top");
        legend.align("center");
        legend.itemsLayout("horizontalExpandable");
        // initiate drawing the chart
        chart.draw();

        // local_sorted_actors.push(['-', '-'])
    }

    async function SpinnerModeFunction(mode) {
        if (mode === "Active") {
            $(".spinner-border").addClass("active");
        } else if (mode === "Disable") {
            $(".spinner-border").removeClass("active");
        }
    }


</script>


<!-- Downlaod/Export buttons script -->
<script>

    async function downloadFiles(file_name_list, save_file_name) {
        startFullPageBlockUI()
        const country_id = document.getElementById("country").value

        let zip = new JSZip()

        const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["country_information"][0]
        const country_folder = response["folder"];
        const country_name = response["name"];

        save_file_name += " مجموعه سند {" + country_name + "}"


        let extension = ".txt"
        if (country_name.includes("فاوا")) {
            extension = '.docx';
        }


        for (const document of file_name_list) {
            const document_name = document['name'] + extension

            const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

            await fetch(path)
                .then(res => res.arrayBuffer())
                .then(value => {
                    zip.file(document_name, value);
                })
        }
        zip.generateAsync({
            type: "blob"
        })
            .then(function (content) {
                // see FileSaver.js
                saveAs(content, save_file_name + ".zip");
            });
        stopFullPageBlockUI( 'دانلود اسناد');
    }

    async function DownloadSerachResultFunction() {
        const save_file_name = "نتیجه جستجو {" + document.getElementById("KeywordsBox").value + "}"
        downloadFiles(SearchResultValue, save_file_name)
    }

    async function ExportExcelSerachResultFunction() {
        var csv = "";

        sep = ","


        let Csv = "نام سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + sep +
            "تعداد کلیدواژه‌ها" + sep + "کلیدواژه‌ها" + sep + "درصد شباهت متولیان" +
            sep + "درصد شباهت همکاران" + sep + "درصد شباهت ذی‌صلاحان" + "\n"

        for (const document of SearchResultValue) {
            Csv += document['name'] + sep + document['approval_reference'] + sep + document['approval_date'] + sep +
                document['keywords_count'] + sep + document['keywords'].join(' / ') + sep + document['motevalian_score'] + sep + document['hamkaran_score'] + sep + document['salahiat_score'] + "\n"

        }

        let save_file_name = "نتیجه جستجو {" + document.getElementById("KeywordsBox").value + "}"
        save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"

        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
        var link = document.createElement("a");
        link.setAttribute("href", csvContent);
        link.setAttribute("download", save_file_name + ".csv");
        document.body.appendChild(link);
        link.click()
    }

    /* Search after press Enter */
    $("#info_form").submit(function() {return false;});
    $("#KeywordsBox").keyup(function (event) {
        if (event.keyCode === 13) {
            ShowResult()
        }
    });

</script>

<script src="../../static/js/tooltip_handler.js"></script>

<!-- Intro Js -->
<script src="../../static/js/adaption/adaption_tour.js">
</script>
<script src="../../static/js/tour.js"></script>




<!-- <script src="../../static/js/UserLogSave.js"></script>-->
<script src="../../static/js/signout_function.js"></script>


<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">


</html>