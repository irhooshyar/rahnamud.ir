<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>


    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">

    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>


    <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../static/js/multiselect/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../static/js/multiselect/jquery.multi-select.js"></script>

    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <link rel="stylesheet" href="../../static/styles/index2.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">


    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <meta charset="UTF-8">
    <title>تحلیل نسخ، ابطال، الغا قوانین</title>
    {% include "doc/title_icon.html" %}

    <style>
        .popover-header,
        .popover-body {
            direction: rtl;
            text-align: right;
            font-family: vazir;
        }
    </style>
</head>

<body>

    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <!-- Intro Js -->
    <script src="../../static/js/search/search_tour.js"></script>
    <script src="../../static/js/tour.js"></script>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#SepecificDropdown').addClass('active');
            $('#Cancellationـanalysis_panel').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>

    <div class="row p-5 flex-row-reverse bg-light mx-0 mt-5">
        <form id="subject_analysis_form" action="" class="custom-control mx-auto needs-validation"
            enctype="multipart/form-data" method="post" novalidate>

            <div class="row flex-row-reverse mx-auto">

                <!-- Country select -->
                <div class="col-md-6 col-12 col-lg-2 bg-light pt-3  mt-1">
                    <label for="country" class=" text-right bg-light float-right">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country" class="form-select text-right float-right"
                        onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>

                </div>

                <!-- Show button -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right mt-1 mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        نمایش
                    </button>
                </div>

            </div>
        </form>

        <ul id="original_tabs" class="nav nav-pills  mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
            role="tablist">

            <li class="nav-item float-right" role="presentation">
                <button id="result_doc" class="nav-link active" data-bs-toggle="pill"
                    data-bs-target="#result_doc_subject" type="button" role="tab" aria-controls="result_doc_subject"
                    aria-selected="true">نتایج جست‌وجو</button>
            </li>


            <li class="nav-item float-right" role="presentation">
                <button id="bar_chart_info_tab" class="nav-link" data-bs-toggle="pill"
                    data-bs-target="#bar_chart_info_pane" type="button" role="tab" aria-controls="bar_chart_info_pane"
                    aria-selected="false">اطلاعات گرافی</button>
            </li>

            <!-- Download Buttons -->
            <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                type="button">
                <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

            </button>

            <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()" type="button">
                <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
            </button>

            <!-- Result Count -->
            <p dir="rtl" id="SearchResultLable" class="text-left float-left text-secondary pl-2"></p>
        </ul>

        <div id="original_pane" class="tab-content float-right bg-white px-1" style="position: relative;"
            id="pills-tabContent">

            <div dir=rtl id="result_doc_subject" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                aria-labelledby="result_doc_subject">
                <div class="table-responsive mt-4">
                    <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                    </table>
                </div>
            </div>


            <!-- Bar chart Info Pane -->
            <div dir="rtl" class="tab-pane fade float-right w-100" id="bar_chart_info_pane" role="tabpanel"
                aria-labelledby="bar_chart_info_tab">

                <div class="row mt-4 w-100 flex-row-reverse mx-0 px-0">
                    <div class="col-md-4 px-4 col-12 col-lg-12 p-3 border">
                        <!-- Document Subject  segment -->
                        <h5 class="document_subject w-100 mt-4 text-center float-right pt-3 pb-3">
                            موضوع سند
                        </h5>
                        <br>
                        <div style="margin-left: 1px !important;" id="subject_container"
                            class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                        </div>
                    </div>
                    <div class="col-md-4 px-4 col-12 col-lg-12 p-3 border">
                        <!-- Document Level segment -->
                        <h5 class="document_level w-100 mt-4 text-center float-right pt-3 pb-3">
                            سطح سند
                        </h5>
                        <br>
                        <div id="level_container"
                            class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                        </div>
                    </div>
                    <div class="col-md-4 px-4 col-12 col-lg-12 p-3 border">
                        <!-- Document Level segment -->
                        <h5 class="document_level w-100 mt-4 text-center float-right pt-3 pb-3">
                            سال تصویب
                        </h5>
                        <br>
                        <div id="year_container" class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                        </div>
                    </div>
                    <div class="col-md-4 px-4 col-12 col-lg-12 p-3 border">
                        <!-- Extracted References segment -->
                        <h5 class="extractected_references w-100 mt-4 text-center float-right pt-3 pb-3">
                            مراجع تصویب
                        </h5>
                        <br>
                        <div id="approval_container"
                            class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                        </div>
                    </div>
                </div>
            </div>

        </div>



    </div>


    <!-- Modal Container -->
    <div class="modal fade" id="detailModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="detailModalHeader" class="modal-title">عنوان سند</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="detailModalBody" class="modal-body text-justify">

                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>

            </div>
        </div>
    </div>

    <!-- ChartModal Container -->
    <button type="button" id="ChartModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#ChartModal"></button>
    <div class="modal fade" id="ChartModal">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ChartModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ChartModalText" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->


                <!-- Modal footer -->
                <div dir="rtl" class="modal-footer">
                    <button id="DownloadDocuments" class="btn btn-primary"><i class="fa fa-download"></i> دانلود
                        اسناد</button>

                    <button id="ExportExcel2" class="btn btn-primary"><i class="fa fa-download"></i> خروجی اکسل
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>


    <script src="../../static/js/scroll_button_handler.js"></script>

    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>




    <!-- Export results -->

    <script>

        async function downloadFiles(file_name_list, save_file_name) {
            startFullPageBlockUI()
            const country_id = document.getElementById("country").value

            let zip = new JSZip()

            const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["country_information"][0]
            const country_folder = response["folder"];
            const country_name = response["name"];

            save_file_name += " مجموعه سند {" + country_name + "}"


            let extension = ".txt"
            if (country_name.includes("فاوا")) {
                extension = '.docx';
            }

            // file_name_list = documents_information_dict
            for (const [doc_id, doc_info] of Object.entries(file_name_list)) {

                const document_name = doc_info['name'] + extension

                const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

                await fetch(path)
                    .then(res => res.arrayBuffer())
                    .then(value => {
                        zip.file(document_name, value);
                    })
            }
            zip.generateAsync({
                type: "blob"
            })
                .then(function (content) {
                    // see FileSaver.js
                    saveAs(content, save_file_name + ".zip");
                });
            stopFullPageBlockUI( 'دانلود اسناد');
        }

        async function DownloadSerachResultFunction() {
            const save_file_name = "پنل تحلیل درگاه: "
            downloadFiles(SearchResultValue, save_file_name)
        }

        async function ExportExcelSerachResultFunction() {
            var csv = "";

            sep = ","


            let Csv = "نام سند" + sep + "موضوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + sep + "کلمات کلیدی" +
                "\n"
            for (const [doc_id, doc_info] of Object.entries(SearchResultValue)) {
                const document_name = doc_info["name"]
                const document_subject = doc_info['subject']
                const document_approval_reference = doc_info['approval_reference']
                const document_approval_date = doc_info['approval_date']
                const document_keyword = doc_info['keyword'].join(' - ')


                Csv += document_name + sep + document_subject + sep + document_approval_reference +
                    sep + document_approval_date +
                    sep + document_keyword + "\n"

            }

            let save_file_name = "پنل تحلیل درگاه: "
            save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"

            let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
            var link = document.createElement("a");
            link.setAttribute("href", csvContent);
            link.setAttribute("download", save_file_name + ".csv");
            document.body.appendChild(link);
            link.click()
        }

    </script>


</body>

<!-- BS Tooltips handler -->
<script src="../../static/js/tooltip_handler.js"></script>

<!-- Intro Js -->
<!-- Intro Js -->
<script src="../../static/js/portal/portal_tour.js">
</script>
<script src="../../static/js/tour.js"></script>

<script src="../../static/js/UserLogSave.js"></script>
<script src="../../static/js/signout_function.js"></script>


<script>

    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl)
    });


</script>


<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">

</html>