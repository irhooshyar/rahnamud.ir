<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <!-- commented for dropdown menu hover bug -->
    <!-- <link href="../../static/library/bootstrap-theme.min-3.3.6.css" rel="stylesheet"> -->


    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>


    <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../static/js/multiselect/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../static/js/multiselect/jquery.multi-select.js"></script>

        
    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">

    <meta charset="UTF-8">


    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->
    <script src="../../static/js/chart.js"></script>
    <title>آراء دیوان عدالت اداری</title>
    {% include "doc/title_icon.html" %}

</head>

<body>
    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#ApprovalsDropdown').addClass('active');
            $('#judgment_search1').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>

    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">

        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" autocomplete="off" novalidate>

            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mx-auto">

                <!-- Country Input -->
                <div class="col-md-6 pt-3 col-12 col-lg-2 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;" onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>

                </div>


                <!-- Search Box input -->
                <div class="col-md-6 pt-3 col-12 col-lg-4 bg-light">
                    <label class="float-right" style="direction: rtl;">عبارت مورد نظر:</label>
                    <input style="direction: rtl;" class="float-left form-control text-right"
                        placeholder="متن جست‌وجو ..." type="text" required="" name="SearchBox" id="SearchBox" value="">
                </div>

                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button id="advanced_search" type="button" class="btn float-right" data-bs-toggle="collapse"
                        data-bs-target="#advanced_fields" aria-expanded="true" aria-controls="advanced_fields">تنظیمات
                        پیشرفته</button>
                    <button type="button" id="document_search" onclick="NewSearch()"
                        class="btn d-flex float-right mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        جست‌وجو
                    </button>
                </div>

            </div>

            <!-- Advanced Fields in Second Row -->
            <div id="advanced_fields" class="collapse show row flex-row-reverse mx-auto mt-4">

                <!-- Conclusion Display Name -->
                <!-- <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">نتیجه رسیدگی:</label>
                    <select id="ConclusionDisplayNameSelect" class="form-select text-right float-right"
                        style="direction: rtl;">
                    </select>

                </div> -->

                <!-- Subject Type Display Name -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> نوع پرونده:</label>
                    <select id="SubjectTypeDisplayNameSelect" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                    </select>

                </div>

                <!-- Judgment Type -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> مرجع صدور رأی:</label>

                    <select id="JudgmentTypeSelect" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- Categories -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> دسته بندی:</label>

                    <select id="CategoriesSelect" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                    </select>

                </div>

                <!-- Judge Name -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> قاضی:</label>

                    <select id="JudgeNameSelect" class="form-select searchable-select text-right float-right searchable-select"
                        style="direction: rtl;">
                    </select>

                </div>

                <!-- From Year input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> سال صدور از:</label>

                    <select id="YearFrom" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- To Year input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class="text-right bg-light float-right" style="direction: rtl;;"> سال صدور تا:</label>

                    <select id="YearTo" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- Document Type -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">در:</label>

                    <select id="WhereSelect" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                        <option value="عنوان یا متن">عنوان یا متن</option>
                        <option value="عنوان" selected>عنوان</option>
                        <option value="متن">متن</option>
                        <option value="شماره دادنامه">شماره دادنامه</option>

                    </select>

                </div>

                <!-- Match Type -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> نوع جستجو:</label>

                    <select id="SearchTypeSelect" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                        <option selected value="exact">دقیقا (Exact)</option>                        
                        <option value="and">و (And)</option>
                        <option value="or">یا (OR)</option>
                    </select>

                </div>

            </div>

        </form>
        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">نتایج جست‌وجو</button>
                </li>
                <!--
                <li class="nav-item float-right" role="presentation">
                    <button id="terms_graph_tab" class="nav-link" data-bs-toggle="pill" data-bs-target="#terms_graph_pane" type="button" role="tab" aria-controls="terms_graph_pane" aria-selected="false">گراف کلمات</button>
                </li>
                -->
                <li class="nav-item float-right" role="presentation">
                    <button id="bar_chart_info_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#bar_chart_info_pane" type="button" role="tab"
                        aria-controls="bar_chart_info_pane" aria-selected="false">داشبورد آماری</button>
                </li>
                <!-- <li class="nav-item float-right" role="presentation">
                    <button id="document_graph_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#document_graph_pane" type="button" role="tab"
                        aria-controls="document_graph_pane" aria-selected="false">گراف ارجاعات</button>
                </li>
                <li class="nav-item float-right definition_keywords_class" role="presentation">
                    <button id="definition_keywords_graph_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#definition_keywords_graph_pane" type="button" role="tab"
                        aria-controls="definition_keywords_graph_pane" aria-selected="false">گراف کلیدواژگان
                        تعاریف</button>
                </li> -->



                <!-- Result Count -->
                <p id="SearchResultLable" class="text-left float-left text-secondary pl-2"></p>
            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">


                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                    aria-labelledby="search_result_tab">
                    <!-- Table Headers -->
                    <div class="mt-4">
                        <!-- Column Selection -->
                        <p id="ColumnSelection" class="text-left text-secondary float-right">فهرست براساس:</p>


                        <!-- Column select -->
                        <div class="col-md-6 col-12 col-lg-2 float-right">

                            <select id="ColumnSelect" onchange="show_table_result();"
                                class="form-select text-right float-right searchable-multi-select" style="direction: rtl;">

                            </select>

                        </div>


                        <div class="float-left">
                            <!-- Download Buttons -->
                            <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                                    class="btn float-left p-0 px-1 mt-2" id="DownloadBtn"
                                    onclick="DownloadSerachResultFunction()"
                                    type="button">
                                <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

                            </button>

                            <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                                    data-bs-placement="top" title="خروجی اکسل"
                                    onclick="ExportExcelSerachResultFunction()"
                                    type="button">
                                <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                            </button>
                        </div>

                        <!-- Page select -->
                        <div class="col-md-6 col-12 col-lg-2 float-left">

                            <input type="number" disabled ="true" onchange="TablePaginationChanged(event)" id="TablePaginationInput" min="1" max="1" value="1"
                            class="form-select text-right float-right" style="direction: rtl;">

                        </div>


                        <!-- Result Pagination -->
                        <p id="ResultPagination" class="text-left text-secondary float-left">صفحه:
                            <span id="from_page">1</span>
                            /
                            <span id="total_page">1</span>
                        </p>

                    </div>
                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                        </table>
                    </div>

                </div>

                <!-- Bar chart Info Pane -->
                <div dir="rtl" style="min-height: 200px;" class="tab-pane fade float-right w-100"
                    id="bar_chart_info_pane" role="tabpanel" aria-labelledby="bar_chart_info_tab">

                    <div class="row mt-4 w-100 flex-row-reverse justify-content-around mx-0 px-0">
                        <!-- <div class="col-md-4 px-4 col-12 col-lg-12 p-3 border">
                            <h5 class="document_conclusion_display_name w-100 mt-4 text-center float-right pt-3 pb-3">
                                نتیجه رسیدگی
                            </h5>
                            <br>
                            <div style="margin-left: 1px !important;" id="conclusion_display_name_container"
                                class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                            </div>
                        </div> -->

                        <div id="subject_type_display_name_container" class="half">
                        </div>

                        <div id="judgment_type_container" class="half">
                        </div>

                        <div id="year_container" class="half" chart-height="550px">
                        </div>

                        <div id="judge_name_container" class="half" chart-height="550px">
                        </div>

                        <div id="complaint_from_container" class="full" chart-height="2000px">
                        </div>


                        {% comment %} <div class="col-md-4 px-4 col-12 col-lg-12 p-3 border">
                            <!-- Document Categories segment -->
                            <h5 class="document_categories w-100 mt-4 text-center float-right pt-3 pb-3">
                                دسته بندی
                            </h5>
                            <br>
                            <div id="categories_container"
                                class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                            </div> {% endcomment %}
                        </div>
                    </div>

                    <!--  Document Graph Pane -->
                    <div class="tab-pane fade show float-right w-100" id="document_graph_pane" role="tabpanel"
                        aria-labelledby="document_graph_tab">
                        <div class="row mt-4 w-100 flex-row-reverse  mx-auto pb-5 px-4">
                            <!-- doc colors -->
                            <ul id="ColorBox"
                                class="list-group flex-row-reverse list-unstyled w-100 list-group-horizontal text-right">
                            </ul>
                            <script src="../../static/js/graph/color_picker_handler.js">
                            </script>
                            <div id="advanced_graph_container" class="w-100 border mt-1" style="height:500px;">
                            </div>
                        </div>
                    </div>

                    <!--  Definition Keywords Graph Pane -->
                    <div class="tab-pane fade show float-right w-100" id="definition_keywords_graph_pane"
                        role="tabpanel" aria-labelledby="definition_keywords_graph_tab">
                        <!-- keyword graph container -->
                        <div class="row mt-4 w-100 flex-row mx-0 px-4 pb-5">

                            <div id="definition_keywords_graph_container" class="w-100 border" style="height: 500px;">
                            </div>
                        </div>
                    </div>


                </div>

            </div>


        </div>

        <!-- EdgeModal Container -->
        <button type="button" id="EdgeModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
            data-bs-target="#EdgeModal"></button>
        <div class="modal fade" id="EdgeModal">
            <div class="modal-dialog modal-dialog-scrollable modal-lg">
                <div class="modal-content">

                    <!-- Modal Header -->
                    <div style="direction: rtl !important;" class="modal-header">
                        <h5 id="EdgeModalHeader" class="modal-title"></h5>
                        <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                    </div>

                    <!-- Modal body -->
                    <div id="EdgeModalText" class="modal-body text-justify">
                    </div>

                    <!-- Modal footer -->
                    <div dir="rtl" class="modal-footer">

                    </div>

                </div>
            </div>
        </div>


        <!-- Modal Container -->
        <div class="modal fade" id="myModal">
            <div class="modal-dialog modal-dialog-scrollable modal-xl">
                <div class="modal-content">

                    <!-- Modal Header -->
                    <div style="direction: rtl !important;" class="modal-header">
                        <h5 id="ModalHeader" class="modal-title">جزئیات سند</h5>
                        <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                    </div>

                    <!-- Modal body -->
                    <!-- Modal body -->
                    <div class="modal-body bg-light text-justify">

                        <h6 id="DocsCount" class='text-secondary'></h6>

                        <div id="DetailText" class="bg-light text-justify mx-2 h-100">
                        </div>

                        <!-- <button id="LoadMoreDocuments" class="btn btn-white w-100 mb-1 float-left" style="color: #0e3f8b"><i
                                class="fa fa-plus pl-2" style="position:relative;top:3px;"></i>نمایش بیش‌تر</button> -->

                    </div>


                    <!-- Modal footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- ChartModal Container -->
        <button type="button" id="ChartModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
            data-bs-target="#ChartModal"></button>
        <div class="modal fade" id="ChartModal">
            <div class="modal-dialog modal-dialog-scrollable modal-lg">
                <div class="modal-content">

                    <!-- Modal Header -->
                    <div style="direction: rtl !important;" class="modal-header">
                        <h5 id="ChartModalHeader" class="modal-title">عنوان</h5>
                        <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                    </div>

                    <!-- Modal body -->
                    <div id="ChartModalText" class="modal-body text-justify">
                    </div>

                    <!-- Modal footer -->
                    <div dir="rtl" class="modal-footer">
                        <button id="DownloadDocuments" class="btn btn-primary"><i class="fa fa-download"></i> دانلود
                            اسناد</button>

                        <button id="ExportExcel2" class="btn btn-primary"><i class="fa fa-download"></i> خروجی اکسل
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- ActorChartModal Container -->
        <button type="button" id="actors_modal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"
            data-bs-target="#actors_modal"></button>
        <div class="modal fade" id="actors_modal">
            <div class="modal-dialog modal-dialog-scrollable modal-xl">
                <div class="modal-content">

                    <!-- Modal Header -->
                    <div style="direction: rtl !important;" class="modal-header">
                        <h5 id="actor_modal_header" class="modal-title">عنوان</h5>
                        <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                    </div>
                    <!-- Modal body -->

                    <div class="bg-light modal-body text-justify">
                        <div class="highlight_options mt-0 p-0 float-left" style="z-index: 13;">
                            <button onclick="showOtherActors()" data-bs-toggle="tooltip" data-bs-placement="right"
                                title="نمایش سایر کنشگران" class="btn border float-left m-0  px-1"><i
                                    style="font-size: 24px;" class="bi text-primary bi-people-fill"></i></button>
                            <!-- <button class="btn float-left m-0  px-1"><i style="font-size: 24px;" class="bi text-success bi-hourglass-split"></i></button> -->
                        </div>
                        <br>
                        <div id="actor_modal_body" class="bg-light text-justify">

                        </div>
                    </div>
                    <!-- Modal footer -->
                    <div id="modal_footer" class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Scrollbar -->
        <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
            <i class="far fa-caret-square-up"></i>
            <!-- <i class="bi bi-chevron-up"></i> -->
            <!-- <i class="bi bi-chevron-double-up"></i> -->
            <!-- <i class="bi bi-arrow-up-circle"></i> -->
        </button>


        <!-- Toast -->
        <div class="position-absolute top-0 start-50 translate-middle p-3" style="z-index: 11;margin-top:95px;">
            <div dir="rtl" id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-body">
                    <button type="button" class="btn-close float-left ml-0" data-bs-dismiss="toast"
                        aria-label="Close"></button>
                    <i style="position: relative; top: -4px; font-size: 18px;"
                        class="bi bi-info-circle-fill  text-info"></i>
                    <span id="toast_message">
                    </span>
                </div>
            </div>
        </div>


        <script src="../../static/js/logincheck.js"></script>

        <script src="../../static/js/scroll_button_handler.js">
        </script>
        <!-- Intro Js -->
        <script src="../../static/js/search/search_tour.js"></script>
        <script src="../../static/js/tour.js"></script>


        <!-- Blocking UI -->
        <script src="../../static/js/blockUI.js"></script>
        <script src="../../static/js/blockUI_handler.js"></script>
        <link rel="stylesheet" href="../../static/styles/loader.css">

        <script src="../../static/js/column.js"></script>

        <script>

            CHART_FIELD_DICT = {
                "subject_type_display_name_container": "subject_type_display_name",
                "year_container": "judgment_year",
                "judgment_type_container": "judgment_type",
                "complaint_from_container": "complaint_from",
                "judge_name_container":"judge_name"
            }
            CHART_NAME_DICT = {
                "subject_type_display_name_container": "نوع پرونده",
                "year_container": "سال دادنامه",
                "judgment_type_container": "مرجع صدور رأی",
                "complaint_from_container": "مشتکی عنه",
                "judge_name_container":"قاضی پرونده",
            }

            const COLUMNS = {
                "judgment_number": "شماره دادنامه",
                "judgment_date": "تاریخ دادنامه",
                "complainant": "شاکی",
                "complaint_from": "مشتکی عنه",
                "subject_type_display_name": "نوع پرونده",
            }
            initSearchableSelects();
            append_column(COLUMNS)
            init()

            SearchResultValue = []
            ES_SearchResult = []
            TABLE_INFO = []
            MAX_RESULT_WINDOW = 5000
            SEARCH_RESULT_SIZE = 500

            judgement_keywords = [
                'مغایر',
                'بر خلاف',
                'برخلاف',
                'خارج از حدود اختیار',
                'خروج از صلاحیت',
                'خارج از صلاحیت',
                'طبق',
                'براساس',
                'مستند به',
                'وفق',
                'به موجب',
                'به استناد',
                'با عنایت به اینکه',
                'بر اساس',
                'مطابق',
                'به استنثناء'
            ]

            judgement_highlight_list = [
                'تاریخ',
                'شماره دادنامه',
                'تاریخ دادنامه',
                'کلاسه پرونده',
                'شماره پرونده',
                'مرجع رسیدگی',
                'شاکی',
                'شاکیان',
                'طرف شکایت',
                'موضوع شکایت و خواسته',
                'گردش کار',
                'مقدمه',
                '‌رای هیات',
                'رأی هیأت عمومی',
                'رأی هیأت خصوصی',
                'رای هیأت خصوصی',
                'رای هیات عمومی'
            ]
            container_id_list = ['SearchResultLable', 'SearchTable',
                'advanced_graph_container', 'definition_keywords_graph_container']

            function clearPrevResults(container_id_list) {

                for (container_id of container_id_list) {
                    document.getElementById(container_id).innerHTML = "";
                }
            }

            async function init() {
                const country_id = document.getElementById("country").value
                startFullPageBlockUI();

                let request_link = 'http://' + location.host + "/GetJudgmentSearchParameters/" + country_id + "/";
                let response = await fetch(request_link).then(response => response.json());
                response = response["parameters_result"]

                /****************** Level List ****************************/
                // document.getElementById("ConclusionDisplayNameSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                //     response['conclusion_display_name'];

                /****************** Subject List ****************************/
                document.getElementById("SubjectTypeDisplayNameSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                    response['subject_type_display_name'];

                /****************** Type List ****************************/
                document.getElementById("JudgmentTypeSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                    response['judgment_type'];

                /****************** Categories List ****************************/

                document.getElementById("CategoriesSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                    response['categories'];

                /****************** Judge_Name List ****************************/

                document.getElementById("JudgeNameSelect").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                    response['judge_name'];

                /****************** Year List ****************************/
                document.getElementById("YearFrom").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                    response['FromYear'];
                document.getElementById("YearTo").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>" +
                    response['ToYear'];

                syncAllSelectsWithResetExceptions(["country"]);

                //user log
                let form_data = new FormData()
                let detail_type = "نمایش پنل"
                form_data.append('detail_type', detail_type);
                UserLog(form_data)

                stopFullPageBlockUI('مقداردهی اولیه')

            }

            function CountryChanged() {
                init()
            }

            function showDocumentInformation(documents_information_result, mode, where, total_hits, curr_page, text,max_score) {

                SearchResultValue = documents_information_result;

                const search_text = document.getElementById("SearchBox").value;

                document.getElementById("SearchResultLable").innerText = "تعداد کل نتایج: " + total_hits + " سند"
                let index = (curr_page - 1)*SEARCH_RESULT_SIZE + 1;
                let document_result = []
                for (let doc of documents_information_result) {
                    const doc_id = doc['_source']['document_id']
                    var doc_name = doc['_source']['name']
                    const doc_file_name = doc['_source']['document_file_name']
                    const judgement_id = doc['_source']['judgment_id']
                    const judgment_number = doc['_source']['judgment_number']
                    const judgment_date = doc['_source']['judgment_date']
                    const judgment_year = doc['_source']['judgment_year'] != 0 ? doc['_source']['judgment_year'] : 'نامشخص'
                    const complaint_serial = doc['_source']['complaint_serial']
                    const conclusion_display_name = doc['_source']['conclusion_display_name']
                    const subject_type_display_name = doc['_source']['subject_type_display_name']
                    const judgment_type = doc['_source']['judgment_type']
                    const complainant = doc['_source']['complainant']
                    const complaint_from = doc['_source']['complaint_from']
                    const categories = doc['_source']['categories']
                    const affected_document_name = doc['_source']['affected_document_name']

                    let score = Math.round((doc['_score']/max_score) * 100)

                    let button_disable = ""
                    // if (mode === "All") {
                    //     button_disable = "disabled"
                    // }

                    // const detail_function = `DetailFunction('${es_id}', '${name}', '${mode}', '${where}', '${index - 1}')`;
                    const detail_function = `DetailFunction('${doc_id}','${doc_name}','${mode}', '${where}','${text}')`;
                    const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + button_disable + ' onclick="' + detail_function + '" data-bs-target="#myModal">جزئیات</button>'

                    const document_link = 'http://' + location.host + "/document_profile/?id=" + doc_id
                    doc_name = '<a href="' + document_link + '">' + doc_name + "</a>"

                    const row = {
                        "index": index,
                        "doc_id": doc_id,
                        "name": doc_name,
                        "doc_file_name": doc_file_name,
                        "judgment_id": judgement_id,
                        "judgment_number": judgment_number,
                        "judgment_date": judgment_date,
                        "judgment_year": judgment_year,
                        "complaint_serial": complaint_serial,
                        "conclusion_display_name": conclusion_display_name,
                        "subject_type_display_name": subject_type_display_name,
                        "judgment_type": judgment_type,
                        "complainant": complainant,
                        "complaint_from": complaint_from,
                        "categories": categories,
                        "affected_document_name": affected_document_name,
                        "count": score,
                        "detail": detail
                    }
                    document_result.push(row)
                    index += 1
                }
                TABLE_INFO = document_result
                show_table_result()
            }

            async function show_table_result() {
                selected_columns = ["index", "name", "count", "detail"]
                selected_columns = find_selected_column(selected_columns)
                columns = [{
                    "name": "index",
                    "title": "ردیف",
                    "breakpoints": "xs sm",
                    "type": "number",
                }, {
                    "name": "name",
                    "title": "نام سند",
                }, {
                    "name": "judgment_number",
                    "title": "شماره دادنامه",
                }, {
                    "name": "judgment_date",
                    "title": "تاریخ دادنامه",
                }, {
                    "name": "complainant",
                    "title": "شاکی",
                }, {
                    "name": "complaint_from",
                    "title": "مشتکی عنه",
                }, {
                    "name": "subject_type_display_name",
                    "title": "نوع پرونده",
                }, {
                    "name": "count",
                    "title": "درصد امتیاز",
                }, {
                    "name": "detail",
                    "title": "جزئیات",
                }]
                if (!selected_columns.includes("all")) {
                    for (let column of columns) {
                        if (selected_columns.includes(column["name"])) {
                            column["visible"] = true
                        } else {
                            column["visible"] = false
                        }
                    }
                }
                
                $('#SearchTable').empty();
                $('.SearchTable').footable({
                    "paging": {
                        "enabled": true,
                        strings: {
                        first: '»',
                        prev:'›',
                        next: '‹',
                        last: '«'
                    }
                    },
                    "filtering": {
                        "enabled": false
                    },
                    "sorting": {
                        "enabled": true
                    },
                    "empty": "سندی یافت نشد.",
                    "columns": columns,
                    "rows": TABLE_INFO
                });
            }

            async function GetDocumentsInformation(country_id, JudgeName, SubjectTypeDisplayName, JudgmentType, Categories, from_year, to_year, place, text, search_type,curr_page) {

                let request_link = '';
                notyf.dismissAll();

                startBlockUI('SearchTable');


                const from_advisory_opinion_count = 0
                const from_interpretation_rules_count = 0
                request_link = 'http://' + location.host + "/SearchJudgment_ES/" + country_id + "/" + JudgeName + "/" +
                    SubjectTypeDisplayName + "/" + JudgmentType + "/" + Categories + "/" + from_year + "/" + to_year + "/" +
                    from_advisory_opinion_count + "/" + from_interpretation_rules_count + "/" + place + "/" + text + "/" + search_type + "/"
                    + curr_page + "/";



                let response = await fetch(request_link).then(response => response.json());

                /*  Show Table Result */
                total_hits = response["total_hits"]
                max_score = response["max_score"]
                curr_page = response["curr_page"]
                ES_SearchResult = response["result"]
                ES_Aggregations = response["aggregations"]

                update_pagination_input(curr_page ,total_hits)


                console.log(ES_SearchResult)
                showDocumentInformation(ES_SearchResult, search_type, place, total_hits, curr_page, text,max_score)
                stopBlockUI('SearchTable', 'نتایج جست‌وجو');


                GetChartData_Es(country_id, text, ES_Aggregations, ES_SearchResult);



                /* Show References Graph */
                startBlockUI('advanced_graph_container');

                await showReferencesGraph(ES_SearchResult)

                stopBlockUI('advanced_graph_container', 'گراف ارجاعات');

            }

            async function update_pagination_input(curr_page,total_hits){
            
            page_count = 0;

            if (total_hits < SEARCH_RESULT_SIZE) {
                page_count = 1

            }else if (total_hits < MAX_RESULT_WINDOW) {
                page_count = Math.ceil(total_hits / SEARCH_RESULT_SIZE)

            }else if (total_hits >= MAX_RESULT_WINDOW){
                page_count = MAX_RESULT_WINDOW / SEARCH_RESULT_SIZE
            }

            document.getElementById("TablePaginationInput").min = 1;
            document.getElementById("TablePaginationInput").max = page_count;
            document.getElementById("TablePaginationInput").value = curr_page;

            document.getElementById("from_page").innerText = curr_page;
            document.getElementById("total_page").innerText = page_count
            
        }



            async function GetChartData_Es(country_id, text, ES_Aggregations, documents_information_result) {

                let request_link = '';
                startBlockUI('bar_chart_info_pane');

                JudgeName_data = ES_Aggregations['judge-name-agg']['buckets']
                SubjectTypeDisplayName_data = ES_Aggregations['subject-type-display-name-agg']['buckets']
                JudgmentType_data = ES_Aggregations['judgment-type-agg']['buckets']
                Categories_data = ES_Aggregations['categories-agg']['buckets']
                judgment_year_data = ES_Aggregations['judgment-year-agg']['buckets']
                ComplaintFrom_data = ES_Aggregations['complaint-from-agg']['buckets']
                doc_ids = []

                for (doc of documents_information_result) {
                    doc_id = doc['_source']['document_id']
                    doc_ids.push(doc_id)
                }


                /* Show Chart  */


                // showChartData(ConclusionDisplayName_data, "conclusion_display_name_container", documents_information_result, false)
                showChartData(SubjectTypeDisplayName_data, "subject_type_display_name_container", documents_information_result, false, "نوع پرونده", "توزیع اسناد براساس نوع پرونده")
                showChartData(judgment_year_data, "year_container", documents_information_result, true, "سال دادنامه", "توزیع اسناد براساس سال دادنامه")
                showChartData(JudgmentType_data, "judgment_type_container", documents_information_result, false, "مرجع صدور رأی", "توزیع اسناد براساس مرجع صدور رای")
                showChartData(ComplaintFrom_data, "complaint_from_container", documents_information_result, false, "مشتکی عنه", "توزیع اسناد براساس مشتکی عنه")
                showChartData(JudgeName_data, "judge_name_container", documents_information_result, false, "قاضی پرونده", "توزیع اسناد براساس قاضی پرونده")

                stopBlockUI('bar_chart_info_pane', 'داشبورد آماری');

            }





            async function SpinnerModeFunction(mode) {
                if (mode === "Active") {
                    $(".spinner-border").addClass("active");
                } else if (mode === "Disable") {
                    $(".spinner-border").removeClass("active");
                }
            }

            async function NewSearch(){
            await update_pagination_input(1,0);
            await ShowResult()
        }

            async function ShowResult() {
                await SpinnerModeFunction("Active");
                document.getElementById('TablePaginationInput').disabled = true;
                // clear previous results
                clearPrevResults(container_id_list);

                await SpinnerModeFunction("Active");

                const country_id = document.getElementById("country").value;
                const SubjectTypeDisplayName = document.getElementById("SubjectTypeDisplayNameSelect").value;
                const JudgmentType = document.getElementById("JudgmentTypeSelect").value;
                const Categories = document.getElementById("CategoriesSelect").value;
                const JudgeName = document.getElementById("JudgeNameSelect").value;
                const from_year = document.getElementById("YearFrom").value;
                const to_year = document.getElementById("YearTo").value;
                const place = document.getElementById("WhereSelect").value;
                let text = document.getElementById("SearchBox").value;
                const search_type = document.getElementById("SearchTypeSelect").value
                const  curr_page = document.getElementById('TablePaginationInput').value

                if (text.trim().length > 0) {
                    text = text.replaceAll('/', '>')
                    text = text.replaceAll('\\', '<')

                    GetDocumentsInformation(country_id, JudgeName, SubjectTypeDisplayName, JudgmentType, Categories, from_year, to_year, place, text, search_type, curr_page);

                } else {
                    GetDocumentsInformation(country_id, JudgeName, SubjectTypeDisplayName, JudgmentType, Categories, from_year, to_year, place, "empty", "All", curr_page);
                }
                if (place == 'تعاریف') {
                    $('#definition_keywords_graph_tab').show();
                    const request_link = 'http://' + location.host + "/SearchGeneralDocumentsDefinition/" + country_id + "/" + search_type + "/" + text + "/"
                    const response = await fetch(request_link).then(response => response.json());

                    createKeywordsGraphData(response['keywords_information']);

                } else {
                    $('#definition_keywords_graph_tab').hide();

                }

                document.getElementById('TablePaginationInput').disabled = false;
                await SpinnerModeFunction("Disable");

                //user log
                let form_data = new FormData()
                let detail_type = "نتایج جست و جو"
                let country_name = $("#country option:selected").text();
                let search_text = text
                let JudgmentType_doc = $("#JudgmentTypeSelect option:selected").text();
                let SubjectTypeDisplayName_doc = $("#SubjectTypeDisplayNameSelect option:selected").text();
                let Categories_doc = $("#CategoriesSelect option:selected").text();
                let JudgeName_doc = $("#JudgeNameSelect option:selected").text();
                let YearFrom_doc = $("#YearFrom option:selected").text();
                let YearTo_doc = $("#YearTo option:selected").text();
                let place_doc = $("#WhereSelect option:selected").text();
                let SearchType_doc = $("#SearchTypeSelect option:selected").text();
                form_data.append('detail_type', detail_type);
                form_data.append('country_name', country_name);
                form_data.append('search_text', search_text);
                form_data.append('JudgmentType_doc', JudgmentType_doc);
                form_data.append('SubjectTypeDisplayName_doc', SubjectTypeDisplayName_doc);
                form_data.append('Categories_doc', Categories_doc);
                form_data.append('JudgeName_doc', JudgeName_doc);
                form_data.append('YearFrom_doc', YearFrom_doc);
                form_data.append('YearTo_doc', YearTo_doc);
                form_data.append('place_doc', place_doc);
                form_data.append('SearchType_doc', SearchType_doc);
                UserLog(form_data)

            }




            function showChartData(data, container, documents_information_result, keySort, xAxisTitle, title) {
                let chart_data = []
                for (column of data) {
                    key = column["key"]
                    // key = column["key"] != 0 ? column["key"] : 'نامشخص'
                    value = column["doc_count"]

                    chart_data.push([key, value])
                }

                showChart(chart_data, container, documents_information_result, keySort, xAxisTitle, title)
            }


            async function showReferencesGraph(documents_information_result) {

                document.getElementById("advanced_graph_container").innerHTML = ""

                let documents_id_list = []
                for (const row of documents_information_result) {
                    if (row['_source']['document_id'] != '') {
                        documents_id_list.push(row['_source']["document_id"]);
                    }
                }

                const measure_id = 2;
                let graphEdgeList = [];
                let graphType = '';

                if (documents_id_list.length > 0) {
                    const request_link = 'http://' + location.host + "/GetGraphEdgesByDocumentsList/" + measure_id + "/"
                    let form_data = new FormData();
                    form_data.append('documents_id_list', documents_id_list)

                    $.ajax({
                        url: request_link,
                        data: form_data,
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        async: false,
                    }).done(function (response) {
                        graphEdgeList = response["graph_edge_list"];
                        graphType = response["graph_type"];
                    }).fail(function (response) {
                        console.log(response);
                    });

                    let nodeList = [];
                    let edgeList = [];
                    let GRAPH_SIZE_LIMIT = 100;

                    if (graphEdgeList.length > GRAPH_SIZE_LIMIT) {
                        document.getElementById("advanced_graph_container").innerHTML =
                            "<span class='d-block text-center' style='color: dodgerblue'><i class=\"fa fa-ban\" aria-hidden=\"true\"></i> گراف بسیار بزرگ است</span>";
                        return -1;
                    }

                    for (let i = 0; i < graphEdgeList.length; i++) {

                        const edge = graphEdgeList[i]
                        const src_id = edge["src_id"]
                        const src_name = edge["src_name"]
                        const src_color = edge["src_color"]
                        const dest_id = edge["dest_id"]
                        const dest_name = edge["dest_name"]
                        const dest_color = edge["dest_color"]
                        const weight = edge["weight"]

                        let source_node = {
                            id: src_id,
                            name: src_name,
                            normal: {
                                fill: src_color,
                                stroke: null
                            },
                            hovered: {
                                fill: src_color,
                                stroke: null
                            },
                            selected: {
                                fill: src_color,
                                stroke: null
                            }
                        }

                        let destination_node = {
                            id: dest_id,
                            name: dest_name,
                            normal: {
                                fill: dest_color,
                                stroke: null
                            },
                            hovered: {
                                fill: dest_color,
                                stroke: null
                            },
                            selected: {
                                fill: dest_color,
                                stroke: null
                            }
                        }

                        let edge_data = {
                            id: src_id + "__" + dest_id,
                            from: src_id,
                            to: dest_id,
                            from_name: src_name,
                            to_name: dest_name,
                            weight: weight
                        };

                        nodeList.push(source_node)
                        nodeList.push(destination_node)
                        edgeList.push(edge_data)
                    }


                    /*********************** Show Graph ****************************/


                    let graphData = {
                        nodes: nodeList,
                        edges: edgeList
                    };

                    var chart = anychart.graph(graphData);
                    chart.height(650);
                    let nodes = chart.nodes();
                    nodes.normal().height(12);
                    nodes.hovered().height(16);
                    nodes.selected().height(16);
                    nodes.hovered().fill("#ffa000");
                    chart.nodes().tooltip().format("{%name}");
                    chart.edges().tooltip().format(" from: {%from_name} \n to: {%to_name} \n weight: {%weight}");
                    chart.edges().tooltip().fontFamily('vazir');
                    chart.nodes().tooltip().fontFamily('vazir');
                    chart.background("transparent");

                    if (graphType === "Directed") {
                        chart.edges().arrows({
                            enabled: true,
                            size: 10,
                            position: '50%'
                        });
                    }

                    chart.container("advanced_graph_container")
                    chart.draw();

                    chart.listen("mouseOver", function(e){
                      document.body.style.cursor = "pointer";
                    });
                    chart.listen("mouseOut", function(e){
                      document.body.style.cursor = "auto";
                    });

                    chart.listen('dblClick', async function (event) {
                        const click_tag = event.domTarget.tag;
                        console.log(click_tag)
                        if (click_tag["type"] === "node") {
                            window.open('http://' + location.host + "/document_profile?id=" + click_tag["id"]);
                        } else if (click_tag["type"] === "edge") {
                            window.open('http://' + location.host + "/comparison?id=" + click_tag["id"]);
                        }

                    })
                }

            }


            function showChart(data, container, documents_information_result, sortKeys, xAxisTitle, title) {
                const options = {
                    data,
                    sortKeys,
                    xAxisTitle,
                    title,
                    yAxisTitle: "تعداد سند",
                    onClick: async function (event, data) {
                    const click_tag = event.domTarget.tag;
                    const index = click_tag["index"]
                    const text = data.row(index)[0];
                    const best_result_count = documents_information_result.length

                    let filtered_result = []
                    let header = ""
                    let save_file_name = document.getElementById("SearchBox").value;

                    if (position === "judge_name_container") {
                        filtered_result = documents_information_result.filter(function (row) {
                            if (row['_source']["judge_name"] === text)
                                return row
                        });
                        header = "قاضی: " + text
                        save_file_name += " (مجموعه سند {1} و قاضی {2})".replace("1", "آراء دیوان عدالت اداری").replace("2", text)
                    }

                    else if (position === "judgment_type_container") {
                        filtered_result = documents_information_result.filter(function (row) {
                            if (row['_source']["judgment_type"] === text)
                                return row
                        });
                        header = "مرجع صدور رأی: " + text
                        save_file_name += " (مجموعه سند {1} و مرجع صدور رأی {2})".replace("1", "آراء دیوان عدالت اداری").replace("2", text)
                    }

                    else if (position === "subject_type_display_name_container") {
                        filtered_result = documents_information_result.filter(function (row) {
                            if (row['_source']["subject_type_display_name"] === text)
                                return row
                        });
                        header = "سطح سند: " + text
                        save_file_name += " (مجموعه سند {1} و سطح سند {2})".replace("1", "آراء دیوان عدالت اداری").replace("2", text)
                    }

                    else if (position === "categories_container") {
                        filtered_result = documents_information_result.filter(function (row) {
                            if (row['_source']["categories"] === text)
                                return row
                        });
                        header = "دسته بندی: " + text
                        save_file_name += " (مجموعه سند {1} و دسته بندی {2})".replace("1", "آراء دیوان عدالت اداری").replace("2", text)
                    }

                    else if (position === "year_container") {
                        filtered_result = documents_information_result.filter(function (row) {
                            if (row['_source']["judgment_year"].substring(0, 4) === text.toString() || (text.toString() === row['_source']['approval_date']))
                                return row
                        });
                        header = "سال صدور: " + text
                        save_file_name += " (مجموعه سند {1} و سال صدور {2})".replace("1", "داتیک").replace("2", text)
                    }

                    else if (position === "complaint_from_container") {
                        filtered_result = documents_information_result.filter(function (row) {
                            if (row['_source']["complaint_from"] === text)
                                return row
                        });
                        header = "مشتکی عنه: " + text
                        save_file_name += " (مجموعه سند {1} و مشتکی عنه {2})".replace("1", "آراء دیوان عدالت اداری").replace("2", text)
                    }


                    document.getElementById("ChartModalHeader").innerText = header
                    let filtered_result_tag = ""
                    let list_of_docId = ""
                    for (const doc of filtered_result) {
                        const link = 'http://' + location.host + "/document_profile/?id=" + doc["_source"]["document_id"]
                        let tag = "<li class='mt-3' id=" + doc["_source"]["document_id"] + "><a href='" + link + "'>" + doc["_source"]["name"] + "</a></li>"
                        filtered_result_tag += tag
                        list_of_docId += doc["document_id"] + "_"
                    }

                    const filtered_result_count = filtered_result.length
                    document.getElementById("ChartModalText").innerHTML = "<h6 class='text-secondary' >" + filtered_result_count + " سند از " + best_result_count + " سند برتر:" + "</h6>"
                    filtered_result_tag = "<ol start='1'>" + filtered_result_tag + "</ol>"
                    document.getElementById("ChartModalText").innerHTML += filtered_result_tag


                    /* download file creation */
                    document.getElementById("DownloadDocuments").onclick = function () {
                        downloadFiles(filtered_result, save_file_name);
                    };

                    console.log(filtered_result)
                    /* export into excel files */
                    document.getElementById("ExportExcel2").onclick = function ExportExcelFunction() {

                        var csv = "";

                        sep = ","
                        let Csv = "نام سند" + sep + "سطح سند" + sep +
                            "موضوع سند" + sep + "نوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + "\n"
                        for (const document of filtered_result) {
                            Csv += document['_source']["name"] + sep + document['_source']["level_name"] + sep + document['_source']["subject_name"] + sep +
                                document['_source']["type_name"] + sep + document['_source']["approval_reference_name"] + sep + document['_source']["approval_date"] + "\n"

                        }

                        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
                        var link = document.createElement("a");
                        link.setAttribute("href", csvContent);
                        link.setAttribute("download", save_file_name + ".csv");
                        document.body.appendChild(link);
                        link.click()
                    };

                    $("#ChartModalBtn").click();




                }
                };

                if (container === "subject_type_display_name_container" || container ==="judge_name_container") {
                    newDoughnutChart(container, options);
                } else {
                    newBarChart(container, options)
                }

            }

            function popup_handler() {
                var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
                var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                    return new bootstrap.Popover(popoverTriggerEl)
                });
            }

            let actors_dict = {}
            let actors_list = []

            /* Optianal keywords need to be highlighted */
            const optional_keywords = ['به‌منظور', 'نسبت به']
            let optional_after_terms_count = {}
            optional_after_terms_count['به‌منظور'] = 2
            optional_after_terms_count['نسبت به'] = 2


            /* Global Constants */
            const motevalian_punctuations = ['.', '،', 'ـ', '-', ':'];
            const hamkaran_punctuations = ['،', ')', ':']

            const motevali_keywords = ['موظف است', 'مکلف است', 'مکلف‌اند', 'موظف‌اند', 'موظفند', 'مکلفند', 'موظف به', 'مکلف به'];
            const hamkaran_keywords = ['با همکاری', 'باهمکاری'];
            const salahiat_keywords = ['مختار است', 'اختیار دارد', 'می‌تواند', 'می تواند', 'میتواند', 'می­تواند', 'می‏تواند', 'مجاز است'];


            const deadline_pattern_keywords = ['ظرف', 'ظرف مدت', 'ظرف مهلت', 'طی', 'طی مدت', 'طی مهلت', 'حداکثر', 'فواصل زمانی', 'هر']
            const time_categories = ['روز', 'هفته', 'ماه', 'سال']
            const numbers_dict = {
                "یک": {
                    'value': 1,
                },
                "دو": {
                    'value': 2,
                },
                "سه": {
                    'value': 3,
                },
                "چهار": {
                    'value': 4,
                },
                "پنج": {
                    'value': 5,
                },
                "شش": {
                    'value': 6,
                },
                "هفت": {
                    'value': 7,
                },
                "هشت": {
                    'value': 8,
                },
                "نه": {
                    'value': 9,
                },
                "ده": {
                    'value': 10,
                }
            }

            async function showActorsChart(chart_container, chart_data, country_id, preprocessed_keywords_text) {

                /* Get Actors Dict */
                let request_link = 'http://' + location.host + "/GetActorsDict/";
                let response = await fetch(request_link).then(response => response.json());
                actors_dict = response['actorsDict']

                /* Get Actors List */
                request_link = 'http://' + location.host + "/GetActorsList/";
                response = await fetch(request_link).then(response => response.json());
                actors_list = response["actorsList"];

                if (!preprocessed_keywords_text || preprocessed_keywords_text == '') {
                    preprocessed_keywords_text = 'empty'
                } else {
                    preprocessed_keywords_text = preprocessed_keywords_text.replace(' ', ',')
                }
                console.log(chart_data);
                document.getElementById(chart_container).innerHTML = ""
                // create a data set
                var data = anychart.data.set(chart_data);

                // map the data
                var salahiat_series_data = data.mapAs({ x: 0, value: 3 });
                var hamkaran_series_data = data.mapAs({ x: 0, value: 2 });
                var motevalian_series_data = data.mapAs({ x: 0, value: 1 });



                // create a chart
                let chart = anychart.column();

                chart
                    .animation(true)
                    .padding([10, 60, 10, 0])



                // x axix labels font setting
                let xAxisLabels = chart.xAxis().labels();
                xAxisLabels.fontFamily("vazir");


                let yAxisLabels = chart.yAxis().labels();
                yAxisLabels.fontFamily("vazir");

                // Not allow labels overlapping
                let xAxis = chart.xAxis();
                xAxis.overlapMode("noOverlap");

                let yAxis = chart.yAxis();
                yAxis.title("تعداد پاراگراف");
                yAxis.title().fontFamily('vazir');
yAxis.title().fontWeight("bold");
                yAxis.title().height(40);


                chart.yScale().minimum(0);
                chart.yScale().ticks().allowFractional(false);
                // tooltip content font setting
                let tooltip = chart.tooltip();
                tooltip.fontFamily("vazir");

                // tooltip title font setting
                let title = chart.tooltip().title();
                title.fontFamily("vazir");


                // set the container id
                chart.container(chart_container);

                // create the second series, set the data and name
                let salahiat_series = chart.column(salahiat_series_data);
                salahiat_series.normal().stroke("#28a745", 0);
                salahiat_series.normal().fill("#ffc107");
                salahiat_series.name("دارای صلاحیت اختیاری");


                // create the second series, set the data and name
                let hamkaran_series = chart.column(hamkaran_series_data);
                hamkaran_series.normal().stroke("#28a745", 0);
                hamkaran_series.normal().fill("#28a745");
                hamkaran_series.name("همکار");


                // create the first series, set the data and name
                let motevalian_series = chart.column(motevalian_series_data);
                // configure the visual settings of the first series
                motevalian_series.normal().fill("#007bff");
                motevalian_series.normal().stroke("#28a745", 0);
                motevalian_series.name("متولی اجرا");

                // enable the legend
                chart.legend(true);

                var legend = chart.legend();
                legend.fontFamily('vazir')


                // set position mode
                legend.positionMode("outside");
                // set the position of the legend
                legend.position("top");
                // set the alignment of the legend
                legend.align("center");

                legend.itemsLayout("horizontalExpandable");
                // initiate drawing the chart
                chart.draw();

                chart.listen("mouseOver", function(e){
                  document.body.style.cursor = "pointer";
                });
                chart.listen("mouseOut", function(e){
                  document.body.style.cursor = "auto";
                });

                // motevalian columns
                motevalian_series.listen('click', async function (e) {
                    const click_tag = e.domTarget.tag;
                    const column_index = click_tag["index"]
                    const actor_name = chart_data[column_index][0];
                    const actor_role_name = 'متولی اجرا';
                    showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text)

                });

                // hamkaran columns
                hamkaran_series.listen('click', function (e) {
                    const click_tag = e.domTarget.tag;
                    const column_index = click_tag["index"]
                    const actor_name = chart_data[column_index][0];
                    const actor_role_name = 'همکار';
                    showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text)
                });

                // salahiat columns
                salahiat_series.listen('click', function (e) {
                    /* Modal Headers */
                    const click_tag = e.domTarget.tag;
                    const column_index = click_tag["index"]
                    const actor_name = chart_data[column_index][0];
                    const actor_role_name = 'دارای صلاحیت اختیاری';
                    showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text)
                });

            }


            async function showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text) {
                startFullPageBlockUI();
                /* Title Body */
                const title_tag = actor_name + ' (' + actor_role_name + ')'
                $('#actor_modal_header').text(title_tag);

                /* Modal Body */
                document.getElementById('actor_modal_body').innerHTML = "";

                let request_link = 'http://' + location.host + "/GetColumnParagraphsByActorRoleName_Modal/" + country_id + "/" + actor_name + "/" + actor_role_name + "/" + preprocessed_keywords_text + "/"
                let response = await fetch(request_link).then(response => response.json());
                let actor_paragraphs_result = response["actor_paragraphs_result"]

                paragraph_tag = '';
                let keywords_list = preprocessed_keywords_text.split(",")

                for (const [paragraph_id, paragraph_info] of Object.entries(actor_paragraphs_result)) {
                    document_id = paragraph_info['document_id']
                    document_name = paragraph_info['name']

                    document_link = 'http://' + location.host + "/document_profile/?id=" + document_id
                    doc_name = '<a class="bold text-secondary" target="_blank" href="' + document_link + '">' + document_name + "</a>"

                    paragraph_text = paragraph_info['text']
                    actor_form = paragraph_info['actor_form']
                    is_ref_actor = paragraph_info['is_ref_actor']
                    ref_text = paragraph_info['ref_text']

                    highlighted_paragraph = await highlightParagraphs(paragraph_text, actor_name, actor_role_name, actor_form, keywords_list, false, is_ref_actor, ref_text)

                    paragraph_tag += "<li class='mb-3 lh-lg'>" + doc_name + highlighted_paragraph + "</li>";

                }


                document.getElementById('actor_modal_body').innerHTML = '<ol start="1">' + paragraph_tag + '</ol>'
                popup_handler();
                stopFullPageBlockUI('کلیک روی نمودار')
                $("#actors_modal_btn").click();
            }

            /****************** Highlight algorithms ********************************** */

            async function highlightParagraphs(paragraph, actor_name, actor_role, paragraph_actor_form, keywords_list, all_hamkar, is_ref_actor, ref_paragraph_text) {


                paragraph_text = paragraph;

                // Highlight keywords
                if (!keywords_list.includes('empty')) {
                    for (keyword of keywords_list) {
                        keyword_tag = "<span class= 'bg-info text-white  rounded px-1'>" + keyword + "</span>"
                        paragraph_text = paragraph_text.replaceAll(keyword, keyword_tag);

                    }
                }


                // highlight other actors
                paragraph_text = await highlightOtherActors(paragraph_text, paragraph_actor_form, actor_name)



                if (actor_role.includes('متولی اجرا')) {

                    paragraph_text = await highlightMotevalian(paragraph_text, paragraph_actor_form, motevali_keywords, 'bg-primary', is_ref_actor, ref_paragraph_text)
                    paragraph_text = await highlightLegalDeadline(paragraph_text, motevali_keywords)

                } else if (actor_role.includes('همکار')) {
                    paragraph_text = await highlightHamkaran(paragraph_text, paragraph_actor_form, hamkaran_keywords, 'bg-success');

                } else {
                    paragraph_text = await highlightSalahiat(paragraph_text, paragraph_actor_form, salahiat_keywords, 'bg-warning', is_ref_actor, ref_paragraph_text)

                }






                /********************* Highlight optional keywords  **************************/
                for (pattern_keyword of optional_keywords) {

                    if (optional_after_terms_count[pattern_keyword] > 0)
                        paragraph_text = await highlightSomeTermsAfterKeyword(paragraph_text, optional_after_terms_count[pattern_keyword], pattern_keyword)

                    pattern_keyword_tag = "<span class='border border-secondary border-2  px-1 rounded'>" + pattern_keyword + "</span>"
                    paragraph_text = paragraph_text.replaceAll(pattern_keyword, pattern_keyword_tag)

                }

                return paragraph_text
            }


            async function highlightMotevalian(paragraph_text, actor_form, pattern_keywords, bg_color, is_ref_actor, ref_paragraph_text) {


                for (pattern_keyword of pattern_keywords) {

                    /* Highlight with actors list */
                    let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"

                    actor_with_postfix_1 = actor_form + ' ' + 'جمهوری اسلامی ایران'
                    actor_with_postfix_2 = actor_form + ' ' + 'ایران'
                    actor_with_postfix_3 = actor_form + ' ' + 'کشور'

                    paragraph_text = paragraph_text.split('.').map((sentence) => {


                        if (sentence.includes(actor_form + ' ' + pattern_keyword)) {

                            if (is_ref_actor) {

                                popover_title = actor_form;
                                popover_content = ref_paragraph_text;
                                actor_tag = '<a dir="rtl" tabindex="0" class="d-inline-block ' + bg_color.replace('bg', 'text') + ' text-right bold"  data-bs-placement="bottom" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="' + popover_title + '" data-bs-content="' + popover_content + '">' + popover_title + '</a>'
                                sentence = sentence.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);

                            } else {

                                actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                                sentence = sentence.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);

                            }

                        }
                        else if (sentence.includes(actor_with_postfix_1 + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_1 + "</span>"
                            sentence = sentence.replaceAll(actor_with_postfix_1 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }
                        else if (sentence.includes(actor_with_postfix_2 + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_2 + "</span>"
                            sentence = sentence.replaceAll(actor_with_postfix_2 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }
                        else if (sentence.includes(actor_with_postfix_3 + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_3 + "</span>"
                            sentence = sentence.replaceAll(actor_with_postfix_3 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }
                        else if (sentence.includes('(' + actor_form + ')' + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_form + ')' + "</span>"
                            sentence = sentence.replaceAll('(' + actor_form + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }
                        else if (sentence.includes('(' + actor_with_postfix_1 + ')' + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_1 + ')' + "</span>"
                            sentence = sentence.replaceAll('(' + actor_with_postfix_1 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }
                        else if (sentence.includes('(' + actor_with_postfix_2 + ')' + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_2 + ')' + "</span>"
                            sentence = sentence.replaceAll('(' + actor_with_postfix_2 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }
                        else if (sentence.includes('(' + actor_with_postfix_3 + ')' + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_3 + ')' + "</span>"
                            sentence = sentence.replaceAll('(' + actor_with_postfix_3 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }

                        return sentence
                    }).join('.')

                }



                /* Highlight with actors list */
                eghdam_keywords = ['اقدام کند', 'اقدام‌کند', 'اقدام نماید', 'اقدام‌نماید']
                non_eghdam_keywords = pattern_keywords.filter(x => !eghdam_keywords.includes(x));

                paragraph_text = paragraph_text.split('.').map((sentence) => {

                    for (e_kw of eghdam_keywords) {

                        pattern_keyword_tag1 = "<span class='bg-secondary text-white rounded px-1'>" + e_kw + "</span>"

                        if (sentence.includes(e_kw) && !check_non_eghdam_kw_exists(sentence, non_eghdam_keywords)) {

                            actor_tag1 = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                            sentence = sentence.replaceAll(actor_form + ' ', actor_tag1 + ' ');

                            sentence = sentence.replaceAll(e_kw, pattern_keyword_tag1);


                        }

                    }

                    return sentence
                }).join('.')




                return paragraph_text;


            }


            function check_non_eghdam_kw_exists(sentence, pattern_keywords) {
                for (p_kw of pattern_keywords) {
                    pattern = p_kw
                    if (sentence.includes(pattern)) {
                        return true;
                    }
                }
                return false;

            }


            async function highlightHamkaran(paragraph_text, actor_form, pattern_keywords, bg_color) {
                const window_length = 100;

                let space_counter = 0;
                detected_hamkaran_list = []


                /* Highlight pattern keywords and references */
                for (pattern_keyword of pattern_keywords) {


                    /* Highlight more with actors list */
                    let regex = '', result, indices = [];

                    if (pattern_keyword == 'با همکاری') {
                        regex = /با همکاری/gi;
                    } else {
                        regex = /باهمکاری/gi;
                    }

                    while ((result = regex.exec(paragraph_text))) {
                        indices.push(result.index);
                    }

                    for (const index of indices) {

                        let start_index = (index + pattern_keyword.length);
                        let substring = paragraph_text.substring(start_index, start_index + window_length);
                        let current_substring = substring;


                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                        // substring = substring.replaceAll(' ' + actor_form + ' ', ' ' + actor_tag + ' ');
                        substring = substring.replaceAll(' ' + actor_form, ' ' + actor_tag);
                        substring = substring.replaceAll('(' + actor_form + ')', '(' + actor_tag + ')');

                        for (symbol of hamkaran_punctuations) {

                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                            substring = substring.replaceAll(' ' + actor_form + symbol, ' ' + actor_tag + symbol);

                        }

                        actor_without_affix = actor_form.replaceAll('وزارت ', '').replaceAll('سازمان ', '').replaceAll(' جمهوری اسلامی ایران', '')

                        if (actor_without_affix != 'اطلاعات' && actor_without_affix != 'کشور' && !substring.includes(actor_form)) {


                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                            substring = substring.replaceAll(' ' + actor_without_affix + ' ', ' ' + actor_tag + ' ');
                            substring = substring.replaceAll('(' + actor_without_affix + ')', '(' + actor_tag + ')');

                            for (symbol of hamkaran_punctuations) {


                                actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                                substring = substring.replaceAll(' ' + actor_without_affix + symbol, ' ' + actor_tag + symbol);

                            }

                        }



                        paragraph_text = paragraph_text.replaceAll(current_substring, substring);

                    }
                    /* Highlight with actors list */
                    let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"

                    paragraph_text = paragraph_text.replaceAll(pattern_keyword, pattern_keyword_tag);

                }




                return paragraph_text;



            }

            async function highlightSalahiat(paragraph_text, actor_form, pattern_keywords, bg_color, is_ref_actor, ref_paragraph_text) {


                for (pattern_keyword of pattern_keywords) {

                    /* Highlight with actors list */
                    let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"

                    actor_with_postfix_1 = actor_form + ' ' + 'جمهوری اسلامی ایران'
                    actor_with_postfix_2 = actor_form + ' ' + 'ایران'
                    actor_with_postfix_3 = actor_form + ' ' + 'کشور'

                    paragraph_text = paragraph_text.split('.').map((sentence) => {


                        if (sentence.includes(actor_form + ' ' + pattern_keyword)) {

                            if (is_ref_actor) {

                                popover_title = actor_form;
                                popover_content = ref_paragraph_text;
                                actor_tag = '<a dir="rtl" tabindex="0" class="d-inline-block ' + bg_color.replace('bg', 'text') + ' text-right bold"  data-bs-placement="bottom" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="' + popover_title + '" data-bs-content="' + popover_content + '">' + popover_title + '</a>'
                                sentence = sentence.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);


                            } else {

                                actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                                sentence = sentence.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);

                            }

                        }
                        else if (sentence.includes(actor_with_postfix_1 + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_1 + "</span>"
                            sentence = sentence.replaceAll(actor_with_postfix_1 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }
                        else if (sentence.includes(actor_with_postfix_2 + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_2 + "</span>"
                            sentence = sentence.replaceAll(actor_with_postfix_2 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }
                        else if (sentence.includes(actor_with_postfix_3 + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_3 + "</span>"
                            sentence = sentence.replaceAll(actor_with_postfix_3 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }
                        else if (sentence.includes('(' + actor_form + ')' + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_form + ')' + "</span>"
                            sentence = sentence.replaceAll('(' + actor_form + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }
                        else if (sentence.includes('(' + actor_with_postfix_1 + ')' + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_1 + ')' + "</span>"
                            sentence = sentence.replaceAll('(' + actor_with_postfix_1 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }
                        else if (sentence.includes('(' + actor_with_postfix_2 + ')' + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_2 + ')' + "</span>"
                            sentence = sentence.replaceAll('(' + actor_with_postfix_2 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }
                        else if (sentence.includes('(' + actor_with_postfix_3 + ')' + ' ' + pattern_keyword)) {
                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_3 + ')' + "</span>"
                            sentence = sentence.replaceAll('(' + actor_with_postfix_3 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                        }

                        return sentence
                    }).join('.')

                }



                return paragraph_text;

            }


            /* Highlight N terms after one keyword */
            async function highlightSomeTermsAfterKeyword(paragraph_text, terms_count, keyword) {
                paragraph_selected_terms = '';
                selected_terms_list = []
                let indices = await getIndicesOf(keyword, paragraph_text);

                for (index of indices) {

                    let pattern_keyword_index = index;
                    let start_index = pattern_keyword_index + keyword.length + 1
                    let end_index = paragraph_text.length;
                    let selected_terms_size = 0

                    if (pattern_keyword_index != -1) {
                        sub_string = paragraph_text.substring(start_index, end_index)

                        selected_terms = sub_string.split(' ').slice(0, terms_count)

                        for (term of selected_terms) {
                            selected_terms_size += term.length
                        }
                        selected_terms_size += (terms_count - 1)

                        selected_terms_text = paragraph_text.substring(start_index, start_index + selected_terms_size);

                        if (!selected_terms_text.includes('span')) {
                            if (!selected_terms_list.includes(selected_terms_text)) {
                                selected_terms_list.push(selected_terms_text)
                            }

                        }


                    }


                }

                for (selected_terms_text of selected_terms_list) {
                    if (selected_terms_text != "") {
                        selected_terms_tag = "<span class='blue_dotted_border selected_terms px-1 mx-1'>" + selected_terms_text + "</span>"
                        paragraph_text = paragraph_text.replaceAll(selected_terms_text, selected_terms_tag)
                    }

                }

                return paragraph_text;
            }

            async function highlightLegalDeadline(paragraph_text, actor_pattern_keywords) {

                for (pattern_keyword of actor_pattern_keywords) {

                    let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"


                    let indices = await getIndicesOf(pattern_keyword_tag, paragraph_text);

                    for (index of indices) {
                        start_index = index + pattern_keyword_tag.length;

                        sub_string = paragraph_text.substring(start_index, paragraph_text.length);

                        for (deadline_keyword of deadline_pattern_keywords) {
                            for (const [nubmer_text, value] of Object.entries(numbers_dict)) {
                                for (time_category of time_categories) {

                                    // ظرف شش ماه
                                    pattern1 = deadline_keyword + ' ' + nubmer_text + ' ' + time_category;
                                    pattern2 = deadline_keyword + ' ' + nubmer_text + ' ' + '(' + value + ')' + ' ' + time_category;

                                    // ظرف شش‌ماه
                                    pattern3 = deadline_keyword + ' ' + nubmer_text + '‌' + time_category;
                                    pattern4 = deadline_keyword + ' ' + nubmer_text + ' ' + '(' + value + ')' + '‌' + time_category;

                                    // ظرف یکسال
                                    pattern5 = deadline_keyword + ' ' + nubmer_text + time_category;
                                    pattern6 = deadline_keyword + ' ' + nubmer_text + ' ' + '(' + value + ')' + time_category;

                                    patterns = [pattern1, pattern2, pattern3,
                                        pattern4, pattern5, pattern6];

                                    for (pattern of patterns) {
                                        deadline_keyword_tag = "<span class='deadlines gray_dotted_border px-1 rounded'>" + deadline_keyword + "</span>"
                                        pattern_without_deadline_keyword = pattern.replace(deadline_keyword + ' ', '');
                                        pattern_without_keyword_tag = "<span class='deadlines border border-warning border-2 px-1 rounded'>" + pattern_without_deadline_keyword + "</span>"
                                        new_sub_string = sub_string.replaceAll(pattern, deadline_keyword_tag + ' ' + pattern_without_keyword_tag)

                                        // closest deadline..not all deadlines. => replace()
                                        paragraph_text = paragraph_text.replace(sub_string, new_sub_string);

                                    }

                                    /* *********************************** */

                                }
                            }
                        }


                    }

                }
                return paragraph_text;

            }

            async function getIndicesOf(searchStr, str) {
                var searchStrLen = searchStr.length;
                if (searchStrLen == 0) {
                    return [];
                }
                var startIndex = 0, index, indices = [];
                while ((index = str.indexOf(searchStr, startIndex)) > -1) {
                    indices.push(index);
                    startIndex = index + searchStrLen;
                }
                return indices;
            }

            async function highlightOtherActors(paragraph_text, paragraph_actor_form, paragraph_actor_name) {
                para_actor_forms = []
                for (const [actor_id, actor_info] of Object.entries(actors_dict)) {
                    if (actor_info['name'] == paragraph_actor_name) {
                        para_actor_forms = actor_info['forms'];
                        break;
                    }
                }

                for (actor_form of actors_list) {
                    if (!para_actor_forms.includes(actor_form)) {
                        actor_form_tag = "<span class='other_actors'>" + actor_form + "</span>"
                        paragraph_text = paragraph_text.replaceAll(' ' + actor_form + ' ', ' ' + actor_form_tag + ' ');
                        paragraph_text = paragraph_text.replaceAll(' ' + actor_form + '،', ' ' + actor_form_tag + '،');
                        paragraph_text = paragraph_text.replaceAll('(' + actor_form + ')', '(' + actor_form_tag + ')');
                    }

                }

                return paragraph_text;
            }

            async function showOtherActors() {
                if ($('.highlighted').length) {
                    $('.highlighted').attr('class', 'other_actors')
                } else {
                    $('.other_actors').attr('class', 'other_actors highlighted bold text-primary px-1 rounded')
                }

            }

            /* *********************************************************************** */

            async function showHighlightedParagraphs_Details(document_id, document_name, affected_document_name, paragraphs_list, document_references_list) {
                /* Title Text */
                const link = 'http://' + location.host + "/document_profile/?id=" + document_id
                let title_tag = "<a class='text-primary my-2' target='blank' href='" + link + "'>" + document_name + "</a>"
                document.getElementById("DetailText").innerHTML = '<li class="mb-3 lh-lg"> <strong> پیام رأی:</strong>' + title_tag + '</li>'
                document.getElementById("DetailText").innerHTML += '<li class="mb-3 lh-lg" > <strong>مصوبه ها: </strong>' + affected_document_name + '</li>'

                for (let paragraph of paragraphs_list) {

                    for (let ref_doc of document_references_list) {
                        ref_doc_id = ref_doc['doc_id']
                        ref_doc_name = ref_doc['doc_name']

                        doc_link = 'http://' + location.host + "/document_profile/?id=" + ref_doc_id
                        doc_tag = '<a class="d-inline-block text-primary bold" target="_blank" href="' + doc_link + '">' + ref_doc_name + "</a>"
                        result_doc_tag = "<span class='text-primary bold'>" + doc_tag + "</span>"

                        paragraph = paragraph.replaceAll(ref_doc_name, result_doc_tag);
                    }
                    tag = "<li class='mb-3 lh-lg'>" + paragraph + "</li>"
                    document.getElementById("DetailText").innerHTML += tag;
                }
                document.getElementById("DetailText").innerHTML = "<ul>" + document.getElementById("DetailText").innerHTML + "</ul>"
            }

            function checkJudegementType(para, keyword, index, array) {
                return (keyword == para.replaceAll(':', '').trim());
            }

            async function DetailFunction(doc_id, doc_name, search_type, where, text) {
                startFullPageBlockUI();

                document.getElementById("DetailText").innerHTML = ""
                let doc_text = ''

                // doc_text = ES_SearchResult[es_doc_id]['_source']['attachment']['content']

                let request_link = 'http://' + location.host + "/GetSearchDetails_ES_Judgment/" + doc_id + "/" + search_type + "/" + text + "/";
                let response = await fetch(request_link).then(response => response.json());
                doc_text = response["result"]
                subject_complaint = response["subject_complaint"]
                affected_document_name = response["affected_document_name"]


                /*  Show detail Result */
                let document_paragraphs_result = []

                doc_text = doc_text.replaceAll('<em>', "<span class='text-primary bold'>").replaceAll('</em>', '</span>');

                for (kw of judgement_highlight_list) {
                    doc_text = doc_text.replace(kw + ':', '\n' + kw + ':')
                    doc_text = doc_text.replace(kw + ' :', '\n' + kw + ' :')
                    if (kw == 'گردش کار' &&
                        (doc_text.includes(kw + ':') || doc_text.includes(kw + ' :'))) {
                        doc_text = doc_text.replace('که:', 'که:' + '\n')
                        doc_text = doc_text.replace('است:', 'است:' + '\n')

                    }

                }


                text_para_list = doc_text.split('\n')


                for (para of text_para_list) {
                    if (para != '' && para != '‌' && para != ' ' && para != '\n') {

                        // شماره دادنامه
                        for (judgement_kw of judgement_highlight_list) {
                            judgement_kw_tag = '<strong>' + judgement_kw + '</strong>'


                            if ((judgement_kw.startsWith('رای') || judgement_kw.startsWith('رأی')) &&
                                para.replace(':', '').trim() == judgement_kw) {

                                para = para.replaceAll(judgement_kw, judgement_kw_tag)

                            }
                            para = para.replaceAll(judgement_kw + ':', judgement_kw_tag + ':')
                            para = para.replaceAll(judgement_kw + ' :', judgement_kw_tag + ' :')
                        }

                        // مغایر- خارج از حدود
                        for (pattern_keyword of judgement_keywords) {
                            let pattern_keyword_tag = "<span class='yellow_bottom_dotted_border rounded px-1'>" + pattern_keyword + "</span>"
                            para = para.replaceAll(pattern_keyword + ' ', pattern_keyword_tag + ' ')

                        }

                        document_paragraphs_result.push(para)
                    }

                }


                // get doc references
                request_link = 'http://' + location.host + "/GetReferencesByDocumentId/" + doc_id + "/" + 1 + "/";
                response = await fetch(request_link).then(response => response.json());
                document_references_list = response["document_references_list"]

                // sort base doc name lenght descending
                document_references_list.sort(function (a, b) {
                    return parseInt(b.doc_name.length) - parseInt(a.doc_name.length);
                });

                console.log(document_references_list)
                // قانون تشکیلات و آیین دادرسی دیوان عدالت اداری
                await showHighlightedParagraphs_Details(doc_id, doc_name, affected_document_name, document_paragraphs_result, document_references_list)
                stopFullPageBlockUI('جزئیات')
            }


        </script>
        <script>
            function TablePaginationChanged(event){
        
                input_id = event.target.id
        
                curr_page_number =  parseInt(event.target.value);
                max_page_number =  parseInt(document.getElementById(input_id).max);
                min_page_number =  parseInt(document.getElementById(input_id).min);
        
        
                if (curr_page_number > max_page_number){
                    document.getElementById(input_id).value = max_page_number
                }
        
                else if (curr_page_number < min_page_number){
                    document.getElementById(input_id).value = min_page_number
                }
                    
                ShowResult();
        
            }
        </script>
        <script src="../../static/js/zipDownload/jszip.min.js"></script>
        <script src="../../static/js/zipDownload/FileSaver.min.js"></script>
        <script>

            async function downloadFiles(file_name_list, save_file_name) {
                startFullPageBlockUI()
                const country_id = document.getElementById('country').value
                let zip = new JSZip()

                const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
                let response = await fetch(request_link).then(response => response.json());
                response = response["country_information"][0]
                const country_folder = response["folder"];
                const country_name = response["name"];

                save_file_name += " مجموعه سند {" + country_name + "}"


                let extension = ".txt"
                if (country_name.includes("فاوا")) {
                    extension = '.docx';
                }

                for (const document of file_name_list) {
                    const document_name = document["_source"]["name"] + extension
                    const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

                    await fetch(path)
                        .then(res => res.arrayBuffer())
                        .then(value => {
                            zip.file(document_name, value);
                        })
                }
                zip.generateAsync({
                    type: "blob"
                })
                    .then(function (content) {
                        // see FileSaver.js
                        saveAs(content, save_file_name + ".zip");
                    });
                stopFullPageBlockUI('دانلود اسناد');
            }


            async function DownloadSerachResultFunction() {

                const save_file_name = "نتیجه جستجو {" + document.getElementById("SearchBox").value + "}"
                downloadFiles(SearchResultValue, save_file_name)
            }

            async function ExportExcelSerachResultFunction() {
                var selected_columns = []
                selected_columns = find_selected_column(selected_columns)
                main_columns = ['نام سند']
                rows = ['name']
                for (const column in COLUMNS) {
                    if (selected_columns.includes(column) || selected_columns.includes('all')) {
                        main_columns.push(COLUMNS[column])
                        rows.push(column)
                    }
                }
        
                var csv = "";
                sep = ","
    
                let Csv = ""
                for (const column of main_columns) {
                    Csv += column + sep
                }
                Csv += "\n"
                for (const document of SearchResultValue) {
                    for (const row of rows) {
                        Csv += document["_source"][row] + sep
                    }
                    Csv += "\n"
                }
    
                let save_file_name = "نتیجه جستجو {" + document.getElementById("SearchBox").value + "}"
                save_file_name += " مجموعه سند {" + document.getElementById("country").innerText + "}"
    
                let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
                var link = document.createElement("a");
                link.setAttribute("href", csvContent);
                link.setAttribute("download", save_file_name + ".csv");
                document.body.appendChild(link);
                link.click()
            }


            async function createKeywordsGraphData(keywords_information_result) {

                nodes = []
                edges = []
                chart_data = []

                for (const [keyword, documents_list] of Object.entries(keywords_information_result)) {

                    if (documents_list.length > 1) {
                        common_keyword_node = {
                            'id': keyword, 'name': keyword, 'fill': {
                                'src': "../../static/icons/question1.png"
                            }, 'group': 'common_keyword'
                        }
                        nodes.push(common_keyword_node);
                    } else {
                        keyword_node = { 'id': keyword, 'name': keyword, 'group': 'keyword' };
                        nodes.push(keyword_node);
                    }

                    for (doc_info of documents_list) {
                        const document_id = doc_info["id"]
                        const document_name = doc_info["name"]
                        const document_link = 'http://' + location.host + "/document_profile/?id=" + document_id
                        const doc_name = '<a target="_blank" href="' + document_link + '">' + document_name + "</a>"

                        document_node = {
                            'id': document_id, 'name': document_name, 'fill': {
                                'src': "../../static/icons/docs.png"
                            }, 'group': 'document'
                        }
                        nodes.push(document_node);

                        edge = {
                            'id': document_id + '__' + keyword,
                            'from': document_id,
                            'to': keyword,
                            'from_name': document_name
                        };

                        edges.push(edge);
                    }


                }

                chart_data = {
                    'nodes': nodes,
                    'edges': edges
                }


                showKeywordsGraph('definition_keywords_graph_container', chart_data)

            }



            async function showKeywordsGraph(chart_container, chart_data) {


                document.getElementById(chart_container).innerHTML = ''
                // create a chart and set the data
                var chart = anychart.graph(chart_data);

                // set the container id
                chart.container(chart_container);

                // configure labels of keywords
                let keywords = chart.group("keyword");
                let common_keywords = chart.group("common_keyword");
                let documents = chart.group("document");



                if (common_keywords != undefined) {
                    common_keywords.normal().height(35);
                    common_keywords.hovered().height(40);
                    common_keywords.selected().height(40);
                    common_keywords.normal().stroke(null);

                    common_keywords.labels().enabled(true);
                    common_keywords.labels().format("{%id}").fontFamily('vazir');
                    common_keywords.labels().fontSize(14);
                    common_keywords.labels().fontWeight(600);
                }


                if (documents != undefined) {
                    documents.normal().height(35);
                    documents.hovered().height(40);
                    documents.selected().height(40);
                    documents.normal().stroke(null);
                }

                chart.nodes().tooltip().format("{%name}");
                chart.edges().tooltip().format(" سند:  {%from_name} \n کلیدواژه:  {%to}");
                chart.edges().tooltip().fontFamily('vazir');
                chart.nodes().tooltip().fontFamily('vazir');

                // initiate drawing the chart
                chart.draw();

                chart.listen("mouseOver", function(e){
                  document.body.style.cursor = "pointer";
                });
                chart.listen("mouseOut", function(e){
                  document.body.style.cursor = "auto";
                });

                chart.listen('Click', async function (event) {

                    const click_tag = event.domTarget.tag;
                    console.log(click_tag)
                    if (click_tag["type"] === "node") {

                        // window.open('http://' + location.host + "/document_profile?id=" + click_tag["id"]);
                    } else if (click_tag["type"] === "edge") {

                        edge_data = click_tag["id"].split('__');
                        doc_id = edge_data[0]
                        keyword = edge_data[1]

                        const link = 'http://' + location.host + "/GetKeywordsGeneralDefinitionByDocumentId/" + doc_id + "/" + keyword + "/";
                        response = await fetch(link).then(response => response.json());
                        response = response['keyword_information']

                        document.getElementById('EdgeModalHeader').innerText = 'کلیدواژه: ' + keyword

                        paragraph_text = response['croped_text']
                        keyword_tag = "<span class='bg-success text-white px-1 rounded'>" + keyword + "</span>: "
                        paragraph_text = paragraph_text.replaceAll(keyword + ':', keyword_tag)

                        keyword_tag = "<span class='bg-success text-white px-1 rounded'>" + keyword + "</span>: "
                        paragraph_text = paragraph_text.replaceAll(keyword + ' :', keyword_tag)


                        const document_address = 'http://' + location.host + "/document_profile/?id=" + response["doc_id"]
                        const document_link = '<a target = "to_blank" href = "' + document_address + '">' + response["doc_name"] + ':</a>'

                        doc_tag = '<h6 class="bold">' + document_link + '</h6>'
                        paragraph_tag = '<li dir="rtl" class = "text-right lh-lg">' + doc_tag + paragraph_text + '</li>'

                        document.getElementById('EdgeModalText').innerHTML = '<ol start="1"> ' + paragraph_tag + '</ol>';

                        $('#EdgeModalBtn').click();

                    }

                })

            }

            /* Search after press Enter */
            $("#info_form").submit(function () { return false; });
            $("#SearchBox").keyup(function (event) {
                event.preventDefault();
                if (event.keyCode === 13) {
                    $("#document_search").click();
                }
            });



        </script>


</body>

<!-- save log user -->
<script>
    async function UserLog(form_data) {
        if (getCookie("username") !== "") {
            const user_name = getCookie("username")
            let page_url = window.location.pathname
            const user_ip = "127.0.0.0"
            page_url = page_url.slice(0, -1);
            if (page_url === "") {
                page_url = "/0";
            }


            let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                console.log("done")

            }).fail(function (res) {
                console.log("fail")
            });

        }
    }
</script>

<script src="../../static/js/tooltip_handler.js"></script>

<!-- Intro Js -->
<script src="../../static/js/search/search_tour.js">
</script>
<script src="../../static/js/tour.js"></script>

<script src="../../static/js/signout_function.js"></script>





</html>