<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">
    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>


    <!-- jsnetworkx -->
    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="../../static/js/jsnetworkx.js"></script>


    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">
    <!-- Download Zip Files -->
    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/adaptation.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">


    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>


    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <meta charset="UTF-8">
    <title>پالایش اعتباری قوانین</title>
    {% include "doc/title_icon.html" %}
</head>

<body>


    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#JudgmentDropdown').addClass('active');
            $('#revoked_document').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>
    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-5">
        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" novalidate>
            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mt-2 mx-auto">
                <!-- Country Input -->
                <div class="col-md-6  pt-3 col-12 col-lg-2 bg-light">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country" class="form-select text-right float-right"
                        style="direction: rtl;" onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        نمایش
                    </button>
                </div>
            </div>
        </form>

        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">نتایج جست و جو</button>
                </li>


                <!-- Download Buttons -->
                <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                    class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

                </button>

                <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button>
                <!-- Result Count -->
                <p id="DocumentCount" dir="rtl" class="text-left float-left text-secondary  pl-2"></p>

            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">

                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                    aria-labelledby="search_result_tab">

                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                        </table>
                    </div>
                </div>

                <!-- Bar chart Info Pane -->


            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div class="modal fade" id="myModal">
        <div id="modal_dialog" class="modal-dialog modal-fullscreen  modal-dialog-scrollable ">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title w-100">
                        <div class="row w-100">
                            <div id="src_document_header" class="col-6 float-right text-center my-auto"></div>
                            <div id="dest_document_header" class="col-6 float-left text-center my-auto"></div>
                        </div>
                    </h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="DetailText" class="modal-body bg-light text-justify">
                    <div class="row w-100 ">
                        <div id="SrcDocumentParagraph" class="col-6 float-right"></div>
                        <div id="DestDocumentParagraph" class="col-6 float-left"></div>
                    </div>
                </div>

                <!-- Modal footer -->
                <div id="modal_footer" class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- ChartModal Container -->
    <button type="button" id="ChartModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#ChartModal"></button>
    <div class="modal fade" id="ChartModal">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ChartModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ChartModalText" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->
                <div dir="rtl" class="modal-footer">
                    <button id="DownloadDocuments" class="btn btn-primary"><i class="fa fa-download"></i> دانلود
                        اسناد</button>

                    <button id="ExportExcel2" class="btn btn-primary"><i class="fa fa-download"></i> خروجی اکسل
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js">
    </script>

    <script src="../../static/js/executive_regulations_analysis/executive_regulations_supervisions_tour.js">
    </script>
</body>


<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">

<script>
    let SearchResultValue = []
    let executive_list = []
    let last_paragraph = null;
    let next_paragraph = '';

    container_id_list = ['SearchTable','DocumentCount']

    function clearPrevResults(container_id_list) {

        for (container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }
    }

    function popup_handler() {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl)
        });
    }

    CountryChanged()

    async function CountryChanged() {
        await ShowResult();
    }

    async function ShowResult() {
        clearPrevResults(container_id_list);
        notyf.dismissAll();
        startBlockUI('SearchTable');

        await SpinnerModeFunction("Active");

        let country_id = document.getElementById("country").value;
        let request_link = 'http://' + location.host + "/GetRevokedTableData/" + country_id + '/';
        let response = await fetch(request_link).then(response => response.json());

        // revoked_data = response["revoked_data"]
        // console.log(revoked_data)

        await showDocumentInformation(response,$("#country option:selected").text());
        await SpinnerModeFunction("Disable");
        stopBlockUI('SearchTable', 'نتایج جست و جو');
    }


    async function showDocumentInformation(response,country_id) {
        revoked_data = response["revoked_data"];
        doc_count = response["doc_count"];
        
        document.getElementById("DocumentCount").innerText =
            (doc_count).toString() + " سند یافت شد.";

        let index = 1
        let document_result = []
        for (let revoked of revoked_data) {
            dest_document_id = revoked.dest_document_id
            src_document_id = revoked.src_document_id
            const detail_function = `DetailFunction('${revoked.src_para_id}', '${revoked.dest_para_id}', '${dest_document_id}', '${src_document_id}', '${revoked.src_document_name}', '${revoked.dest_document_name}')`
            const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" onclick="' + detail_function + '" data-bs-target="#myModal">جزئیات</button>'

            const src_document_link = 'http://' + location.host + "/information/?id=" + src_document_id
            const src_doc_name = '<a href="' + src_document_link + '">' + revoked.src_document_name + "</a>"

            const dest_document_link = 'http://' + location.host + "/information/?id=" + dest_document_id
            const dest_doc_name = '<a href="' + dest_document_link + '">' + revoked.dest_document_name + "</a>"

            const row = {
                "index": index, 
                "revoked_sub_type": revoked.revoked_sub_type,
                "revoked_type_name": revoked.revoked_type_name,
                "revoked_size": revoked.revoked_size,
                "src_document_name": src_doc_name,
                "dest_document_name": dest_doc_name,
                "detail": detail
            }
            document_result.push(row)
            index ++;
        }

        $('#SearchTable').empty();
        $('#SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                        first: '»',
                        prev:'›',
                        next: '‹',
                        last: '«'
                    }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "سندی یافت نشد.",
            "columns": [{
                "name": "index",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "src_document_name",
                "title": "ناسخ",
                "style": {
                    "width": "20%"
                }
            }, {
                "name": "dest_document_name",
                "title": "منسوخ",
                "style": {
                    "width": "20%"
                }
            }, {
                "name": "revoked_sub_type",
                "title": "صریح / ضمنی",
                "style": {
                    "width": "10%"
                }
            },{
                "name": "revoked_size",
                "title": "جزئی / کلی",
                "style": {
                    "width": "10%"
                }
            },{
                "name": "revoked_type_name",
                "title": "نوع عدم اعتبار",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "detail",
                "title": "جزئیات",
                "style": {
                    "width": "10%"
                }
            }
            ],
            "rows": document_result
        });





        // {# load charts #}
        // startBlockUI('bar_chart_info_pane');
        // let chart_data = []
        // let has_supervision = 0
        // let doesnt_have_supervision = 0
        // for (let executive of executive_list)
        // {
        //     if (executive['supervisions'].length > 0)
        //         has_supervision++;
        //     else
        //         doesnt_have_supervision++;
        // }
        // chart_data.push(['دارای ناظر', has_supervision])
        // chart_data.push(['بدون ناظر', doesnt_have_supervision])
        // showChart(chart_data, "sup_container", SearchResultValue, false,country_id,executive_list)


        // chart_data = []
        // let chart_data_dict = {}
        // for (let executive of executive_list)
        // {
        //     let sups = executive['supervisions']
        //     for (let sup of sups)
        //     {
        //         if(sup['name'])
        //         {
        //             if (chart_data_dict[sup['name']])
        //                 chart_data_dict[sup['name']] += 1;
        //             else
        //                 chart_data_dict[sup['name']] = 1
        //         }
        //     }
        // }
        // for (let key of Object.keys(chart_data_dict))
        // {
        //     chart_data.push([key, chart_data_dict[key]])
        // }
        // showChart(chart_data, "actor_container", SearchResultValue, false,country_id,executive_list)
        // showChartData(subject_chart_data, "subject_container", SearchResultValue, false)
        // showChartData(approval_year_chart_data, "year_container", SearchResultValue, true)
        // showChartData(approval_references_chart_data, "approval_container", SearchResultValue, false)
        // stopBlockUI('bar_chart_info_pane', 'داشبورد آماری');
    }

    async function DetailFunction(src_para_id,dest_para_id, dest_document_id, src_document_id, src_doc_name, dest_doc_name) {

        let country_id = document.getElementById("country").value;
        let request_link = 'http://' + location.host + "/GetDetailRevokedData/" + src_para_id + '/'+ dest_para_id + '/'+ dest_document_id + '/';
        let response = await fetch(request_link).then(response => response.json());
        let src_para_text = response['src_para_text']
        let dest_para_list = response['dest_para_list']

        await showDetailsDataExact(src_document_id,src_doc_name,
        src_para_text,dest_document_id,dest_doc_name,dest_para_list
        )
        
    }

    async function showDetailsDataExact(src_doc_id,src_doc_name,
    src_para_text,dest_doc_id,dest_doc_name,dest_para_list) {


        console.log(src_doc_name)

        /* Title Text */
        const src_document_link = 'http://' + location.host + "/information/?id=" + src_doc_id;
        let src_document_tag = "<a target='to_blank' href='" + src_document_link + "'>" + src_doc_name + "</a>";
        document.getElementById("src_document_header").innerHTML = 'سند ناسخ: ' + src_document_tag;


        const dest_document_link = 'http://' + location.host + "/information/?id=" + dest_doc_id;
        let dest_document_tag = "<a target='to_blank' href='" + dest_document_link + "'>" + dest_doc_name + "</a>";
        document.getElementById("dest_document_header").innerHTML = 'سند منسوخ: ' + dest_document_tag;

        /* Body Text */
        document.getElementById("SrcDocumentParagraph").innerHTML = '<ul>' + '<li class="text-right bold lh-lg">' +src_para_text + '</li>' +  '</ul>';
        dest_para_tag = ''
        for (para of dest_para_list){
            dest_para_tag += '<li class="text-right lh-lg">' + para + '</li>'
        }

        document.getElementById("DestDocumentParagraph").innerHTML = '<ul>' + dest_para_tag  +  '</ul>';

        


        // document.getElementById("DetailText").innerHTML = '<p class="m-4">'+supervisions_text+'</p>';
        popup_handler();
    }


    function showChartData(data, container, documents_information_result, keySort) {
        let chart_data = []
        for (const [key, value] of Object.entries(data)) {
            chart_data.push([value["name"], value["count"]])
        }
        showChart(chart_data, container, documents_information_result, keySort,'',{})
    }

    function showChart(data, position, documents_information_result, keySort,country_id,sups) {


        if (keySort === true) {
            data.sort(function (element_a, element_b) {
                return element_a[0] - element_b[0];
            });
        }
        else {
            data.sort(function (element_a, element_b) {
                return element_a[1] - element_b[1];
            });
        }

        data.sort(function (x, y) { return x[0] === 'نامشخص' ? -1 : y[0] === 'نامشخص' ? 1 : 0; });

        // Sorts the data by descending.
        data = anychart.data.set(data)

        document.getElementById(position).innerHTML = ""

        chart = anychart.column();
        chart.container(position);
        // create a column series and set the data
        var series = chart.column(data);
        chart
            .animation(true)
            .padding([10, 40, 5, 20])


        chart.background().fill('#ffffff');
        series.normal().fill("#488fb8", 1);
        series.normal().stroke("#488fb8", 0);

        // var state = series.normal();
        // state.fill('#1481c0')

        // x axix labels font setting
        var xAxisLabels = chart.xAxis().labels();
        xAxisLabels.fontFamily("vazir");

        var yAxisLabels = chart.yAxis().labels();
        yAxisLabels.fontFamily("vazir");

        // Not allow labels overlapping
        var xAxis = chart.xAxis();
        xAxis.overlapMode("noOverlap");

        var yAxis = chart.yAxis();
        yAxis.title("تعداد سند");
        yAxis.title().fontFamily('vazir');
yAxis.title().fontWeight("bold");
        yAxis.title().height(40);

        // tooltip content font setting
        var tooltip = chart.tooltip();
        tooltip.fontFamily("vazir");

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir");

        chart.tooltip().hAlign('center').format("{%value}");

        chart.xAxis().labels().height(60);

        chart.yAxis().labels().format("{%value}");

        chart.yScale().minimum(0);
        chart.yScale().ticks().allowFractional(false);

        //xAxisLabels.rotation(-90)
        // initiate drawing the chart
        chart.draw();

        chart.listen('Click', async function (event) {
            const click_tag = event.domTarget.tag;
            const index = click_tag["index"]
            const text = data.row(index)[0];
            let filtered_result = []
            let header = ""
            let save_file_name = '';

            if (position === "sup_container") {
                filtered_result = sups.filter(function (row) {
                    if (text == 'بدون ناظر')
                    {
                        if (row["supervisions"].length===0)
                            return row
                    }
                    else
                    {
                        if (row["supervisions"].length>0)
                            return row
                    }
                });
                header = text
                save_file_name += " (مجموعه سند {1} و {2})".replace("1", country_id).replace("2", text)
            }

            else if (position === "subject_container") {
                filtered_result = documents_information_result.filter(function (row) {
                    if (row["subject"] === text)
                        return row
                });
                header = "موضوع: " + text
                save_file_name += " (مجموعه سند {1} و موضوع {2})".replace("1", filtered_result[0]["country"]).replace("2", text)
            }

            else if (position === "approval_container") {
                filtered_result = documents_information_result.filter(function (row) {
                    if (row["approval_reference"] === text)
                        return row
                });
                header = "مرجع تصویب: " + text
                save_file_name += " (مجموعه سند {1} و مرجع تصویب {2})".replace("1", filtered_result[0]["country"]).replace("2", text)
            }

            else if (position === "year_container") {
                filtered_result = documents_information_result.filter(function (row) {
                    if (row["approval_date"].substring(0, 4) === text.toString() || (text.toString() === row['approval_date']))
                        return row
                });
                header = "سال تصویب: " + text
                save_file_name += " (مجموعه سند {1} و سال تصویب {2})".replace("1", filtered_result[0]["country"]).replace("2", text)
            }

            else if (position === "actor_container") {
                filtered_result = sups.filter(function (row) {
                    for(let supervision of row['supervisions'])
                    {
                        if(supervision['name']===text)
                            return row
                    }
                });
                header = "مرجع ناظر: " + text
                save_file_name += " (مجموعه سند {1} و به عنوان ناظر {2})".replace("1", country_id).replace("2", text)
            }


            document.getElementById("ChartModalHeader").innerText = header
            let filtered_result_tag = ""
            let list_of_docId = ""
            for (const doc of filtered_result) {
                const link = 'http://' + location.host + "/information/?id=" + doc["id"]
                let tag = "<li class='mt-3' id=" + doc["id"] + "><a href='" + link + "'>" + doc["name"] + "</a></li>"
                filtered_result_tag += tag
                list_of_docId += doc["id"] + "_"
            }

            filtered_result_tag = "<ol start='1'>" + filtered_result_tag + "</ol>"
            document.getElementById("ChartModalText").innerHTML = filtered_result_tag


            /* download file creation */
            document.getElementById("DownloadDocuments").onclick = function () {
                downloadFiles(filtered_result, save_file_name);
            };

            /* export into excel files */
            document.getElementById("ExportExcel2").onclick = function ExportExcelFunction() {

                var csv = "";

                sep = ","
                let Csv = "نام سند" + sep + "سطح سند" + sep +
                    "موضوع سند" + sep + "نوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + "\n"
                for (let document of filtered_result) {
                    let new_doc=document;
                    if(!document["level"])
                    {
                        for(let temp of documents_information_result)
                        {
                            if(temp['id']===parseInt(document['id']))
                            {
                                new_doc = temp;
                                break;
                            }
                        }
                    }
                    Csv += new_doc["name"] + sep + new_doc["level"] + sep + new_doc["subject"] + sep +
                        new_doc["type"] + sep + new_doc["approval_reference"] + sep + new_doc["approval_date"] + "\n"

                }

                let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
                var link = document.createElement("a");
                link.setAttribute("href", csvContent);
                link.setAttribute("download", save_file_name + ".csv");
                document.body.appendChild(link);
                link.click()
            };

            $("#ChartModalBtn").click();


        })

    }




    async function SpinnerModeFunction(mode) {
        if (mode === "Active") {
            $(".spinner-border").addClass("active");
        } else if (mode === "Disable") {
            $(".spinner-border").removeClass("active");
        }
    }


</script>

<!-- Export results -->

<script>

    async function downloadFiles(file_name_list, save_file_name) {
        startFullPageBlockUI()
        const country_id = document.getElementById("country").value

        let zip = new JSZip()

        const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["country_information"][0]
        const country_folder = response["folder"];
        const country_name = response["name"];

        save_file_name += " مجموعه سند {" + country_name + "}"


        let extension = ".txt"
        if (country_name.includes("فاوا")) {
            extension = '.docx';
        }


        for (const document of file_name_list) {
            const document_name = document['name'] + extension

            const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

            await fetch(path)
                .then(res => res.arrayBuffer())
                .then(value => {
                    zip.file(document_name, value);
                })
        }
        zip.generateAsync({
            type: "blob"
        })
            .then(function (content) {
                // see FileSaver.js
                saveAs(content, save_file_name + ".zip");
            });
        stopFullPageBlockUI( 'دانلود اسناد');
    }

    async function DownloadSerachResultFunction() {
        const save_file_name = " آئین‌نامه‌های اجرایی در"
        downloadFiles(SearchResultValue, save_file_name)
    }

    async function ExportExcelSerachResultFunction() {
        var csv = "";

        sep = ","


        let Csv = "نام آئین‌نامه‌" + sep + "سطح سند" + sep + "موضوع سند" + sep +
                "نوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + sep +
                "دارای ناظر" + sep +
            "مرجع/مراجع ناظر" + "\n"
        for (const document of SearchResultValue) {
            let new_doc=document;
            for(let temp of executive_list)
            {
                if(parseInt(temp['id'])===parseInt(document['id']))
                {
                    new_doc = temp;
                    break;
                }
            }
            let temp = ''

            for(let supervision of new_doc['supervisions'])
            {
                if (supervision['name'])
                    temp += ";" + supervision['name']
            }
            if(temp.length > 0)
                temp = temp.substring(1, temp.length)
            Csv += document["name"] + sep + document["level"] + sep + document["subject"] + sep +
                    document["type"] + sep + document["approval_reference"] + sep + document["approval_date"] + sep +
            (
            new_doc["has_supervision"]?
            'دارد'
            :
            'ندارد'
            )
            + sep + temp + "\n"
        }

        let save_file_name = " آئین‌نامه‌های اجرایی در"
        save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"

        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
        var link = document.createElement("a");
        link.setAttribute("href", csvContent);
        link.setAttribute("download", save_file_name + ".csv");
        document.body.appendChild(link);
        link.click()
    }

</script>


<script src="../../static/js/tooltip_handler.js"></script>
<!-- Intro Js -->

<!--<script src="../../static/js/UserLogSave.js"></script>-->
<script src="../../static/js/signout_function.js"></script>



</html>