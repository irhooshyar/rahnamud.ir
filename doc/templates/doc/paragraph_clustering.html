<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-radar.min.js"></script>

    <script src="../../static/library/anychart-base.min-8.10.0.js"></script>
    <!-- <script src="../../static/library/anychart-8.10.0-exports.min.js"></script> -->
    <script src="../../static/library/anychart-ui.min-8.10.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/anychart-ui.min-8.10.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/anychart-font.min-8.10.0.css">

    <script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-tag-cloud.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-heatmap.min.js"></script>
    <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../static/js/multiselect/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../static/js/multiselect/jquery.multi-select.js"></script>


    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">



    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <!-- Download Zip Files -->
    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/adaptation.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">

    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>


    <script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>

    <meta charset="UTF-8">
    <title>خوشه‌بندی احکام</title>
    {% include "doc/title_icon.html" %}


    <script>
        $(document).ready(function () {

            // Active panel
            $('#AIDropdown').addClass('active');
            $('#paragraph_clustering').addClass('active');



            // chart controller


            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });


        });
    </script>

</head>

<body>
    {% load static %}

    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">

        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" novalidate>

            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mt-2 mx-auto">

                <!-- Country Input مجموعه سند-->
                <div class="col-md-6  pt-3 col-12 col-lg-2 mt-1 bg-light" dir="rtl">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country"
                        class="form-select text-right float-right searchable-select" style="direction: rtl;"
                        onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        {% if v == 'فاوا' %}
                        <option value="{{ k }}">{{ v }}</option>

                        {% endif %}

                        {% if v == 'هوش‌یار' %}
                        <option value="{{ k }}">{{ v }}- قوانین</option>

                        {% endif %}

                        {% endfor %}
                    </select>
                </div>

                <!-- Clustering Algorithm -->
                <div class="col-md-6  pt-3 col-12 col-lg-2 mt-1 bg-light" dir="rtl">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">الگوریتم خوشه‌بندی:</label>
                    <select id="Clustering_Algorithm_Select"
                        class="form-select text-right float-right searchable-select" style="direction: rtl;">
                        <option value="K-Means">K-Means</option>
                        <option disabled value="LDA">LDA</option>

                        <!-- <option value="DB-SCAN">DB-SCAN</option> -->
                        <option disabled value="FCM">FCM</option>
                    </select>
                </div>


                <!-- Cluster Size  -->
                <div class="col-md-6  pt-3 col-12 col-lg-2 mt-1 bg-light" dir="rtl">
                    <label class="text-right bg-light float-right" style="direction: rtl;;">تعداد خوشه‌ها:</label>
                    <select id="Cluster_Count_Select" onchange="ShowResult()"
                        class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>
                </div>

                <!-- DocumentVector -->
                <div class="col-md-6  pt-3 col-12 col-lg-2 mt-1 bg-light" dir="rtl">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">نوع بردار:</label>
                    <select id="Document_Vector_Select" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;">
                        <option value="TF-IDF">TF-IDF</option>
                        <!-- <option>LDA</option> -->
                        <option disabled value="BERT">BERT</option>
                    </select>
                </div>

                <!-- ClusterName  -->
                <!-- <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light ActorSelect" id="multipleSelectDiv" style="direction: rtl;">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">موضوعات:</label>
                    <select id="ClusterNameSelect" class="form-select text-right float-right">
                    </select>

                </div> -->

                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 mt-1 col-12">
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right mr-2">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        نمایش
                    </button>

                </div>

            </div>



        </form>

        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">
                        نتایج خوشه‌بندی</button>
                </li>


                <li class="nav-item float-right" role="presentation">
                    <button id="centroids_result_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#centroids_result_pane" type="button" role="tab"
                        aria-controls="centroids_result_pane" aria-selected="false">تحلیل مراکز خوشه‌ها</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="discriminant_features_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#discriminant_features_pane" type="button" role="tab"
                        aria-controls="discriminant_features_pane" aria-selected="false">واژگان متمایزکننده</button>
                </li>


                <!-- Download Buttons -->
                <!-- <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                    class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>
                </button>

                <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button> -->

                <!-- Result Count -->



                <p country_id="{{k}}" id="SearchResultLable"
                    class="decision_tree_btn text-left float-left text-secondary pl-2">
                    تفسیرپذیری نتایج:

                    <a id="decision_tree_link"  class="decision_tree_link  text-primary fw-bold" target="_blank" style="text-decoration: none;"
                        href="#">
                        (درخت تصمیم)
                    </a>

                </p>



            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">


                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                    aria-labelledby="search_result_tab">

                    <!-- Table Headers -->
                    <div class="mt-4">
                        <!-- Column Selection -->
                        <p id="ColumnSelection" class="text-left text-secondary float-right">فهرست براساس:</p>


                        <!-- Column select -->
                        <div class="col-md-6 col-12 col-lg-2 float-right">

                            <select id="ColumnSelect" onchange="show_table_result();"
                                class="form-select text-right float-right searchable-multi-select"
                                style="direction: rtl;">

                            </select>

                        </div>


                        <!-- Page select -->
                        <div class="col-md-6 col-12 col-lg-2 float-left">

                            <input type="number" disabled="true" onchange="TablePaginationChanged(event)"
                                id="TablePaginationInput" min="1" max="1" value="1"
                                class="form-select text-right float-right" style="direction: rtl;">

                        </div>


                        <!-- Result Pagination -->
                        <p id="ResultPagination" class="text-left text-secondary float-left">صفحه:
                            <span id="from_page">1</span>
                            /
                            <span id="total_page">1</span>
                        </p>

                    </div>
                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                        </table>
                    </div>
                </div>


                <!-- Centroids Pane -->
                <div id="centroids_result_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="centroids_result_tab">

                    <!-- HeatMap Pane -->

                    <h5 class="document_subject w-100 mt-4 text-center float-right pt-3 pb-3">
                        توزیع اندازه خوشه‌ها
                    </h5>
                    <br>
                    <div id="cluster_size_chart_container" style="height: 85vh" class="bg-white w-100 p-4">
                    </div>

                    <!-- Members Count Pane -->

                    <h5 class="document_subject w-100 mt-4 text-center float-right pt-3 pb-3">
                        فاصله مراکز خوشه‌ها
                    </h5>
                    <br>
                    <div id="heatmap_chart_container" style="height: 85vh" class="bg-white w-100 p-4">
                    </div>

                </div>

                <!-- Discriminant-Features Pane -->
                <div id="discriminant_features_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="discriminant_features_tab">

                    <!-- HeatMap Pane -->

                    <h5 class="document_subject w-100 mt-4 text-center float-right pt-3 pb-3">
                        واژگان متمایزکننده براساس الگوریتم ANOVA
                    </h5>
                    <br>
                    <div id="anova_chart_container" style="height: 85vh" class="bg-white w-100 p-4">
                    </div>

                    <!-- Members Count Pane -->

                    <h5 class="document_subject w-100 mt-4 text-center float-right pt-3 pb-3">
                        واژگان متمایزکننده براساس الگوریتم درخت تصمیم (ضریب Gini)
                    </h5>
                    <br>
                    <div id="decision_tree_chart_container" style="height: 85vh" class="bg-white w-100 p-4">
                    </div>

                </div>


            </div>
        </div>

    </div>

    </div>



    <!-- Details Modal Container -->
    <div class="modal fade" id="detailModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title">ابر واژگان</h5>
                    <div id="topic_keywords_container" class="w-80 text-right" dir="rtl"></div>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body bg-light text-justify">
                    <div id="DetailText" class="bg-light text-justify mx-2 h-100">
                    </div>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js">
    </script>

</body>
<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">

<script src="../../static/js/column.js"></script>
<script>
    CLUSTERS_DATA = {}

    CLUSTERING_ALG_ID = 0;

    TABLE_INFO = []
    const COLUMNS = {
        "anova":"واژگان متمایزکننده",
        "cloud": 'ابر واژگان',
        "detail": "احکام مرتبط"
    }




    container_id_list = ['SearchTable',
        'cluster_size_chart_container',
        'heatmap_chart_container',
        'anova_chart_container',
        'decision_tree_chart_container'
    ]

    function clearPrevResults(container_id_list) {
        for (let container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }
    }


    
    async function init() {


        document.getElementById("document_search").disabled = true;

        const country_name = $("#country option:selected").text();
        max_k = (country_name == 'فاوا') ? 20:55

        for (i= 5; i<= max_k; i+=5){
            option_tag = "<option value='" + i + "' >" + i + "</option>"
            document.getElementById('Cluster_Count_Select').innerHTML += option_tag
        }




        document.getElementById("document_search").disabled = false;
        await CountryChanged()


    }


    init()
    initSearchableSelects();
    append_column(COLUMNS)

    async function CountryChanged() {
        document.getElementById('Cluster_Count_Select').innerHTML = ""
        
        const country_name = $("#country option:selected").text();
        max_k = (country_name == 'فاوا') ? 20:55

        for (i= 5; i<= max_k; i+=5){
            option_tag = "<option value='" + i + "' >" + i + "</option>"
            document.getElementById('Cluster_Count_Select').innerHTML += option_tag
        }

        await ShowResult();
    }


    async function ShowResult() {

        clearPrevResults(container_id_list);

        startBlockUI('SearchTable');


        const country_id = document.getElementById("country").value;
        const country_name = $("#country option:selected").text();
        const algorithm_name = document.getElementById("Clustering_Algorithm_Select").value;
        const vector_type = document.getElementById("Document_Vector_Select").value;
        const cluster_count = document.getElementById("Cluster_Count_Select").value;





        let request_link = 'http://' + location.host + "/GetParagraph_Clusters/" + country_id + "/"
            + algorithm_name + "/" + vector_type + "/" + cluster_count + "/";

        let response = await fetch(request_link).then(response => response.json());

        clusters_data = response["clusters_data"]
        heatmap_chart_data = response["heatmap_chart_data"]

        anova_chart_data = response["anova_chart_data"]
        decision_tree_chart_data = response["decision_tree_chart_data"]
        CLUSTERING_ALG_ID = response["clustering_algorithm_id"]

        


        CLUSTERS_DATA = clusters_data
        cluster_size_chart_data = []

        index = 1
        document_result = []

        for ([cluster_id, info] of Object.entries(clusters_data)) {

            const cloud_function = `CloudFunction('${cluster_id}')`;
            const cloud = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + ' onclick="' + cloud_function + '" data-bs-target="#detailModal">مشاهده</button>'

            const detail_function = `DetailFunction('${country_id}','${cluster_id}')`;
            const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + ' onclick="' + detail_function + '" data-bs-target="#detailModal">جزئیات</button>'


            const anova_function = `ANOVAFunction('${cluster_id}')`;
            const anova = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + ' onclick="' + anova_function + '" data-bs-target="#detailModal">مشاهده</button>'

            const word_list = info['word_list']
            const cluster_size = info['cluster_size']
            const cluster_name = info['name']

            cluster_size_chart_data.push([cluster_name, cluster_size])

            const row = {
                "id": index, "cluster_name": cluster_name, "word_list": word_list, "cluster_size": cluster_size, "cloud": cloud,
                "detail": detail,"anova":anova
            }

            document_result.push(row)
            index += 1
        }
        TABLE_INFO = document_result
        show_table_result()

        $('#SearchTable').empty();
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '»',
                    prev: '›',
                    next: '‹',
                    last: '«'
                }
            },

            "filtering": {
                    "enabled": true,
                    "placeholder": "نام کلیدواژه ...",
                    "filters": [{
                        "name": "my-filter",
                        "query": $('.form-control').val(),
                        "columns": ["word_list"]
                    }]
                },

            "sorting": {
                "enabled": true
            },
            "empty": "موضوعی یافت نشد.",
            "columns": columns,
            "rows": TABLE_INFO
        });

        stopBlockUI('SearchTable', 'نتایج خوشه‌بندی');


        //------------- heatmap chart --------------------------------

        show_heatmap_charts('heatmap_chart_container', heatmap_chart_data, "تعداد پاراگراف");

        //------------- cluster-size chart --------------------------------

        showChart(cluster_size_chart_data, "cluster_size_chart_container", false, "خوشه", "تعداد پاراگراف")

        //------------- ANOVA chart --------------------------------

        showChart(anova_chart_data, "anova_chart_container", false, "واژه", "درصد امتیاز")

        //------------- DecisionTree chart --------------------------------

        showChart(decision_tree_chart_data, "decision_tree_chart_container", false, "واژه", "درصد امتیاز")



    }

    $('#decision_tree_link').on('click',function(e){
        e.preventDefault();
        const country_id = document.getElementById("country").value;

        decision_tree_url = 'http://' + location.host + "/decision_tree/" + country_id + "/" + CLUSTERING_ALG_ID + "/"
        window.open(decision_tree_url,'_blank')
    })


    function showChart(data, position, keySort, xAxisTitle, yAxisTitle) {


        if (keySort === true) {
            data.sort(function (element_a, element_b) {
                return element_a[0] - element_b[0];
            });
        }
        else {
            data.sort(function (element_a, element_b) {
                return element_a[1] - element_b[1];
            });
        }

        data.sort(function (x, y) { return x[0] === 'نامشخص' ? -1 : y[0] === 'نامشخص' ? 1 : 0; });

        if (data[0][0] == 0) {
            data[0][0] = 'نامشخص'
        }
        // Sorts the data by descending.
        data = anychart.data.set(data)

        document.getElementById(position).innerHTML = ""

        chart = anychart.column();
        chart.container(position);
        // create a column series and set the data
        var series = chart.column(data);
        chart
            .animation(true)
            .padding([10, 40, 5, 20])


        chart.background().fill('#ffffff');
        series.normal().fill("#488fb8", 1);
        series.normal().stroke("#488fb8", 0);

        // var state = series.normal();
        // state.fill('#1481c0')

        // x axix labels font setting
        var xAxisLabels = chart.xAxis().labels();
        xAxisLabels.fontFamily("vazir");
        // xAxisLabels.rotation(315);

        var yAxisLabels = chart.yAxis().labels();
        yAxisLabels.fontFamily("vazir");

        // Not allow labels overlapping
        let xAxis = chart.xAxis();
        xAxis.overlapMode("noOverlap");
        xAxis.title(xAxisTitle);
        xAxis.title().fontFamily('vazir');
        xAxis.title().fontWeight("bold");
        xAxis.title().height(40);

        var yAxis = chart.yAxis();
        yAxis.title(yAxisTitle);
        yAxis.title().fontFamily('vazir');
        yAxis.title().fontWeight("bold");
        yAxis.title().height(40);


        // tooltip content font setting
        var tooltip = chart.tooltip();
        tooltip.fontFamily("vazir");

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir");

        chart.tooltip().hAlign('center').format("{%value}");

        chart.xAxis().labels().height(60);

        chart.yAxis().labels().format("{%value}");

        chart.yScale().minimum(0);
        chart.yScale().ticks().allowFractional(false);

        //xAxisLabels.rotation(-90)
        // initiate drawing the chart
        chart.draw();

        chart.listen("mouseOver", function (e) {
            document.body.style.cursor = "pointer";
        });
        chart.listen("mouseOut", function (e) {
            document.body.style.cursor = "auto";
        });

    }


    async function show_heatmap_charts(container, data) {
        document.getElementById(container).innerHTML = ""

        // create a chart and set the data
        chart = anychart.heatMap(data);

        // set the container id
        chart.container(container);


        // set the chart title
        chart.title().fontFamily("vazir").textDirection('rtl');
        // chart.tooltip().format("{%yPercentOfTotal}% ({%value})\n\n{%custom_field}");
        chart.tooltip().fontFamily('vazir').textDirection('rtl');

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir").textDirection('rtl');

        // initiate drawing the chart
        chart.draw();
    }

    async function show_table_result() {
        selected_columns = ["id", "cluster_name", "word_list", "cluster_size"]
        selected_columns = find_selected_column(selected_columns)


        columns = [{
            "name": "id",
            "title": "ردیف",
            "breakpoints": "xs sm",
            "type": "number",
        }, {
            "name": "cluster_name",
            "title": "نام خوشه",
        }, {
            "name": "word_list",
            "title": "کلیدواژگان موضوعات",
        }, {
            "name": "cluster_size",
            "title": "تعداد اعضای خوشه",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "cloud",
            "title": "ابر واژگان",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "detail",
            "title": "احکام مرتبط",
            "style": {
                "width": "10%"
            }
        }, {
            "name": "anova",
            "title": "واژگان متمایزکننده",
            "style": {
                "width": "10%"
            }
        }]

        if (!selected_columns.includes("all")) {
            for (let column of columns) {
                if (selected_columns.includes(column["name"])) {
                    column["visible"] = true
                } else {
                    column["visible"] = false
                }
            }
        }


        $('#SearchTable').empty();
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '»',
                    prev: '›',
                    next: '‹',
                    last: '«'
                }
            },

            "filtering": {
                    "enabled": true,
                    "placeholder": "نام کلیدواژه ...",
                    "filters": [{
                        "name": "my-filter",
                        "query": $('.form-control').val(),
                        "columns": ["word_list"]
                    }]
                },
            
                "sorting": {
                "enabled": true
            },
            "empty": "موضوعی یافت نشد.",
            "columns": columns,
            "rows": TABLE_INFO
        });

    }

    function get_highlight_templates(keyword, keyword_tag) {
        highlight_templates = [
            // [keyword + ' ', keyword_tag + ' ']
            // , [' ' + keyword, ' ' + keyword_tag]
             [' ' + keyword + ' ', ' ' + keyword_tag + ' ']
            // , [keyword + '‌', keyword_tag + '‌']

            // , ['‌' + keyword, '‌' + keyword_tag]

            // , ['‌' + keyword + '‌', '‌' + keyword + '‌']


        ]
        return highlight_templates;
    }
    async function DetailFunction(country_id, topic_id) {
        startFullPageBlockUI()

        document.getElementById("DetailText").innerHTML = ""
        document.getElementById("topic_keywords_container").innerHTML = ""

        let request_link = 'http://' + location.host + "/Get_Topic_Paragraphs/" + country_id + "/"
            + topic_id + "/";

        let response = await fetch(request_link).then(response => response.json());
        topic_paragraphs = response["topic_paragraphs"]

        modal_header = "احکام خوشه شماره:  " + CLUSTERS_DATA[topic_id]["name"].replaceAll('C', '')
        keyword_list = CLUSTERS_DATA[topic_id]['word_list'].split(' -').slice(0, 20)

        i = 0
        for (keyword of keyword_list) {
            i += 1
            let tag = '<div class="form-check form-check-inline float-right py-2 pb-1"><input class="form-check-input topic_keyword' + '" id="kw_' + i + '" style="padding:0;"  type="checkbox" value="' + keyword + '" checked = "true"><label class="form-check-label">' + keyword + '</label> </div>'
            document.getElementById("topic_keywords_container").innerHTML += tag;
        }

        document.getElementById("ModalHeader").innerHTML = modal_header

        body_tag = ""

        for ([doc_id, doc_info] of Object.entries(topic_paragraphs)) {

            paragraphs_list = doc_info['para_list']
            doc_name = doc_info['doc_name']

            const doc_link = 'http://' + location.host + "/document_profile/?id=" + doc_id
            let doc_tag = "<a class='bold text-secondary' target='blank' href='" + doc_link + "'>" + doc_name + "</a>"


            doc_ul = ""


            for (let paragraph of paragraphs_list) {
                j = 0
                for (keyword of keyword_list) {
                    j += 1
                    keyword = keyword.trim()

                    keyword_tag = '<span class="text-primary fw-bold h_kw_' + j + '">' + keyword + '</span>'

                    // highlight_templates = get_highlight_templates(keyword, keyword_tag);

                    // for (h_t of highlight_templates) {
                    //     if (keyword.length > 2)
                    //         paragraph = paragraph.replaceAll(h_t[0], h_t[1])
                    // }
                    paragraph = paragraph.replaceAll(' ' + keyword + ' ', ' ' + keyword_tag + ' ')


                }

                tag = "<li class='mb-3 lh-lg'>" + paragraph + "</li>"
                doc_ul += tag;
            }

            doc_ul = "<li class='mb-3 lh-lg'>" + doc_tag + "<ul class='border-right border-gray border-2'>" + doc_ul + "</ul>" + "</li>"
            body_tag += doc_ul

            document.getElementById("DetailText").innerHTML = "<ol start='1'>" + body_tag + "</ol>"
        }
        $('.topic_keyword').change(function () {

            if (this.checked) {
                $('.h_' + this.id).addClass('text-primary fw-bold')

            } else {
                $('.h_' + this.id).removeClass('text-primary fw-bold')

            }
        })
        stopFullPageBlockUI('احکام مرتبط');

    }

    async function ANOVAFunction(cluster_id){
        cluster_name = CLUSTERS_DATA[cluster_id]['name'];
        discriminat_words_chart_data = CLUSTERS_DATA[cluster_id]['discriminat_words_chart_data'];
        
        document.getElementById("ModalHeader").innerHTML = "واژگان متمایزکننده خوشه " + cluster_name + " از سایر خوشه‌ها"
        document.getElementById("DetailText").innerHTML = ""
        document.getElementById("topic_keywords_container").innerHTML = ""
        startFullPageBlockUI()

        showChart(discriminat_words_chart_data, "DetailText", false, "واژه", "درصد امتیاز")
        stopFullPageBlockUI('واژگان متمایزکننده');

    }

    async function CloudFunction(cluster_id) {
        startFullPageBlockUI()
        document.getElementById("ModalHeader").innerHTML = "ابر واژگان"
        document.getElementById("DetailText").innerHTML = ""
        document.getElementById("topic_keywords_container").innerHTML = ""

        tag_cloud_data = CLUSTERS_DATA[cluster_id]['tag_cloud_data'];
        cluster_name = CLUSTERS_DATA[cluster_id]['name'];

        await show_TagCloud_chart(tag_cloud_data, cluster_name, "DetailText")
        stopFullPageBlockUI('ابر واژگان');


    }

    async function show_TagCloud_chart(tag_cloud_data, cluster_name, container) {
        // create a chart and set the data

        document.getElementById(container).innerHTML = ""

        var chart = anychart.tagCloud(tag_cloud_data);
        chart.fontFamily('vazir');

        // set the chart title
        chart.title("خوشه :شماره " + cluster_name.replaceAll('C', ''));
        chart.title().fontFamily("vazir").textDirection('rtl');
        // chart.tooltip().format("{%yPercentOfTotal}% ({%value})\n\n{%custom_field}");
        chart.tooltip().fontFamily('vazir').textDirection('rtl');

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir").textDirection('rtl');

        // configure angles
        chart.angles([0]);
        chart.textSpacing(10);
        // set the container id
        chart.container(container);
        // chart.tooltip().format("{امتیاز: %yPercentOfTotal}% \n({%value})");
        chart.tooltip().format("امتیاز: {%yPercentOfTotal}%");

        // initiate drawing the chart
        chart.draw();
    }

    function popup_handler() {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl)
        });
    }
</script>


<script src="../../static/js/tooltip_handler.js"></script>

<script src="../../static/js/UserLogSave.js"></script>
<script src="../../static/js/signout_function.js"></script>
<script src="../../static/js/actors/actors_tour.js"></script>
<script src="../../static/js/tour.js"></script>







</html>