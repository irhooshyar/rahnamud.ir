<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>

    <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../static/js/multiselect/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../static/js/multiselect/jquery.multi-select.js"></script>


    <!-- jsnetworkx -->
    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="../../static/js/jsnetworkx.js"></script>


    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <!-- Download Zip Files -->
    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/adaptation.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">



    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <meta charset="UTF-8">
    <title>چرخه حیات تنظیم‌گری</title>
    {% include "doc/title_icon.html" %}

    <script>
        $(document).ready(function () {

            // Active panel
            $('#RegularityDropdown').addClass('active');
            $('#regularity_life_cycle_panel').addClass('active');

            // chart controller
            $('#pie_chart_btn').on('click', function (e) {
                $('#tools_dist_chart_container').fadeOut();
                $('#tools_pie_chart_container').fadeIn();
            });

            $('#bar_chart_btn').on('click', function (e) {
                $('#tools_pie_chart_container').fadeOut();
                $('#tools_dist_chart_container').fadeIn();
            });


            $('#regularity_life_cycle').addClass('active');
            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });


        });
    </script>

</head>

<body>

    <!-- Menu -->

    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">

        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" novalidate>

            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mt-2 mx-auto">

                <!-- Country Input -->
                <div class="col-md-6  pt-3 col-12 col-lg-2 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;" onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>

                </div>


                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button id="advanced_search" type="button" class="btn float-right" data-bs-toggle="collapse"
                        data-bs-target="#advanced_fields" aria-expanded="true" aria-controls="advanced_fields">تنظیمات
                        پیشرفته</button>
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        نمایش
                    </button>
                </div>

            </div>

            <!-- Advanced Fields in Second Row -->
            <div id="advanced_fields" class="collapse show row flex-row-reverse mx-auto mt-4">

                <!-- Search Box input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1">
                    <label class="float-right" style="direction: rtl;"> کلیدواژه‌های کسب‌وکار <span style="color: red">*</span>:</label>
                    <input style="direction: rtl;" class="float-left form-control text-right"
                        placeholder="کلیدواژه اول/ کلیدواژه دوم/ ..." type="text" required="" name="KeywordsBox"
                        id="KeywordsBox" value="" name="KeywordsBox">
                </div>

                <!-- Regularity Tools input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class="text-right bg-light float-right" style="direction: rtl;;">ابزار تنظیم:</label>

                    <select id="RegularityToolsSelect" class="form-select text-right float-right searchable-multi-select"
                        style="direction: rtl;">
                    </select>

                </div>

                <!-- Regularity life cycle input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class="text-right bg-light float-right" style="direction: rtl;;">چرخه حیات:</label>

                    <select id="RegularityLifeCycleSelect" class="form-select text-right float-right searchable-multi-select"
                        style="direction: rtl;">
                    </select>

                </div>


            </div>

        </form>

        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">نتایج جست‌وجو</button>
                </li>


                <!-- Download Buttons -->
                <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                    class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

                </button>

                <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button>

                <!-- Result Count -->
                <p id="DocumentCount" dir="rtl" class="text-left float-left text-secondary  pl-2"></p>

            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">

                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                    aria-labelledby="search_result_tab">

                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                        </table>
                    </div>

                </div>

            </div>

        </div>


    </div>


    <!-- Details Modal Container -->
    <div class="modal fade" id="detailModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="DetailText" class="modal-body bg-light text-justify">
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>

            </div>
        </div>
    </div>



{#    <!-- Tools Modal Container -->#}
{##}
{#    <button type="button" id="tool_modal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"#}
{#        data-bs-target="#tool_modal"></button>#}
{##}
{#    <div class="modal fade" id="tool_modal">#}
{#        <div class="modal-dialog modal-dialog-scrollable modal-xl">#}
{#            <div class="modal-content">#}
{##}
{#                <!-- Modal Header -->#}
{#                <div style="direction: rtl !important;" class="modal-header">#}
{#                    <h5 id="ToolModalHeader" class="modal-title">عنوان</h5>#}
{#                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>#}
{#                </div>#}
{##}
{#                <!-- Modal body -->#}
{#                <div id="ToolParagraphsModalBody" class="modal-body bg-light text-justify">#}
{#                </div>#}
{##}
{#                <!-- Modal footer -->#}
{#                <div class="modal-footer">#}
{#                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>#}
{#                </div>#}
{##}
{#            </div>#}
{#        </div>#}
{#    </div>#}



    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js">
    </script>

    <script src="../../static/js/adaption/adaption_tour.js">
    </script>
    <script src="../../static/js/tour.js"></script>


    <!-- Toast -->
    <div class="position-absolute top-0 start-50 translate-middle p-3" style="z-index: 11;margin-top:95px;">
        <div dir="rtl" id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div dir="rtl" class="toast-header">
                <img width="25px;" src="../../static/icons/logo/logo1.png" class="rounded mx-0" alt="...">
                <strong dir="rtl" class="w-100 mr-2 mt-1">هوش‌یار</strong>
                <button type="button" class="btn-close float-left ml-0" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <i style="position: relative; top: -7px; font-size: 18px;"
                    class="bi bi-exclamation-triangle-fill  text-warning"></i>
                <span id="toast_message">
                    موضوعی انتخاب نشده‌است.
                </span>
            </div>
        </div>
    </div>

</body>

<!-- save log user -->
<script>
    async function UserLog(form_data) {
        if (getCookie("username") !== "") {
            const user_name = getCookie("username")
            let page_url = window.location.pathname
            const user_ip = "127.0.0.0"
            page_url = page_url.slice(0, -1);
            if (page_url === "") {
                page_url = "/0";
            }


            let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                console.log("done")

            }).fail(function (res) {
                console.log("fail")
            });

        }
    }
</script>

<script>
    initSearchableSelects();
    let preprocessed_keywords_text = 'empty';
    let SearchResultValue = {}
    let multiselect_tool_value = '';
    let multiselect_life_cycle_value = '';

    init()


    container_id_list = ['SearchTable','DocumentCount']

    function clearPrevResults(container_id_list) {

        for (container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }
    }


    async function init() {

        let i;
        document.getElementById("document_search").disabled = true;

        const country_id = document.getElementById("country").value

        /****************** Regularity Tools List ****************************/
        request_link = 'http://' + location.host + "/GetRegularityToolsList/";
        response = await fetch(request_link).then(response => response.json());
        response = response["RegularityToolsList"]


        let options = [{ value:'0', text: 'همه' }];

        for (i = 0; i < response.length; i++) {
            const tool_id = response[i]["id"]
            const tool_name = response[i]["tool_name"]

            options.push( {value: tool_id, text: tool_name});
        }

        syncSelectOptions("RegularityToolsSelect", options);



        /****************** Regularity life cycle List ****************************/
        request_link = 'http://' + location.host + "/GetRegularityLifeCycleList/";
        response = await fetch(request_link).then(response => response.json());
        response = response["RegularityLifeCycleList"]



        options = [{ value:'0', text: 'همه' }];

        for (let i = 0; i < response.length; i++) {
            const life_cycle_name_id = response[i]["id"]
            const life_cycle_name = response[i]["life_cycle_name"]

            options.push( {value: life_cycle_name_id, text: life_cycle_name});
        }

        syncSelectOptions("RegularityLifeCycleSelect", options);


        document.getElementById("document_search").disabled = false;

        //user log
        let form_data = new FormData()
        let detail_type = "نمایش پنل"
        form_data.append('detail_type', detail_type);
        UserLog(form_data)
    }


    function CountryChanged() {
        clearPrevResults(container_id_list);
        init()
    }

    async function ShowResult() {
        clearPrevResults(container_id_list);

        multiselect_tool_value = await GetMultiSelectValue('RegularityToolsSelect');
        multiselect_life_cycle_value = await GetMultiSelectValueAllNames('RegularityLifeCycleSelect');



        const country_id = document.getElementById("country").value;

        const keywords_text = document.getElementById("KeywordsBox").value;
        let keywords_list = []

        keywords_list = keywords_text.split('/');
        keywords_list = keywords_list.map(function (keyword) {
            return keyword.trim();
        })

        keywords_list = keywords_list.filter(keyword => (keyword != '' && keyword != ' '));

        preprocessed_keywords_text = keywords_list.toString()

        if (preprocessed_keywords_text == '') {
            preprocessed_keywords_text = 'empty'
        }
        if (preprocessed_keywords_text === 'empty') {
            alert('کلیدواژه‌ای وارد نشده‌است.');
            $('#KeywordsBox').focus();
        }else {
            if (multiselect_tool_value == "") {
                showToastMessage(' ابزار تنظیم انتخاب نشده‌است.');
                $('#RegularityToolsSelect').focus();
            }
            else if (multiselect_life_cycle_value == "") {
                showToastMessage(' چرخه حیات انتخاب نشده‌است.');
                $('#RegularityLifeCycleSelect').focus();
            }
            else {
                notyf.dismissAll();
                startBlockUI('SearchTable');

                await SpinnerModeFunction("Active");


                request_link = 'http://' + location.host + "/SearchDocumentsByRegulatorsLifeCycleAndKeywords/"
                    + country_id + "/" + multiselect_tool_value + "/" + multiselect_life_cycle_value + "/" + preprocessed_keywords_text + "/";
                response = await fetch(request_link).then(response => response.json());

                documents_information_dict = response["documents_information_dict"];

                showDocumentInformation(documents_information_dict);
                stopBlockUI('SearchTable','نتایج جست‌وجو');
                await SpinnerModeFunction("Disable");

            }
        }

        //user log
        let form_data = new FormData()
        let detail_type = "نتایج جست و جو"
        let country_name_select = $("#country option:selected").text();
        let keywords_text_search = keywords_text
        let RegularityTools_Select = $("#RegularityToolsSelect option:selected").text();
        let RegularityLifeCycle_Select = $("#RegularityLifeCycleSelect option:selected").text();
        form_data.append('detail_type', detail_type);
        form_data.append('country_name_select', country_name_select);
        form_data.append('keywords_text_search', keywords_text);
        form_data.append('RegularityTools_Select', RegularityTools_Select);
        form_data.append('RegularityLifeCycle_Select', RegularityLifeCycle_Select);
        UserLog(form_data)



    }


    async function GetMultiSelectValue(tag) {
        var e = document.getElementById(tag);
        var selected = [...e.options]
            .filter(option => option.selected)
            .map(option => option.value)
        return selected.join("__")
    }
    async function GetMultiSelectValueAllNames(tag) {
        var e = document.getElementById(tag);
        var selected = [...e.options]
            .filter(option => option.selected)
            .map(option => option.innerText)
        if (selected[0] === 'همه')
            return [...e.options].map(option => option.innerText).filter(option => option !== 'همه').join("__")
        return selected.join("__")
    }


    async function showDocumentInformation(documents_information_dict) {

        SearchResultValue = documents_information_dict;

        document.getElementById("DocumentCount").innerText = (Object.keys(documents_information_dict).length).toString() + " سند یافت شد.";
        let index = 1;
        let document_result = []


        for (const [doc_id, doc_info] of Object.entries(documents_information_dict)) {


            const document_id = doc_id
            const document_name = doc_info["name"]
            const document_subject = doc_info['subject']
            let life_cycle_name = doc_info["life_cycle_name"]
            life_cycle_name = life_cycle_name.join(", ")

            const document_link = 'http://' + location.host + "/document_profile/?id=" + document_id
            const doc_name = '<a target="_blank" href="' + document_link + '">' + document_name + "</a>"

            const detail_function = "DetailFunction(" + document_id + ")"
            const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + ' onclick="' + detail_function + '" data-bs-target="#detailModal">جزئیات</button>'

            const row = {
                "id": index, "name": doc_name,
                'document_subject': document_subject,
                'life_cycle_name': life_cycle_name,
                "detail": detail
            }
            document_result.push(row)
            index += 1
        }
        $('#SearchTable').empty();
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                         first: '»',
                         prev:'›',
                         next: '‹',
                         last: '«'
                     }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "سندی یافت نشد.",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "name",
                "title": "نام سند",
                "style": {
                    "width": "45%"
                }
            }, {
                "name": "document_subject",
                "title": "موضوع سند",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "life_cycle_name",
                "title": "چرخه حیات",
                "style": {
                    "width": "40%"
                }
            }, {
                "name": "detail",
                "title": "جزئیات",
                "style": {
                    "width": "5%"
                }
            }
            ],
            "rows": document_result
        });

    }

    
    async function DetailFunction(document_id) {
        document.getElementById("DetailText").innerHTML = ""
        let request_link = 'http://' + location.host + "/GetLifeCycleParagraphsDetails_Modal/" + document_id +
            "/" + multiselect_tool_value + "/" + multiselect_life_cycle_value + "/" + preprocessed_keywords_text + "/"

        let response = await fetch(request_link).then(response => response.json());

        /*  Show detail Result */
        let document_paragraphs_result = response["document_paragraphs_result"]
        let document_name = response["document_name"]

        await showDetailsModal(document_id, document_name, document_paragraphs_result)

    }

    async function showDetailsModal(document_id, document_name, paragraphs_list) {
        /* Title Text */
        const link = 'http://' + location.host + "/document_profile/?id=" + document_id
        let title_tag = "<a target='blank' href='" + link + "'>" + document_name + "</a>"
        document.getElementById("ModalHeader").innerHTML = title_tag

        /* Body Text */
        const keywords = preprocessed_keywords_text.split(",")

        for (let paragraph of paragraphs_list) {

            highlighted_paragraph = await highlightParagraphs(paragraph, keywords)
            tag = "<li class='mb-3 lh-lg'>" + highlighted_paragraph + "</li>"
            document.getElementById("DetailText").innerHTML += tag;
        }
        document.getElementById("DetailText").innerHTML = "<ul>" + document.getElementById("DetailText").innerHTML + "</ul>"

    }

    async function highlightParagraphs(paragraph, keywords) {

        mojavez_pattern_keyword_1 = 'مجوز از'
        mojavez_pattern_keyword_2 = 'با مجوز'
        mojavez_pattern_keyword_3 = 'مجوز رسمی'
        mojavez_pattern_keyword_4 = 'مجوز رسمی از'
        mojavez_pattern_keywords_list = [mojavez_pattern_keyword_1, mojavez_pattern_keyword_2, mojavez_pattern_keyword_3, mojavez_pattern_keyword_4]


        ejaze_puntuations = ['،', ' ـ ', '.']

        let paragraph_text = paragraph['text']
        {#paragraph_tool = paragraph['tool']#}


        let keywords_list = await GetMultiSelectValueAllNames('RegularityToolsSelect')
        {#console.log(keywords_list)#}


        for (paragraph_tool of keywords_list.split("__")) {

            {#console.log(paragraph_tool)#}
            let tool_tag = "<span class='bg-secondary text-white px-1 rounded'>" + paragraph_tool + "</span> "
            paragraph_text = paragraph_text.replaceAll(paragraph_tool, tool_tag)

        }
        {#let temp_tag = "#".repeat(paragraph_tool.length)#}
        {#for (let paragraph_range of paragraph['highlights']) {#}
        {#    paragraph_text = paragraph_text.slice(0,paragraph_range[0]) +#}
        {#        paragraph_text.slice(paragraph_range[0],paragraph_range[1]+1).replaceAll(paragraph_tool, temp_tag) +#}
        {#        paragraph_text.slice(paragraph_range[1]+1,paragraph_text.length);#}
        //}



        for (word of keywords) {

            let tag = "<span class='bg-primary text-white px-1 rounded'>" + word + "</span> "

            if (paragraph_text.startsWith(word))
                paragraph_text = paragraph_text.replaceAll(word + ' ', tag + ' ');

            paragraph_text = paragraph_text.replaceAll(word + ' ', tag + ' ');
            paragraph_text = paragraph_text.replaceAll(' ' + word + ' ', ' ' + tag + ' ');
            paragraph_text = paragraph_text.replaceAll('(' + word + ')', '(' + tag + ')');
            paragraph_text = paragraph_text.replaceAll(' ' + word + '،', ' ' + tag + '،');
            paragraph_text = paragraph_text.replaceAll('(' + word + '،', '(' + tag + '،');
        }

        for (word of multiselect_life_cycle_value.split("__")) {

            let tag = "<span class='bg-info text-white px-1 rounded'>" + word + "</span> "

            {#let temp_tag_ = "@".repeat(word.length)#}
            {#for (let paragraph_range of paragraph['highlights']) {#}
            {#    paragraph_text = paragraph_text.slice(0,paragraph_range[0]) +#}
            {#        paragraph_text.slice(paragraph_range[0],paragraph_range[1]+1).replaceAll(word, temp_tag_) +#}
            {#        paragraph_text.slice(paragraph_range[1]+1,paragraph_text.length);#}
            //}
            paragraph_text = paragraph_text.replaceAll(word, tag)
        }



        return paragraph_text;

    }



    async function SpinnerModeFunction(mode) {
        if (mode === "Active") {
            $(".spinner-border").addClass("active");
        } else if (mode === "Disable") {
            $(".spinner-border").removeClass("active");
        }
    }



</script>


<!-- Export results -->

<script>

    async function downloadFiles(file_name_list, save_file_name) {
        startFullPageBlockUI()
        const country_id = document.getElementById("country").value

        let zip = new JSZip()

        const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["country_information"][0]
        const country_folder = response["folder"];
        const country_name = response["name"];

        save_file_name += " مجموعه سند {" + country_name + "}"


        let extension = ".txt"
        if (country_name.includes("فاوا")) {
            extension = '.docx';
        }


        for (const [doc_id, doc_info] of Object.entries(file_name_list)) {

            const document_name = doc_info['name'] + extension

            const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

            await fetch(path)
                .then(res => res.arrayBuffer())
                .then(value => {
                    zip.file(document_name, value);
                })
        }
        zip.generateAsync({
            type: "blob"
        })
            .then(function (content) {
                // see FileSaver.js
                saveAs(content, save_file_name + ".zip");
            });
        stopFullPageBlockUI( 'دانلود اسناد');
    }

    async function DownloadSerachResultFunction() {
        if (Object.entries(SearchResultValue).length == 0)
            return showToastMessage("لیست اسناد خالی است.")
        const save_file_name = " چرخه های حیات در"
        downloadFiles(SearchResultValue, save_file_name)
    }

    async function ExportExcelSerachResultFunction() {
        if (Object.entries(SearchResultValue).length == 0)
            return showToastMessage("لیست اسناد خالی است.")
        var csv = "";

        sep = ","


        let Csv = "نام سند" + sep + "موضوع سند" + sep + "چرخه حیات" +
            {#sep + "تاریخ تصویب" + sep +#}
            {#"تنظیم‌گر (ابزار تنظیم)" +#}
            "\n"
        for (const [doc_id, doc_info] of Object.entries(SearchResultValue)) {
            {#let document_regulators = doc_info["regulators"]#}
            {#document_regulators = document_regulators.toString().replaceAll(',', ' / ');#}

            Csv += doc_info['name'] + sep + doc_info['subject'] + sep +
                doc_info['life_cycle_name'] + sep +
                {#doc_info['approval_date'] + sep +#}
                {#document_regulators +#}
                "\n"

        }

        let save_file_name = " چرخه های حیات در"
        save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"

        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
        var link = document.createElement("a");
        link.setAttribute("href", csvContent);
        link.setAttribute("download", save_file_name + ".csv");
        document.body.appendChild(link);
        link.click()
    }



    function showToastMessage(message_text) {
        document.getElementById('toast_message').innerText = message_text
        var toastElList = [].slice.call(document.querySelectorAll('.toast'))
        var toastList = toastElList.map(function (toastEl) {
            return new bootstrap.Toast(toastEl)
        });
        toastList.forEach(toast => toast.show())
    }

     /* Search after press Enter */
    $("#info_form").submit(function() {return false;});
    $("#KeywordsBox").keyup(function (event) {
        if (event.keyCode === 13) {
            ShowResult()
        }
    });

</script>


<script src="../../static/js/tooltip_handler.js"></script>
<!-- Intro Js -->
<script src="../../static/js/regularity/regularity_tour.js">
</script>
<script src="../../static/js/tour.js"></script>

<script src="../../static/js/signout_function.js"></script>



<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">

</html>