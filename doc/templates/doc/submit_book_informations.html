<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <!-- commented for dromdown menu hover bug -->
    <!-- <link href="../../static/library/bootstrap-theme.min-3.3.6.css" rel="stylesheet"> -->
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">

    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>

    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">

    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">


    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">


    <!-- Blocking UI -->
    <script src="../../static/js/blockUI.js"></script>
   <script src="../../static/library/html2pdf.bundle.min-0.10.1.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="../../static/styles/loader.css">

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/recommendation.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <meta charset="UTF-8">

    <title> ثبت اطلاعات کتاب </title>
    {% include "doc/title_icon.html" %}

</head>

<body>
    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#BooksDropdown').addClass('active');
            $('#submit_book_informations').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });

        });
    </script>


    <!-- End of Menu -->

    <!-- Main Container -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-5">

        <div class="col">
        </div>
        <div class="col-7">


            <form class="shadow p-4 bg-white" id="submit_book_form" method="POST">

                <div class="row text">
                    <div class="form_title mb-3">
                     <p class="title ">فرم ثبت اطلاعات کتاب</p>
                    </div>
                    <div class="col mb-3">
                        <label for="bookname">نام کتاب <span style="color: red">*</span>:</label>
                        <select dir="rtl" id="bookname" name="bookname" class="form-select text-right float-right" onchange="BookChanged()">

                        </select>
                    </div>

                    <div class="col">
                        <label for="publishername">نام ناشر<span style="color: red">*</span>:</label>
                        <input type="text" class="form-control fa-input" id="publishername" required>
                    </div>

                    <div class="mb-3">
                        <label for="book_subject">موضوع کتاب<span style="color: red">*</span>:</label>
                        <input type="text" class="form-control fa-input" id="book_subject" required>
                    </div>

                    <div class="col mb-3">
                        <label for="year">سال کتاب <span style="color: red">*</span>:</label>
                        <input type="text" class="form-control fa-input" id="year" required>
                    </div>

                    <div class="mb-3">
                        <label for="pagecount">تعداد صفحه<span style="color: red">*</span>:</label>
                        <input type="text" class="form-control fa-input" id="pagecount" required>
                    </div>

                    <div class="mb-3 d-grid gap-2 col-6 mx-auto">
                        <button class="btn btn-primary" value="submit" onclick=SubmitResult() disabled > آپلود کتاب </button>
                    </div>                    


                    <div class="mb-3 d-grid gap-2 col-6 mx-auto">
                        <button class="btn btn-primary" value="submit" onclick=SubmitResult()>ثبت و ارسال</button>
                    </div>
                </div>
            </form>

        </div>
        <div class="col">
        </div>


    </div>
</body>


<script src="../../static/library/notyf.min.js"></script>

<script>
    const notyf = new Notyf();
    let ratingValue = 0
    var books_info = {}
    init();

    async function init() {
        request_link = 'http://' + location.host + "/get_all_books/";
        response = await fetch(request_link).then(response => response.json());   
        books_info = response['books'] 
        document.getElementById('bookname').innerHTML = ''
        document.getElementById('bookname').innerHTML += '<option value="' + '0' + '">' + '--انتخاب کنید--' + '</option>'
        for (let i = 0; i < books_info.length; i++) {
            let book_name = books_info[i].name
            let book_id = books_info[i].id
            document.getElementById('bookname').innerHTML += '<option value="' + book_id + '">' + book_name + '</option>'
        }
        BookChanged();   
    }

    async function BookChanged() {
        let book_id = document.getElementById('bookname').value
        for (let i = 0; i < books_info.length; i++) {
            if (books_info[i].id == book_id) {
                document.getElementById('publishername').value = books_info[i]['publisher_name'];
                document.getElementById('book_subject').value = books_info[i]['subject'];
                document.getElementById('year').value = books_info[i]['year'];
                document.getElementById('pagecount').value = books_info[i]['pagecount'];
                break
            }
        }
    }

    async function SubmitResult() {
        try {
            var book_id = document.getElementById("bookname").value;
            for (let i = 0; i < books_info.length; i++) {
                if (books_info[i].id == book_id) {
                    document_id = books_info[i]['document_id'];
                    break
                }
            }
            var publishername = document.getElementById("publishername").value;
            var book_subject = document.getElementById("book_subject").value;
            var year = document.getElementById("year").value;
            var pagecount = document.getElementById("pagecount").value;

            if (book_id == "0" || publishername == "" || book_subject == "" || year == "" || pagecount == "") {

                notyf.error('برای ثبت کتاب باید تمام فیلدها را پر نمایید.')
                return
            }

            request_link = 'http://' + location.host + "/submit_book_info_by_publisher/" + book_id + "/";
            response = await fetch(request_link).then(response => response.json());
            if (response['status'] == 'OK') {
                notyf.success('اطلاعات کتاب با موفقیت ثبت شد.')
            }
            else {
                if (response['status'] == 'duplicate') {
                    notyf.error('اطلاعات کتاب تکراری است.')
                }
                else {
                    notyf.error('خطایی در ثبت اطلاعات کتاب رخ داده است.')
                }
                return;
            }

            document.getElementById('bookname').innerHTML = ''
            document.getElementById('bookname').innerHTML += '<option value="' + '0' + '">' + '--انتخاب کنید--' + '</option>'
            for (let i = 0; i < books_info.length; i++) {
                let book_name = books_info[i].name
                let book_id = books_info[i].id
                document.getElementById('bookname').innerHTML += '<option value="' + book_id + '">' + book_name + '</option>'
            }
            
            document.getElementById("publishername").value = "";
            document.getElementById("book_subject").value = "";
            document.getElementById("year").value = "";
            document.getElementById("pagecount").value = "";

        }catch (e) {
            console.error(e)
            notyf.error('لطفا دوباره تلاش کنید');

        }

    }
    $("#submit_book_form").submit(function() {return false;});

    </script>

<!-- BS Tooltips handler -->
<script src="../../static/js/tooltip_handler.js"></script>
{% comment %} <script src="../../static/js/UserLogSave.js"></script> {% endcomment %}

<script src="../../static/js/signout_function.js"></script>

</html>