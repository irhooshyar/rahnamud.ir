<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">
    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">

    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>


    <!-- jsnetworkx -->
    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="../../static/js/jsnetworkx.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">
    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">



    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->
    <script src="../../static/js/chart.js"></script>

    <meta charset="UTF-8">
    <title> تحلیل آماری مصوبات</title>
    {% include "doc/title_icon.html" %}
</head>

<body>

    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#SubjectDropdown').addClass('active');
            $('#subject_statistics').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>

    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">

        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" novalidate>

            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mx-auto">
                <!-- Country Input -->
                <div class="col-md-6 pt-3 col-12 col-lg-4 bg-light" dir="rtl">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country" class="form-select text-right float-right searchable-select"
                        onchange="CountryChanged()" style="direction: rtl;">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>


        </form>
        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="budget_results_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#budget_results_pane" type="button" role="tab"
                        aria-controls="budget_results_pane" aria-selected="false"> قوانین بودجه</button>
                </li>
                <li class="nav-item float-right" role="presentation">
                    <button id="barname_results_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#barname_results_pane" type="button" role="tab"
                        aria-controls="barname_results_pane" aria-selected="false"> برنامه توسعه</button>
                </li>

            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">

                <!--  Budget Pane -->
                <div class="tab-pane fade show active float-right w-100" id="budget_results_pane" role="tabpanel"
                    aria-labelledby="budget_results_tab">
                    <div class="charts-list-container">
                        <div id="subject_container_budget" class="half"></div>
                        <div id="level_container_budget" class="half"></div>
                        <div id="year_container_budget" class="full" chart-height="850px"></div>
                        <div id="approval_container_budget" class="full" chart-height="1500px"></div>
                    </div>
                </div>


                <!-- Barname Pane -->
                <div class="tab-pane fade float-right w-100" id="barname_results_pane" role="tabpanel"
                    aria-labelledby="barname_results_tab">
                    <div class="charts-list-container">
                        <div id="subject_container_barname" class="half"></div>
                        <div id="level_container_barname" class="half"></div>
                        <div id="year_container_barname" class="full" chart-height="850px"></div>
                        <div id="approval_container_barname" class="full" chart-height="1500px"></div>
                    </div>
                </div>
            </div>

        </div>


    </div>

    <!-- ChartModal Container -->
    <button type="button" id="ChartModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#ChartModal"></button>
    <div class="modal fade" id="ChartModal">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ChartModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ChartModalText" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->


                <!-- Modal footer -->
                <div dir="rtl" class="modal-footer">
                    <button id="DownloadDocuments" class="btn btn-primary"><i class="fa fa-download"></i> دانلود
                        اسناد</button>

                    <button id="ExportExcel" class="btn btn-primary"><i class="fa fa-download"></i> خروجی اکسل</button>
                </div>

            </div>
        </div>
    </div>


    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
        <!-- <i class="bi bi-chevron-up"></i> -->
        <!-- <i class="bi bi-chevron-double-up"></i> -->
        <!-- <i class="bi bi-arrow-up-circle"></i> -->
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js"></script>

    <!-- Intro Js -->
    <script src="../../static/js/subject_statistics/subject_statistics_tour.js">
    </script>
    <script src="../../static/js/tour.js"></script>

    <!-- Blocking UI -->
    <script src="../../static/js/blockUI.js"></script>
    <script src="../../static/js/blockUI_handler.js"></script>
    <link rel="stylesheet" href="../../static/styles/loader.css">

    <!-- save log user -->
    <script>
        async function UserLog(form_data) {
            if (getCookie("username") !== "") {
                const user_name = getCookie("username")
                let page_url = window.location.pathname
                const user_ip = "127.0.0.0"
                page_url = page_url.slice(0, -1);
                if (page_url === "") {
                    page_url = "/0";
                }


                let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

                $.ajax({
                    url: link_request,
                    data: form_data,
                    type: 'POST',
                    contentType: false,
                    processData: false,
                    async: true,


                }).done(function (res) {
                    console.log("done")

                }).fail(function (res) {
                    console.log("fail")
                });

            }
        }
    </script>



    <script>
        initSearchableSelects();
        container_id_list = []

        function clearPrevResults(container_id_list) {

            for (container_id of container_id_list) {
                document.getElementById(container_id).innerHTML = "";
            }
        }

        init()

        async function init() {

            CountryChanged()

            //user log
            let form_data = new FormData()
            let detail_type = "نمایش پنل"
            form_data.append('detail_type', detail_type);
            UserLog(form_data)
        }

        async function CountryChanged() {


            showResult('قوانین بودجه');
            // *************************
            showResult('برنامه توسعه');

        }



        async function showResult(tab_name) {

            clearPrevResults(container_id_list);
            notyf.dismissAll();

            const country_id = document.getElementById("country").value
            const country_name = $('#country option:selected').text()

            let level_container = ''
            let subject_container = ''
            let year_container = ''
            let approval_container = ''

            if (tab_name == 'قوانین بودجه') {

                subject_container = 'subject_container_budget';
                level_container = 'level_container_budget';
                year_container = 'year_container_budget';
                approval_container = 'approval_container_budget';
                startBlockUI('budget_results_pane');


            } else {

                subject_container = 'subject_container_barname';
                level_container = 'level_container_barname';
                year_container = 'year_container_barname';
                approval_container = 'approval_container_barname';
                startBlockUI('barname_results_pane');
            }

            /* Make Request   */

            let request_link = 'http://' + location.host + "/" + "GetSubjectStatistics_ChartData" + "/" + country_id + "/" + tab_name + "/"

            let response = await fetch(request_link).then(response => response.json());
            console.log(response)

            /* Show Chart  */
            const subject_chart_data = response["subject_chart_data"]
            const approval_references_chart_data = response["approval_references_chart_data"]
            const level_chart_data = response["level_chart_data"]
            const approval_year_chart_data = response["approval_year_chart_data"]
            const type_chart_data = response["type_chart_data"]


            showChartData(subject_chart_data, subject_container, country_id,country_name, tab_name, true, 'موضوع سند', 'موضوع سند')
            showChartData(level_chart_data, level_container, country_id,country_name, tab_name, true, 'سطح سند', 'سطح سند')
            showChartData(approval_year_chart_data, year_container, country_id,country_name, tab_name, true, 'سال تصویب', 'سال تصویب')
            showChartData(approval_references_chart_data, approval_container, country_id,country_name, tab_name, true, 'مرجع تصویب', 'مرجع تصویب')

            if (tab_name == 'قوانین بودجه') {
                stopBlockUI('budget_results_pane', 'قوانین بودجه');

            } else {
                stopBlockUI('barname_results_pane', 'برنامه توسعه');

            }

            //user log
            let form_data = new FormData()
            let detail_type = "نتایج جست و جو"
            let country_name_select = country_name;
            form_data.append('detail_type', detail_type);
            form_data.append('country_name_select', country_name_select);
            UserLog(form_data)

        }


        function showChartData(chart_data, container, country_id,country_name, BoxName, keySort, xAxisTitle, title) {
            if (chart_data.length === 0) {
                document.getElementById(container).innerHTML = "<span class='d-block text-center' style='color: dodgerblue'><i class=\"fa fa-ban\" aria-hidden=\"true\"></i>هیچ سندی یافت نشد</span>";
            } else {
                showChart(chart_data, container, country_id,country_name, BoxName, keySort, xAxisTitle, title)
            }

        }

        function showChart(data, container, country_id,country_name,BoxName, sortKeys, xAxisTitle, title) {
            const options = {
                data,
                sortKeys,
                xAxisTitle,
                title,
                yAxisTitle: "تعداد سند",
                onClick: async function (event, data) {
                    document.getElementById("ChartModalText").innerHTML = ""
                    
                    const click_tag = event.domTarget.tag;
                    const index = click_tag["index"]
                    const text = data.row(index)[0];
                    const column_name = text
                    let filtered_result = []
                    let header = ""
                    let save_file_name = BoxName;
    
                    startFullPageBlockUI();
    
                    if (container.includes("subject_container")) {
                        chart_type = 'subject_chart_data'
    
                        header = "موضوع: " + text
                        save_file_name += " (مجموعه سند {1} و موضوع {2})".replace("1", country_name).replace("2", text)
                    }
                    else if (container.includes("approval_container")) {
    
                        chart_type = 'approval_reference_chart_data'
    
                        header = "مرجع تصویب: " + text
                        save_file_name += " (مجموعه سند {1} و مرجع تصویب {2})".replace("1", country_name).replace("2", text)
                    }
                    else if (container.includes("level_container")) {
                     
                        chart_type = 'level_chart_data'
    
                        header = "سطح سند: " + text
                        save_file_name += " (مجموعه سند {1} و سطح سند {2})".replace("1", country_name).replace("2", text)
                    }
                    
                    else if (container.includes("year_container")) {
                        
                        chart_type = 'approval_year_chart_data'
    
                        header = "سال تصویب: " + text
                        save_file_name += " (مجموعه سند {1} و سال تصویب {2})".replace("1", country_name).replace("2", text)
                    }
    
                    document.getElementById("ChartModalHeader").innerText = header
    
    
                    let request_link = 'http://' + location.host + "/GetSubjectStatistics_Column_Modal/" + country_id + "/" +
                    BoxName  + "/" + chart_type + "/" + column_name + "/"
    
                    let response = await fetch(request_link).then(response => response.json());
    
                    filtered_result = response['document_list']
    
                    
                    let filtered_result_tag = ""
                    let list_of_docId = ""
    
                    for (const doc of filtered_result) {
                        const link = 'http://' + location.host + "/document_profile/?id=" + doc["document_id"]
                        let tag = "<li class='mt-3' id=" + doc["document_id"] + "><a target='to_blank' href='" + link + "'>" + doc["document_name"] + "</a></li>"
                        filtered_result_tag += tag
    
                        list_of_docId += doc["document_id"] + "_"
                    }
                    filtered_result_tag = "<ol start='1'>" + filtered_result_tag + "</ol>"
                    document.getElementById("ChartModalText").innerHTML = filtered_result_tag
    
                    stopFullPageBlockUI('کلیک روی نمودار')
                    $("#ChartModalBtn").click();
    
                    /* download file creation*/
                    document.getElementById("DownloadDocuments").onclick = function () {
                        downloadFiles(filtered_result, save_file_name,country_id);
                    };
                    console.log(filtered_result)
                     /* export into excel files */
                    document.getElementById("ExportExcel").onclick = async function ExportExcelFunction() {
    
                        var csv = "";
    
                        sep = ","
                        let Csv = "نام سند" + sep + "سطح سند" + sep +
                            "موضوع سند" + sep + "نوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + "\n"
                        for (let document of filtered_result) {
                            Csv += document["document_name"] + sep + document["level_name"] + sep + document["subject_name"] + sep +
                                document["type_name"] + sep + document["approval_reference_name"] + sep + document["approval_date"] + "\n"
    
                       }
    
                        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
                        var link = document.createElement("a");
                        link.setAttribute("href", csvContent);
                        link.setAttribute("download", save_file_name + ".csv");
                        document.body.appendChild(link);
                        link.click()
                    };    
                }
            };

            if (container === "subject_container_budget" || container === "subject_container_barname") {
                newDoughnutChart(container, options);
            }
            else {
                newBarChart(container, options)
            }
        }


    </script>
    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>
    <script>
        async function downloadFiles(file_name_list, save_file_name,country_id) {
            startFullPageBlockUI()
            let zip = new JSZip()

            const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["country_information"][0]
            const country_folder = response["folder"];
            const country_name = response["name"];

            let extension = ".txt"
            if (country_name.includes("فاوا")) {
                extension = '.docx';
            }

            for (const document of file_name_list) {
                const document_name = document["document_name"] + extension
                const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

                await fetch(path)
                    .then(res => res.arrayBuffer())
                    .then(value => {
                        zip.file(document_name, value);
                    })
            }
            zip.generateAsync({
                type: "blob"
            })
                .then(function (content) {
                    // see FileSaver.js
                    saveAs(content, save_file_name + ".zip");
                });
            stopFullPageBlockUI( 'دانلود اسناد');
        }
    </script>

</body>

<!-- BS Tooltips handler -->
<script src="../../static/js/tooltip_handler.js"></script>



<!-- <script src="../../static/js/UserLogSave.js"></script>-->
<script src="../../static/js/signout_function.js"></script>



</html>