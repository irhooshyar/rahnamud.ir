<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css" />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-radar.min.js"></script>


    <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../static/js/multiselect/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../static/js/multiselect/jquery.multi-select.js"></script>





    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <!-- Download Zip Files -->
    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/adaptation.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">

    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../../static/js/GraphClass.js"></script>
    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <meta charset="UTF-8">
    <title>جست‌وجوی کنشگران</title>
    {% include "doc/title_icon.html" %}



    <script>
        $(document).ready(function () {

            // Active panel
            $('#ActorsDropdown').addClass('active');
            $('#actors_search').addClass('active');



            // chart controller
            $('#trend_chart_btn').on('click', function (e) {
                $('#radar_charts').fadeOut();
                $('#trend_charts').fadeIn();
            });

            $('#radar_charts_btn').on('click', function (e) {
                $('#trend_charts').fadeOut();
                $('#radar_charts').fadeIn();
            });

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });


        });
    </script>

</head>

<body>

    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>
    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">

        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" novalidate>

            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mt-2 mx-auto">

                <!-- Country Input -->
                <div class="col-md-6  pt-3 col-12 col-lg-2 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country"
                        class="form-select text-right float-right searchable-select" style="direction: rtl;"
                        onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>

                </div>

                <!-- Search Box input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3">
                    <label class="float-right" style="direction: rtl;">لیست کلیدواژه‌ها<span
                            style="color: red">(*)</span>:</label>
                    <input style="direction: rtl;" class="float-left form-control text-right"
                        placeholder="کلیدواژه اول/ کلیدواژه دوم/ ..." type="text" required="" name="KeywordsBox"
                        id="KeywordsBox" value="" name="KeywordsBox">
                </div>
                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button id="advanced_search" type="button" class="btn float-right" data-bs-toggle="collapse"
                        data-bs-target="#advanced_fields" aria-expanded="true" aria-controls="advanced_fields">تنظیمات
                        پیشرفته</button>
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        نمایش
                    </button>
                </div>

            </div>

            <!-- Advanced Fields in Second Row -->
            <div id="advanced_fields" class="collapse show row flex-row-reverse mx-auto mt-4">


                <!-- Actor Area-->
                <div class="col-md-6  pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">حوزه:</label>

                    <select id="ActorAreaSelect" onchange="AreaChanged()"
                        class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- Actor Sub-Area-->
                <div class="col-md-6  pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> زیر حوزه:</label>

                    <select disabled id="ActorSubAreaSelect" onchange="SubAreaChanged()"
                        class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- Actor -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light ActorSelect" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">کنشگر<span
                            style="color: red">(*)</span>:</label>

                    <select id="ActorSelect" class="form-select text-right float-right searchable-multi-select"
                        style="direction: rtl;">
                    </select>

                </div>

                <!-- Actor Role input -->
                <div id="selectDiv" class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light ActorRoleSelect" dir="rtl">

                    <label class="text-right bg-light float-right" style="direction: rtl;;">نقش کنشگر<span
                            style="color: red">(*)</span>:</label>

                    <select id="ActorRoleSelect" class="form-select text-right float-right searchable-multi-select"
                        style="direction: rtl;">
                    </select>

                </div>
            </div>
        </form>

        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="actor_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#actor_result_pane" type="button" role="tab" aria-controls="actor_result_pane"
                        aria-selected="true">نتایج جست‌وجو</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">اسناد مرتبط</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="chart_info_tab" class="nav-link" data-bs-toggle="pill" data-bs-target="#chart_info_pane"
                        type="button" role="tab" aria-controls="chart_info_pane" aria-selected="false">اطلاعات
                        نموداری</button>
                </li>


                <li class="nav-item float-right" role="presentation">
                    <button id="actors_graph_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#actors_graph_pane" type="button" role="tab" aria-controls="actors_graph_pane"
                        aria-selected="false">گراف کلیدواژه - کنشگر</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="actors_supervisors_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#actors_supervisors_pane" type="button" role="tab"
                        aria-controls="actors_supervisors_pane" aria-selected="false">گراف
                        نظارت</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="time_series_analysis_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#time_series_analysis_pane" type="button" role="tab"
                        aria-controls="time_series_analysis_pane" aria-selected="false">تحلیل اختصاصی کنشگر</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="actors_role_comparison_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#actors_role_comparison_pane" type="button" role="tab"
                        aria-controls="actors_role_comparison_pane" aria-selected="false">مقایسه کنشگران</button>
                </li>

                <!-- Download Buttons -->
                <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                    class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

                </button>

                <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button>

                <!-- Result Count -->
                <p id="DocumentCount" dir="rtl" class="text-left float-left text-secondary  pl-2"></p>

            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">


                <!-- Actor Result Pane -->
                <div id="actor_result_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                    aria-labelledby="actor_result_tab">

                    <!-- ActorTable  -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped ActorTable" style="min-height: 200px;" id="ActorTable">
                        </table>
                    </div>

                </div>

                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 float-right" role="tabpanel"
                    aria-labelledby="search_result_tab">

                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                        </table>
                    </div>

                </div>


                <!-- Actors Chart Pane -->
                <div id="chart_info_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="chart_info_tab">
                    <div class="row mt-4 w-100 flex-row mx-0 px-4">
                        <label id="chart_parallelism" class=" text-center bg-light float-center"
                            style="direction: rtl;">
                        </label>
                        <!-- <label id="chart_entropy" class=" text-center bg-light float-center" style="direction: rtl;">
                        </label>
                        <label id="chart_stats" class=" text-center bg-light float-center" style="direction: rtl;">
                        </label> -->

                        <div dir="ltr" id="actors_chart_container" style="height: 400px"
                            class="bg-white w-100 p-4 pb-2">
                        </div>
                    </div>

                </div>


                <!-- Actors Graph Pane -->
                <div id="actors_graph_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="actors_graph_tab">
                    <div class="row mt-4 w-100 flex-row mx-0 px-4 pb-5">

                        <div id="actors_graph_container" class="w-100 border" style="height: 500px;">
                        </div>
                    </div>

                </div>


                <!-- ActorsSupervisors Graph Pane -->
                <div id="actors_supervisors_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="actors_supervisors_tab">
                    <div class="row mt-4 w-100 flex-row mx-0 px-4 pb-5">

                        <div dir="ltr" id="actors_supervisors_graph_container" style="height: 400px"
                            class="bg-white w-100 p-1">
                        </div>
                    </div>

                </div>
                {% load static %}
                <!-- Time Series Chart  Pane -->
                <div id="time_series_analysis_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="time_series_analysis_tab">

                    <button id="trend_chart_btn" data-bs-toggle="tooltip" data-bs-placement="left" title="تحلیل زمانی"
                        class="btn px-1 py-0 mr-2 mt-1">
                        <img src="{% static 'icons/chart_icons/line_plot2.png' %}" alt="">
                    </button>
                    <br>

                    <button id="radar_charts_btn" data-bs-toggle="tooltip" data-bs-placement="left"
                        title="تحلیل حوزه فعالیت" class="btn px-1 py-0 mr-2 mb-1">
                        <img width="32px" src="{% static 'icons/chart_icons/radar_plot1.png' %}" alt="">
                    </button>

                    <div id="trend_charts" class="row mt-0 w-100 flex-row mx-0 px-4 pb-5">
                        <div dir="ltr" id="time_series_analysis_chart_container" style="height: 450px"
                            class="bg-white w-100 p-1">
                        </div>

                    </div>

                    <div id="radar_charts" class="row mt-0 w-100 flex-row mx-0 px-4 pb-5">

                        <div dir="ltr" id="subjects_radar_chart_container" style="height: 450px"
                            class="col-6 bg-white p-1">
                        </div>


                        <div dir="ltr" id="roles_radar_chart_container" style="height: 450px"
                            class="col-6 bg-white p-1">
                        </div>

                    </div>

                </div>


                <!-- Actors Role Chart  Pane -->
                <div id="actors_role_comparison_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="actors_role_comparison_tab">
                    <div class="row mt-4 w-100 flex-row mx-0 px-4 pb-5">
                        <div dir="ltr" id="all_roles_comparison_chart_container" style="height: 400px"
                            class="bg-white w-100 p-1">
                        </div>

                        <div dir="ltr" id="motevali_comparison_chart_container" style="height: 400px"
                            class="bg-white w-100 p-1">
                        </div>

                        <div dir="ltr" id="hamkar_comparison_chart_container" style="height: 400px"
                            class="bg-white w-100 p-1">
                        </div>

                        <div dir="ltr" id="salahiat_comparison_chart_container" style="height: 400px"
                            class="bg-white w-100 p-1">
                        </div>
                    </div>

                </div>

            </div>

        </div>

    </div>

    <!-- Details Modal Container -->
    <div class="modal fade" id="detailModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body bg-light text-justify">

                    <div class="highlight_options mt-0 p-0 float-left" style="z-index: 13;">
                        <button onclick="showOtherActors()" data-bs-toggle="tooltip" data-bs-placement="right"
                            title="نمایش سایر کنشگران" class="btn border float-left m-0  px-1"><i
                                style="font-size: 24px;" class="bi text-primary bi-people-fill"></i></button>
                        <!-- <button class="btn float-left m-0  px-1"><i style="font-size: 24px;" class="bi text-success bi-hourglass-split"></i></button> -->
                    </div>
                    <br>
                    <div id="DetailText" class="bg-light text-justify">
                    </div>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>

            </div>
        </div>
    </div>

    <!-- ChartModal Container -->
    <button type="button" id="actors_modal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#actors_modal"></button>
    <div class="modal fade" id="actors_modal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="actor_modal_header" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>
                <!-- Modal body -->

                <div class="bg-light modal-body text-justify">
                    <div class="highlight_options mt-0 p-0 float-left" style="z-index: 13;">
                        <button onclick="showOtherActors()" data-bs-toggle="tooltip" data-bs-placement="right"
                            title="نمایش سایر کنشگران" class="btn border float-left m-0  px-1"><i
                                style="font-size: 24px;" class="bi text-primary bi-people-fill"></i></button>
                        <!-- <button class="btn float-left m-0  px-1"><i style="font-size: 24px;" class="bi text-success bi-hourglass-split"></i></button> -->
                    </div>
                    <br>
                    <div id="actor_modal_body" class="bg-light text-justify">

                    </div>
                </div>
                <!-- Modal footer -->
                <div id="modal_footer" class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن
                    </button>
                </div>

            </div>
        </div>
    </div>


    <!-- ChartModal Container -->
    <button type="button" id="edge_modal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#edge_modal"></button>

    <div class="modal fade" id="edge_modal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <div id="edge_modal_header" class="modal-title">
                        <span class="text-secondary">کنش‌گر: </span>
                        <h5 id="edge_actor_modal_header" class="d-inline-block text-right"></h5>
                        <br>
                        <span class="text-secondary">کلیدواژه: </span>
                        <h6 id="edge_keyword_modal_header" class="d-inline-block text-right"></h6>
                    </div>

                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="edge_actor_paragraphs" class="modal-body bg-light text-justify">

                    <div class="highlight_options mt-0 p-0 float-left" style="z-index: 13;">
                        <button onclick="showOtherActors()" data-bs-toggle="tooltip" data-bs-placement="right"
                            title="نمایش سایر کنشگران" class="btn border float-left m-0  px-1"><i
                                style="font-size: 24px;" class="bi text-primary bi-people-fill"></i></button>
                        <!-- <button class="btn float-left m-0  px-1"><i style="font-size: 24px;" class="bi text-success bi-hourglass-split"></i></button> -->
                    </div>
                    <br>

                    <div id="edge_actor_modal_body">

                    </div>
                </div>


                <!-- Modal footer -->
                <div id="modal_footer" class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن
                    </button>
                </div>

            </div>
        </div>
    </div>


    <!-- Actor-Supervisor Edge modal Container -->
    <button type="button" id="actor_supervisor_edge_modal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#actor_supervisor_edge_modal"></button>

    <div class="modal fade" id="actor_supervisor_edge_modal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <div id="edge_modal_header" class="modal-title">
                        <span class="text-secondary">کنش‌گر: </span>
                        <h5 id="edge_actor_name_header" class="d-inline-block text-right"></h5>
                        <br>
                        <span class="text-secondary">ناظر: </span>
                        <h6 id="edge_supervisor_name_header" class="d-inline-block text-right"></h6>
                    </div>

                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="edge_actor_supervisor_paragraphs" class="modal-body bg-light text-justify">

                    <div class="highlight_options mt-0 p-0 float-left" style="z-index: 13;">
                        <button onclick="showOtherActors()" data-bs-toggle="tooltip" data-bs-placement="right"
                            title="نمایش سایر کنشگران" class="btn border float-left m-0  px-1"><i
                                style="font-size: 24px;" class="bi text-primary bi-people-fill"></i></button>
                        <!-- <button class="btn float-left m-0  px-1"><i style="font-size: 24px;" class="bi text-success bi-hourglass-split"></i></button> -->
                    </div>
                    <br>

                    <div id="edge_actor_supervisor_modal_body">

                    </div>
                </div>


                <!-- Modal footer -->
                <div id="modal_footer" class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن
                    </button>
                </div>

            </div>
        </div>
    </div>





    <!-- YearModal Container -->
    <button type="button" id="year_modal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#year_modal"></button>
    <div class="modal fade" id="year_modal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <div id="edge_modal_header" class="modal-title">
                        <span class="text-secondary">کنش‌گر: </span>
                        <h5 id="year_actor_modal_header" class="d-inline-block text-right"></h5>
                        <br>
                        <span class="text-secondary">در سال: </span>
                        <h6 id="year_name_modal_header" class="d-inline-block text-right"></h6>
                    </div>

                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->

                <div class="bg-light modal-body text-justify">
                    <div class="highlight_options mt-0 p-0 float-left" style="z-index: 13;">
                        <button onclick="showOtherActors()" data-bs-toggle="tooltip" data-bs-placement="right"
                            title="نمایش سایر کنشگران" class="btn border float-left m-0  px-1"><i
                                style="font-size: 24px;" class="bi text-primary bi-people-fill"></i></button>
                        <!-- <button class="btn float-left m-0  px-1"><i style="font-size: 24px;" class="bi text-success bi-hourglass-split"></i></button> -->
                    </div>
                    <br>
                    <div id="year_modal_body" class="bg-light text-justify">

                    </div>
                </div>
                <!-- Modal footer -->
                <div id="modal_footer" class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن
                    </button>
                </div>

            </div>
        </div>
    </div>


    <!-- Toast -->
    <div class="position-absolute top-0 start-50 translate-middle p-3" style="z-index: 11;margin-top:95px;">
        <div dir="rtl" id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div dir="rtl" class="toast-header">
                <img width="25px;" src="../../static/icons/logo/logo1.png" class="rounded mx-0" alt="...">
                <strong dir="rtl" class="w-100 mr-2 mt-1">هوش‌یار</strong>
                <button type="button" class="btn-close float-left ml-0" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <i style="position: relative; top: -7px; font-size: 18px;"
                    class="bi bi-exclamation-triangle-fill  text-warning"></i>
                <span id="toast_message">
                    موضوعی انتخاب نشده‌است.
                </span>
            </div>
        </div>
    </div>

    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js">
    </script>

</body>


<script>

    let actors_list = []
    let actors_dict = {}

    /* Optianal keywords need to be highlighted */
    const optional_keywords = ['به‌منظور', 'نسبت به']
    let optional_after_terms_count = {}
    optional_after_terms_count['به‌منظور'] = 2
    optional_after_terms_count['نسبت به'] = 2

    let preprocessed_keywords_text = 'empty';
    let SearchResultValue = {}
    let multiselect_role_value = '';
    let multiselect_actor_value = '';

    /* Global Constants */
    const motevalian_punctuations = ['.', '،', 'ـ', '-', ':'];
    const hamkaran_punctuations = ['،', ')', ':']

    const motevali_keywords = ['موظف است', 'مکلف است', 'مکلف‌اند', 'موظف‌اند', 'موظفند', 'مکلفند', 'موظف به', 'مکلف به'];
    const hamkaran_keywords = ['با همکاری', 'باهمکاری'];
    const salahiat_keywords = ['مختار است', 'اختیار دارد', 'می‌تواند', 'می تواند', 'میتواند', 'می­تواند', 'می‏تواند', 'مجاز است', 'اجازه داده می‌شود', 'اجازه داده می شود', 'اجازه داده  میشود'];


    const deadline_pattern_keywords = ['ظرف', 'ظرف مدت', 'ظرف مهلت', 'طی', 'طی مدت', 'طی مهلت', 'حداکثر', 'فواصل زمانی', 'هر']
    const time_categories = ['روز', 'هفته', 'ماه', 'سال']
    const numbers_dict = {
        "یک": {
            'value': 1,
        },
        "دو": {
            'value': 2,
        },
        "سه": {
            'value': 3,
        },
        "چهار": {
            'value': 4,
        },
        "پنج": {
            'value': 5,
        },
        "شش": {
            'value': 6,
        },
        "هفت": {
            'value': 7,
        },
        "هشت": {
            'value': 8,
        },
        "نه": {
            'value': 9,
        },
        "ده": {
            'value': 10,
        }
    }

    ENTROPY_DETAILS_TAG = ''


    initSearchableSelects()
    init()


    container_id_list = ['SearchTable', 'ActorTable', 'DocumentCount',
        'actors_chart_container', 'actors_graph_container', 'actors_supervisors_graph_container',
        'time_series_analysis_chart_container', 'motevali_comparison_chart_container',
        'hamkar_comparison_chart_container', 'salahiat_comparison_chart_container',
        'all_roles_comparison_chart_container',
        'roles_radar_chart_container', 'subjects_radar_chart_container',
        'chart_parallelism']

    function clearPrevResults(container_id_list) {

        for (let container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }
    }

    async function init() {
        document.getElementById("document_search").disabled = true;

        const country_id = document.getElementById("country").value

        /****************** Actors Area List ****************************/

        request_link = 'http://' + location.host + "/GetActorAreaList/";
        response = await fetch(request_link).then(response => response.json());
        response = response["ActorAreaList"]

        let options = [{ value: '0', text: 'همه' }];
        for (let i = 0; i < response.length; i++) {
            const area_id = response[i]["id"]
            const area_name = response[i]["area_name"]

            options.push({ value: area_id, text: area_name });
        }
        syncSelectOptions("ActorAreaSelect", options)

        /****************** Actors Role  List ****************************/

        request_link = 'http://' + location.host + "/GetActorRoleList/";
        response = await fetch(request_link).then(response => response.json());
        response = response["ActorRoleList"]

        options = [{ value: "0", text: "همه" }];

        for (let i = 0; i < response.length; i++) {
            const role_id = response[i]["id"]
            const role_name = response[i]["role_name"]

            options.push({ value: role_id, text: role_name });

        }
        syncSelectOptions('ActorRoleSelect', options)

        /* Actors List */
        document.getElementById("document_search").disabled = false;


        /* Get Actors List */
        request_link = 'http://' + location.host + "/GetActorsList/";
        response = await fetch(request_link).then(response => response.json());
        actors_list = response["actorsList"];

        /* Get Actors Dict */
        request_link = 'http://' + location.host + "/GetActorsDict/";
        response = await fetch(request_link).then(response => response.json());
        actors_dict = response['actorsDict']

    }

    async function CountryChanged() {
        clearPrevResults(container_id_list);
    }


    async function AreaChanged() {
        document.getElementById("document_search").disabled = true;

        let selected_area_id = document.getElementById('ActorAreaSelect').value
        let request_link = 'http://' + location.host + "/GetSubAreasByAreaId/" + selected_area_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["SubAreaList"];


        let options = [{ value: '0', text: 'همه' }];
        for (let i = 0; i < response.length; i++) {
            const sub_area_id = response[i]["id"]
            const sub_area_name = response[i]["name"]

            options.push({ value: sub_area_id, text: sub_area_name });
        }
        syncSelectOptions("ActorSubAreaSelect", options)
        document.getElementById("document_search").disabled = false;

    }

    async function SubAreaChanged() {

        document.getElementById("document_search").disabled = true;

        let selected_area_id = document.getElementById('ActorAreaSelect').value
        let request_link = 'http://' + location.host + "/GetActorsByAreaID/" + selected_area_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["ActorsList"];
        let options = [{ value: "0", text: "همه" }];

        for (let i = 0; i < response.length; i++) {
            const actor_id = response[i]["id"]
            const actor_name = response[i]["name"]

            options.push({ value: actor_id, text: actor_name });

        }
        syncSelectOptions('ActorSelect', options)
        document.getElementById("document_search").disabled = false;

    }



    async function ShowResult() {

        clearPrevResults(container_id_list);

        multiselect_role_value = await GetMultiSelectValue('ActorRoleSelect');
        multiselect_actor_value = await GetMultiSelectValue('ActorSelect');

        const country_id = document.getElementById("country").value;
        const area_id = document.getElementById("ActorAreaSelect").value;
        const keywords_text = document.getElementById("KeywordsBox").value;
        let keywords_list = []

        keywords_list = keywords_text.split('/');
        keywords_list = keywords_list.map(function (keyword) {
            return keyword.trim();
        })

        keywords_list = keywords_list.filter(keyword => (keyword !== '' && keyword !== ' '));

        preprocessed_keywords_text = keywords_list.toString()

        if (preprocessed_keywords_text === '') {
            preprocessed_keywords_text = 'empty';
        }
        if (multiselect_role_value === "") {
            showToastMessage('نقش کنشگر انتخاب نشده‌است.');
        }
        if (multiselect_actor_value === "") {
            showToastMessage('کنشگر انتخاب نشده‌است.');
        }
        // else if (preprocessed_keywords_text === 'empty'){
        else if (false) {
            showToastMessage('کلیدواژه‌ای وارد نشده‌است.');
            $('#KeywordsBox').focus();

        }
        else {
            await SpinnerModeFunction("Active");

            await ToggleActorsKeywordsGraphTabShow(preprocessed_keywords_text)
            await ToggleActorsTimeSeriesChartTabShow(multiselect_actor_value);
            await ToggleActorsComparisonChartTabShow(area_id, multiselect_actor_value);
            /****************** Get Actors Information Data ****************************/
            notyf.dismissAll();

            startBlockUI('ActorTable');

            let request_link = 'http://' + location.host + "/SearchActorsByKeywords/"
                + country_id + "/" + multiselect_role_value + "/" + area_id + "/" + multiselect_actor_value + "/" + preprocessed_keywords_text + "/";
            let response = await fetch(request_link).then(response => response.json());

            let actors_information_dict = response["actors_information_dict"];

            await showActorsInformation(actors_information_dict, multiselect_role_value, preprocessed_keywords_text, country_id);

            stopBlockUI('ActorTable', 'نتایج جست‌وجو');

            /****************** Get Documents Information Data ****************************/

            startBlockUI('SearchTable');

            request_link = 'http://' + location.host + "/SearchDocumentsByActorsKeywords/"
                + country_id + "/" + multiselect_role_value + "/" + area_id + "/" + multiselect_actor_value + "/" + preprocessed_keywords_text + "/";
            response = await fetch(request_link).then(response => response.json());

            let documents_information_dict = response["documents_information_dict"];

            await showDocumentInformation(documents_information_dict, area_id, multiselect_actor_value, multiselect_role_value, preprocessed_keywords_text);
            stopBlockUI('SearchTable', 'اسناد مرتبط');

            /****************** Get Actors Chart Data ****************************/

            await getActorsChartData(country_id, area_id, multiselect_actor_value, multiselect_role_value, preprocessed_keywords_text);


            /****************** Get Actors-Keywords Graph Data ****************************/

            if (preprocessed_keywords_text !== 'empty') {

                await getActorsKeywordsGraphData(country_id, area_id, multiselect_actor_value, multiselect_role_value, preprocessed_keywords_text)

            }

            /****************** Get Actors-Supervisors Graph Data ****************************/

            await getActorsSupervisorsGraphData(country_id, area_id, multiselect_actor_value, multiselect_role_value, preprocessed_keywords_text);


            /****************** Get Time-Series Chart Data ****************************/
            if (multiselect_actor_value.split('__').length == 1
                && !multiselect_actor_value.split('__').includes("0")) {

                await getTimeSeriesChartData(country_id, multiselect_role_value, multiselect_actor_value, preprocessed_keywords_text);
                $('#trend_chart_btn').hover();
                $('#trend_chart_btn').click();

                await getSubjectRadarChartData(country_id, multiselect_role_value, multiselect_actor_value, preprocessed_keywords_text);
                await getRoleRadarChartData(country_id, multiselect_role_value, multiselect_actor_value, preprocessed_keywords_text);

            }

            /****************** Get Actors-Comparison Chart Data ****************************/
            if ((area_id == '0' && multiselect_actor_value.split('__').includes('0'))
                || (multiselect_actor_value.split('__').length < 2) &&
                !(multiselect_actor_value.split('__').includes('0') && (area_id != '0'))
            ) {
                showToastMessage('برای «مقایسه کنشگران» می‌بایست حداقل 2 کنشگر انتخاب کنید (همچنین انتخاب تمام کنشگران امکان‌پذیر نیست!)')

            } else {
                await getActorsComparisonChartData(country_id, multiselect_role_value, multiselect_actor_value,
                    area_id, preprocessed_keywords_text)
            }


            await SpinnerModeFunction("Disable");
        }
    }

    /************** Actors-comparison chart data tab ***************************************/
    async function getActorsComparisonChartData(country_id, multiselect_role_value, multiselect_actor_value, area_id, preprocessed_keywords_text) {


        startBlockUI('actors_role_comparison_pane');

        let request_link = 'http://' + location.host + "/GetActorsComparison_ChartData/"
            + country_id + "/" + multiselect_role_value + "/" + area_id + "/" + multiselect_actor_value + "/" + preprocessed_keywords_text + "/";
        let response = await fetch(request_link).then(response => response.json());

        let years_chart_data = response["years_chart_data"];
        let selected_actors = response["selected_actors"];

        all_roles_chart_data = years_chart_data['برآیند نقش‌ها']
        motevali_chart_data = years_chart_data['متولی اجرا']
        hamkar_chart_data = years_chart_data['همکار']
        salahiat_chart_data = years_chart_data['دارای صلاحیت اختیاری']

        await showComparisonChartData(selected_actors, 'all_roles_comparison_chart_container', 'برآیند نقش‌ها', all_roles_chart_data, country_id, preprocessed_keywords_text)
        await showComparisonChartData(selected_actors, 'motevali_comparison_chart_container', 'متولی اجرا', motevali_chart_data, country_id, preprocessed_keywords_text)
        await showComparisonChartData(selected_actors, 'hamkar_comparison_chart_container', 'همکار', hamkar_chart_data, country_id, preprocessed_keywords_text)
        await showComparisonChartData(selected_actors, 'salahiat_comparison_chart_container', 'دارای صلاحیت اختیاری', salahiat_chart_data, country_id, preprocessed_keywords_text)

        stopBlockUI('actors_role_comparison_pane', 'مقایسه کنشگران');

    }

    async function showComparisonChartData(selected_actors, chart_container, role_name, chart_data, country_id, preprocessed_keywords_text) {


        document.getElementById(chart_container).innerHTML = ""

        // create a chart
        var chart = anychart.line();

        chart
            .animation(true)
            .padding([10, 60, 10, 0])


        // tooltip content font setting
        var tooltip = chart.tooltip();
        tooltip.fontFamily("vazir");

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir");

        // set the chart title
        chart.title(role_name);
        chart.title().fontFamily("vazir");;

        // set the interactivity mode
        // chart.interactivity().hoverMode("single");


        var data = anychart.data.set(chart_data)

        for (i = 0; i < selected_actors.length; i++) {
            let actor_name = selected_actors[i]
            var actor_series_data = data.mapAs({ x: 0, value: i + 1 });
            // create the first series, set the data and name
            var actor_series = chart.line(actor_series_data);
            actor_series.name(actor_name);


            // motevalian columns
            actor_series.listen('click', async function (event) {
                const click_tag_index = event.domTarget.tag;
                const doc_year = chart_data[click_tag_index][0];
                console.log(role_name, actor_name)
                await showYearParagraphs_Modal(country_id, actor_name, role_name, doc_year, preprocessed_keywords_text);

            });

        }


        // set the chart title

        // set the titles of the axes
        chart.xAxis().title("سال");
        chart.yAxis().title("تعداد وظایف");


        // x axix labels font setting
        var xAxisLabels = chart.xAxis().labels();
        xAxisLabels.fontFamily("vazir");

        var yAxisLabels = chart.yAxis().labels();
        yAxisLabels.fontFamily("vazir");

        // Not allow labels overlapping
        var xAxis = chart.xAxis();
        xAxis.overlapMode("noOverlap");
        xAxis.title().fontFamily('vazir');
        xAxis.title().fontWeight("bold");

        // xAxis.staggerMode(false);

        var yAxis = chart.yAxis();
        yAxis.title().fontFamily('vazir');
        yAxis.title().fontWeight("bold");
        yAxis.title().height(40);

        // chart.xScale().mode('continuous');
        chart.yScale().ticks().allowFractional(false)

        // set the container id
        chart.container(chart_container);


        // enable the legend
        chart.legend(true);

        var legend = chart.legend();
        legend.fontFamily('vazir')

        // set position mode
        legend.positionMode("inside");
        // set position and alignement
        legend.position("top");
        legend.align("center");
        legend.itemsLayout("horizontalExpandable");


        // Enable drag and drop
        legend.drag(true);


        // Set maximum width.
        legend.maxWidth("60%");
        legend.maxHeight("15%");

        // legend settings
        var paginator = chart.legend().paginator();
        // set paginator layout
        paginator.layout("horizontal");
        // place paginator on the right
        paginator.orientation("top");

        // initiate drawing the chart
        chart.draw();


    }

    /************** Subject Radar chart data tab ***************************************/

    async function getSubjectRadarChartData(country_id, multiselect_role_value, actor_id, preprocessed_keywords_text) {

        startBlockUI('subjects_radar_chart_container');

        let request_link = 'http://' + location.host + "/GetActorSubjectsRadar_ChartData/"
            + country_id + "/" + multiselect_role_value + "/" + actor_id + "/" + preprocessed_keywords_text + "/";
        let response = await fetch(request_link).then(response => response.json());

        let subjects_chart_data = response["subjects_chart_data"];

        console.log(subjects_chart_data)

        let actor_name = GetMultiSelectText('ActorSelect');

        await showRadarChart('subjects_radar_chart_container', actor_name, subjects_chart_data, 'تحلیل موضوعی', country_id, preprocessed_keywords_text)
        stopBlockUI('subjects_radar_chart_container', 'حوزه موضوعی کنشگر');
    }

    /************** Role Radar chart data tab ***************************************/

    async function getRoleRadarChartData(country_id, multiselect_role_value, actor_id, preprocessed_keywords_text) {

        startBlockUI('roles_radar_chart_container');

        let request_link = 'http://' + location.host + "/GetActorRolesRadar_ChartData/"
            + country_id + "/" + multiselect_role_value + "/" + actor_id + "/" + preprocessed_keywords_text + "/";
        let response = await fetch(request_link).then(response => response.json());

        let roles_chart_data = response["roles_chart_data"];

        console.log(roles_chart_data)

        let actor_name = GetMultiSelectText('ActorSelect');

        await showRadarChart('roles_radar_chart_container', actor_name, roles_chart_data, 'تحلیل نقش', country_id, preprocessed_keywords_text)
        stopBlockUI('roles_radar_chart_container', 'تحلیل نقش‌های کنشگر');
    }

    async function showRadarChart(chart_container, actor_name, chart_data, chart_pre_title, country_id, preprocessed_keywords_text) {
        document.getElementById(chart_container).innerHTML = ""


        anychart.onDocumentReady(function () {

            // create a chart
            chart = anychart.radar();


            chart
                .animation(true)
                .padding([10, 60, 10, 0])

            // set the chart title
            chart_title = chart_pre_title + '\n' + "کنشگر: " + actor_name + "\n"

            chart.title(chart_title);
            chart.title().fontFamily("vazir");;


            // create the first series (line) and set the data
            var series = chart.line(chart_data);

            series.normal().stroke("4 #00cc99");
            series.hovered().stroke("4 #00cc99");
            series.selected().stroke("4 #00cc99");

            // set the container id
            chart.container(chart_container);
            // initiate drawing the chart


            // chart.xScale().mode('continuous');
            chart.yScale().ticks().allowFractional(false)


            // x axix labels font setting
            var xAxisLabels = chart.xAxis().labels();
            xAxisLabels.fontFamily("vazir");
            xAxisLabels.fontWeight(600);

            // y axix labels font setting
            var yAxisLabels = chart.yAxis().labels();
            yAxisLabels.fontFamily("vazir");

            chart.tooltip().title().fontFamily('vazir');
            chart.tooltip().fontFamily('vazir');
            chart.tooltip().hAlign('center').format("{%value}%");

            chart.yGrid().palette(["gray 0.05", "gray 0.1"]);

            chart.draw();

        });
    }

    /************** Time-Series chart data tab ***************************************/

    async function getTimeSeriesChartData(country_id, multiselect_role_value, actor_id, preprocessed_keywords_text) {

        startBlockUI('time_series_analysis_chart_container');

        let request_link = 'http://' + location.host + "/GetActorTimeSeries_ChartData_ByKeywords/"
            + country_id + "/" + multiselect_role_value + "/" + actor_id + "/" + preprocessed_keywords_text + "/";
        let response = await fetch(request_link).then(response => response.json());

        let years_chart_data = response["years_chart_data"];

        let actor_name = GetMultiSelectText('ActorSelect');

        await showYearsLineChart('time_series_analysis_chart_container', actor_name, years_chart_data, country_id, preprocessed_keywords_text)
        stopBlockUI('time_series_analysis_chart_container', 'تحلیل اختصاصی کنشگر');
    }


    async function showYearsLineChart(chart_container, actor_name, chart_data, country_id, preprocessed_keywords_text) {


        document.getElementById(chart_container).innerHTML = ""

        // create a chart
        var chart = anychart.line();

        chart
            .animation(true)
            .padding([10, 60, 10, 0])


        // tooltip content font setting
        var tooltip = chart.tooltip();
        tooltip.fontFamily("vazir");

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir");

        // set the chart title
        chart_title = "تحلیل زمانی\n" + "کنشگر: " + actor_name + '\n'
        chart.title(chart_title);
        chart.title().fontFamily("vazir");;

        // set the interactivity mode
        // chart.interactivity().hoverMode("single");


        var data = anychart.data.set(chart_data)

        var total_series_data = data.mapAs({ x: 0, value: 4 });
        // create the second series, set the data and name
        var total_series = chart.line(total_series_data);
        total_series.name("برآیند نقش‌ها");

        // configure the visual settings of the second series
        total_series.normal().stroke("#6a0dad", 2, "10 5", "round");
        total_series.hovered().stroke("#6a0dad", 4, "10 5", "round");
        total_series.selected().stroke("#6a0dad", 6, "10 5", "round");


        var hamkaran_series_data = data.mapAs({ x: 0, value: 2 });
        // create the second series, set the data and name
        var hamkaran_series = chart.line(hamkaran_series_data);
        hamkaran_series.name("همکار");

        // configure the visual settings of the second series
        hamkaran_series.normal().stroke("#28a745", 2, "10 5", "round");
        hamkaran_series.hovered().stroke("#28a745", 4, "10 5", "round");
        hamkaran_series.selected().stroke("#28a745", 6, "10 5", "round");


        // map the data
        var salahiat_series_data = data.mapAs({ x: 0, value: 3 });

        // create the first series, set the data and name
        var salahiat_series = chart.line(salahiat_series_data);
        salahiat_series.name("دارای صلاحیت اختیاری");

        // configure the visual settings of the first series
        salahiat_series.normal().stroke("#ffc107", 2, "10 5", "round");
        salahiat_series.hovered().stroke("#ffc107", 4, "10 5", "round");
        salahiat_series.selected().stroke("#ffc107", 6, "10 5", "round");


        var motevalian_series_data = data.mapAs({ x: 0, value: 1 });
        // create the first series, set the data and name
        var motevalian_series = chart.line(motevalian_series_data);
        motevalian_series.name("متولی اجرا");

        // configure the visual settings of the first series
        motevalian_series.normal().stroke("#007bff", 2, "10 5", "round");
        motevalian_series.hovered().stroke("#007bff", 4, "10 5", "round");
        motevalian_series.selected().stroke("#007bff", 6, "10 5", "round");

        // set the chart title

        // set the titles of the axes
        chart.xAxis().title("سال");
        chart.yAxis().title("تعداد وظایف");


        // x axix labels font setting
        var xAxisLabels = chart.xAxis().labels();
        xAxisLabels.fontFamily("vazir");

        var yAxisLabels = chart.yAxis().labels();
        yAxisLabels.fontFamily("vazir");

        // Not allow labels overlapping
        var xAxis = chart.xAxis();
        xAxis.overlapMode("noOverlap");
        xAxis.title().fontFamily('vazir');
        xAxis.title().fontWeight("bold");

        // xAxis.staggerMode(false);

        var yAxis = chart.yAxis();
        yAxis.title().fontFamily('vazir');
        yAxis.title().fontWeight("bold");
        yAxis.title().height(40);

        // chart.xScale().mode('continuous');
        chart.yScale().ticks().allowFractional(false)

        // set the container id
        chart.container(chart_container);


        // enable the legend
        chart.legend(true);

        var legend = chart.legend();
        legend.fontFamily('vazir')

        // set position mode
        legend.positionMode("inside");
        // set position and alignement
        legend.position("top");
        legend.align("center");
        legend.itemsLayout("horizontalExpandable");

        // initiate drawing the chart
        chart.draw();

        // motevalian columns
        motevalian_series.listen('click', async function (event) {
            const click_tag_index = event.domTarget.tag;
            const doc_year = chart_data[click_tag_index][0];
            const actor_role_name = 'متولی اجرا';

            await showYearParagraphs_Modal(country_id, actor_name, actor_role_name, doc_year, preprocessed_keywords_text);

        });

        // hamkaran columns
        hamkaran_series.listen('click', async function (event) {
            const click_tag_index = event.domTarget.tag;
            const doc_year = chart_data[click_tag_index][0];
            const actor_role_name = 'همکار';

            await showYearParagraphs_Modal(country_id, actor_name, actor_role_name, doc_year, preprocessed_keywords_text);
        });

        // salahiat columns
        salahiat_series.listen('click', async function (event) {
            /* Modal Headers */
            const click_tag_index = event.domTarget.tag;
            const doc_year = chart_data[click_tag_index][0];
            const actor_role_name = 'دارای صلاحیت اختیاری';

            await showYearParagraphs_Modal(country_id, actor_name, actor_role_name, doc_year, preprocessed_keywords_text);
        });

        // total columns
        total_series.listen('click', async function (event) {
            /* Modal Headers */
            const click_tag_index = event.domTarget.tag;
            const doc_year = chart_data[click_tag_index][0];
            const actor_role_name = 'برآیند نقش‌ها';

            await showYearParagraphs_Modal(country_id, actor_name, actor_role_name, doc_year, preprocessed_keywords_text);
        });


    }


    async function showYearParagraphs_Modal(country_id, actor_name, actor_role_name, doc_year, preprocessed_keywords_text) {
        startFullPageBlockUI()

        request_link = 'http://' + location.host + "/GetActorYearParagraphs_Line_Modal/" + country_id + "/" + actor_name + "/" + actor_role_name + "/"
            + doc_year + "/" + preprocessed_keywords_text + "/";
        response = await fetch(request_link).then(response => response.json());
        const year_paragraphs_result = response["year_paragraphs"]

        document.getElementById('year_modal_body').innerHTML = ""
        console.log(year_paragraphs_result)

        /* Modal Title */
        const title_tag = actor_name + ' (' + actor_role_name + ')'
        $('#year_actor_modal_header').text(title_tag);

        const year_tag = doc_year
        $('#year_name_modal_header').text(year_tag);

        paragraph_tag = '';
        let keywords_list = preprocessed_keywords_text.split(",")

        for (const [paragraph_id, paragraph_info] of Object.entries(year_paragraphs_result)) {
            document_id = paragraph_info['document_id']
            document_name = paragraph_info['document_name']

            document_link = 'http://' + location.host + "/information/?id=" + document_id
            doc_name = '<a class="bold text-secondary" target="to_blank" href="' + document_link + '">' + document_name + "</a>"

            paragraph_text = paragraph_info['text']
            actor_form = paragraph_info['actor_form']
            actor_role = paragraph_info['actor_role']
            is_ref_actor = paragraph_info['is_ref_actor']
            ref_text = paragraph_info['ref_text']

            highlighted_paragraph = await highlightParagraphs(paragraph_text, actor_name, actor_role, actor_form, keywords_list, false, is_ref_actor, ref_text)

            paragraph_tag += "<li class='mb-3 lh-lg'>" + doc_name + highlighted_paragraph + "</li>";

        }


        document.getElementById('year_modal_body').innerHTML = '<ol start="1">' + paragraph_tag + '</ol>'
        popup_handler();

        $("#year_modal_btn").click();


        stopFullPageBlockUI('اسناد مرتبط با سال')
    }

    /************** Actors-Supervisors Graph tab ***************************************/

    async function getActorsSupervisorsGraphData(country_id, area_id, multiselect_actor_value, multiselect_role_value, preprocessed_keywords_text) {
        startBlockUI('actors_supervisors_graph_container');

        let request_link = 'http://' + location.host + "/GetActorsSupervisorsGraphData/"
            + country_id + "/" + area_id + "/" + multiselect_actor_value + "/" + preprocessed_keywords_text + "/";
        let response = await fetch(request_link).then(response => response.json());

        let actors_supervisors_graph_data = response["actors_supervisors_graph_data"];
        await showActorsKeywordsGraph('actors_supervisors_graph_container', actors_supervisors_graph_data, 'Directed', country_id, multiselect_role_value, preprocessed_keywords_text);
        stopBlockUI('actors_supervisors_graph_container', 'گراف نظارت');
    }

    async function showActorSupervisorEdgeModal(paragraphs_dict_result, source_actor_name, supervisor_name, preprocessed_keywords_text) {

        let keywords_list = preprocessed_keywords_text.split(',')

        /* Title Text */
        $('#edge_actor_name_header').text(source_actor_name)
        $('#edge_supervisor_name_header').text(supervisor_name)
        /* Body Text */

        document.getElementById("edge_actor_supervisor_modal_body").innerHTML = ""
        let paragraph_tag = '';

        for (const [paragraph_id, paragraph_info] of Object.entries(paragraphs_dict_result)) {
            document_id = paragraph_info['document_id']
            document_name = paragraph_info['document_name']

            document_link = 'http://' + location.host + "/information/?id=" + document_id
            doc_name = '<a class="bold text-secondary" target="to_blank" href="' + document_link + '">' + document_name + "</a>"

            paragraph_text = paragraph_info['paragraph_text'];
            source_actor_form = paragraph_info['source_actor_form']
            supervisor_actor_form = paragraph_info['supervisor_actor_form']

            highlighted_paragraph = await highlightActorSupervisor(paragraph_text, source_actor_form, supervisor_actor_form, keywords_list)
            paragraph_tag += "<li class='mb-3 lh-lg'>" + doc_name + highlighted_paragraph + "</li>"
        }

        document.getElementById("edge_actor_supervisor_modal_body").innerHTML = "<ul>" + paragraph_tag + "</ul>"

        $('#actor_supervisor_edge_modal_btn').click();

    }

    async function highlightActorSupervisor(paragraph_text, source_actor_form, supervisor_actor_form, keywords_list) {

        report_keywords = ['گزارش عملکرد', 'گزارش']
        paragraph_text = await highlightMotevalian(paragraph_text, source_actor_form, motevali_keywords, 'bg-success');
        paragraph_text = await highlightLegalDeadline(paragraph_text, motevali_keywords)


        // highlight other actors
        paragraph_text = await highlightOtherActors(paragraph_text, source_actor_form)

        // Highlight search keywords
        if (!keywords_list.includes('empty')) {
            for (keyword of keywords_list) {
                let keyword_tag = "<span class= 'bg-info text-white  rounded px-1'>" + keyword + "</span>"
                paragraph_text = paragraph_text.replaceAll(keyword, keyword_tag);

            }
        }

        // Highlight report keywords
        for (keyword of report_keywords) {
            report_keyword_tag = "<span class='border border-secondary border-2  px-1 rounded'>" + keyword + "</span>"
            paragraph_text = paragraph_text.replaceAll(' ' + keyword + ' ', ' ' + report_keyword_tag + ' ')

        }

        return paragraph_text;
    }

    /************** Actors result tab ***************************************/

    async function showActorsInformation(actors_information_dict, multiselect_role_value, preprocessed_keywords_text, country_id) {


        // document.getElementById("DocumentCount").innerText = (Object.keys(actors_information_dict).length).toString() + " سند یافت شد.";
        let index = 1;
        let actor_result = []
        let sorted_column = '';

        if (preprocessed_keywords_text.includes('empty')) {
            sorted_column = 'actor_roles'
        } else {
            sorted_column = 'keywords'
        }
        /* sort result dict by keyword_len */
        var actors_information_dict_sorted = Object.keys(actors_information_dict).map(function (key) {
            return [key, actors_information_dict[key]];
        });
        actors_information_dict_sorted.sort(function (first, second) {
            return second[1][sorted_column].length - first[1][sorted_column].length;
        });

        for (const actor_info of actors_information_dict_sorted) {

            const actor_id = actor_info[0]
            const actor_name = actor_info[1]["actor_name"]
            const actor_roles = actor_info[1]["actor_roles"]
            const actor_keyword = actor_info[1]["keywords"]

            const actor_link = 'http://' + location.host + "/actors_information/?country_id=" + country_id + "/?actor_id=" + actor_id
            const actor_tag = '<a  target="to_blank" href="' + actor_link + '">' + actor_name + "</a>"

            const detail_function = "ActorDetailFunction(" + actor_id + ")"
            const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + ' onclick="' + detail_function + '" data-bs-target="#detailModal">جزئیات</button>'

            const row = {
                "id": index,
                "actor_name": actor_tag,
                'actor_roles': actor_roles.join(' - '),
                'actor_keyword': actor_keyword.join(' - '),
                "detail": detail
            }
            actor_result.push(row)
            index += 1
        }
        $('#ActorTable').empty();
        $('.ActorTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '»',
                    prev: '›',
                    next: '‹',
                    last: '«'
                }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "سندی یافت نشد.",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "actor_name",
                "title": "نام کنشگر",
                "style": {
                    "width": "30%"
                }
            }, {
                "name": "actor_roles",
                "title": "نقش کنشگر",
                "style": {
                    "width": "25%"
                }
            }, {
                "name": "actor_keyword",
                "title": "کلیدواژگان",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "detail",
                "title": "جزئیات",
                "style": {
                    "width": "5%"
                }
            }
            ],
            "rows": actor_result
        });



    }

    async function ActorDetailFunction(actor_id) {

        let roles_id = multiselect_role_value;
        let country_id = document.getElementById("country").value
        let request_link = 'http://' + location.host + "/GetActorParagraphsDetails_Modal/" + country_id + "/" + actor_id + "/" + roles_id + "/" + preprocessed_keywords_text + "/"

        let response = await fetch(request_link).then(response => response.json());

        /*  Show detail Result */
        let actor_paragraphs_result = response["actor_paragraphs_result"]
        let actor_name = response["actor_name"]
        await showActorDetailModal(actor_id, actor_name, actor_paragraphs_result)

    }

    async function showActorDetailModal(actor_id, actor_name, actor_paragraphs_result) {

        document.getElementById("DetailText").innerHTML = ""

        /* Title Text */
        document.getElementById("ModalHeader").innerText = actor_name

        /* Body Text */
        let keywords_list = preprocessed_keywords_text.split(",")

        document.getElementById("DetailText").innerHTML = ""

        for (let [actor_role, paragraph_dict] of Object.entries(actor_paragraphs_result)) {
            // paragraph_list = paragraph_info['paragraph_list']
            // paragraph_actor_form = paragraph_info['actor_form']

            paragraph_tag = ''
            actor_role_li = '<h5 class="bold">' + actor_role + ':' + '</h5>'
            document.getElementById("DetailText").innerHTML += actor_role_li;

            for (const [paragraph_id, paragraph_info] of Object.entries(paragraph_dict)) {
                document_id = paragraph_info['document_id']
                document_name = paragraph_info['document_name']

                document_link = 'http://' + location.host + "/information/?id=" + document_id
                doc_name = '<a class="bold text-secondary" target="to_blank" href="' + document_link + '">' + document_name + "</a>"

                paragraph_text = paragraph_info['text']
                actor_form = paragraph_info['actor_form']
                is_ref_actor = paragraph_info['is_ref_actor']
                ref_paragraph_text = paragraph_info['ref_text']

                highlighted_paragraph = await highlightParagraphs(paragraph_text, actor_name, actor_role, actor_form, keywords_list, false, is_ref_actor, ref_paragraph_text)
                paragraph_tag += "<li class='mb-3 lh-lg'>" + doc_name + highlighted_paragraph + "</li>"
            }

            paragraphs_tag = '<ul>' + paragraph_tag + '</ul>'
            document.getElementById("DetailText").innerHTML += paragraphs_tag;
        }
        document.getElementById("DetailText").innerHTML = "<ul>" + document.getElementById("DetailText").innerHTML + "</ul>"

        popup_handler();
    }

    /************** Documents result tab ***************************************/

    async function showDocumentInformation(documents_information_dict, area_id, actors_id, role_id, keywords_text) {

        SearchResultValue = documents_information_dict;

        document.getElementById("DocumentCount").innerText = (Object.keys(documents_information_dict).length).toString() + " سند یافت شد.";
        let index = 1;
        let document_result = []


        for (const [doc_id, doc_info] of Object.entries(documents_information_dict)) {


            const document_id = doc_id
            const document_name = doc_info["name"]

            const document_subject = doc_info['subject']
            const document_approval_reference = doc_info['approval_reference']
            const document_approval_date = doc_info['approval_date']

            const role_name = doc_info["role_name"]
            let document_actors = doc_info["actors"]
            document_actors = document_actors.toString().replaceAll(',', '<br>');

            const document_link = 'http://' + location.host + "/information/?id=" + document_id
            const doc_name = '<a target="blank" href="' + document_link + '">' + document_name + "</a>"

            const detail_function = "DetailFunction(" + document_id + "," + area_id + ")"
            const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + ' onclick="' + detail_function + '" data-bs-target="#detailModal">جزئیات</button>'

            const row = {
                "id": index, "name": doc_name,
                'document_subject': document_subject,
                'document_approval_reference': document_approval_reference,
                'document_approval_date': document_approval_date,
                "actors (role)": document_actors,
                "detail": detail
            }
            document_result.push(row)
            index += 1
        }
        $('#SearchTable').empty();
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '»',
                    prev: '›',
                    next: '‹',
                    last: '«'
                }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "سندی یافت نشد.",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "name",
                "title": "نام سند",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "document_subject",
                "title": "موضوع سند",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "actors (role)",
                "title": "کنشگر (نقش)",
                "style": {
                    "width": "25%"
                }
            }, {
                "name": "detail",
                "title": "جزئیات",
                "style": {
                    "width": "5%"
                }
            }
            ],
            "rows": document_result
        });

    }


    async function DetailFunction(document_id, area_id) {

        let roles_id = multiselect_role_value;
        let country_id = document.getElementById("country").value
        let request_link = 'http://' + location.host + "/GetDocumentActorsDetails_Modal/" + document_id + "/" + roles_id + "/" + area_id + "/" + multiselect_actor_value + "/" + preprocessed_keywords_text + "/"

        let response = await fetch(request_link).then(response => response.json());

        /*  Show detail Result */
        let document_paragraphs_result = response["document_paragraphs_result"]
        let document_name = response["document_name"]
        await showDetailsModal(document_id, document_name, document_paragraphs_result)

    }

    async function showDetailsModal(document_id, document_name, paragraphs_dict) {

        /* Title Text */
        const link = 'http://' + location.host + "/information/?id=" + document_id
        let title_tag = "<a target='blank' href='" + link + "'>" + document_name + "</a>"
        document.getElementById("ModalHeader").innerHTML = title_tag

        /* Body Text */
        let keywords_list = preprocessed_keywords_text.split(",")

        document.getElementById("DetailText").innerHTML = ""

        for (let [actor_role, paragraph_info] of Object.entries(paragraphs_dict)) {
            paragraph_dict = paragraph_info['paragraph_dict']

            paragraph_tag = ''
            actor_role_li = '<h6 class="bold">' + actor_role + ':' + '</h6>'
            document.getElementById("DetailText").innerHTML += actor_role_li;

            for (const [paragraph_id, paragraph_info] of Object.entries(paragraph_dict)) {
                paragraph_text = paragraph_info['text']
                actor_form = paragraph_info['actor_form']
                actor_name = paragraph_info['actor_name']

                is_ref_actor = paragraph_info['is_ref_actor']
                ref_paragraph_text = paragraph_info['ref_text']

                highlighted_paragraph = await highlightParagraphs(paragraph_text, actor_name, actor_role, actor_form, keywords_list, false, is_ref_actor, ref_paragraph_text)
                // highlighted_paragraph =paragraph_text
                paragraph_tag += "<li class='mb-3 lh-lg'>" + highlighted_paragraph + "</li>"
            }

            paragraphs_tag = '<ul>' + paragraph_tag + '</ul>'
            document.getElementById("DetailText").innerHTML += paragraphs_tag;
        }
        document.getElementById("DetailText").innerHTML = "<ul>" + document.getElementById("DetailText").innerHTML + "</ul>"
        popup_handler();
    }

    /************** Actors Chart tab ***************************************/

    async function getActorsChartData(country_id, area_id, multiselect_actor_value, multiselect_role_value, preprocessed_keywords_text) {
        startBlockUI('actors_chart_container');

        request_link = 'http://' + location.host + "/GetActorsDistChartData/"
            + country_id + "/" + multiselect_role_value + "/" + area_id + "/" + multiselect_actor_value + "/" + preprocessed_keywords_text + "/";
        response = await fetch(request_link).then(response => response.json());

        actors_chart_data = response["actors_chart_data"];
        let entropy_dict = response['entropy_dict'];
        let normal_entropy_dict = response['normal_entropy_dict'];
        let mean_dict = response['mean_dict'];
        let std_dict = response['std_dict'];
        let parallelism_dict = response['parallelism_dict'];
        document.getElementById('chart_parallelism').innerHTML = '<span class="text-secondary bold">' + "احتمال موازی کاری: " + '</span>'
            + '<span class="bold" style="color: purple">' + parallelism_dict["sum_columns"] + ' </span>'
            + '(<span  style="color: rgb(0, 123, 255)">' + parallelism_dict["column_1"] + '، </span>'
            + '<span  style="color: rgb(40, 167, 69)">' + parallelism_dict["column_2"] + '، </span>'
            + '<span  style="color: rgb(255, 193, 7)">' + parallelism_dict["column_3"] + '</span>)'
            + '<span onclick="showEntropyDetails()" class="p-2 fw-bold" '
            + 'data-bs-toggle="tooltip" data-bs-placement="left" title="جزئیات بیش‌تر"'
            + 'style="position:relative;top:-6px;cursor:pointer;font-size:20px;">'
            + '<i class="bi bi-info-circle text-secondary fw-bold"></i>'
            + '</span>'


        chart_entropy = '<p class="fw-bold">'
            + '<span class="text-secondary">' + "آنتروپی: " + '</span>'
            + '<span style="color: purple">' + entropy_dict["sum_columns"] + ' </span>'
            + '(<span  style="color: rgb(0, 123, 255)">' + entropy_dict["column_1"] + '، </span>'
            + '<span  style="color: rgb(40, 167, 69)">' + entropy_dict["column_2"] + '، </span>'
            + '<span  style="color: rgb(255, 193, 7)">' + entropy_dict["column_3"] + '</span>)'
            + '</p>'
            + '<p>'
            + '<span class="text-secondary">' + " آنتروپی نرمال: " + '</span>'
            + '<span style="color: purple">' + normal_entropy_dict["sum_columns"] + ' </span>'
            + '(<span  style="color: rgb(0, 123, 255)">' + normal_entropy_dict['column_1'] + '، </span>'
            + '<span  style="color: rgb(40, 167, 69)">' + normal_entropy_dict['column_2'] + '، </span>'
            + '<span  style="color:rgb(255, 193, 7)">' + normal_entropy_dict['column_3'] + '</span>)';
        + '</p>'

        chart_stats = '<p>'
            + '<span class="text-secondary">' + "میانگین: " + '</span>'
            + '<span style="color: purple">' + mean_dict["sum_columns"] + ' </span>'
            + '(<span  style="color: rgb(0, 123, 255)">' + mean_dict["column_1"] + '، </span>'
            + '<span  style="color: rgb(40, 167, 69)">' + mean_dict["column_2"] + '، </span>'
            + '<span  style="color: rgb(255, 193, 7)">' + mean_dict["column_3"] + '</span>)'
            + '</p>'
            + '<p>'
            + '<span class="text-secondary">' + " انحراف معیار: " + '</span>'
            + '<span style="color: purple">' + std_dict["sum_columns"] + ' </span>'
            + '(<span  style="color: rgb(0, 123, 255)">' + std_dict['column_1'] + '، </span>'
            + '<span  style="color: rgb(40, 167, 69)">' + std_dict['column_2'] + '، </span>'
            + '<span  style="color:rgb(255, 193, 7)">' + std_dict['column_3'] + '</span>)'
            + '</p>';

        ENTROPY_DETAILS_TAG = ""
        ENTROPY_DETAILS_TAG += chart_entropy + chart_stats

        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
        showActorsChart('actors_chart_container', actors_chart_data, country_id, preprocessed_keywords_text)
        stopBlockUI('actors_chart_container', 'داشبورد آماری');

    }


    async function showEntropyDetails() {
        Swal.fire({
            icon: 'success',
            html: ENTROPY_DETAILS_TAG,
            showCloseButton: true,
            showConfirmButton: false,
            customClass: {
                "icon": "styleSwalIcon"
            }
        })
    }


    async function showActorsChart(chart_container, chart_data, country_id, preprocessed_keywords_text) {


        document.getElementById(chart_container).innerHTML = ""
        // create a data set
        var data = anychart.data.set(chart_data);

        // map the data
        var salahiat_series_data = data.mapAs({ x: 0, value: 3 });
        var hamkaran_series_data = data.mapAs({ x: 0, value: 2 });
        var motevalian_series_data = data.mapAs({ x: 0, value: 1 });



        // create a chart
        var chart = anychart.column();

        chart
            .animation(true)
            .padding([10, 60, 10, 0])

        chart.background().fill('#ffffff');


        // x axix labels font setting
        var xAxisLabels = chart.xAxis().labels();
        xAxisLabels.fontFamily("vazir");

        var yAxisLabels = chart.yAxis().labels();
        yAxisLabels.fontFamily("vazir");

        // Not allow labels overlapping
        var xAxis = chart.xAxis();
        xAxis.overlapMode("noOverlap");

        var yAxis = chart.yAxis();
        yAxis.title("تعداد وظایف");
        yAxis.title().fontFamily('vazir');
        yAxis.title().fontWeight("bold");
        yAxis.title().height(40);


        chart.yScale().minimum(0);
        chart.yScale().ticks().allowFractional(false);
        // tooltip content font setting
        var tooltip = chart.tooltip();
        tooltip.fontFamily("vazir");

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir");


        // set the container id
        chart.container(chart_container);

        // create the second series, set the data and name
        var salahiat_series = chart.column(salahiat_series_data);
        salahiat_series.normal().stroke("#28a745", 0);
        salahiat_series.normal().fill("#ffc107");
        salahiat_series.name("دارای صلاحیت اختیاری");


        // create the second series, set the data and name
        var hamkaran_series = chart.column(hamkaran_series_data);
        hamkaran_series.normal().stroke("#28a745", 0);
        hamkaran_series.normal().fill("#28a745");
        hamkaran_series.name("همکار");


        // create the first series, set the data and name
        var motevalian_series = chart.column(motevalian_series_data);
        // configure the visual settings of the first series
        motevalian_series.normal().fill("#007bff");
        motevalian_series.normal().stroke("#28a745", 0);
        motevalian_series.name("متولی اجرا");

        // enable the legend
        chart.legend(true);

        var legend = chart.legend();
        legend.fontFamily('vazir')

        // set position mode
        legend.positionMode("inside");
        // set position and alignement
        legend.position("top");
        legend.align("center");
        legend.itemsLayout("horizontalExpandable");
        // initiate drawing the chart
        chart.draw();


        chart.listen("mouseOver", function (e) {
            document.body.style.cursor = "pointer";
        });
        chart.listen("mouseOut", function (e) {
            document.body.style.cursor = "auto";
        });

        // motevalian columns
        motevalian_series.listen('click', async function (e) {
            const click_tag = e.domTarget.tag;
            const column_index = click_tag["index"]
            const actor_name = chart_data[column_index][0];
            const actor_role_name = 'متولی اجرا';
            showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text)

        });

        // hamkaran columns
        hamkaran_series.listen('click', function (e) {
            const click_tag = e.domTarget.tag;
            const column_index = click_tag["index"]
            const actor_name = chart_data[column_index][0];
            const actor_role_name = 'همکار';
            showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text)
        });

        // salahiat columns
        salahiat_series.listen('click', function (e) {
            /* Modal Headers */
            const click_tag = e.domTarget.tag;
            const column_index = click_tag["index"]
            const actor_name = chart_data[column_index][0];
            const actor_role_name = 'دارای صلاحیت اختیاری';
            showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text)
        });

    }


    async function showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, preprocessed_keywords_text) {
        startFullPageBlockUI();
        /* Title Body */
        const title_tag = actor_name + ' (' + actor_role_name + ')'
        $('#actor_modal_header').text(title_tag);

        /* Modal Body */
        document.getElementById('actor_modal_body').innerHTML = "";

        let request_link = 'http://' + location.host + "/GetColumnParagraphsByActorRoleName_Modal/" + country_id + "/" + actor_name + "/" + actor_role_name + "/" + preprocessed_keywords_text + "/"
        let response = await fetch(request_link).then(response => response.json());
        let actor_paragraphs_result = response["actor_paragraphs_result"]

        paragraph_tag = '';
        let keywords_list = preprocessed_keywords_text.split(",")

        for (const [paragraph_id, paragraph_info] of Object.entries(actor_paragraphs_result)) {
            document_id = paragraph_info['document_id']
            document_name = paragraph_info['document_name']

            document_link = 'http://' + location.host + "/information/?id=" + document_id
            doc_name = '<a class="bold text-secondary" target="to_blank" href="' + document_link + '">' + document_name + "</a>"

            paragraph_text = paragraph_info['text']
            actor_form = paragraph_info['actor_form']
            is_ref_actor = paragraph_info['is_ref_actor']
            ref_text = paragraph_info['ref_text']

            highlighted_paragraph = await highlightParagraphs(paragraph_text, actor_name, actor_role_name, actor_form, keywords_list, false, is_ref_actor, ref_text)

            paragraph_tag += "<li class='mb-3 lh-lg'>" + doc_name + highlighted_paragraph + "</li>";

        }


        document.getElementById('actor_modal_body').innerHTML = '<ol start="1">' + paragraph_tag + '</ol>'
        popup_handler();
        stopFullPageBlockUI('کلیک روی نمودار')
        $("#actors_modal_btn").click();
    }

    /************** Actors-Keywords Graph tab ***************************************/

    async function getActorsKeywordsGraphData(country_id, area_id, multiselect_actor_value, multiselect_role_value, preprocessed_keywords_text) {
        startBlockUI('actors_graph_container');

        request_link = 'http://' + location.host + "/GetActorsKeywordsGraphData/"
            + country_id + "/" + multiselect_role_value + "/" + area_id + "/" + multiselect_actor_value + "/" + preprocessed_keywords_text + "/";
        response = await fetch(request_link).then(response => response.json());

        actors_graph_data = response["actors_graph_data"];
        await showActorsKeywordsGraph('actors_graph_container', actors_graph_data, 'Undirected', country_id, multiselect_role_value, preprocessed_keywords_text)
        stopBlockUI('actors_graph_container', 'گراف کلیدواژه-کنشگر');


    }

    async function showActorsKeywordsGraph(container, actors_graph_data, graph_type, country_id, multiselect_role_value, preprocessed_keywords_text) {

        document.getElementById(container).innerHTML = ''
        // create a chart and set the data
        var chart = anychart.graph(actors_graph_data);

        // set the container id
        chart.container(container);

        // configure labels of keywords
        let keywords = chart.group("keywords");
        let actors = chart.group("actors");
        let categories = chart.group("categories");
        let source_actors = chart.group("source_actors");
        let supervisors_actors = chart.group("supervisors_actors");



        if (keywords != undefined) {


            keywords.normal().shape("diamond");
            keywords.hovered().shape("diamond");
            keywords.selected().shape("diamond");

            keywords.normal().height(30);
            keywords.hovered().height(35);
            keywords.selected().height(35);
            // set the fill of nodes in groups
            keywords.normal().fill("#16b2f5");
            keywords.hovered().fill("white");
            keywords.selected().fill("#16b2f5")

            // set the stroke of nodes in groups
            keywords.normal().stroke(null);
            keywords.hovered().stroke("#16b2f5", 3);
            keywords.selected().stroke("#333333", 3);

            keywords.labels().enabled(true);
            keywords.labels().format("{%id}").fontFamily('vazir');
            keywords.labels().fontSize(14);
            keywords.labels().fontWeight(600);
            chart.edges().tooltip().format(" کنشگر:  {%from} \n کلیدواژه:  {%to}");
        }

        if (actors != undefined) {
            actors.normal().height(35);
            actors.hovered().height(40);
            actors.selected().height(40);
            actors.normal().stroke(null);

            actors.labels().enabled(true);
            actors.labels().format("{%id}").fontFamily('vazir');
            actors.labels().fontSize(14);
            actors.labels().fontWeight(600);
        }

        if (source_actors != undefined) {
            source_actors.normal().height(35);
            source_actors.hovered().height(40);
            source_actors.selected().height(40);
            source_actors.normal().stroke(null);

            source_actors.labels().enabled(true);
            source_actors.labels().format("{%id}").fontFamily('vazir');
            source_actors.labels().fontSize(14);
            source_actors.labels().fontWeight(600);
        }

        if (supervisors_actors != undefined) {
            supervisors_actors.normal().height(35);
            supervisors_actors.hovered().height(40);
            supervisors_actors.selected().height(40);
            supervisors_actors.normal().stroke(null);

            supervisors_actors.labels().enabled(true);
            supervisors_actors.labels().format("{%id}").fontFamily('vazir');
            supervisors_actors.labels().fontSize(14);
            supervisors_actors.labels().fontWeight(600);
        }

        chart.nodes().tooltip().format("{%id}");
        chart.nodes().tooltip().fontFamily('vazir');

        chart.edges().tooltip().fontFamily('vazir');
        if (container == 'actors_supervisors_graph_container')
            chart.edges().tooltip().format(" کنشگر:  {%from} \n ناظر:  {%to}");

        if (graph_type === "Directed") {
            chart.edges().arrows({
                enabled: true,
                size: 10,
                position: '50%'
            });
        }
        // initiate drawing the chart
        chart.draw();


        chart.listen("mouseOver", function (e) {
            document.body.style.cursor = "pointer";
        });
        chart.listen("mouseOut", function (e) {
            document.body.style.cursor = "auto";
        });

        chart.listen('Click', async function (event) {
            // simulate live update
            // console.log(actors_graph_data)
            // actors_graph_data['nodes'].push({id:'sfajlsdjald'})

            // chart.data(actors_graph_data);

            const click_tag = event.domTarget.tag;
            // edge clicked
            if (click_tag["type"] === "edge") {

                edges = actors_graph_data['edges']
                edge_id = parseInt(click_tag['id'].split('_')[1])

                selected_edge = edges[edge_id]

                if (container == 'actors_supervisors_graph_container') {


                    source_actor_name = selected_edge['from']
                    supervisor_name = selected_edge['to']
                    source_id = selected_edge['source_id']
                    supervisor_id = selected_edge['supervisor_id']


                    let request_link = 'http://' + location.host + "/GetActorsSupervisorsEdge_Modal/" + country_id + "/" + source_id + "/" + supervisor_id + "/" + preprocessed_keywords_text + "/"
                    let response = await fetch(request_link).then(response => response.json());
                    let paragraphs_dict_result = response['paragraphs_dict_result'];

                    await showActorSupervisorEdgeModal(paragraphs_dict_result, source_actor_name, supervisor_name, preprocessed_keywords_text);

                }
                else {

                    actor_name = selected_edge['from']
                    keyword = selected_edge['to']
                    destination_node_type = selected_edge['destination_node_type']
                    actor_id = selected_edge['actor_id']


                    let request_link = 'http://' + location.host + "/GetActorsEdgeParagraphsByKeyword_Modal/" + country_id + "/" + actor_id + "/" + multiselect_role_value + "/" + keyword + "/"
                    let response = await fetch(request_link).then(response => response.json());
                    let actor_paragraphs_result = response['actor_paragraphs_result'];

                    await showActorKeywordEdgeModal(actor_paragraphs_result, actor_name, keyword);
                }

            }

        })




    }

    async function showActorKeywordEdgeModal(actor_paragraphs_result, actor_name, keyword) {

        let keywords_list = [keyword]

        /* Title Text */
        $('#edge_actor_modal_header').text(actor_name)
        $('#edge_keyword_modal_header').text(keyword)
        /* Body Text */

        document.getElementById("edge_actor_modal_body").innerHTML = ""

        for (let [actor_role, paragraph_dict] of Object.entries(actor_paragraphs_result)) {

            paragraph_tag = ''
            actor_role_li = '<h5 class="bold">' + actor_role + ':' + '</h5>'
            document.getElementById("edge_actor_modal_body").innerHTML += actor_role_li;

            for (const [paragraph_id, paragraph_info] of Object.entries(paragraph_dict)) {
                document_id = paragraph_info['document_id']
                document_name = paragraph_info['document_name']

                document_link = 'http://' + location.host + "/information/?id=" + document_id
                doc_name = '<a class="bold text-secondary" target="to_blank" href="' + document_link + '">' + document_name + "</a>"

                paragraph_text = paragraph_info['text']
                actor_form = paragraph_info['actor_form']
                is_ref_actor = paragraph_info['is_ref_actor']
                ref_text = paragraph_info['ref_text']


                highlighted_paragraph = await highlightParagraphs(paragraph_text, actor_name, actor_role, actor_form, keywords_list, false, is_ref_actor, ref_text)


                paragraph_tag += "<li class='mb-3 lh-lg'>" + doc_name + highlighted_paragraph + "</li>"
            }

            paragraphs_tag = '<ol start = "1">' + paragraph_tag + '</oll>'
            document.getElementById("edge_actor_modal_body").innerHTML += paragraphs_tag;
        }
        document.getElementById("edge_actor_modal_body").innerHTML = "<ul>" + document.getElementById("edge_actor_modal_body").innerHTML + "</ul>"
        popup_handler();
        $('#edge_modal_btn').click();

    }

    /****************** Highlight algorithms ********************************** */

    async function highlightParagraphs(paragraph, actor_name, actor_role, paragraph_actor_form, keywords_list, all_hamkar, is_ref_actor, ref_paragraph_text) {


        paragraph_text = paragraph;

        // Highlight keywords
        if (!keywords_list.includes('empty')) {
            for (keyword of keywords_list) {
                keyword_tag = "<span class= 'bg-info text-white  rounded px-1'>" + keyword + "</span>"
                paragraph_text = paragraph_text.replaceAll(keyword, keyword_tag);

            }
        }


        // highlight other actors
        paragraph_text = await highlightOtherActors(paragraph_text, paragraph_actor_form, actor_name)



        if (actor_role.includes('متولی اجرا')) {

            paragraph_text = await highlightMotevalian(paragraph_text, paragraph_actor_form, motevali_keywords, 'bg-primary', is_ref_actor, ref_paragraph_text)
            paragraph_text = await highlightLegalDeadline(paragraph_text, motevali_keywords)

        } else if (actor_role.includes('همکار')) {
            paragraph_text = await highlightHamkaran(paragraph_text, paragraph_actor_form, hamkaran_keywords, 'bg-success');

        } else {
            paragraph_text = await highlightSalahiat(paragraph_text, paragraph_actor_form, salahiat_keywords, 'bg-warning', is_ref_actor, ref_paragraph_text)

        }






        /********************* Highlight optional keywords  **************************/
        for (pattern_keyword of optional_keywords) {

            if (optional_after_terms_count[pattern_keyword] > 0)
                paragraph_text = await highlightSomeTermsAfterKeyword(paragraph_text, optional_after_terms_count[pattern_keyword], pattern_keyword)

            pattern_keyword_tag = "<span class='border border-secondary border-2  px-1 rounded'>" + pattern_keyword + "</span>"
            paragraph_text = paragraph_text.replaceAll(pattern_keyword, pattern_keyword_tag)

        }

        return paragraph_text
    }




    async function highlightMotevalian(paragraph_text, actor_form, pattern_keywords, bg_color, is_ref_actor, ref_paragraph_text) {


        for (pattern_keyword of pattern_keywords) {

            /* Highlight with actors list */
            let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"

            actor_with_postfix_1 = actor_form + ' ' + 'جمهوری اسلامی ایران'
            actor_with_postfix_2 = actor_form + ' ' + 'ایران'
            actor_with_postfix_3 = actor_form + ' ' + 'کشور'

            paragraph_text = paragraph_text.split('.').map((sentence) => {


                if (sentence.includes(actor_form + ' ' + pattern_keyword)) {

                    if (is_ref_actor) {

                        popover_title = actor_form;
                        popover_content = ref_paragraph_text;
                        actor_tag = '<a dir="rtl" tabindex="0" class="d-inline-block ' + bg_color.replace('bg', 'text') + ' text-right bold"  data-bs-placement="bottom" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="' + popover_title + '" data-bs-content="' + popover_content + '">' + popover_title + '</a>'
                        sentence = sentence.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);

                    } else {

                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                        sentence = sentence.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);

                    }

                }
                else if (sentence.includes(actor_with_postfix_1 + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_1 + "</span>"
                    sentence = sentence.replaceAll(actor_with_postfix_1 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }
                else if (sentence.includes(actor_with_postfix_2 + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_2 + "</span>"
                    sentence = sentence.replaceAll(actor_with_postfix_2 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }
                else if (sentence.includes(actor_with_postfix_3 + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_3 + "</span>"
                    sentence = sentence.replaceAll(actor_with_postfix_3 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }
                else if (sentence.includes('(' + actor_form + ')' + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_form + ')' + "</span>"
                    sentence = sentence.replaceAll('(' + actor_form + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }
                else if (sentence.includes('(' + actor_with_postfix_1 + ')' + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_1 + ')' + "</span>"
                    sentence = sentence.replaceAll('(' + actor_with_postfix_1 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }
                else if (sentence.includes('(' + actor_with_postfix_2 + ')' + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_2 + ')' + "</span>"
                    sentence = sentence.replaceAll('(' + actor_with_postfix_2 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }
                else if (sentence.includes('(' + actor_with_postfix_3 + ')' + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_3 + ')' + "</span>"
                    sentence = sentence.replaceAll('(' + actor_with_postfix_3 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }

                return sentence
            }).join('.')

        }



        /* Highlight with actors list */
        eghdam_keywords = ['اقدام کند', 'اقدام‌کند', 'اقدام نماید', 'اقدام‌نماید']
        non_eghdam_keywords = pattern_keywords.filter(x => !eghdam_keywords.includes(x));

        paragraph_text = paragraph_text.split('.').map((sentence) => {

            for (e_kw of eghdam_keywords) {

                pattern_keyword_tag1 = "<span class='bg-secondary text-white rounded px-1'>" + e_kw + "</span>"

                if (sentence.includes(e_kw) && !check_non_eghdam_kw_exists(sentence, non_eghdam_keywords)) {

                    actor_tag1 = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                    sentence = sentence.replaceAll(actor_form + ' ', actor_tag1 + ' ');

                    sentence = sentence.replaceAll(e_kw, pattern_keyword_tag1);


                }

            }

            return sentence
        }).join('.')




        return paragraph_text;


    }


    function check_non_eghdam_kw_exists(sentence, pattern_keywords) {
        for (p_kw of pattern_keywords) {
            pattern = p_kw
            if (sentence.includes(pattern)) {
                return true;
            }
        }
        return false;

    }



    async function highlightHamkaran(paragraph_text, actor_form, pattern_keywords, bg_color) {
        const window_length = 100;

        let space_counter = 0;
        detected_hamkaran_list = []


        /* Highlight pattern keywords and references */
        for (pattern_keyword of pattern_keywords) {


            /* Highlight more with actors list */
            let regex = '', result, indices = [];

            if (pattern_keyword == 'با همکاری') {
                regex = /با همکاری/gi;
            } else {
                regex = /باهمکاری/gi;
            }

            while ((result = regex.exec(paragraph_text))) {
                indices.push(result.index);
            }

            for (const index of indices) {

                let start_index = (index + pattern_keyword.length);
                let substring = paragraph_text.substring(start_index, start_index + window_length);
                let current_substring = substring;


                actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                // substring = substring.replaceAll(' ' + actor_form + ' ', ' ' + actor_tag + ' ');
                substring = substring.replaceAll(' ' + actor_form, ' ' + actor_tag);
                substring = substring.replaceAll('(' + actor_form + ')', '(' + actor_tag + ')');

                for (symbol of hamkaran_punctuations) {

                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                    substring = substring.replaceAll(' ' + actor_form + symbol, ' ' + actor_tag + symbol);

                }

                actor_without_affix = actor_form.replaceAll('وزارت ', '').replaceAll('سازمان ', '').replaceAll(' جمهوری اسلامی ایران', '')

                if (actor_without_affix != 'اطلاعات' && actor_without_affix != 'کشور' && !substring.includes(actor_form)) {


                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                    substring = substring.replaceAll(' ' + actor_without_affix + ' ', ' ' + actor_tag + ' ');
                    substring = substring.replaceAll('(' + actor_without_affix + ')', '(' + actor_tag + ')');

                    for (symbol of hamkaran_punctuations) {


                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                        substring = substring.replaceAll(' ' + actor_without_affix + symbol, ' ' + actor_tag + symbol);

                    }

                }



                paragraph_text = paragraph_text.replaceAll(current_substring, substring);

            }
            /* Highlight with actors list */
            let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"

            paragraph_text = paragraph_text.replaceAll(pattern_keyword, pattern_keyword_tag);

        }




        return paragraph_text;



    }

    async function highlightSalahiat(paragraph_text, actor_form, pattern_keywords, bg_color, is_ref_actor, ref_paragraph_text) {


        for (pattern_keyword of pattern_keywords) {

            /* Highlight with actors list */
            let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"

            actor_with_postfix_1 = actor_form + ' ' + 'جمهوری اسلامی ایران'
            actor_with_postfix_2 = actor_form + ' ' + 'ایران'
            actor_with_postfix_3 = actor_form + ' ' + 'کشور'

            paragraph_text = paragraph_text.split('.').map((sentence) => {


                if (sentence.includes(actor_form + ' ' + pattern_keyword)) {

                    if (is_ref_actor) {

                        popover_title = actor_form;
                        popover_content = ref_paragraph_text;
                        actor_tag = '<a dir="rtl" tabindex="0" class="d-inline-block ' + bg_color.replace('bg', 'text') + ' text-right bold"  data-bs-placement="bottom" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="' + popover_title + '" data-bs-content="' + popover_content + '">' + popover_title + '</a>'
                        sentence = sentence.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);


                    } else {

                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                        sentence = sentence.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);

                    }

                }
                else if (sentence.includes(actor_with_postfix_1 + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_1 + "</span>"
                    sentence = sentence.replaceAll(actor_with_postfix_1 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }
                else if (sentence.includes(actor_with_postfix_2 + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_2 + "</span>"
                    sentence = sentence.replaceAll(actor_with_postfix_2 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }
                else if (sentence.includes(actor_with_postfix_3 + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_with_postfix_3 + "</span>"
                    sentence = sentence.replaceAll(actor_with_postfix_3 + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }
                else if (sentence.includes('(' + actor_form + ')' + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_form + ')' + "</span>"
                    sentence = sentence.replaceAll('(' + actor_form + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }
                else if (sentence.includes('(' + actor_with_postfix_1 + ')' + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_1 + ')' + "</span>"
                    sentence = sentence.replaceAll('(' + actor_with_postfix_1 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }
                else if (sentence.includes('(' + actor_with_postfix_2 + ')' + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_2 + ')' + "</span>"
                    sentence = sentence.replaceAll('(' + actor_with_postfix_2 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }
                else if (sentence.includes('(' + actor_with_postfix_3 + ')' + ' ' + pattern_keyword)) {
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_with_postfix_3 + ')' + "</span>"
                    sentence = sentence.replaceAll('(' + actor_with_postfix_3 + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }

                return sentence
            }).join('.')

        }



        return paragraph_text;

    }





    /* Highlight N terms after one keyword */
    async function highlightSomeTermsAfterKeyword(paragraph_text, terms_count, keyword) {
        paragraph_selected_terms = '';
        selected_terms_list = []
        let indices = await getIndicesOf(keyword, paragraph_text);

        for (index of indices) {

            let pattern_keyword_index = index;
            let start_index = pattern_keyword_index + keyword.length + 1
            let end_index = paragraph_text.length;
            let selected_terms_size = 0

            if (pattern_keyword_index != -1) {
                sub_string = paragraph_text.substring(start_index, end_index)

                selected_terms = sub_string.split(' ').slice(0, terms_count)

                for (term of selected_terms) {
                    selected_terms_size += term.length
                }
                selected_terms_size += (terms_count - 1)

                selected_terms_text = paragraph_text.substring(start_index, start_index + selected_terms_size);

                if (!selected_terms_text.includes('span')) {
                    if (!selected_terms_list.includes(selected_terms_text)) {
                        selected_terms_list.push(selected_terms_text)
                    }

                }


            }


        }

        for (selected_terms_text of selected_terms_list) {
            if (selected_terms_text != "") {
                selected_terms_tag = "<span class='blue_dotted_border selected_terms px-1 mx-1'>" + selected_terms_text + "</span>"
                paragraph_text = paragraph_text.replaceAll(selected_terms_text, selected_terms_tag)
            }

        }

        return paragraph_text;
    }

    async function highlightLegalDeadline(paragraph_text, actor_pattern_keywords) {

        for (pattern_keyword of actor_pattern_keywords) {

            let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"


            let indices = await getIndicesOf(pattern_keyword_tag, paragraph_text);

            for (index of indices) {
                start_index = index + pattern_keyword_tag.length;

                sub_string = paragraph_text.substring(start_index, paragraph_text.length);

                for (deadline_keyword of deadline_pattern_keywords) {
                    for (const [nubmer_text, value] of Object.entries(numbers_dict)) {
                        for (time_category of time_categories) {

                            // ظرف شش ماه
                            pattern1 = deadline_keyword + ' ' + nubmer_text + ' ' + time_category;
                            pattern2 = deadline_keyword + ' ' + nubmer_text + ' ' + '(' + value + ')' + ' ' + time_category;

                            // ظرف شش‌ماه
                            pattern3 = deadline_keyword + ' ' + nubmer_text + '‌' + time_category;
                            pattern4 = deadline_keyword + ' ' + nubmer_text + ' ' + '(' + value + ')' + '‌' + time_category;

                            // ظرف یکسال
                            pattern5 = deadline_keyword + ' ' + nubmer_text + time_category;
                            pattern6 = deadline_keyword + ' ' + nubmer_text + ' ' + '(' + value + ')' + time_category;

                            patterns = [pattern1, pattern2, pattern3,
                                pattern4, pattern5, pattern6];

                            for (pattern of patterns) {
                                deadline_keyword_tag = "<span class='deadlines gray_dotted_border px-1 rounded'>" + deadline_keyword + "</span>"
                                pattern_without_deadline_keyword = pattern.replace(deadline_keyword + ' ', '');
                                pattern_without_keyword_tag = "<span class='deadlines border border-warning border-2 px-1 rounded'>" + pattern_without_deadline_keyword + "</span>"
                                new_sub_string = sub_string.replaceAll(pattern, deadline_keyword_tag + ' ' + pattern_without_keyword_tag)

                                // closest deadline..not all deadlines. => replace()
                                paragraph_text = paragraph_text.replace(sub_string, new_sub_string);

                            }

                            /* *********************************** */

                        }
                    }
                }


            }

        }
        return paragraph_text;

    }

    async function getIndicesOf(searchStr, str) {
        var searchStrLen = searchStr.length;
        if (searchStrLen == 0) {
            return [];
        }
        var startIndex = 0, index, indices = [];
        while ((index = str.indexOf(searchStr, startIndex)) > -1) {
            indices.push(index);
            startIndex = index + searchStrLen;
        }
        return indices;
    }

    async function highlightOtherActors(paragraph_text, paragraph_actor_form, paragraph_actor_name) {
        para_actor_forms = []
        for (const [actor_id, actor_info] of Object.entries(actors_dict)) {
            if (actor_info['name'] == paragraph_actor_name) {
                para_actor_forms = actor_info['forms'];
                break;
            }
        }

        for (actor_form of actors_list) {
            if (!para_actor_forms.includes(actor_form)) {
                actor_form_tag = "<span class='other_actors'>" + actor_form + "</span>"
                paragraph_text = paragraph_text.replaceAll(' ' + actor_form + ' ', ' ' + actor_form_tag + ' ');
                paragraph_text = paragraph_text.replaceAll(' ' + actor_form + '،', ' ' + actor_form_tag + '،');
                paragraph_text = paragraph_text.replaceAll('(' + actor_form + ')', '(' + actor_form_tag + ')');
            }

        }

        return paragraph_text;
    }

    async function showOtherActors() {
        if ($('.highlighted').length) {
            $('.highlighted').attr('class', 'other_actors')
        } else {
            $('.other_actors').attr('class', 'other_actors highlighted bold text-primary px-1 rounded')
        }

    }

    /* *********************************************************************** */


    async function ToggleActorsKeywordsGraphTabShow(preprocessed_keywords_text) {
        if (preprocessed_keywords_text == 'empty') {

            if ($('#actors_graph_tab').hasClass('active')) {
                $('#actor_result_tab').click();
            }

            $('#actors_graph_tab').hide();

        } else {
            $('#actors_graph_tab').show();
        }
    }



    async function ToggleActorsTimeSeriesChartTabShow(actors_id) {
        if (actors_id.split('__').length > 1
            || actors_id.split('__').includes("0")) {

            if ($('#time_series_analysis_tab').hasClass('active')) {
                $('#time_series_analysis_tab').click();
            }

            $('#time_series_analysis_tab').hide();

        } else {
            $('#time_series_analysis_tab').show();
        }
    }


    async function ToggleActorsComparisonChartTabShow(category_id, actors_id) {
        if ((category_id == '0' && multiselect_actor_value.split('__').includes('0'))
            || (multiselect_actor_value.split('__').length < 2) &&
            !(multiselect_actor_value.split('__').includes('0') && (category_id != '0'))
        ) {

            if ($('#actors_role_comparison_tab').hasClass('active')) {
                $('#actors_role_comparison_tab').click();
            }

            $('#actors_role_comparison_tab').hide();

        } else {
            $('#actors_role_comparison_tab').show();
        }
    }



    function GetMultiSelectText(container_id) {
        let e = document.getElementById(container_id);
        let selected = [...e.options]
            .filter(option => option.selected)
            .map(option => option.innerText)
        return selected.join("__")
    }

    async function GetMultiSelectValue(container_id) {
        let e = document.getElementById(container_id);
        let selected = [...e.options]
            .filter(option => option.selected)
            .map(option => option.value)
        return selected.join("__")
    }

    async function SpinnerModeFunction(mode) {
        if (mode === "Active") {
            $(".spinner-border").addClass("active");
        } else if (mode === "Disable") {
            $(".spinner-border").removeClass("active");
        }
    }
</script>

<!-- Export results -->

<script>

    async function downloadFiles(file_name_list, save_file_name) {
        startFullPageBlockUI()
        const country_id = document.getElementById("country").value

        let zip = new JSZip()

        const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["country_information"][0]
        const country_folder = response["folder"];
        const country_name = response["name"];

        save_file_name += " مجموعه سند {" + country_name + "}"


        let extension = ".txt"
        if (country_name.includes("فاوا")) {
            extension = '.docx';
        }


        for (const [doc_id, doc_info] of Object.entries(file_name_list)) {

            const document_name = doc_info['name'] + extension

            const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

            await fetch(path)
                .then(res => res.arrayBuffer())
                .then(value => {
                    zip.file(document_name, value);
                })
        }
        zip.generateAsync({
            type: "blob"
        })
            .then(function (content) {
                // see FileSaver.js
                saveAs(content, save_file_name + ".zip");
            });
        stopFullPageBlockUI('دانلود اسناد');
    }

    async function DownloadSerachResultFunction() {
        const save_file_name = " کنشگران در"
        downloadFiles(SearchResultValue, save_file_name)
    }

    async function ExportExcelSerachResultFunction() {
        var csv = "";

        sep = ","


        let Csv = "نام سند" + sep + "موضوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + sep +
            "کنشگر (نقش کنشگر)" +
            "\n"
        for (const [doc_id, doc_info] of Object.entries(SearchResultValue)) {
            let document_actors = doc_info["actors"]
            document_actors = document_actors.toString().replaceAll(',', ' / ');

            Csv += doc_info['name'] + sep + doc_info['subject'] + sep +
                doc_info['approval_reference'] + sep +
                doc_info['approval_date'] + sep +
                document_actors + "\n"

        }

        let save_file_name = " کنشگران در"
        save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"

        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
        var link = document.createElement("a");
        link.setAttribute("href", csvContent);
        link.setAttribute("download", save_file_name + ".csv");
        document.body.appendChild(link);
        link.click()
    }


    function showToastMessage(message_text) {
        document.getElementById('toast_message').innerText = message_text
        var toastElList = [].slice.call(document.querySelectorAll('.toast'))
        var toastList = toastElList.map(function (toastEl) {
            return new bootstrap.Toast(toastEl)
        });
        toastList.forEach(toast => toast.show())
    }

    /* Search after press Enter */
    $("#info_form").submit(function () { return false; });
    $("#KeywordsBox").keyup(function (event) {
        if (event.keyCode === 13) {
            ShowResult()
        }
    });

    function popup_handler() {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl)
        });
    }
</script>


<script src="../../static/js/tooltip_handler.js"></script>

<!--<script src="../../static/js/UserLogSave.js"></script>-->
<script src="../../static/js/signout_function.js"></script>
<script src="../../static/js/actors/actors_tour.js"></script>
<script src="../../static/js/tour.js"></script>


<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">



</html>