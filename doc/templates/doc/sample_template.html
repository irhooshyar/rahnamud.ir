<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>


    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">

    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../static/js/multiselect/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../static/js/multiselect/jquery.multi-select.js"></script>

    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <link rel="stylesheet" href="../../static/styles/index2.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">


    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->
    <script src="../../static/js/chart.js"></script>

    <meta charset="UTF-8">
    <title>{{ panel_info.page_title }}</title>
    
    {% include "doc/title_icon.html" %}

    <style>
        .popover-header,
        .popover-body {
            direction: rtl;
            text-align: right;
            font-family: vazir;
        }
    </style>
</head>

<body>

    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <!-- Intro Js -->
    <script src="../../static/js/search/search_tour.js"></script>
    <script src="../../static/js/tour.js"></script>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#SepecificDropdown').addClass('active');
            let panel_name = "{{ panel_info.panel_name }}"
            panel_selector = '#' + panel_name;
            $(panel_selector).addClass('active');
            // $('#sample_template_panel').text("{{ panel_info.page_title }}");
            

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>

    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">
        <form id="subject_analysis_form" action="" class="custom-control mx-auto needs-validation"
            enctype="multipart/form-data" method="post" novalidate>

            <div class="row flex-row-reverse mx-auto">

                <!-- Country select -->
                <div class="col-md-6 col-12 col-lg-2 bg-light pt-3  mt-1" dir="rtl">
                    <label for="country" class=" text-right bg-light float-right">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country" class="form-select text-right float-right searchable-select"
                        onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>

                </div>

                <!-- Subject select -->
                <div id="selectDiv" class="col-md-6 pt-3 col-12 col-lg-3 bg-light mt-1" dir="rtl">
                    <label for="SubjectSelect" class="text-right bg-light float-right">موضوع سند <span
                            style="color: red">(*)</span>:</label>
                    <select id="SubjectSelect" class="form-select text-right float-right searchable-multi-select" style="direction: rtl;">
                    </select>
                </div>

                <!-- Show button -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right mt-1 mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        نمایش
                    </button>
                </div>

            </div>
        </form>

        <ul id="original_tabs" class="nav nav-pills  mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
            role="tablist">

            <li class="nav-item float-right" role="presentation">
                <button id="result_doc" class="nav-link active" data-bs-toggle="pill"
                    data-bs-target="#result_doc_subject" type="button" role="tab" aria-controls="result_doc_subject"
                    aria-selected="true">نتایج جست‌وجو</button>
            </li>


            <li class="nav-item float-right" role="presentation">
                <button id="bar_chart_info_tab" class="nav-link" data-bs-toggle="pill"
                    data-bs-target="#bar_chart_info_pane" type="button" role="tab" aria-controls="bar_chart_info_pane"
                    aria-selected="false">داشبورد آماری</button>
            </li>

            <!-- Download Buttons -->
            <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                type="button">
                <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

            </button>

            <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()" type="button">
                <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
            </button>

            <!-- Result Count -->
            <p dir="rtl" id="SearchResultLable" class="text-left float-left text-secondary pl-2"></p>
        </ul>

        <div id="original_pane" class="tab-content float-right px-1" id="pills-tabContent">

            <div dir=rtl id="result_doc_subject" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                aria-labelledby="result_doc_subject">
                <div class="table-responsive mt-4">
                    <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                    </table>
                </div>
            </div>


            <!-- Bar chart Info Pane -->
            <div dir="rtl" class="tab-pane fade float-right w-100" id="bar_chart_info_pane" role="tabpanel"
                aria-labelledby="bar_chart_info_tab">
                <div class="row mt-4 w-100 flex-row-reverse justify-content-around mx-0 px-0">
                    <div id="subject_container" class="half" chart-height="450px"></div>
                    <div id="level_container" class="half" chart-height="450px"></div>
                    <div id="year_container" class="full" chart-height="800px"></div>
                    <div id="approval_container" class="full" chart-height="1500px"></div>
                    <div id="actors_chart_container" class="full" chart-height="800px"></div>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal Container -->
    <div class="modal fade" id="detailModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="detailModalHeader" class="modal-title">عنوان سند</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="detailModalBody" class="modal-body text-justify">

                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>

            </div>
        </div>
    </div>

    <!-- ChartModal Container -->
    <button type="button" id="ChartModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#ChartModal"></button>
    <div class="modal fade" id="ChartModal">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ChartModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ChartModalText" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->


                <!-- Modal footer -->
                <div dir="rtl" class="modal-footer">
                    <button id="DownloadDocuments" class="btn btn-primary"><i class="fa fa-download"></i> دانلود
                        اسناد</button>

                    <button id="ExportExcel2" class="btn btn-primary"><i class="fa fa-download"></i> خروجی اکسل
                    </button>
                </div>

            </div>
        </div>
    </div>



    <!-- ChartModal Container -->
    <button type="button" id="actors_modal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#actors_modal"></button>
    <div class="modal fade" id="actors_modal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="actor_modal_header" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>
                <!-- Modal body -->

                <div class="bg-light modal-body text-justify">
                    <div class="highlight_options mt-0 p-0 float-left" style="z-index: 13;">
                        <button onclick="showOtherActors()" data-bs-toggle="tooltip" data-bs-placement="right"
                            title="نمایش سایر کنشگران" class="btn border float-left m-0  px-1"><i
                                style="font-size: 24px;" class="bi text-primary bi-people-fill"></i></button>
                        <!-- <button class="btn float-left m-0  px-1"><i style="font-size: 24px;" class="bi text-success bi-hourglass-split"></i></button> -->
                    </div>
                    <br>
                    <div id="actor_modal_body" class="bg-light text-justify">

                    </div>
                </div>
                <!-- Modal footer -->
                <div id="modal_footer" class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن
                    </button>
                </div>

            </div>
        </div>
    </div>


    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>


    <script src="../../static/js/scroll_button_handler.js"></script>

    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>

    <!-- save log user -->
    <script>
        async function UserLog(form_data) {
            if (getCookie("username") !== "") {
                const user_name = getCookie("username")
                let page_url = window.location.pathname
                const user_ip = "127.0.0.0"
                page_url = page_url.slice(0, -1);
                if (page_url === "") {
                    page_url = "/0";
                }


                let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

                $.ajax({
                    url: link_request,
                    data: form_data,
                    type: 'POST',
                    contentType: false,
                    processData: false,
                    async: true,


                }).done(function (res) {
                    console.log("done")

                }).fail(function (res) {
                    console.log("fail")
                });

            }
        }
    </script>


    <script>

        const panel_name = "{{ panel_info.panel_name }}"
        /* Keyword list */
        let panel_keywords_text = "{{ keywords_text }}"
        let keywords_info = panel_keywords_text.split(',')

        let panel_kw_templates_text = "{{ kw_templates_text }}"
        let kw_templates_text_info = panel_kw_templates_text.split(',')

        let keyword_template = []
        let keyword_list = [];
        let after_terms_count = {}


        for (kw of keywords_info){
            name = kw.split(':')[0]
            after_count = kw.split(':')[1]

            keyword_list.push(name);
            after_terms_count[name] = after_count
        }


        for (kw of kw_templates_text_info){
            name = kw
            keyword_template.push(name);
        }

        /* Optianal keywords need to be highlighted */

        let panel_optional_keywords_text = "{{ optional_keywords_text }}"
        let optional_keywords_info = panel_optional_keywords_text.split(',')

        let optional_keywords = []
        let optional_after_terms_count = {}
   
        for (kw of optional_keywords_info){
            name = kw.split(':')[0]
            after_count = kw.split(':')[1]

            optional_keywords.push(name);
            optional_after_terms_count[name] = after_count
        }


        /* Global Constants */
        const motevalian_punctuations = ['.', '،', 'ـ', '-', ':'];
        const hamkaran_punctuations = ['،', ')', ':']

        const motevali_keywords = ['موظف است', 'مکلف است', 'مکلف‌اند', 'موظف‌اند', 'موظفند', 'مکلفند', 'موظف به', 'مکلف به'];
        const hamkaran_keywords = ['با همکاری', 'باهمکاری'];
        const salahiat_keywords = ['مختار است', 'اختیار دارد', 'می‌تواند', 'می تواند', 'میتواند', 'مجاز است'];


        const deadline_pattern_keywords = ['ظرف', 'ظرف مدت', 'ظرف مهلت', 'طی', 'طی مدت', 'طی مهلت', 'حداکثر', 'فواصل زمانی', 'هر']
        const time_categories = ['روز', 'هفته', 'ماه', 'سال']
        const numbers_dict = {
            "یک": {
                'value': 1,
            },
            "دو": {
                'value': 2,
            },
            "سه": {
                'value': 3,
            },
            "چهار": {
                'value': 4,
            },
            "پنج": {
                'value': 5,
            },
            "شش": {
                'value': 6,
            },
            "هفت": {
                'value': 7,
            },
            "هشت": {
                'value': 8,
            },
            "نه": {
                'value': 9,
            },
            "ده": {
                'value': 10,
            }
        }


        let actors_list = []

        let countryId;
        let SearchResultValue = {}


        init()



        container_id_list = ['SearchTable', 'SearchResultLable']

        function clearPrevResults(container_id_list) {

            for (container_id of container_id_list) {
                document.getElementById(container_id).innerHTML = "";
            }
        }

        async function init() {
            initSearchableSelects();

            /* Get Actors List */
            const request_link = 'http://' + location.host + "/GetActorsList/";
            const response = await fetch(request_link).then(response => response.json());
            actors_list = response["actorsList"];
            CountryChanged()

            //user log
            let form_data = new FormData()
            let detail_type = "نمایش پنل"
            form_data.append('detail_type', detail_type);
            UserLog(form_data)
        }

        async function CountryChanged() {

            clearPrevResults(container_id_list);
            countryId = document.getElementById("country").value

            /******************* Get Subject Options **********************/
            request_link = 'http://' + location.host + "/GetSubjectsByCountryId/" + countryId + "/";
            response = await fetch(request_link).then(response => response.json());
            response = response["documents_subject_list"]
            let document_result = []

            let options = [{ value: "0", text: "همه"}];

            for (var i = 0; i < response.length; i++) {
                const subject_id = response[i]["id"]
                const subject_name = response[i]["subject"]

                options.push({value:subject_id, text: subject_name});

            }
            syncSelectOptions('SubjectSelect', options)

        }


        async function GetMultiSelectSubjectValue() {
            var e = document.getElementById("SubjectSelect");
            var selected = [...e.options]
                .filter(option => option.selected)
                .map(option => option.value)
            return selected.join("__")
        }

        function GetMultiSelectSubjectText() {
            let e = document.getElementById("SubjectSelect");
            let selected = [...e.options]
                .filter(option => option.selected)
                .map(option => option.innerText)
            return selected.join("-")
        }


        async function ShowResult() {


            const multiselect_subject_value = await GetMultiSelectSubjectValue();

            if (multiselect_subject_value == "") {
                alert('موضوعی انتخاب نشده‌است.');
            } else {

                clearPrevResults(container_id_list);
                notyf.dismissAll();
                startBlockUI('SearchTable');
                await SpinnerModeFunction("Active");

                country_id = document.getElementById("country").value;
                country_name = $('#country option:selected').text()

                const keyword_list_string = keyword_list.join("_")

                request_link = 'http://' + location.host + "/searchDocumentsBy__keyword__/" + panel_name + "/" + country_id + "/" + multiselect_subject_value + "/"
                response = await fetch(request_link).then(response => response.json());

                documents_information_list = response["documents_information_list"];


                await showDocumentInformation(documents_information_list)
                stopBlockUI('SearchTable', 'نتایج جست‌وجو');

                /************************* Generate chart data *********************/
                startBlockUI('bar_chart_info_pane');

                request_link = 'http://' + location.host + "/Generate__keyword__ChartsData/" + panel_name + "/" + country_id + "/" + multiselect_subject_value  + "/"
                response = await fetch(request_link).then(response => response.json());

                const subject_chart_data = response["subject_chart_data"]
                const approval_references_chart_data = response["approval_references_chart_data"]
                const level_chart_data = response["level_chart_data"]
                const approval_year_chart_data = response["approval_year_chart_data"]
                const type_chart_data = response["type_chart_data"]
                const actors_chart_data = response["actors_chart_data"]


                showChartData(subject_chart_data, "subject_container", country_id, country_name, multiselect_subject_value, false, "موضوع", "توزیع موضوعی اسناد")
                showChartData(level_chart_data, "level_container", country_id, country_name, multiselect_subject_value, false, "سطح", "توزیع اسناد بر اساس سطح اسناد")
                showChartData(approval_year_chart_data, "year_container", country_id, country_name, multiselect_subject_value, true, "سال تصویب", "توزیع اسناد بر اساس سال تصویب")
                showChartData(approval_references_chart_data, "approval_container", country_id, country_name, multiselect_subject_value, false, "مرجع تصویب", "توزیع اسناد بر اساس مرجع تصویب")

                showActorsChart('actors_chart_container', actors_chart_data, country_id, multiselect_subject_value)


                await SpinnerModeFunction("Disable");
                stopBlockUI('bar_chart_info_pane', 'داشبورد آماری');

            }

            //user log
            let form_data = new FormData()
            let detail_type = "نتایج جست و جو"
            let country_name_select = country_name
            let multiselect_subject_select = multiselect_subject_value
            form_data.append('detail_type', detail_type);
            form_data.append('country_name_select', country_name_select);
            form_data.append('multiselect_subject_select', multiselect_subject_select);
            UserLog(form_data)


        }


        function showChartData(data, container, country_id, country_name, multiselect_subject_value, keySort, xAxisTitle, title) {
            showChart(data, container, country_id, country_name, multiselect_subject_value, keySort, xAxisTitle, title)
        }


        function showChart(data, container, country_id, country_name, multiselect_subject_value, keySort, xAxisTitle, title) {
            const options = {
                data,
                keySort,
                title,
                yAxisTitle: "تعداد سند",
                xAxisTitle,
                onclick:async function (event, data) {

                document.getElementById("ChartModalText").innerHTML = ""

                const click_tag = event.domTarget.tag;
                const index = click_tag["index"]
                const text = data.row(index)[0];
                const column_name = text;

                let filtered_result = []
                let header = ""
                let save_file_name = 'پنل درگاه: '

                startFullPageBlockUI();

                if (position === "subject_container") {
                    chart_type = 'subject_chart_data'

                    header = "موضوع: " + text
                    save_file_name += " (مجموعه سند {1} و موضوع {2})".replace("1", country_name).replace("2", text)
                }

                else if (position === "approval_container") {
                    chart_type = 'approval_reference_chart_data'

                    header = "مرجع تصویب: " + text
                    save_file_name += " (مجموعه سند {1} و مرجع تصویب {2})".replace("1", country_name).replace("2", text)
                }

                else if (position === "level_container") {
                    chart_type = 'level_chart_data'

                    header = "سطح سند: " + text
                    save_file_name += " (مجموعه سند {1} و سطح سند {2})".replace("1", country_name).replace("2", text)
                }

                else if (position === "year_container") {

                    chart_type = 'approval_year_chart_data'

                    header = "سال تصویب: " + text
                    save_file_name += " (مجموعه سند {1} و سال تصویب {2})".replace("1", country_name).replace("2", text)
                }

                document.getElementById("ChartModalHeader").innerText = header


                let request_link = 'http://' + location.host + "/GetPortalDocuments_ByColumn_Modal/" + panel_name + "/" + country_id + "/" +
                    multiselect_subject_value + "/" + chart_type + "/" + column_name + "/"

                let response = await fetch(request_link).then(response => response.json());

                filtered_result = response['document_list']



                let filtered_result_tag = ""
                let list_of_docId = ""
                for (const doc of filtered_result) {
                    const link = 'http://' + location.host + "/information/?id=" + doc["document_id"]
                    let tag = "<li class='mt-3' id=" + doc["document_id"] + "><a target='blank' href='" + link + "'>" + doc["document_name"] + "</a></li>"
                    filtered_result_tag += tag
                    list_of_docId += doc["document_id"] + "_"
                }

                filtered_result_tag = "<ol start='1'>" + filtered_result_tag + "</ol>"
                document.getElementById("ChartModalText").innerHTML = filtered_result_tag

                stopFullPageBlockUI('کلیک روی نمودار')
                $("#ChartModalBtn").click();

                /* download file creation */
                document.getElementById("DownloadDocuments").onclick = function () {
                    downloadFiles(filtered_result, save_file_name);
                };

                console.log(save_file_name)
                /* export into excel files */
                document.getElementById("ExportExcel2").onclick = async function ExportExcelFunction() {

                    var csv = "";

                    sep = ","
                    let Csv = "نام سند" + sep + "سطح سند" + sep +
                        "موضوع سند" + sep + "نوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + "\n"
                    for (let document of filtered_result) {

                        Csv += document["document_name"] + sep + document["level_name"] + sep + document["subject_name"] + sep +
                            document["type_name"] + sep + document["approval_reference_name"] + sep + document["approval_date"] + "\n"

                    }

                    let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
                    var link = document.createElement("a");
                    link.setAttribute("href", csvContent);
                    link.setAttribute("download", save_file_name + ".csv");
                    document.body.appendChild(link);
                    link.click()
                };



            }
            }
            if (container === "subject_container") {
                newDoughnutChart(container, options);
            } else {
                newBarChart(container, options)
            }
        }




        async function showActorsChart(chart_container, chart_data, country_id, multiselect_subject_value) {
            const options = {
            data: chart_data,
            xAxisTitle: 'کنشگر',
            title: 'توزیع کنشگران اسناد',
            yAxisTitle: "تعداد پاراگراف",
            bars: [
                {
                    name: "متولی اجرا",
                    onClick: async function (e) {
                const click_tag = e.domTarget.tag;
                const column_index = click_tag["index"]
                const actor_name = chart_data[column_index][0];
                const actor_role_name = 'متولی اجرا';
                showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, keyword_template, multiselect_subject_value)

            }
                },
                {
                    name: "همکار",
                    onClick: function (e) {
                const click_tag = e.domTarget.tag;
                const column_index = click_tag["index"]
                const actor_name = chart_data[column_index][0];
                const actor_role_name = 'همکار';
                showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, keyword_template, multiselect_subject_value)
            }
                },
                {
                    name: "دارای صلاحیت اختیاری",
                    onClick: function (e) {
                /* Modal Headers */
                const click_tag = e.domTarget.tag;
                const column_index = click_tag["index"]
                const actor_name = chart_data[column_index][0];
                const actor_role_name = 'دارای صلاحیت اختیاری';
                showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, keyword_template, multiselect_subject_value)
            }
                }
            ]};
            newBarsChart(chart_container, options)
        }



        async function showColumnParagraphs_Modal(country_id, actor_name, actor_role_name, keyword_template, multiselect_subject_value) {
            /* Title Body */
            const title_tag = actor_name + ' (' + actor_role_name + ')'
            $('#actor_modal_header').text(title_tag);

            /* Modal Body */
            document.getElementById('actor_modal_body').innerHTML = "";

            $("#actors_modal_btn").click();

            let template_keywords_text = keyword_template.toString();

            let request_link = 'http://' + location.host + "/Get_Portal_ActorParagraphs_ByColumn_Modal/" + panel_name + "/" + country_id + "/" + multiselect_subject_value + "/" + actor_name + "/" + actor_role_name + "/" + template_keywords_text + "/"
            let response = await fetch(request_link).then(response => response.json());
            let actor_paragraphs_result = response["actor_paragraphs_result"]
            doc_tag = ''
            // let keywords_list = template_keywords;

            for (const [doc_id, doc_info] of Object.entries(actor_paragraphs_result)) {
                document_id = doc_id
                document_name = doc_info['document_name']

                document_link = 'http://' + location.host + "/information/?id=" + document_id
                doc_name = '<a class="bold text-secondary" target="to_blank" href="' + document_link + '">' + document_name + "</a>"

                paragraph_list = doc_info['paragraph_list']
                paragraphs_tag = ''
                for (paragraph of paragraph_list) {
                    paragraph_text = paragraph['paragraph_text']
                    actor_form = paragraph['actor_form']
                    highlighted_paragraph = await highlight_ChartActor_Paragraphs(paragraph_text, actor_role_name, actor_form, keyword_list)
                    paragraphs_tag += "<li class='mb-3 lh-lg' >" + highlighted_paragraph + "</li>"
                }
                paragraphs_tag = '<ul>' + paragraphs_tag + '</ul>'
                doc_tag += "<li class='mb-3 lh-lg'>" + doc_name + paragraphs_tag + "</li>"
            }


            document.getElementById('actor_modal_body').innerHTML = '<ol start="1">' + doc_tag + '</ol>'

        }





        async function showDocumentInformation(documents_information_list) {

            SearchResultValue = documents_information_list;

            document.getElementById("SearchResultLable").innerText = (documents_information_list.length).toString() + " سند یافت شد.";

            $('#SearchTable').empty();
            $('#SearchTable').footable({
                "paging": {
                    "enabled": true,
                     strings: {
                         first: '»',
                         prev:'›',
                         next: '‹',
                         last: '«'
                     }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "سندی یافت نشد.",
                "columns": [{
                    "name": "id",
                    "title": "ردیف",
                    "breakpoints": "xs sm",
                    "type": "number",
                    "style": {
                        "width": "5%"
                    }
                }, {
                    "name": "document_tag",
                    "title": "نام سند",
                    "style": {
                        "width": "35%"
                    }
                }, {
                    "name": "document_subject",
                    "title": "موضوع سند",
                    "style": {
                        "width": "15%"
                    }
                }, {
                    "name": "document_approval_reference",
                    "title": "مرجع تصویب",
                    "style": {
                        "width": "15%"
                    }
                }, {
                    "name": "document_approval_date",
                    "title": "تاریخ تصویب",
                    "style": {
                        "width": "15%"
                    }
                }, {
                    "name": "document_keywords",
                    "title": "کلمات کلیدی",
                    "style": {
                        "width": "30%"
                    }
                }, {
                    "name": "detail",
                    "title": "جزئیات",
                    "style": {
                        "width": "5%"
                    }
                }
                ],
                "rows": documents_information_list
            });



        }

        async function DetailFunction(document_id) {

            startFullPageBlockUI();

            document.getElementById('detailModalBody').innerHTML = "";

            /******************************* Document paragraphs **********************************/
            const keyword_list_string = keyword_list.join("_")
            request_link = 'http://' + location.host + "/Get__keyword__Paragraphs_Detail_Modal/" + document_id + "/" + keyword_list_string + "/";
            response = await fetch(request_link).then(response => response.json());
            document_paragraphs_list = response["document_paragraphs_result"]
            document_name = response["document_name"]

            document_address = 'http://' + location.host + "/information/?id=" + document_id
            document_link = '<a target = "to_blank" href = "' + document_address + '">' + document_name + '</a>'


            /******************************* General definition **********************************/
            request_link = 'http://' + location.host + "/GetGeneralDefinition2/" + document_id + "/";
            response = await fetch(request_link).then(response => response.json());
            response = response['result']
            let definitions_data = {}

            for (let i = 0; i < response.length; i++) {
                const word = response[i]["word"]
                const definition = response[i]["definition"]
                definitions_data[word] = definition
                // definitions_data += `<p>${i + 1}- ${word}: ${definition}</p>`
            }

            console.log(definitions_data)
            // Set modal title
            document.getElementById('detailModalHeader').innerHTML = document_link

            modal_paragraphs_tag = ''

            for (paragraph of document_paragraphs_list) {

                // highlight paragraph
                paragraph_text = await highlightParagraph(paragraph, definitions_data);

                paragraph_tag = '<li dir="rtl" class ="text-right border-bottom border-1 mb-4 lh-lg">' + paragraph_text + '</li>'
                modal_paragraphs_tag += paragraph_tag

            }

            document.getElementById('detailModalBody').innerHTML = '<ul> ' + modal_paragraphs_tag + '</ul>';

            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
            var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl)
            });

            stopFullPageBlockUI('جزئیات سند')
        }



        async function highlightParagraph(paragraph, definitions_data) {

            paragraph_id = paragraph['id']
            paragraph_text = paragraph['text']

            definitions_words = []
            definitions_bullets = ''
            // all words add to bullet
            for (const [word, def] of Object.entries(definitions_data)) {
                word_template = ' ' + word + ' '
                if (paragraph_text.includes(word_template)) {
                    popover_title = word;
                    popover_content = def;
                    word_tag = '<a dir="rtl" tabindex="0" class="d-inline-block text-primary text-right"  data-bs-placement="bottom" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="' + popover_title + '" data-bs-content="' + popover_content + '">' + popover_title + '</a>'
                    definitions_words.push(word_tag);

                }


            }



            /* Actors highlight algorithm   */
            motevalian_result = await highlightMotevalian(paragraph_text, motevali_keywords, 'bg-success', 'border-success')
            paragraph_text = motevalian_result[0]
            paragraph_motevalian = motevalian_result[1]

            hamkaran_result = await highlightHamkaran(paragraph_text, hamkaran_keywords, 'bg-success', 'border-success')
            paragraph_text = hamkaran_result[0]
            paragraph_hamkaran = hamkaran_result[1]

            salahiat_result = await highlightSalahiat(paragraph_text, salahiat_keywords, 'bg-success', 'border-success')
            paragraph_text = salahiat_result[0]
            paragraph_salahiat = salahiat_result[1]


            /* Highlight document references */
            document_references_result = await highlightDocumentsReferences(paragraph_text, paragraph_id)
            paragraph_text = document_references_result[0]
            paragraph_references = document_references_result[1]



            /* Highlight pattern keywords */
            for (pattern_keyword of keyword_list) {

                if (after_terms_count[pattern_keyword] > 0)
                    paragraph_text = await highlightSomeTermsAfterKeyword(paragraph_text, after_terms_count[pattern_keyword], pattern_keyword)

                pattern_keyword_tag = "<span class='bg-secondary text-white px-1 rounded'>" + pattern_keyword + "</span>"
                paragraph_text = paragraph_text.replaceAll(pattern_keyword, pattern_keyword_tag)

            }

            /********************* Highlight optional keywords  **************************/
            for (pattern_keyword of optional_keywords) {

                if (optional_after_terms_count[pattern_keyword] > 0)
                    paragraph_text = await highlightSomeTermsAfterKeyword(paragraph_text, optional_after_terms_count[pattern_keyword], pattern_keyword)

                pattern_keyword_tag = "<span class='border border-secondary border-2  px-1 rounded'>" + pattern_keyword + "</span>"
                paragraph_text = paragraph_text.replaceAll(pattern_keyword, pattern_keyword_tag)

            }


            /******************* Detect definition words ************************/

            // Create items array
            var items = Object.keys(definitions_data).map(function (key) {
                return [key, definitions_data[key], key.length];
            });

            // Sort the array based on the third element
            sorted_def_data = items.sort(function (first, second) {
                return second[2] - first[2];
            });


            // Highlight with a simple tag
            for (data of sorted_def_data) {
                word = data[0]
                def = data[1]

                word_template = ' ' + word + ' '
                if (paragraph_text.includes(word_template)) {
                    a_tag = '<a>' + word + '</a>'
                    paragraph_text = paragraph_text.replaceAll(word_template, ' ' + a_tag + ' ')

                }

            }


            // Highlight with correct tag
            for (data of sorted_def_data) {
                word = data[0]
                def = data[1]

                word_template = '<a>' + word + '</a>'
                if (paragraph_text.includes(word_template)) {
                    console.log(word_template)
                    popover_title = word;
                    popover_content = def;
                    word_tag = '<a dir="rtl" tabindex="0" class="d-inline-block text-primary text-right"  data-bs-placement="bottom" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="' + popover_title + '" data-bs-content="' + popover_content + '">' + popover_title + '</a>'
                    paragraph_text = paragraph_text.replaceAll(word_template, ' ' + word_tag + ' ')

                }


            }


            definitions_bullets = definitions_words.join(' - ');


            /******************** Add more info bulletes for each paragraph **********************/
            more_info_tag = ''

            if (paragraph_motevalian.length >= 0) {
                motevalian_bullet = '<li dir="rtl" class = "text-right lh-lg"> <span class="bold"> متولیان اجرا: </span>' + '<span class="text-success">' + paragraph_motevalian.join(' - ') + '</span>' + '</li>'
                more_info_tag += motevalian_bullet
            }

            if (paragraph_hamkaran.length >= 0) {
                hamkaran_bullet = '<li dir="rtl" class = "text-right lh-lg"> <span class="bold"> همکاران: </span>' + '<span class="text-success">' + paragraph_hamkaran.join(' - ') + '</span>' + '</li>'
                more_info_tag += hamkaran_bullet
            }


            if (paragraph_salahiat.length >= 0) {
                salahiat_bullet = '<li dir="rtl" class = "text-right lh-lg"> <span class="bold"> دارای صلاحیت اختیاری: </span>' + '<span class="text-success">' + paragraph_salahiat.join(' - ') + '</span>' + '</li>'
                more_info_tag += salahiat_bullet
            }



            if (paragraph_references.length >= 0) {
                document_references_bullet = '<li dir="rtl" class = "text-right lh-lg"> <span class="bold"> ارجاع به اسناد: </span>' + '<span class="text-primary">' + paragraph_references.join(' - ') + '</span>' + '</li>'
                more_info_tag += document_references_bullet
            }

            if (definitions_bullets.length >= 0) {
                document_definition_bullet = '<li dir="rtl" class = "text-right lh-lg"> <span class="bold"> ارجاع به تعاریف: </span>' + '<span class="text-primary">' + definitions_bullets + '</span>' + '</li>'
                more_info_tag += document_definition_bullet
            }


            more_info_tag = '<ul class= "mt-3 mb-3 border-right border-5 rounded">' + more_info_tag + '</ul>'
            paragraph_text += more_info_tag



            return paragraph_text;
        }



        /* Actor highlight algorithms */
        async function highlightMotevalian(paragraph_text, pattern_keywords, bg_color, border_color) {

            detected_motevalian_list = []
            for (pattern_keyword of pattern_keywords) {

                /* Highlight with actors list */
                let pattern_keyword_tag = "<span class='gray_dotted_border rounded px-1'>" + pattern_keyword + "</span>"
                for (actor of actors_list) {

                    if (paragraph_text.includes(actor + ' ' + pattern_keyword) ||
                        paragraph_text.includes(actor.replaceAll(' جمهوری اسلامی ایران', '') + ' ' + pattern_keyword)) {
                        detected_motevalian_list.push(actor)
                    }


                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor + "</span>"
                    paragraph_text = paragraph_text.replaceAll(actor + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);

                    actor_without_postfix = actor.replace(' جمهوری اسلامی ایران', '')
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor + "</span>"
                    paragraph_text = paragraph_text.replaceAll(actor_without_postfix + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }

                /* Highlight without actors list */
                let regex = '', result, indices = [];

                if (pattern_keyword == 'موظف است') {
                    regex = /موظف است/gi;
                } else if (pattern_keyword == 'مکلف است') {
                    regex = /مکلف است/gi;
                }
                else if (pattern_keyword == 'مکلفند') {
                    regex = /مکلفند/gi;
                }
                else if (pattern_keyword == 'مکلف‌اند') {
                    regex = /مکلف‌اند/gi;
                }
                else if (pattern_keyword == 'موظفند') {
                    regex = /موظفند/gi;
                }
                else if (pattern_keyword == 'موظف‌اند') {
                    regex = /موظف‌اند/gi;
                }
                else if (pattern_keyword == 'موظف به') {
                    regex = /موظف به/gi;
                }
                else if (pattern_keyword == 'مکلف به') {
                    regex = /مکلف به/gi;
                }

                while ((result = regex.exec(paragraph_text))) {
                    indices.push(result.index);
                }

                for (index of indices) {


                    let start_index = (index - 1);
                    let reference = '';
                    let reference_tag = '';


                    for (let i = (start_index); i >= 0; i--) {

                        if (motevalian_punctuations.includes(paragraph_text[i]) || i == 0) {


                            if (paragraph_text[i + 1] == ' ') {

                                reference = paragraph_text.substring((i != 0 ? (i + 2) : i), start_index);

                            } else {
                                reference = paragraph_text.substring((i != 0 ? (i + 1) : i), start_index);
                            }

                            reference_tag = '<span class="detected_reference border border-2 ' + border_color + ' rounded px-1">' + reference + '</span> ';

                            break;

                        }
                    };

                    if (reference != ' ' && reference.length > 1 && reference.length < 50) {

                        if (paragraph_text.includes(reference + ' ' + pattern_keyword)) {
                            detected_motevalian_list.push(reference);
                        }

                        let pattern_tag = "<span class='gray_dotted_border rounded px-1'>" + pattern_keyword + "</span> "

                        paragraph_text = paragraph_text.replaceAll(reference + ' ' + pattern_keyword, reference_tag + ' ' + pattern_tag);

                    }


                }

            }


            return [paragraph_text, detected_motevalian_list];


        }

        async function highlightHamkaran(paragraph_text, pattern_keywords, bg_color, border_color) {
            const window_length = 100;

            let space_counter = 0;
            detected_hamkaran_list = []


            /* Highlight pattern keywords and references */
            for (pattern_keyword of pattern_keywords) {


                /* Highlight more with actors list */
                let regex = '', result, indices = [];

                if (pattern_keyword == 'با همکاری') {
                    regex = /با همکاری/gi;
                } else {
                    regex = /باهمکاری/gi;
                }

                while ((result = regex.exec(paragraph_text))) {
                    indices.push(result.index);
                }

                for (const index of indices) {

                    let start_index = (index + pattern_keyword.length);
                    let substring = paragraph_text.substring(start_index, start_index + window_length);
                    let current_substring = substring;

                    for (actor of actors_list) {


                        if (substring.includes(' ' + actor + ' ' ||
                            '(' + actor + ')')) {
                            detected_hamkaran_list.push(actor)
                        }

                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor + "</span>"
                        substring = substring.replaceAll(' ' + actor + ' ', ' ' + actor_tag + ' ');
                        substring = substring.replaceAll('(' + actor + ')', '(' + actor_tag + ')');

                        for (symbol of hamkaran_punctuations) {

                            if (substring.includes(' ' + actor + symbol, ' ')) {
                                detected_hamkaran_list.push(actor)
                            }

                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor + "</span>"
                            substring = substring.replaceAll(' ' + actor + symbol, ' ' + actor_tag + symbol);

                        }

                        actor_without_affix = actor.replaceAll('وزارت ', '').replaceAll('سازمان ', '').replaceAll(' جمهوری اسلامی ایران', '')

                        if (actor_without_affix != 'اطلاعات' && actor_without_affix != 'مجموعه سند' && !substring.includes(actor)) {

                            if (substring.includes(' ' + actor_without_affix + ' ' ||
                                '(' + actor_without_affix + ')')) {

                                detected_hamkaran_list.push(actor_without_affix)
                            }

                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor + "</span>"
                            substring = substring.replaceAll(' ' + actor_without_affix + ' ', ' ' + actor_tag + ' ');
                            substring = substring.replaceAll('(' + actor_without_affix + ')', '(' + actor_tag + ')');

                            for (symbol of hamkaran_punctuations) {

                                if (substring.includes(' ' + actor_without_affix + symbol, ' ')) {

                                    detected_hamkaran_list.push(actor_without_affix)
                                }

                                actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor + "</span>"
                                substring = substring.replaceAll(' ' + actor_without_affix + symbol, ' ' + actor_tag + symbol);

                            }

                        }

                    }

                    paragraph_text = paragraph_text.replaceAll(current_substring, substring);

                }
                /* Highlight with actors list */
                let pattern_keyword_tag = "<span class='gray_dotted_border rounded px-1'>" + pattern_keyword + "</span>"

                paragraph_text = paragraph_text.replaceAll(pattern_keyword, pattern_keyword_tag);

            }




            return [paragraph_text, detected_hamkaran_list];



        }

        async function highlightSalahiat(paragraph_text, pattern_keywords, bg_color, border_color) {
            detected_salahiat_list = []

            for (pattern_keyword of pattern_keywords) {

                /* Highlight with actors list */
                let pattern_keyword_tag = "<span class='gray_dotted_border  rounded px-1'>" + pattern_keyword + "</span>"
                for (actor of actors_list) {

                    if (paragraph_text.includes(actor + ' ' + pattern_keyword) ||
                        paragraph_text.includes(actor.replace(' جمهوری اسلامی ایران', '') + ' ' + pattern_keyword)) {
                        detected_salahiat_list.push(actor);
                    }

                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor + "</span>"
                    paragraph_text = paragraph_text.replaceAll(actor + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);


                    actor_without_postfix = actor.replace(' جمهوری اسلامی ایران', '')
                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor + "</span>"
                    paragraph_text = paragraph_text.replaceAll(actor_without_postfix + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                }

                /* Highlight without actors list */
                let regex = '', result, indices = [];

                if (pattern_keyword == 'مختار است') {
                    regex = /مختار است/gi;
                } else if (pattern_keyword == 'اختیار دارد') {
                    regex = /اختیار دارد/gi;
                } else if (pattern_keyword == 'می‌تواند') {
                    regex = /می‌تواند/gi

                } else if (pattern_keyword == 'می تواند') {
                    regex = /می تواند/gi
                }
                else if (pattern_keyword == 'میتواند') {
                    regex = /میتواند/gi
                }
                else if (pattern_keyword == 'مجاز است') {
                    regex = /مجاز است/gi
                }

                while ((result = regex.exec(paragraph_text))) {
                    indices.push(result.index);
                }

                for (index of indices) {


                    let start_index = (index - 1);
                    let reference = '';
                    let reference_tag = '';


                    for (let i = (start_index); i >= 0; i--) {

                        if (motevalian_punctuations.includes(paragraph_text[i]) || i == 0) {


                            if (paragraph_text[i + 1] == ' ') {

                                reference = paragraph_text.substring((i != 0 ? (i + 2) : i), start_index);

                            } else {
                                reference = paragraph_text.substring((i != 0 ? (i + 1) : i), start_index);
                            }

                            reference_tag = '<span class="detected_reference border border-2 ' + border_color + ' rounded px-1">' + reference + '</span>'

                            break;

                        }
                    };

                    if (reference != ' ' && reference.length > 1 && reference.length < 50) {

                        if (paragraph_text.includes(reference + ' ' + pattern_keyword)) {
                            detected_salahiat_list.push(reference);
                        }
                        let pattern_tag = '<span class="gray_dotted_border rounded px-1">' + pattern_keyword + '</span> '

                        paragraph_text = paragraph_text.replaceAll(reference + ' ' + pattern_keyword, reference_tag + ' ' + pattern_tag);

                    }


                }

            }

            return [paragraph_text, detected_salahiat_list];

        }




        /* Highlight document references */
        async function highlightDocumentsReferences(paragraph_text, paragraph_id) {

            references_tag_list = []

            request_link = 'http://' + location.host + "/GetParagraphReferences/" + paragraph_id + '/';
            response = await fetch(request_link).then(response => response.json());

            let paragraph_references_list = response["references"];

            reference_result = await replaceReferences(paragraph_text, paragraph_references_list);

            return reference_result
        }

        async function replaceReferences(paragraph, paragraph_references_list) {



            for (references_info of paragraph_references_list) {

                doc_name = references_info['doc_name']
                doc_id = references_info['doc_id']
                document_link = 'http://' + location.host + "/information/?id=" + doc_id
                reference_tag = '<a class="d-inline-block text-primary" target="to_blank" href="' + document_link + '">' + doc_name + "</a>"

                if (paragraph.search(doc_name) > 0) {


                    let pattern_tag = "<span class='text-primary'>" + reference_tag + "</span> ";
                    paragraph = paragraph.replaceAll(doc_name, pattern_tag);
                    references_tag_list.push(reference_tag)
                }



            }

            return [paragraph, references_tag_list];
        }


        async function customHighlightAlgorithm(paragraph_text) {
            //Your algorithm

            return paragraph_text;
        }





        /****************** Chart Modal Highlight algorithms ********************************** */

        async function highlight_ChartActor_Paragraphs(paragraph, actor_role, paragraph_actor_form, keywords_list) {

            paragraph_text = '';



            if (actor_role.includes('متولی اجرا')) {

                paragraph_text = await highlight_Chart_Motevalian(paragraph, paragraph_actor_form, motevali_keywords, 'bg-primary')
                paragraph_text = await highlightLegalDeadline(paragraph_text, motevali_keywords)

            } else if (actor_role.includes('همکار')) {
                paragraph_text = await highlight_Chart_Hamkaran(paragraph, paragraph_actor_form, hamkaran_keywords, 'bg-success');

            } else {
                paragraph_text = await highlight_Chart_Salahiat(paragraph, paragraph_actor_form, salahiat_keywords, 'bg-warning')

            }


            // Highlight keywords
            if (!keywords_list.includes('empty')) {
                for (keyword of keywords_list) {
                    keyword_tag = "<span class= 'bg-info text-white  rounded px-1'>" + keyword + "</span>"
                    paragraph_text = paragraph_text.replaceAll(keyword, keyword_tag);

                }
            }


            // highlight other actors
            paragraph_text = await highlightOtherActors(paragraph_text, paragraph_actor_form)


            /********************* Highlight optional keywords  **************************/
            for (pattern_keyword of optional_keywords) {

                if (optional_after_terms_count[pattern_keyword] > 0)
                    paragraph_text = await highlightSomeTermsAfterKeyword(paragraph_text, optional_after_terms_count[pattern_keyword], pattern_keyword)

                pattern_keyword_tag = "<span class='border border-secondary border-2  px-1 rounded'>" + pattern_keyword + "</span>"
                paragraph_text = paragraph_text.replaceAll(pattern_keyword, pattern_keyword_tag)

            }

            return paragraph_text
        }

        async function highlight_Chart_Motevalian(paragraph_text, actor_form, pattern_keywords, bg_color) {

            for (pattern_keyword of pattern_keywords) {

                /* Highlight with actors list */
                let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"
                actor_without_postfix = actor_form.replace(' جمهوری اسلامی ایران', '')
                actor_without_postfix = actor_without_postfix.replace(' ایران', '')

                paragraph_text = paragraph_text.split('.').map((sentence) => {


                    if (sentence.includes(actor_form + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                        sentence = sentence.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes('(' + actor_form + ')' + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + '(' + actor_form + ')' + "</span>"
                        sentence = sentence.replaceAll('(' + actor_form + ')' + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }
                    else if (sentence.includes(actor_without_postfix + ' ' + pattern_keyword)) {
                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_without_postfix + "</span>"
                        sentence = sentence.replaceAll(actor_without_postfix + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);
                    }

                    return sentence
                }).join('.')

            }



            /* Highlight with actors list */
            pattern_keyword = 'اقدام کند'
            pattern_keyword_tag1 = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"
            actor_without_postfix = actor_form.replace(' جمهوری اسلامی ایران', '')

            paragraph_text = paragraph_text.split('.').map((sentence) => {

                if ((sentence.includes('اقدام کند') || sentence.includes('اقدام‌کند'))) {

                    actor_tag1 = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                    sentence = sentence.replaceAll(' ' + actor_form + ' ', ' ' + actor_tag1 + ' ');


                    actor_tag2 = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_without_postfix + "</span>"
                    sentence = sentence.replaceAll(' ' + actor_without_postfix + 'actor_without_postfix',
                        ' ' + actor_tag2 + ' ');

                    sentence = sentence.replaceAll('اقدام کند', pattern_keyword_tag1);

                }
                return sentence
            }).join('.')




            return paragraph_text;


        }

        async function highlight_Chart_Hamkaran(paragraph_text, actor_form, pattern_keywords, bg_color) {
            const window_length = 100;

            let space_counter = 0;
            detected_hamkaran_list = []


            /* Highlight pattern keywords and references */
            for (pattern_keyword of pattern_keywords) {


                /* Highlight more with actors list */
                let regex = '', result, indices = [];

                if (pattern_keyword == 'با همکاری') {
                    regex = /با همکاری/gi;
                } else {
                    regex = /باهمکاری/gi;
                }

                while ((result = regex.exec(paragraph_text))) {
                    indices.push(result.index);
                }

                for (const index of indices) {

                    let start_index = (index + pattern_keyword.length);
                    let substring = paragraph_text.substring(start_index, start_index + window_length);
                    let current_substring = substring;


                    actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                    substring = substring.replaceAll(' ' + actor_form + ' ', ' ' + actor_tag + ' ');
                    substring = substring.replaceAll('(' + actor_form + ')', '(' + actor_tag + ')');

                    for (symbol of hamkaran_punctuations) {

                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                        substring = substring.replaceAll(' ' + actor_form + symbol, ' ' + actor_tag + symbol);

                    }

                    actor_without_affix = actor_form.replaceAll('وزارت ', '').replaceAll('سازمان ', '').replaceAll(' جمهوری اسلامی ایران', '')

                    if (actor_without_affix != 'اطلاعات' && actor_without_affix != 'مجموعه سند' && !substring.includes(actor_form)) {


                        actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                        substring = substring.replaceAll(' ' + actor_without_affix + ' ', ' ' + actor_tag + ' ');
                        substring = substring.replaceAll('(' + actor_without_affix + ')', '(' + actor_tag + ')');

                        for (symbol of hamkaran_punctuations) {


                            actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                            substring = substring.replaceAll(' ' + actor_without_affix + symbol, ' ' + actor_tag + symbol);

                        }

                    }



                    paragraph_text = paragraph_text.replaceAll(current_substring, substring);

                }
                /* Highlight with actors list */
                let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"

                paragraph_text = paragraph_text.replaceAll(pattern_keyword, pattern_keyword_tag);

            }




            return paragraph_text;



        }

        async function highlight_Chart_Salahiat(paragraph_text, actor_form, pattern_keywords, bg_color) {

            for (pattern_keyword of pattern_keywords) {

                /* Highlight with actors list */
                let pattern_keyword_tag = "<span class='bg-secondary text-white  rounded px-1'>" + pattern_keyword + "</span>"

                actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                paragraph_text = paragraph_text.replaceAll(actor_form + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);


                actor_without_postfix = actor_form.replace(' جمهوری اسلامی ایران', '')
                actor_tag = "<span class='" + bg_color + " text-white rounded px-1 reference'>" + actor_form + "</span>"
                paragraph_text = paragraph_text.replaceAll(actor_without_postfix + ' ' + pattern_keyword, actor_tag + ' ' + pattern_keyword_tag);



            }

            return paragraph_text;

        }

        /* Highlight N terms after one keyword */
        async function highlightSomeTermsAfterKeyword(paragraph_text, terms_count, keyword) {
            paragraph_selected_terms = '';
            selected_terms_list = []
            let indices = await getIndicesOf(keyword, paragraph_text);

            for (index of indices) {

                let pattern_keyword_index = index;
                let start_index = pattern_keyword_index + keyword.length + 1
                let end_index = paragraph_text.length;
                let selected_terms_size = 0

                if (pattern_keyword_index != -1) {
                    sub_string = paragraph_text.substring(start_index, end_index)

                    selected_terms = sub_string.split(' ').slice(0, terms_count)

                    for (term of selected_terms) {
                        selected_terms_size += term.length
                    }
                    selected_terms_size += (terms_count - 1)

                    selected_terms_text = paragraph_text.substring(start_index, start_index + selected_terms_size);

                    if (!selected_terms_text.includes('span')) {
                        if (!selected_terms_list.includes(selected_terms_text)) {
                            selected_terms_list.push(selected_terms_text)
                        }

                    }


                }


            }

            for (selected_terms_text of selected_terms_list) {
                if (selected_terms_text != "") {
                    selected_terms_tag = "<span class='blue_dotted_border selected_terms px-1 mx-1'>" + selected_terms_text + "</span>"
                    paragraph_text = paragraph_text.replaceAll(selected_terms_text, selected_terms_tag)
                }

            }

            return paragraph_text;
        }

        async function highlightLegalDeadline(paragraph_text, actor_pattern_keywords) {

            for (pattern_keyword of actor_pattern_keywords) {

                let pattern_keyword_tag = "<span class='bg-secondary text-white rounded px-1'>" + pattern_keyword + "</span>"


                let indices = await getIndicesOf(pattern_keyword_tag, paragraph_text);

                for (index of indices) {
                    start_index = index + pattern_keyword_tag.length;

                    sub_string = paragraph_text.substring(start_index, paragraph_text.length);

                    for (deadline_keyword of deadline_pattern_keywords) {
                        for (const [nubmer_text, value] of Object.entries(numbers_dict)) {
                            for (time_category of time_categories) {

                                // ظرف شش ماه
                                pattern1 = deadline_keyword + ' ' + nubmer_text + ' ' + time_category;
                                pattern2 = deadline_keyword + ' ' + nubmer_text + ' ' + '(' + value + ')' + ' ' + time_category;

                                // ظرف شش‌ماه
                                pattern3 = deadline_keyword + ' ' + nubmer_text + '‌' + time_category;
                                pattern4 = deadline_keyword + ' ' + nubmer_text + ' ' + '(' + value + ')' + '‌' + time_category;

                                // ظرف یکسال
                                pattern5 = deadline_keyword + ' ' + nubmer_text + time_category;
                                pattern6 = deadline_keyword + ' ' + nubmer_text + ' ' + '(' + value + ')' + time_category;

                                patterns = [pattern1, pattern2, pattern3,
                                    pattern4, pattern5, pattern6];

                                for (pattern of patterns) {
                                    deadline_keyword_tag = "<span class='deadlines gray_dotted_border px-1 rounded'>" + deadline_keyword + "</span>"
                                    pattern_without_deadline_keyword = pattern.replace(deadline_keyword + ' ', '');
                                    pattern_without_keyword_tag = "<span class='deadlines border border-warning border-2 px-1 rounded'>" + pattern_without_deadline_keyword + "</span>"
                                    new_sub_string = sub_string.replaceAll(pattern, deadline_keyword_tag + ' ' + pattern_without_keyword_tag)

                                    // closest deadline..not all deadlines. => replace()
                                    paragraph_text = paragraph_text.replace(sub_string, new_sub_string);

                                }

                                /* *********************************** */

                            }
                        }
                    }


                }

            }
            return paragraph_text;

        }

        async function highlightOtherActors(paragraph_text, paragraph_actor_form) {
            for (actor_form of actors_list) {
                if (actor_form != paragraph_actor_form) {
                    actor_form_tag = "<span class='other_actors'>" + actor_form + "</span>"
                    paragraph_text = paragraph_text.replaceAll(' ' + actor_form + ' ', ' ' + actor_form_tag + ' ');
                    paragraph_text = paragraph_text.replaceAll(' ' + actor_form + '،', ' ' + actor_form_tag + '،');
                    paragraph_text = paragraph_text.replaceAll('(' + actor_form + ')', '(' + actor_form_tag + ')');
                }

            }

            return paragraph_text;
        }

        async function showOtherActors() {
            if ($('.highlighted').length) {
                $('.highlighted').attr('class', 'other_actors')
            } else {
                $('.other_actors').attr('class', 'other_actors highlighted bold text-primary px-1 rounded')
            }

        }


        async function getIndicesOf(searchStr, str) {
            var searchStrLen = searchStr.length;
            if (searchStrLen == 0) {
                return [];
            }
            var startIndex = 0, index, indices = [];

            while ((index = str.indexOf(searchStr, startIndex)) > -1) {
                indices.push(index);
                startIndex = index + searchStrLen;
            }
            return indices;
        }


        async function SpinnerModeFunction(mode) {
            if (mode === "Active") {
                $(".spinner-border").addClass("active");
            } else if (mode === "Disable") {
                $(".spinner-border").removeClass("active");
            }

        }


    </script>



    <!-- Export results -->

    <script>

        async function downloadFiles(file_name_list, save_file_name) {
            startFullPageBlockUI()
            const country_id = $('#country option:selected').val()

            let zip = new JSZip()

            const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["country_information"][0]
            const country_folder = response["folder"];
            const country_name = response["name"];

            // save_file_name += " مجموعه سند {" + country_name + "}"


            let extension = ".txt"
            if (country_name.includes("فاوا")) {
                extension = '.docx';
            }

            // file_name_list = documents_information_dict
            for (const doc_info of file_name_list) {

                const document_name = doc_info['document_name'] + extension

                const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

                await fetch(path)
                    .then(res => res.arrayBuffer())
                    .then(value => {
                        zip.file(document_name, value);
                    })
            }
            zip.generateAsync({
                type: "blob"
            })
                .then(function (content) {
                    // see FileSaver.js
                    saveAs(content, save_file_name + ".zip");
                });
            stopFullPageBlockUI('دانلود اسناد');
        }

        async function DownloadSerachResultFunction() {
            const save_file_name = "پنل تحلیل درگاه: "
            downloadFiles(SearchResultValue, save_file_name)
        }

        async function ExportExcelSerachResultFunction() {
            var csv = "";

            sep = ","


            let Csv = "نام سند" + sep + "موضوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + sep + "کلمات کلیدی" +
                "\n"
            for (const doc_info of SearchResultValue) {
                const document_name = doc_info["document_name"]
                const document_subject = doc_info['document_subject']
                const document_approval_reference = doc_info['document_approval_reference']
                const document_approval_date = doc_info['document_approval_date']
                const document_keyword = doc_info['document_keywords']


                Csv += document_name + sep + document_subject + sep + document_approval_reference +
                    sep + document_approval_date +
                    sep + document_keyword + "\n"

            }

            let save_file_name = "پنل تحلیل درگاه: "
            save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"

            let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
            var link = document.createElement("a");
            link.setAttribute("href", csvContent);
            link.setAttribute("download", save_file_name + ".csv");
            document.body.appendChild(link);
            link.click()
        }

    </script>


</body>

<!-- BS Tooltips handler -->
<script src="../../static/js/tooltip_handler.js"></script>

<!-- Intro Js -->
<!-- Intro Js -->
<script src="../../static/js/portal/portal_tour.js">
</script>
<script src="../../static/js/tour.js"></script>
<!-- <script src="../../static/js/UserLogSave.js"></script>-->
<script src="../../static/js/signout_function.js"></script>


<script>

    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl)
    });


</script>


<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">

</html>