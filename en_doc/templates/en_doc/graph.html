<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>


    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">

    <link rel="stylesheet" href="../../static/styles/en_style/index2.css">
    <link rel="stylesheet" href="../../static/styles/vote_analysis.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">

    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!-- Blocking UI -->
    <script src="../../static/js/blockUI.js"></script>
    <script src="../../static/js/blockUI_handler.js"></script>
    <link rel="stylesheet" href="../../static/styles/loader.css">

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <meta charset="UTF-8">

    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="../../static/js/jsnetworkx.js"></script>

    <link rel="stylesheet" href="../../static/styles/en_style/index.css">
    <link rel="stylesheet" href="../../static/styles/graph.css">
    <meta charset="UTF-8">

    <title>Approvals Graph</title>
    {% include "doc/title_icon.html" %}
</head>

<body>

     <!-- Menu -->
    <nav dir="ltr" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "en_doc/header.html" %}
    </nav>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#ApprovalsDropdown').addClass('active');
            $('#graph_panel').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'Iran') {
                    let page_name = current_url.split('/')[3]
                    console.log(page_name)
                    let requested_url = current_url.replace('/en', '')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>

    <script src="../../static/js/topnav_handler.js"></script>

    <div class="row p-5 pb-0 flex-row-reverse mx-auto bg-light">
        <form action="" class="custom-control mx-auto needs-validation" id="graph_form" enctype="multipart/form-data"
            method="post" novalidate>

            <div class="row mb-0 flex-row mt-4 mx-auto">

                <div class="col-md-6 pt-3 col-12 col-lg-2 bg-light">

                    <label class="text-left bg-light float-left" style="direction: ltr;;">Country:</label>

                    <select id="country" name="country" class="form-select text-left float-left"
                        onchange="CountryChanged()" style="direction: ltr;">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6 pt-3 col-12 col-lg-2 bg-light">
                    <label class=" text-left bg-light float-left" style="direction: ltr;;">Graph Type:</label>
                    <select id="GraphType" name="GraphType" class="form-select text-left float-left"
                        style="direction: ltr;">
                    </select>
                </div>

                <div class="col-md-3 pt-3 col-12 col-lg-2 bg-light">
                    <label class=" text-left bg-light float-left" style="direction: ltr;;">Min Similarity:</label>
                    <select id="MinimumSimilarity" name="MinimumSimilarity" class="form-select text-left float-left"
                        style="direction: ltr;">
                    </select>
                </div>

                <div class="col-lg-3 mr-0 col-md-6 pt-5 col-12">
                    <!-- Advanced Setting btn-->
                    <button id="constraints_setting" type="button" class="btn bg-white float-left mr-4"
                        data-bs-toggle="collapse" data-bs-target="#constraints_container" aria-expanded="false"
                        aria-controls="constraints_container">Advanced Setting</button>

                    <!-- Show result btn -->
                    <button type="button" id="graph_show" class="btn float-left" onclick="ShowGraph()">Show</button>
                </div>


                <div id="similarity_chart_column" class="col-md-6 pt-3 col-12 col-lg-3 mx-0 p-0  bg-light">
                    <div id="similarity_chart_container" style="height: 180px" class="bg-white w-100 p-0">
                    </div>
                </div>

            </div>

            <!-- Constraints -->
            <div id="constraints_container"
                class="collapse show constraints_container row flex-row pt-0 mb-0 mt-0 mx-auto">

                <div id="SourceMainDiv" class="col-md-3 p-1 col-12 col-lg-6 mt-1">
                    <div class="source_header bg-white row mx-auto p-1">
                        <label class="text-center my-0" style="direction: ltr;;">
                            Source Node Constraints
                        </label>
                    </div>
                    <div class="source_container pb-2 row mx-auto">

                        <div class="col-md-3 pt-3 col-12 col-lg-6 bg-light">
                            <label class=" text-left bg-light float-left " style="direction: ltr;">Legislation by Type:</label>
                            <select id="SourceType" name="SourceType" class="form-select text-left float-left"
                                style="direction: ltr;" onchange="ChangeOptions('Source')">
                            </select>
                        </div>

                        <div class="col-md-6 pt-3 col-12 col-lg-6 bg-light ">
                            <label class=" text-left bg-light float-left" style="direction: ltr;;">Legislation by Subject:</label>
                            <select id="SourceSubject" name="SourceSubject" class="form-select text-left float-left"
                                onchange="ChangeOptions('Source')" style="direction: ltr;">
                            </select>
                        </div>

                    </div>
                </div>


                <div id="DestinationMainDiv" class="col-md-3 p-1 col-12  col-lg-6  mt-1">
                    <div class="destination_header bg-white row mx-auto p-1">
                        <label class=" text-center bg-white my-0" style="direction: ltr;;">
                            Target Node Constraints
                        </label>
                    </div>
                    <div class="destination_container pb-2 row mx-auto">

                        <div class="col-md-3 pt-3 col-12 col-lg-6 bg-light">
                            <label class=" text-left bg-light float-left " style="direction: ltr;;">Legislation by Type:</label>
                            <select id="DestinationType" name="DestinationType" class="form-select text-left float-left"
                                style="direction: ltr;" onchange="ChangeOptions('Destination')">
                            </select>
                        </div>

                        <div class="col-md-6 pt-3 col-12 col-lg-6 bg-light">
                            <label class=" text-left bg-light float-left " style="direction: ltr;;">Legislation by Subject:</label>
                            <select id="DestinationSubject" name="DestinationSubject"
                                class="form-select text-left float-left" onchange="ChangeOptions('Destination')"
                                style="direction: ltr;">
                            </select>
                        </div>

                    </div>
                </div>

            </div>

        </form>

        <!--Original Tabs -->
        <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-left  d-block" id="pills-tab"
            role="tablist">

            <li class="nav-item float-left" role="presentation">
                <button id="advanced_view_tab" class="nav-link active" data-bs-toggle="pill"
                    data-bs-target="#advanced_view_pane" type="button" role="tab" aria-controls="advanced_view_pane"
                    aria-selected="true">Advanced View</button>
            </li>
            <li class="nav-item float-left" role="presentation">
                <button id="simple_view_tab" class="nav-link" data-bs-toggle="pill" data-bs-target="#simple_view_pane"
                    type="button" role="tab" aria-controls="simple_view_pane" aria-selected="false">Simple View</button>
            </li>
        </ul>

        <!-- Original Panes -->
        <div id="original_pane" class="tab-content float-left px-1 bg-white" id="pills-tabContent">

            <!--  Document Graph Pane -->
            <div class="tab-pane fade show active float-left w-100" id="advanced_view_pane" role="tabpanel"
                aria-labelledby="advanced_view_tab">
                <div class="row mt-4 w-100 flex-row  mx-auto pb-5 px-4">
                    <!-- doc colors -->
                    <ul id="ColorBox" class="list-group flex-row list-unstyled w-100 list-group-horizontal text-left">
                    </ul>
                    <script src="../../static/js/graph/color_picker_handler.js">
                    </script>
                    <div id="advanced_graph_container" class="w-100 border mt-1" style="height:500px;">
                    </div>
                </div>
            </div>

            <!-- Bar chart Info Pane -->
            <div class=" tab-pane fade float-left w-100 " id="simple_view_pane" role="tabpanel"
                aria-labelledby="simple_view_tab ">
                <div class="row mt-4 w-100 flex-row-reverse mx-0 px-4 pb-5">
                    <div id="simple_graph_container" class="w-100 border" style="height: 500px;">
                    </div>

                </div>

            </div>
        </div>

    </div>

    <!-- Modal Container -->
    <div class="modal fade" id="SelectDocumentModal_Source">
        <div style="max-width: 1200px !important;" class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <!-- Modal Header -->
                <div style="direction: ltr !important;" class="modal-header">
                    <h5 id="ModalHeader_Source" class="modal-title">Select Source Node</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ModalBody_Source" class="modal-body text-justify">
                    <div class="container_modal">
                        <table class="table table-striped PopUpTable_Source">
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="SelectDocumentModal_Destination">
        <div style="max-width: 1200px !important;" class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: ltr !important;" class="modal-header">
                    <h5 id="ModalHeader_Destination" class="modal-title">Select Target Node</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>


                <!-- Modal body -->
                <div id="ModalBody_Destination" class="modal-body text-justify">
                    <div class="container_modal">
                        <table class="table table-striped PopUpTable_Destination">
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>



    </div>

    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="Go To Top" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>
    <script src="../../static/js/scroll_button_handler.js">
    </script>


    <script>
        init()

        async function init() {
            const country_id = document.getElementById("country").value
            /****************** Get Similarity Measure ****************************/

            let request_link = 'http://' + location.host + "/en"+ "/GetGraphSimilarityMeasureByCountry/" + country_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["measure_list"]

            console.log(response)

            document.getElementById("GraphType").innerHTML = ""
            for (var i = 0; i < response.length; i++) {
                const measure_id = response[i]["id"]
                const measure_name = response[i]["name"]

                const tag = "<option value=" + measure_id + " >" + measure_name + "</option>";

                document.getElementById("GraphType").innerHTML += tag
            }

            /****************** Get Graph Distribution ****************************/
            const measure_id = document.getElementById("GraphType").value
            request_link = 'http://' + location.host + "/en"+ "/GetGraphDistribution/" + country_id + "/" + measure_id + "/";
            response = await fetch(request_link).then(response => response.json());
            response = response["graph_distribution"]

            document.getElementById("MinimumSimilarity").innerHTML = ""

            var distribution_chart_value_list = []

            for (var i = 0; i < response.length; i++) {
                const similarity = response[i]["similarity"]
                const count = response[i]["count"]
                const tag = "<option value=" + similarity + " >" + similarity + "</option>";

                document.getElementById("MinimumSimilarity").innerHTML += tag

                distribution_chart_value_list.push([similarity, count])
            }

            showChart(distribution_chart_value_list, "similarity_chart_container")


            /****************** Subject List ****************************/
            document.getElementById("SourceSubject").innerHTML = "<option value=" + 0 + " >" + "All" + "</option>";
            document.getElementById("DestinationSubject").innerHTML = "<option value=" + 0 + " >" + "All" + "</option>";


            /****************** Type List ****************************/

            document.getElementById("SourceType").innerHTML = "<option value=" + 0 + " >" + "All" + "</option>";
            document.getElementById("DestinationType").innerHTML = "<option value=" + 0 + " >" + "All" + "</option>";

            /******************************** Get Type Color *****************************************/

        }

        async function SelectDocFunction(document_id, tag) {
            const request_link = 'http://' + location.host + "/en"+ "/GetDocumentById/" + document_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["document_information"][0]
            document.getElementById(tag + "Documents").innerHTML = "<option value=" + response["id"] + " >" + response["name"] + "</option>";
        }

        function CountryChanged() {
            init()
        }

        async function ShowGraph() {

            const country_id = document.getElementById("country").value

            /*********************** Filter Source Documents ****************************/
            const source_subject_id = document.getElementById("SourceSubject").value
            const source_type_id = document.getElementById("SourceType").value

            /*********************** Filter Destination Documents ****************************/
            const destination_subject_id = document.getElementById("DestinationSubject").value
            const destination_type_id = document.getElementById("DestinationType").value

            /*********************** Create Graph ****************************/
            const measure_id = document.getElementById("GraphType").value
            const minimum_weight = (document.getElementById("MinimumSimilarity").value).toString()
            let request_link = 'http://' + location.host + "/en"+ "/GetGraphEdgesByDocumentIdMeasure/" + country_id + "/" + source_type_id + "/" + source_subject_id + "/" +
                 destination_type_id + "/" + destination_subject_id + "/" + measure_id + "/" + minimum_weight + "/";
            let response = await fetch(request_link).then(response => response.json());

            let graphEdgeList = response["graph_edge_list"]
            let graphType = response["graph_type"]

            console.log(response)

            let nodeList = []
            let edgeList = []

            for (let i = 0; i < graphEdgeList.length; i++) {

                const edge = graphEdgeList[i]
                const src_id = edge["src_id"]
                const src_name = edge["src_name"]
                const src_color = edge["src_color"]
                const dest_id = edge["dest_id"]
                const dest_name = edge["dest_name"]
                const dest_color = edge["dest_color"]
                const weight = edge["weight"]

                let source_node = {
                    id: src_id,
                    name: src_name,
                    normal: {
                        fill: src_color,
                        stroke: null
                    },
                    hovered: {
                        fill: src_color,
                        stroke: null
                    },
                    selected: {
                        fill: src_color,
                        stroke: null
                    }
                }

                let destination_node = {
                    id: dest_id,
                    name: dest_name,
                    normal: {
                        fill: dest_color,
                        stroke: null
                    },
                    hovered: {
                        fill: dest_color,
                        stroke: null
                    },
                    selected: {
                        fill: dest_color,
                        stroke: null
                    }
                }

                let edge_data = {
                    id: src_id + "__" + dest_id,
                    from: src_id,
                    to: dest_id,
                    from_name: src_name,
                    to_name: dest_name,
                    weight: weight
                };

                nodeList.push(source_node)
                nodeList.push(destination_node)
                edgeList.push(edge_data)
            }


            /*********************** Show Graph ****************************/

            document.getElementById("advanced_graph_container").innerHTML = ""

            let graphData = {
                nodes: nodeList,
                edges: edgeList
            };

            var chart = anychart.graph(graphData);
            chart.height(650);
            let nodes = chart.nodes();
            nodes.normal().height(12);
            nodes.hovered().height(16);
            nodes.selected().height(16);
            nodes.hovered().fill("#ffa000");
            chart.nodes().tooltip().format("{%name}");
            chart.edges().tooltip().format(" from: {%from_name} \n to: {%to_name} \n weight: {%weight}");
            chart.edges().tooltip().fontFamily('vazir');
            chart.nodes().tooltip().fontFamily('vazir');
            chart.background("transparent");

            if (graphType === "Directed") {
                chart.edges().arrows({
                    enabled: true,
                    size: 10,
                    position: '50%'
                });
            }

            chart.container("advanced_graph_container")
            chart.draw();

            chart.listen('dblClick', async function (event) {
                const click_tag = event.domTarget.tag;
                console.log(click_tag)
                if (click_tag["type"] === "node") {
                    window.open('http://' + location.host + "/en/information?id=" + click_tag["id"]);
                } else if (click_tag["type"] === "edge") {
                    window.open('http://' + location.host + "/en/comparison?id=" + click_tag["id"]);
                }

            })

        }


        function showChart(data, position) {
            document.getElementById(position).innerHTML = ""

            let chart_container = position;
            chart = anychart.column();
            chart.container(chart_container);

            // create a column series and set the data
            var series = chart.column(data);

            chart.background().fill('white');

            // var state = series.normal();
            // state.fill('#1481c0')

            // x axix labels font setting
            var xAxisLabels = chart.xAxis().labels();
            xAxisLabels.fontFamily("vazir");
            xAxisLabels.fontSize(10);

            var yAxisLabels = chart.yAxis().labels();
            yAxisLabels.fontFamily("vazir");

            // Not allow labels overlapping
            var xAxis = chart.xAxis();
            xAxis.overlapMode("noOverlap");


            // tooltip content font setting
            var tooltip = chart.tooltip();
            tooltip.fontFamily("vazir");
            tooltip.titleFormat("Edges Count: {%y}")

            // tooltip title font setting
            var title = chart.tooltip().title();
            title.fontFamily("vazir");

            chart.tooltip().hAlign('center').format("حداقل شباهت: {%x}");


            // set all axis title
            var xAxis = chart.xAxis();
            xAxis.title("Min Similarity");
            xAxis.title().fontFamily('vazir');

            var yAxis = chart.yAxis();
            yAxis.title("Edges Count");
            yAxis.title().fontFamily('vazir');
            chart.yAxis().labels().format("{%value}");

            chart.xAxis().labels().height(30);
            chart.yScale(anychart.scales.log());

            // initiate drawing the chart
            chart.draw();


            chart.listen('dblClick', async function (event) {
                const click_tag = event.domTarget.tag;
                document.getElementById("MinimumSimilarity").selectedIndex = click_tag["index"];

                ShowGraph();


                $("html, body").animate({
                    scrollTop: $(document).height()
                }, 1000);
            })
            chart.listen('Click', async function (event) {
                const click_tag = event.domTarget.tag;
                document.getElementById("MinimumSimilarity").selectedIndex = click_tag["index"];
            })
        }
    </script>


</body>

</html>