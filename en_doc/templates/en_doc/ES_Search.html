<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">

    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>


    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">

    <link rel="stylesheet" href="../../static/styles/en_style/index2.css">
    <link rel="stylesheet" href="../../static/styles/information_chart.css">
    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/4.3.0/introjs-ltr.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/styles/en_style/user_guide_tour.css">

    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <meta charset="UTF-8">
    <link rel="stylesheet" href="../../static/styles/en_style/index.css">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">
    <meta charset="UTF-8">
    <title>Approvals Search</title>
    {% include "doc/title_icon.html" %}
</head>

<body>
    <!-- Menu -->
    <nav dir="ltr" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "en_doc/header.html" %}
    </nav>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#ApprovalsDropdown').addClass('active');
            $('#es_search_panel').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'Iran') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace('/en', '')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>

    <script src="../../static/js/topnav_handler.js"></script>
    
    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row px-0 py-5 px-md-5 py-md-5 m-0">

        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" novalidate>

            <!-- Primary Fields in First Row -->
            <div class="row flex-row mx-auto">

                <!-- Country Input -->
                <div class="col-md-6 pt-3 col-12 col-lg-2 bg-light">

                    <label class=" text-left bg-light float-left" style="direction: ltr;;">Country:</label>
                    <select dir="ltr" id="country" name="country" class="form-select text-left float-left"
                        style="direction: ltr;" onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>

                </div>


                <!-- Search Box input -->
                <div class="col-md-6 pt-3 col-12 col-lg-4 bg-light">
                    <label class="float-left" style="direction: ltr;">Search:</label>
                    <input style="direction: ltr;" class="float-left form-control text-left"
                        placeholder="search ..." type="text" required="" name="SearchBox" id="SearchBox" value="">
                </div>

                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button id="advanced_search" type="button" class="btn float-left" data-bs-toggle="collapse"
                        data-bs-target="#advanced_fields" aria-expanded="false" aria-controls="advanced_fields">Advanced Settings</button>
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-left ml-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">Searching ...</span>
                        </div>
                        Search
                    </button>
                </div>

            </div>

            <!-- Advanced Fields in Second Row -->
            <div id="advanced_fields" class="collapse show row flex-row mx-auto mt-4">

                <!-- document level input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light">

                    <label class=" text-left bg-light float-left" style="direction: ltr;;">Hierarchy of Law:</label>
                    <select id="LevelSelect" class="form-select text-left float-left" style="direction: ltr;">
                    </select>

                </div>

{#                <!-- document subject input -->#}
{#                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light">#}
{##}
{#                    <label class=" text-left bg-light float-left" style="direction: ltr;;">Legislation by Subject:</label>#}
{#                    <select id="SubjectSelect" class="form-select text-left float-left" style="direction: ltr;">#}
{#                    </select>#}
{##}
{#                </div>#}

{#                <!-- search type input -->#}
{#                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light">#}
{##}
{#                    <label class=" text-left bg-light float-left" style="direction: ltr;;">Legislation by Type:</label>#}
{##}
{#                    <select id="TypeSelect" class="form-select text-left float-left" style="direction: ltr;">#}
{#                    </select>#}
{##}
{#                </div>#}

                <!-- Approval References -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 bg-light">

                    <label class=" text-left bg-light float-left" style="direction: ltr;;">Legislative Body:</label>

                    <select id="ApprovalReferences" class="form-select text-left float-left" style="direction: ltr;">
                    </select>

                </div>

                <!-- From Year input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light">

                    <label class=" text-left bg-light float-left" style="direction: ltr;;">Legislation by Year (from):</label>

                    <select id="YearFrom" class="form-select text-left float-left" style="direction: ltr;">
                    </select>

                </div>

                <!-- To Year input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light">

                    <label class="text-left bg-light float-left" style="direction: ltr;;">Legislation by Year (to):</label>

                    <select id="YearTo" class="form-select text-left float-left" style="direction: ltr;">
                    </select>

                </div>

                <!-- Document Type -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light">

                    <label class=" text-left bg-light float-left" style="direction: ltr;;">Place:</label>

                    <select id="WhereSelect" class="form-select text-left float-left" style="direction: ltr;">
                        <option value="عنوان و متن">Title and Body</option>
                        <option value="عنوان">Title</option>
                        <option value="متن">Body</option>
                        <option value="تعاریف">Definitions</option>
                    </select>

                </div>

                <!-- Match Type -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light">

                    <label class=" text-left bg-light float-left" style="direction: ltr;;">Search Type:</label>

                    <select id="SearchTypeSelect" class="form-select text-left float-left" style="direction: ltr;">
                        <option value="exact">Exact</option>
                        <option value="and">And</option>
                        <option value="or">Or</option>
                    </select>

                </div>

            </div>

        </form>
        <div dir="ltr" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-left  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-left" role="presentation">
                    <button id="search_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">Search Result</button>
                </li>
                <!--
                <li class="nav-item float-left" role="presentation">
                    <button id="terms_graph_tab" class="nav-link" data-bs-toggle="pill" data-bs-target="#terms_graph_pane" type="button" role="tab" aria-controls="terms_graph_pane" aria-selected="false">گراف کلمات</button>
                </li>
                -->
                <li class="nav-item float-left" role="presentation">
                    <button id="bar_chart_info_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#bar_chart_info_pane" type="button" role="tab"
                        aria-controls="bar_chart_info_pane" aria-selected="false">Charts</button>
                </li>
                <li class="nav-item float-left" role="presentation">
                    <button id="document_graph_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#document_graph_pane" type="button" role="tab"
                        aria-controls="document_graph_pane" aria-selected="false">References Graph</button>
                </li>

                <!-- Download Buttons -->
                <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="Download documents"
                    class="btn float-right p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

                </button>

                <button class="btn float-right p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Export excel" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button>

                <!-- Result Count -->
                <p id="SearchResultLable"  class="text-left float-right text-secondary pl-2"></p>
            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-left px-1 bg-white" id="pills-tabContent">

                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 fade show active float-left" role="tabpanel"
                    aria-labelledby="search_result_tab">
                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" id="SearchTable">
                        </table>
                    </div>

                </div>

                <!-- Bar chart Info Pane -->
                <div dir="ltr" class="tab-pane fade float-left w-100" id="bar_chart_info_pane" role="tabpanel"
                    aria-labelledby="bar_chart_info_tab">

                    <div class="row mt-4 w-100 flex-row-reverse mx-0 px-0">
                        <!--<div class="col-md-4 px-4 col-12 col-lg-12 p-3 border"
                            <h5 class="document_subject w-100 mt-4 text-center float-left pt-3 pb-3">
                            Legislation by Subject
                            </h5>
                            <br>
                            <div style="margin-left: 1px !important;" id="subject_container"
                                class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                            </div>
                        </div>-->
                        <div class="col-md-4 px-4 col-12 col-lg-12 p-3 border">
                            <!-- Document Level segment -->
                            <h5 class="document_level w-100 mt-4 text-center float-left pt-3 pb-3">
                                Hierarchy of Law
                            </h5>
                            <br>
                            <div id="level_container"
                                class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                            </div>
                        </div>
                        <div class="col-md-4 px-4 col-12 col-lg-12 p-3 border">
                            <!-- Document Level segment -->
                            <h5 class="document_level w-100 mt-4 text-center float-left pt-3 pb-3">
                            Legislation by Year
                            </h5>
                            <br>
                            <div id="year_container"
                                class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                            </div>
                        </div>
                        <div class="col-md-4 px-4 col-12 col-lg-12 p-3 border">
                            <!-- Extracted References segment -->
                            <h5 class="extractected_references w-100 mt-4 text-center float-left pt-3 pb-3">
                                Legislative Body
                            </h5>
                            <br>
                            <div id="approval_container"
                                class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                            </div>
                        </div>
                    </div>
                </div>

                <!--  Document Graph Pane -->
                <div class="tab-pane fade show float-left w-100" id="document_graph_pane" role="tabpanel"
                    aria-labelledby="document_graph_tab">
                    <div class="row mt-4 w-100 flex-row-reverse  mx-auto pb-5 px-4">
                        <!-- doc colors -->
                        <ul id="ColorBox"
                            class="list-group flex-row-reverse list-unstyled w-100 list-group-horizontal text-left">
                        </ul>
                        <script src="../../static/js/graph/color_picker_handler.js">
                        </script>
                        <div id="advanced_graph_container" class="w-100 border mt-1" style="height:500px;">
                        </div>
                    </div>
                </div>


            </div>

        </div>


    </div>


    <!-- Modal Container -->
    <div class="modal fade" id="myModal">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: ltr !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title">Title</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="DetailText" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>

    <!-- ChartModal Container -->
    <button type="button" id="ChartModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#ChartModal"></button>
    <div class="modal fade" id="ChartModal">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: ltr !important;" class="modal-header">
                    <h5 id="ChartModalHeader" class="modal-title">title</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ChartModalText" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->
                <div dir="ltr" class="modal-footer">
                    <button id="DownloadDocuments" class="btn btn-primary"><i class="fa fa-download"></i>
                        Download Documents
                    </button>

                    <button id="ExportExcel2" class="btn btn-primary"><i class="fa fa-download"></i>
                        Download Excel
                    </button>
                </div>

            </div>
        </div>
    </div>    

    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="Go To Top" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
        <!-- <i class="bi bi-chevron-up"></i> -->
        <!-- <i class="bi bi-chevron-double-up"></i> -->
        <!-- <i class="bi bi-arrow-up-circle"></i> -->
    </button>
    <script src="../../static/js/scroll_button_handler.js">
    </script>

    <script>
        init()

        SearchResultValue = []

        async function init() {
            const country_id = document.getElementById("country").value

            /****************** Level List ****************************/
            document.getElementById("LevelSelect").innerHTML = "<option value=" + 0 + " >" + "All" + "</option>";
            let request_link = 'http://' + location.host + "/en" + "/GetLevelByCountryId/" + country_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["documents_level_list"]

            for (var i = 0; i < response.length; i++) {
                const level_id = response[i]["id"]
                const level_name = response[i]["level"]

                const tag = "<option value=" + level_id + " >" + level_name + "</option>";

                document.getElementById("LevelSelect").innerHTML += tag
            }

            /****************** Subject List ****************************/
            {#document.getElementById("SubjectSelect").innerHTML = "<option value=" + 0 + " >" + "All" + "</option>";#}


            /****************** Type List ****************************/
            {#document.getElementById("TypeSelect").innerHTML = "<option value=" + 0 + " >" + "All" + "</option>";#}

            /****************** ApprovalReferences List ****************************/
            document.getElementById("ApprovalReferences").innerHTML = "<option value=" + 0 + " >" + "All" + "</option>";
            request_link = 'http://' + location.host + "/en" + "/GetApprovalReferencesByCountryId/" + country_id + "/";
            response = await fetch(request_link).then(response => response.json());
            response = response["documents_approval_list"]


            for (var i = 0; i < response.length; i++) {
                const approval_reference_id = response[i]["id"]
                const approval_reference_name = response[i]["approval_reference"]

                const tag = "<option value=" + approval_reference_id + " >" + approval_reference_name + "</option>";

                document.getElementById("ApprovalReferences").innerHTML += tag
            }

            /****************** ApprovalReferences List ****************************/
            document.getElementById("YearFrom").innerHTML = "<option value=" + 0 + " >" + "All" + "</option>";
            document.getElementById("YearTo").innerHTML = "<option value=" + 0 + " >" + "All" + "</option>";
            request_link = 'http://' + location.host + "/en" + "/GetYearsBoundByCountryId/" + country_id + "/";
            response = await fetch(request_link).then(response => response.json());
            response = response["documents_approval_list"]
            const min_year = response[0]
            const max_year = response[1]

            if (max_year !== -1 && min_year !== -1) {
                for (var i = max_year; i >= min_year; i--) {
                    const tag = "<option value=" + i + " >" + i + "</option>";
                    document.getElementById("YearFrom").innerHTML += tag
                    document.getElementById("YearTo").innerHTML += tag
                }
            }
        }

        function CountryChanged() {
            init()
        }


        function showDocumentInformation(documents_information_result, mode, place, total_hits, text) {

            SearchResultValue = documents_information_result;

            const search_text = document.getElementById("SearchBox").value;
            if (total_hits == 10000) {
                total_hits = 'more than ' + total_hits
            }
            document.getElementById("SearchResultLable").innerText = total_hits + " documents found.";
            let index = 1;
            let document_result = []
            for (let doc of documents_information_result) {
                const es_id = doc["_id"]
                const id = doc["_source"]["document_id"]
                const name = doc["_source"]["name"]
                const level = doc["_source"]["level_name"]
                const approval_reference = doc["_source"]["approval_reference_name"]
                const approval_date = doc["_source"]["approval_date"]
                let count = Math.round((doc['_score'] * 100)) / 100


                let button_disable = ""
                if (mode === "All") {
                    button_disable = "disabled"
                }

                const detail_function = `DetailFunction('${id}','${name}','${mode}', '${place}','${text}')`;
                const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + button_disable + ' onclick="' + detail_function + '" data-bs-target="#myModal">details</button>'

                const document_link = 'http://' + location.host + "/en/information/?id=" + id
                const doc_name = '<a target="blank" href="' + document_link + '">' + name + "</a>"

                const row = { "id": index, "name": doc_name, "approval_reference": approval_reference, "approval_date": approval_date, "count": count, "detail": detail }
                document_result.push(row)
                index += 1
            }
            document.getElementsByClassName("SearchTable")[0].innerHTML = "";
            $('.SearchTable').footable({
                "paging": {
                    "enabled": true,
                     strings: {
                         first: '»',
                         prev:'›',
                         next: '‹',
                         last: '«'
                     }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "Not Found.",
                "columns": [{
                    "name": "id",
                    "title": "#",
                    "breakpoints": "xs sm",
                    "type": "number",
                    "style": {
                        "width": "5%"
                    }
                }, {
                    "name": "name",
                    "title": "Document Name",
                    "style": {
                        "width": "35%"
                    }
                }, {
                    "name": "approval_reference",
                    "title": "Legislative Body",
                    "style": {
                        "width": "15%"
                    }
                }, {
                    "name": "approval_date",
                    "title": "Legislation by Year",
                    "style": {
                        "width": "15%"
                    }
                }, {
                    "name": "count",
                    "title": "Score",
                    "style": {
                        "width": "10%"
                    }
                }, {
                    "name": "detail",
                    "title": "Details",
                    "style": {
                        "width": "5%"
                    }
                }
                ],
                "rows": document_result
            });


        }

        async function GetChartData_Es(country_id, level_id, approval_reference_id, from_year, to_year, place, text, search_type, documents_information_result) {

            let request_link = '';
            startBlockUI('bar_chart_info_pane');

            approval_references_data = {}
            level_data = {}
            approval_year_data = {}
            doc_ids = []

            for (doc of documents_information_result) {
                doc_id = doc['_source']['document_id']
                doc_ids.push(doc_id)

                doc_es_id = doc['_id']
                doc_name = doc['_source']['name']
                doc_approval_ref = doc['_source']['approval_reference_name']
                doc_level = doc['_source']['level_name']
                doc_approval_year = (doc['_source']['approval_date'] != 0) ? doc['_source']['approval_date'] : 'Unknown'


                if (!(doc_approval_ref in approval_references_data)) {
                    approval_references_data[doc_approval_ref] = {
                        "name": doc_approval_ref, "count": 1
                    }
                }

                else {
                    approval_references_data[doc_approval_ref]["count"] += 1

                }

                if (!(doc_level in level_data)) {
                    level_data[doc_level] = { "name": doc_level, "count": 1 }

                }
                else {
                    level_data[doc_level]["count"] += 1

                }

                if (!(doc_approval_year in approval_year_data)) {
                    approval_year_data[doc_approval_year] = {
                        "name": doc_approval_year, "count": 1
                    }
                }

                else {
                    approval_year_data[doc_approval_year]["count"] += 1

                }
            }


            /* Show Chart  */


            showChartData(level_data, "level_container", documents_information_result, false)
            showChartData(approval_year_data, "year_container", documents_information_result, true)
            showChartData(approval_references_data, "approval_container", documents_information_result, false)

            stopBlockUI('bar_chart_info_pane', 'Chart Informations');

        }

        function showChartData(data, container, documents_information_result, keySort) {
            let chart_data = []
            for (const [key, value] of Object.entries(data)) {
                chart_data.push([value["name"], value["count"]])
            }
            showChart(chart_data, container, documents_information_result, keySort)
        }

        async function GetDocumentsInformation(country_id, level_id, approval_reference_id, from_year, to_year, place, text, search_type) {

            let request_link = '';
            notyf.dismissAll();

            startBlockUI('SearchTable');


            request_link = 'http://' + location.host + "/en/SearchDocument_ES/" + country_id + "/" + level_id + "/" +
                approval_reference_id + "/" + from_year + "/" + to_year + "/" + place + "/" + text + "/" + search_type + "/"




            let response = await fetch(request_link).then(response => response.json());

            /*  Show Table Result */
            total_hits = response["total_hits"]
            ES_SearchResult = response["result"]


            let documents_information_result = []


            showDocumentInformation(ES_SearchResult, search_type, place, total_hits, text)
            stopBlockUI('SearchTable', 'Search Results');


            GetChartData_Es(country_id, level_id, approval_reference_id, from_year, to_year, place, text, search_type, ES_SearchResult);


            /* Show References Graph */
            startBlockUI('advanced_graph_container');

            await showReferencesGraph(ES_SearchResult)

            stopBlockUI('advanced_graph_container', 'References Graph');

        }

        async function ShowResult() {
            await SpinnerModeFunction("Active");
            // clear previous results
            {% comment %} clearPrevResults(container_id_list); {% endcomment %}

            await SpinnerModeFunction("Active");

            const country_id = document.getElementById("country").value;
            const level_id = document.getElementById("LevelSelect").value;
            const approval_reference_id = document.getElementById("ApprovalReferences").value;
            const from_year = document.getElementById("YearFrom").value;
            const to_year = document.getElementById("YearTo").value;
            const place = document.getElementById("WhereSelect").value;
            const text = document.getElementById("SearchBox").value;
            const search_type = document.getElementById("SearchTypeSelect").value

            if (text.trim().length > 0) {
                GetDocumentsInformation(country_id, level_id, approval_reference_id, from_year, to_year, place, text, search_type);

            } else {

                GetDocumentsInformation(country_id, level_id, approval_reference_id, from_year, to_year, place, "empty", 'All');

            }

            await SpinnerModeFunction("Disable");

            {% comment %} //user log
            let form_data = new FormData()
            let detail_type = "نتایج جست و جو"
            let country_name = $("#country option:selected").text();
            let search_text = text
            form_data.append('detail_type', detail_type);
            form_data.append('country_name', country_name);
            form_data.append('search_text', search_text);
            UserLog(form_data) {% endcomment %}

        }


        async function showReferencesGraph(documents_information_result) {

            document.getElementById("advanced_graph_container").innerHTML = ""

            let documents_id_list = []
            for (const row of documents_information_result) {
                if (row['_source']['document_id'] != '') {
                    documents_id_list.push(row['_source']["document_id"]);
                }
            }

            const measure_id = 2;
            let graphEdgeList = [];
            let graphType = '';

            if (documents_id_list.length > 0) {
                const request_link = 'http://' + location.host + "/en/GetGraphEdgesByDocumentsList/" + measure_id + "/"
                let form_data = new FormData();
                form_data.append('documents_id_list', documents_id_list)

                $.ajax({
                    url: request_link,
                    data: form_data,
                    type: 'POST',
                    contentType: false,
                    processData: false,
                    async: false,
                }).done(function (response) {
                    graphEdgeList = response["graph_edge_list"];
                    graphType = response["graph_type"];
                }).fail(function (response) {
                    console.log(response);
                });

                let nodeList = [];
                let edgeList = [];
                let GRAPH_SIZE_LIMIT = 100;

                if (graphEdgeList.length > GRAPH_SIZE_LIMIT) {
                    document.getElementById("advanced_graph_container").innerHTML =
                        "<span class='d-block text-center' style='color: dodgerblue'><i class=\"fa fa-ban\" aria-hidden=\"true\"></i> گراف بسیار بزرگ است</span>";
                    return -1;
                }

                for (let i = 0; i < graphEdgeList.length; i++) {

                    const edge = graphEdgeList[i]
                    const src_id = edge["src_id"]
                    const src_name = edge["src_name"]
                    const src_color = edge["src_color"]
                    const dest_id = edge["dest_id"]
                    const dest_name = edge["dest_name"]
                    const dest_color = edge["dest_color"]
                    const weight = edge["weight"]

                    let source_node = {
                        id: src_id,
                        name: src_name,
                        normal: {
                            fill: src_color,
                            stroke: null
                        },
                        hovered: {
                            fill: src_color,
                            stroke: null
                        },
                        selected: {
                            fill: src_color,
                            stroke: null
                        }
                    }

                    let destination_node = {
                        id: dest_id,
                        name: dest_name,
                        normal: {
                            fill: dest_color,
                            stroke: null
                        },
                        hovered: {
                            fill: dest_color,
                            stroke: null
                        },
                        selected: {
                            fill: dest_color,
                            stroke: null
                        }
                    }

                    let edge_data = {
                        id: src_id + "__" + dest_id,
                        from: src_id,
                        to: dest_id,
                        from_name: src_name,
                        to_name: dest_name,
                        weight: weight
                    };

                    nodeList.push(source_node)
                    nodeList.push(destination_node)
                    edgeList.push(edge_data)
                }


                /*********************** Show Graph ****************************/


                let graphData = {
                    nodes: nodeList,
                    edges: edgeList
                };

                var chart = anychart.graph(graphData);
                chart.height(650);
                let nodes = chart.nodes();
                nodes.normal().height(12);
                nodes.hovered().height(16);
                nodes.selected().height(16);
                nodes.hovered().fill("#ffa000");
                chart.nodes().tooltip().format("{%name}");
                chart.edges().tooltip().format(" from: {%from_name} \n to: {%to_name} \n weight: {%weight}");
                chart.edges().tooltip().fontFamily('vazir');
                chart.nodes().tooltip().fontFamily('vazir');
                chart.background("transparent");

                if (graphType === "Directed") {
                    chart.edges().arrows({
                        enabled: true,
                        size: 10,
                        position: '50%'
                    });
                }

                chart.container("advanced_graph_container")
                chart.draw();

                chart.listen('dblClick', async function (event) {
                    const click_tag = event.domTarget.tag;
                    console.log(click_tag)
                    if (click_tag["type"] === "node") {
                        window.open('http://' + location.host + "/information?id=" + click_tag["id"]);
                    } else if (click_tag["type"] === "edge") {
                        window.open('http://' + location.host + "/comparison?id=" + click_tag["id"]);
                    }

                })
            }

        }

        function showChart(data, position, documents_information_result, keySort) {
            if (keySort === true) {
                data.sort(function (element_a, element_b) {
                    return element_a[0] - element_b[0];
                });
            }
            else {
                data.sort(function (element_a, element_b) {
                    return element_a[1] - element_b[1];
                });
            }

            
            data.sort(function (x, y) { return x[0] === 'Unknown' ? -1 : y[0] === 'Unknown' ? 1 : 0; });

            // Sorts the data by descending.
            data = anychart.data.set(data)

            document.getElementById(position).innerHTML = ""

            chart = anychart.column();
            chart.container(position);
            // create a column series and set the data
            var series = chart.column(data);
            chart
                .animation(true)
                .padding([10, 40, 5, 20])


            chart.background().fill('#ffffff');
            series.normal().fill("#488fb8", 1);
            series.normal().stroke("#488fb8", 0);

            // var state = series.normal();
            // state.fill('#1481c0')

            // x axix labels font setting
            var xAxisLabels = chart.xAxis().labels();
            xAxisLabels.fontFamily("vazir");

            var yAxisLabels = chart.yAxis().labels();
            yAxisLabels.fontFamily("vazir");

            // Not allow labels overlapping
            var xAxis = chart.xAxis();
            xAxis.overlapMode("noOverlap");

            var yAxis = chart.yAxis();
            yAxis.title("document count");
            yAxis.title().fontFamily('vazir');
            yAxis.title().height(40);

            // tooltip content font setting
            var tooltip = chart.tooltip();
            tooltip.fontFamily("vazir");

            // tooltip title font setting
            var title = chart.tooltip().title();
            title.fontFamily("vazir");

            chart.tooltip().hAlign('center').format("{%value}");

            chart.xAxis().labels().height(60);

            chart.yAxis().labels().format("{%value}");

            chart.yScale().minimum(0);
            chart.yScale().ticks().allowFractional(false);

            //xAxisLabels.rotation(-90)
            // initiate drawing the chart
            chart.draw();
            chart.listen('Click', async function (event) {
                const click_tag = event.domTarget.tag;
                const index = click_tag["index"]
                var text = data.row(index)[0];
                let filtered_result = []
                let header = ""
                let save_file_name = document.getElementById("SearchBox").value;

                if (position === "approval_container") {
                    filtered_result = documents_information_result.filter(function (row) {
                        if (row['_source']["approval_reference_name"] === text)
                            return row
                    });
                    header = "Legislative Body: " + text
                    save_file_name += "(country {1} and approval reference {2})".replace("1", filtered_result[0]["country"]).replace("2", text)
                }

                else if (position === "level_container") {
                    filtered_result = documents_information_result.filter(function (row) {
                        if (row['_source']["level_name"] === text)
                            return row
                    });
                    header = "hierarchy of law: " + text
                    save_file_name += "(country {1} and level {2})".replace("1", filtered_result[0]["country"]).replace("2", text)
                }

                else if (position === "year_container") {
                    filtered_result = documents_information_result.filter(function (row) {
                        if (row['_source']["approval_date"] === text)
                            return row
                    });
                    header = "Legislation by Year: " + text
                    save_file_name += "(country {1} and date {2})".replace("1", filtered_result[0]["country"]).replace("2", text)
                }

                document.getElementById("ChartModalHeader").innerText = header
                let filtered_result_tag = ""
                let list_of_docId = ""
                for (const doc of filtered_result) {
                    const link = 'http://' + location.host + "/en/information/?id=" + doc["_source"]["document_id"]
                    let tag = "<li class='mt-3' id=" + doc["_source"]["document_id"] + "><a href='" + link + "'>" + doc["_source"]["name"] + "</a></li>"
                    filtered_result_tag += tag
                    list_of_docId += doc["document_id"] + "_"
                }

                filtered_result_tag = "<ol start='1'>" + filtered_result_tag + "</ol>"
                document.getElementById("ChartModalText").innerHTML = filtered_result_tag


                /* download file creation */
                document.getElementById("DownloadDocuments").onclick = function () {
                    downloadFiles(filtered_result, save_file_name);
                };


                /* export into excel files */
                document.getElementById("ExportExcel2").onclick = function ExportExcelFunction() {

                    var csv = "";

                    sep = ","
                    let Csv = "Document Name" + sep + "Document Level" + sep + 
                    "Approval Reference" + sep + "Approval Date" + sep + "Count" + "\n"
                    
                    for (const document of filtered_result) {
                        Csv += document["_source"]["name"].replaceAll(',', '_') + sep + document["_source"]["level_name"].replaceAll(',', '_') + sep + 
                        document["_source"]["approval_reference_name"].replaceAll(',', '_') + sep + document["_source"]["approval_date"] + sep + document["_score"] + "\n"
        
                    }

                    let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
                    var link = document.createElement("a");
                    link.setAttribute("href", csvContent);
                    link.setAttribute("download", save_file_name + ".csv");
                    document.body.appendChild(link);
                    link.click()
                };

                $("#ChartModalBtn").click();


            })

        }
      
        async function showDetailsDataAndOR(document_id, document_name, paragraphs_list, text) {
            /* Title Text */
            const link = 'http://' + location.host + "/en/information/?id=" + document_id
            let title_tag = "<a target='blank' href='" + link + "'>" + document_name + "</a>"
            document.getElementById("ModalHeader").innerHTML = title_tag


            /* Body Text */
            const words = text.split(" ")
            document.getElementById("DetailText").innerHTML = ""
            for (let paragraph of paragraphs_list) {
                for (let word of words) {
                    const tag = "<span class='text-primary bold'>" + word + "</span>"

                    if (paragraph.startsWith(word))
                        paragraph = paragraph.replaceAll(word + ' ', tag + ' ');

                    paragraph = paragraph.replaceAll(' ' + word + ' ', ' ' + tag + ' ');
                }

                const tag = "<li class='mb-3'>" + paragraph + "</li>"
                document.getElementById("DetailText").innerHTML += tag;
            }
            document.getElementById("DetailText").innerHTML = "<ul>" + document.getElementById("DetailText").innerHTML + "</ul>"
        }
        async function showDetailsDataExact(document_id, document_name, paragraphs_list, text) {
            /* Title Text */
            const link = 'http://' + location.host + "/en/information/?id=" + document_id
            let title_tag = "<a target='blank' href='" + link + "'>" + document_name + "</a>"
            document.getElementById("ModalHeader").innerHTML = title_tag

            /* Body Text */
            const words = text.split(" ")
            document.getElementById("DetailText").innerHTML = ""
            for (let paragraph of paragraphs_list) {
                let temp = text.toLowerCase()
                let tag = "<span class='text-primary bold'>" + text + "</span> "
                let tag1 = "<span class='text-primary bold'>" + temp + "</span> "
                if (paragraph.startsWith(text))
                    paragraph = paragraph.replaceAll(text + ' ', tag + ' ');
                if (paragraph.startsWith(temp))
                    paragraph = paragraph.replaceAll(temp + ' ', tag1 + ' ');

                paragraph = paragraph.replaceAll(' ' + text + ' ', ' ' + tag + ' ');
                paragraph = paragraph.replaceAll(' ' + temp + ' ', ' ' + tag1 + ' ');

                tag = "<li class='mb-3'>" + paragraph + "</li>"
                document.getElementById("DetailText").innerHTML += tag;
            }
            document.getElementById("DetailText").innerHTML = "<ul>" + document.getElementById("DetailText").innerHTML + "</ul>"
        }

        

        async function DetailFunction(doc_id, doc_name, search_type, where, text) {
            startFullPageBlockUI();

            document.getElementById("DetailText").innerHTML = ""
            document.getElementById("ModalHeader").innerHTML = ""
            let doc_text = ''

            // doc_text = ES_SearchResult[es_doc_id]['_source']['attachment']['content']

            let request_link = 'http://' + location.host + "/en/GetSearchDetails_ES/" + doc_id  + "/" + search_type + "/" + text + "/";
            let response = await fetch(request_link).then(response => response.json());
            doc_text = response["result"]


            /*  Show detail Result */
            let document_paragraphs_result = []

            doc_text = doc_text.replaceAll('<em>', "<span class='text-primary bold'>").replaceAll('</em>', '</span>');
            all_para = doc_text.split('\n');

            for (para of all_para) {
                if (para.includes('<span>') || para.includes('</span>')) {
                    document_paragraphs_result.push(para)
                }
            }

            if (document_paragraphs_result.length == 0){
                document_paragraphs_result = all_para
            }



            await showHighlightedParagraphs_Details(doc_id, doc_name, document_paragraphs_result)
            stopFullPageBlockUI('Details')
        }

        async function showHighlightedParagraphs_Details(document_id, document_name, paragraphs_list) {
            /* Title Text */
            const link = 'http://' + location.host + "/en/information/?id=" + document_id
            let title_tag = "<a target='blank' href='" + link + "'>" + document_name + "</a>"
            document.getElementById("ModalHeader").innerHTML = title_tag

            document.getElementById("DetailText").innerHTML = ""
            for (let paragraph of paragraphs_list) {

                tag = "<li class='mb-3'>" + paragraph + "</li>"
                document.getElementById("DetailText").innerHTML += tag;
            }
            document.getElementById("DetailText").innerHTML = "<ul>" + document.getElementById("DetailText").innerHTML + "</ul>"
        }

        async function SpinnerModeFunction(mode) {
            if (mode === "Active") {
                $(".spinner-border").addClass("active");
            } else if (mode === "Disable") {
                $(".spinner-border").removeClass("active");
            }
        }
    </script>
    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>
    <script>

        async function downloadFiles(file_name_list, save_file_name) {
            startFullPageBlockUI()
            const country_id = document.getElementById('country').value
            let zip = new JSZip()

            const request_link = 'http://' + location.host + "/en/GetCountryById/" + country_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["country_information"][0]
            const country_folder = response["folder"];
            const country_name = response["name"];

            save_file_name += "Country {" + country_name + "}"


            let extension = ".txt"
            if (country_name.includes("فاوا")) {
                extension = '.docx';
            }

            for (const document of file_name_list) {
                const document_name = document["_source"]["name"] + extension
                const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

                await fetch(path)
                    .then(res => res.arrayBuffer())
                    .then(value => {
                        zip.file(document_name, value);
                    })
            }
            zip.generateAsync({
                type: "blob"
            })
                .then(function (content) {
                    // see FileSaver.js
                    saveAs(content, save_file_name + ".zip");
                });
            stopFullPageBlockUI('Download Documents');
        }



        async function DownloadSerachResultFunction() {
            save_file_name = "search result {" + document.getElementById("SearchBox").value + "}"
            downloadFiles(SearchResultValue, save_file_name)
        }

        async function ExportExcelSerachResultFunction() {
            var csv = "";

            sep = ","
            let Csv = "Document Name" + sep + "Document Level" + sep + 
            "Approval Reference" + sep + "Approval Date" + sep + "Count" + "\n"
            
            for (const document of SearchResultValue) {
                Csv += document["_source"]["name"].replaceAll(',', '_') + sep + document["_source"]["level_name"].replaceAll(',', '_') + sep + 
                document["_source"]["approval_reference_name"].replaceAll(',', '_') + sep + document["_source"]["approval_date"] + sep + document["_score"] + "\n"

            }

            let save_file_name = "Search Result {" + document.getElementById("SearchBox").value + "}"
            save_file_name += " Country {" + document.getElementById("country").innerText + "}"

            let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
            var link = document.createElement("a");
            link.setAttribute("href", csvContent);
            link.setAttribute("download", save_file_name + ".csv");
            document.body.appendChild(link);
            link.click()
        }

        /* Search after press Enter */
        $("#info_form").submit(function () { return false; });
        $("#SearchBox").keyup(function (event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                $("#document_search").click();
            }
        });

    </script>

</body>

<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/en_js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">

<!-- BS Tooltips handler -->
<script src="../../static/js/tooltip_handler.js"></script>
{#<script src="../../static/js/UserLogSave.js"></script>#}

<!-- Intro Js -->
<script src="../../static/js/en_js/search/search_tour.js">
</script>
<script src="../../static/js/signout_function.js"></script>

</html>